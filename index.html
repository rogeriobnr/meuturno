<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="manifest" href="./manifest.json">
    <meta name="theme-color" content="#1d4ed8">
    <title>Meu Turno</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">

    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
        }

        #toast {
            position: fixed;
            left: 50%;
            bottom: 30px;
            transform: translate(-50%, 100px);
            min-width: 280px;
            background-color: #2c3e50;
            color: #fff;
            text-align: center;
            border-radius: 0.375rem;
            padding: 1rem;
            z-index: 10000;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.4s ease, transform 0.4s ease, visibility 0.4s;
        }

        #toast.show {
            opacity: 1;
            visibility: visible;
            transform: translate(-50%, 0);
        }

        #toast.error {
            background-color: #c0392b;
        }

        #toast.success {
            background-color: #27ae60;
        }

        .popup-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            z-index: 9998;
            display: none;
            backdrop-filter: blur(4px);
        }

        .popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 1.25rem;
            border-radius: 0.75rem;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
            z-index: 9999;
            width: 90%;
            max-width: 400px;
            display: none;       max-height: 90vh;       max-height: 90vh;
        }

        .menu-open #menu-lateral {
            transform: translateX(0);
        }

        .menu-open #menu-overlay {
            opacity: 1;
            pointer-events: auto;
        }

        .campo-invalido {
            border-color: #ef4444 !important;
            box-shadow: 0 0 0 2px rgba(239, 68, 68, 0.4);
        }

        .servico-pendente-os {
            border-left-width: 4px;
            border-left-color: #F97316;
        }

        .servico-pendente-os .servico-cabecalho {
            background-color: #FFF7ED;
        }

        .servico-compartilhado .servico-cabecalho {
            background-color: #d9f99d;
        }

        .servico-compartilhado {
            border-left-width: 4px;
            border-left-color: #84cc16;
        }

        .servico-cabecalho {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            padding: 0.75rem 1rem;
            background-color: #e9ecef;
            border-bottom-width: 1px;
            border-color: #ced4da;
            border-top-left-radius: 0.5rem;
            border-top-right-radius: 0.5rem;
        }

        .servico-cabecalho-info {
            flex-grow: 1;
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
            margin-right: 0.5rem;
        }

        .servico-cabecalho-info .frota-destaque {
            font-weight: bold;
            color: #0056b3;
        }

        .servico-cabecalho-info .atividade-info {
            color: #495057;
            font-size: 0.9em;
            margin-left: 0.25rem;
        }

        .servico-cabecalho-toggler {
            font-size: 1.1em;
            color: #495057;
        }

        .servico-detalhes {
            padding: 1rem;
            border-width: 1px;
            border-top-width: 0;
            border-color: #ced4da;
            border-bottom-left-radius: 0.5rem;
            border-bottom-right-radius: 0.5rem;
        }
    </style>
</head>

<body class="bg-gray-100 text-gray-800">
    <header class="bg-blue-800 text-white p-4 shadow-md flex items-center justify-between sticky top-0 z-10">
        <button id="hamburger-btn"
            class="text-2xl p-2 rounded-full hover:bg-blue-700 transition-colors">&#9776;</button>
        <div class="flex items-center gap-x-3">
            <img src="logo.png" alt="Logo MeuTurno" class="h-8" onerror="this.style.display='none'">
            <h1 id="header-titulo" class="text-xl font-bold">Turno</h1>
        </div>
        <div class="w-10"></div>
    </header>
    <nav id="menu-lateral"
        class="fixed top-0 left-0 h-full bg-white shadow-lg z-30 transform -translate-x-full transition-transform duration-300 ease-in-out w-3/4 max-w-sm">
        <div class="p-4 border-b">
            <h2 class="text-2xl font-bold text-blue-800">MeuTurno</h2>
        </div>
        <div class="flex flex-col">
            <a href="#" class="p-4 border-b text-gray-700 hover:bg-gray-100 transition-colors"
                data-secao="turno">Turno</a>
            <a href="#" class="p-4 border-b text-gray-700 hover:bg-gray-100 transition-colors"
                data-secao="servicos">Servi√ßos</a>
            <a href="#" class="p-4 border-b text-gray-700 hover:bg-gray-100 transition-colors"
                data-secao="frotas">Frotas</a>
            
            <a href="#" class="p-4 border-b text-gray-700 hover:bg-gray-100 transition-colors"
                data-secao="relatorio">Relat√≥rio</a>
            
            <a href="#" class="p-4 border-b text-gray-700 hover:bg-gray-100 transition-colors"
                data-secao="historico">Hist√≥rico</a>
            <a href="#" class="p-4 border-b text-gray-700 hover:bg-gray-100 transition-colors"
   data-secao="apontamento">Apontamento Di√°rio</a>
            <a href="#" class="p-4 border-b text-gray-700 hover:bg-gray-100 transition-colors"
                data-secao="catalogo">Cat√°logo de Pe√ßas</a>
            <a href="#" class="p-4 border-b text-gray-700 hover:bg-gray-100 transition-colors"
                data-secao="estatisticas">Estat√≠sticas</a>
            <a href="#" class="p-4 border-b text-gray-700 hover:bg-gray-100 transition-colors"
                data-secao="config">Configurar</a>
        </div>
    </nav>

    <div id="menu-overlay"
        class="fixed top-0 left-0 w-full h-full bg-black bg-opacity-50 z-20 opacity-0 pointer-events-none transition-opacity duration-300 ease-in-out">
    </div>

    <main class="p-4">
        <section id="turno">
            <div class="p-4 border border-gray-200 rounded-lg">
    <h4 class="text-lg font-semibold text-blue-700 mb-3 border-b pb-2">Dados do Turno</h4>
    
    <div>
        <label for="dataTurno" class="block text-sm font-medium text-gray-700"><strong>Data</strong></label>
        <input id="dataTurno" type="date" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" onchange="salvarDadosParciaisTurno()" required>
    </div>

    <div class="mt-4">
        <label for="fazenda" class="block text-sm font-medium text-gray-700"><strong>Fazenda</strong></label>
        <div class="flex gap-2">
            <select id="fazenda" class="mt-1 block w-full p-2 border border-gray-300 rounded-md bg-white shadow-sm" onchange="salvarDadosParciaisTurno()" required>
                <option value="">Carregando...</option>
            </select>
            <button onclick="adicionarNovaFazenda()" class="mt-1 bg-green-600 hover:bg-green-700 text-white px-3 rounded-md font-bold text-xl shadow-sm" title="Adicionar Fazenda">+</button>
            <button onclick="removerFazendaSelecionada()" class="mt-1 bg-red-100 hover:bg-red-200 text-red-600 px-3 rounded-md font-bold shadow-sm" title="Apagar Selecionada">üóëÔ∏è</button>
        </div>
    </div>

    <div class="mt-4">
        <label for="frente" class="block text-sm font-medium text-gray-700"><strong>Frente</strong></label>
        <div class="flex gap-2">
            <select id="frente" class="mt-1 block w-full p-2 border border-gray-300 rounded-md bg-white shadow-sm" onchange="salvarDadosParciaisTurno()" required>
                <option value="">Carregando...</option>
            </select>
            <button onclick="adicionarNovaFrente()" class="mt-1 bg-green-600 hover:bg-green-700 text-white px-3 rounded-md font-bold text-xl shadow-sm" title="Adicionar Frente">+</button>
            <button onclick="removerFrenteSelecionada()" class="mt-1 bg-red-100 hover:bg-red-200 text-red-600 px-3 rounded-md font-bold shadow-sm" title="Apagar Selecionada">üóëÔ∏è</button>
        </div>
    </div>

    <div class="mt-4">
        <label for="turnoLetra" class="block text-sm font-medium text-gray-700"><strong>Turno</strong></label>
        <select id="turnoLetra" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" onchange="salvarDadosParciaisTurno()">
            <option value="A">A</option>
            <option value="B">B</option>
            <option value="C">C</option>
        </select>
    </div>
</div>

                <div class="p-4 border border-gray-200 rounded-lg">
    <div class="flex justify-between items-center border-b pb-2 mb-3">
        <h4 class="text-lg font-semibold text-blue-700">Equipe do Turno</h4>
        <button onclick="abrirPopupSelecaoEquipe()" class="bg-blue-600 hover:bg-blue-700 text-white text-xs py-2 px-3 rounded-md font-bold shadow-sm flex items-center gap-1">
            <span>üë•</span> Selecionar / Cadastrar
        </button>
    </div>
    
    <div id="boxEquipe" class="space-y-2">
        <p class="text-sm text-gray-400 italic text-center py-2">Ningu√©m adicionado ao turno ainda.</p>
    </div>
</div>

                <div class="p-4 border border-gray-200 rounded-lg">
                    <h4 class="text-lg font-semibold text-blue-700 mb-3 border-b pb-2">Frotas do Turno</h4>
                    <button onclick="abrirPopupSelecaoFrota()"
                        class="w-full bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-4 rounded-md mb-4">Adicionar
                        Frota do Cat√°logo</button>
                    <div id="listaFrotas" class="mt-3 space-y-2"></div>
                </div>
            </div>
        </section>
        <section id="servicos" class="hidden"></section>
        <section id="frotas" class="hidden"></section>
        <section id="catalogo" class="hidden"></section>
        <section id="estatisticas" class="hidden"></section>
        <section id="relatorio" class="hidden"></section>
        <section id="historico" class="hidden"></section>
        <section id="config" class="hidden"></section>
        
        <section id="apontamento" class="hidden">
    <div class="bg-white p-4 rounded-lg shadow space-y-6">
        <h2 class="text-xl font-bold text-blue-800 border-b pb-2">Apontamento Di√°rio (Bracell)</h2>

        <div class="space-y-4">
    
    <div class="bg-white border border-gray-200 rounded-xl shadow-sm p-4">
        <div class="flex items-center gap-2 mb-3 pb-2 border-b border-gray-100">
            <span class="text-lg">üìã</span>
            <h3 class="font-bold text-gray-800 text-sm uppercase tracking-wide">Dados do Formul√°rio</h3>
        </div>

        <div class="space-y-3">
            <div>
                <label class="block text-xs font-bold text-gray-500 mb-1 flex items-center gap-1">
                    <span>üè≠</span> Tipo de Oficina
                </label>
                <select id="apontamentoTipoOficina" class="w-full p-2.5 bg-gray-50 border border-gray-200 rounded-lg text-sm text-gray-700 focus:ring-2 focus:ring-blue-500 outline-none transition-all font-medium">
                    <option value="externa">Oficina Externa (Campo)</option>
                    <option value="interna">Oficina Interna (Automotiva)</option>
                </select>
            </div>

            <div>
                <label class="block text-xs font-bold text-gray-500 mb-1 flex items-center gap-1">
                    <span>üë§</span> Colaborador
                </label>
                <select id="apontamentoColaborador" class="w-full p-2.5 bg-gray-50 border border-gray-200 rounded-lg text-sm text-gray-700 focus:ring-2 focus:ring-blue-500 outline-none font-medium"></select>
            </div>

            <div class="grid grid-cols-2 gap-3">
                <div>
                    <label class="block text-xs font-bold text-gray-500 mb-1">Setor</label>
                    <input type="text" id="apontamentoSetor" value="Manuten√ß√£o Silvicultura" class="w-full p-2.5 bg-gray-50 border border-gray-200 rounded-lg text-sm text-gray-700 focus:ring-2 focus:ring-blue-500 outline-none">
                </div>
                <div>
    <label class="block text-xs font-bold text-gray-500 mb-1">Data do Apontamento</label>
    <input type="date" id="apontamentoData" 
           class="w-full p-2.5 bg-white border border-gray-200 rounded-lg text-sm text-gray-800 focus:ring-2 focus:ring-blue-500 outline-none font-bold"
           onchange="atualizarPreviewSeNecessario()">
</div>

            </div>
        </div>
    </div>

 <!--   <div class="bg-yellow-50 border border-yellow-200 rounded-xl p-3">
        <div class="flex items-center justify-between mb-2">
            <h3 class="text-xs font-bold text-yellow-800 uppercase flex items-center gap-1">
                <span>üìè</span> Calibra√ß√£o Fina
            </h3>
            <span class="text-[10px] text-yellow-600 bg-yellow-100 px-2 py-0.5 rounded-full">Ajuste de Impress√£o</span>
        </div>
        
        <div class="flex space-x-3">
            <div class="flex-1">
                <label class="block text-[10px] font-bold text-yellow-700 mb-1">Horizontal (X)</label>
                <input type="number" id="ajusteXGlobal" value="0" class="w-full p-2 border border-yellow-300 rounded-lg text-sm bg-white text-center font-bold text-gray-700 placeholder-gray-300" placeholder="0">
            </div>
            <div class="flex-1">
                <label class="block text-[10px] font-bold text-yellow-700 mb-1">Vertical (Y)</label>
                <input type="number" id="ajusteYGlobal" value="0" class="w-full p-2 border border-yellow-300 rounded-lg text-sm bg-white text-center font-bold text-gray-700 placeholder-gray-300" placeholder="0">
            </div>
        </div>
    </div>

</div> -->

            <div class="mt-6">
    <div class="flex items-center justify-between mb-3">
        <h3 class="text-base font-bold text-gray-800 flex items-center gap-2">
            <span class="bg-blue-100 text-blue-600 w-8 h-8 flex items-center justify-center rounded-full text-lg">üïí</span>
            Linha do Tempo
        </h3>
        <span class="text-xs font-medium text-gray-500 bg-gray-100 px-2 py-1 rounded-full">
            Sequ√™ncia do Dia
        </span>
    </div>

    <div class="grid grid-cols-2 gap-3 mb-4">
        <button onclick="adicionarLinhaManual()" 
            class="flex flex-col items-center justify-center p-3 bg-white border-2 border-dashed border-gray-300 rounded-xl hover:border-orange-400 hover:bg-orange-50 transition-all group shadow-sm">
            <span class="text-2xl mb-1 group-hover:scale-110 transition-transform">‚òï</span>
            <span class="text-xs font-bold text-gray-600 group-hover:text-orange-600">Atividades (H..)</span>
            <span class="text-[10px] text-gray-400">Refei√ß√£o, Organiza√ß√£o, Outros...</span>
        </button>

        <button onclick="abrirPopupImportarServico()" 
            class="flex flex-col items-center justify-center p-3 bg-blue-50 border-2 border-blue-100 rounded-xl hover:bg-blue-100 hover:border-blue-300 transition-all group shadow-sm">
            <span class="text-2xl mb-1 group-hover:scale-110 transition-transform">üîß</span>
            <span class="text-xs font-bold text-blue-700">Importar Servi√ßo</span>
            <span class="text-[10px] text-blue-400"> N√£o esque√ßa de adicionar as o.s...</span>
        </button>
    </div>

    <div id="listaLinhasApontamento" class="space-y-3 min-h-[100px]">
        <div class="text-center py-8 text-gray-400 text-sm italic">
            Nenhuma atividade registrada ainda.
        </div>
    </div>
</div>
         </div>        

<div class="pt-4 mt-4 border-t border-gray-200">
    <div class="grid grid-cols-3 gap-2">
        
        <button onclick="gerarPreviewApontamento()" 
            class="flex flex-col items-center justify-center py-3 px-1 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg shadow active:scale-95 transition-all">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mb-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                <path stroke-linecap="round" stroke-linejoin="round" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
            </svg>
            <span class="text-[10px] font-bold uppercase leading-tight">Atualizar</span>
        </button>

        <button onclick="baixarApontamento('jpg')" 
            class="flex flex-col items-center justify-center py-3 px-1 bg-green-600 hover:bg-green-700 text-white rounded-lg shadow active:scale-95 transition-all">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mb-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
            </svg>
            <span class="text-[10px] font-bold uppercase leading-tight">Salvar JPG</span>
        </button>

        <button onclick="baixarOuCompartilharPDF()" 
            class="flex flex-col items-center justify-center py-3 px-1 bg-red-600 hover:bg-red-700 text-white rounded-lg shadow active:scale-95 transition-all">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mb-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z" />
            </svg>
            <span class="text-[10px] font-bold uppercase leading-tight">PDF / Enviar</span>
        </button>
        
    </div>
</div>

        <div class="overflow-auto border border-gray-300 rounded mt-4 bg-gray-200 flex justify-center p-2">
            <canvas id="canvasApontamento" class="max-w-full h-auto shadow-lg bg-white"></canvas>
        </div>
    </div>
</section>



        <button id="fabAddFrotaCatalogo" onclick="abrirPopupTipoFrota()"
            class="fixed bottom-12 right-5 bg-blue-600 hover:bg-blue-700 text-white rounded-full w-14 h-14 flex items-center justify-center text-2xl shadow-lg z-50"
            style="display: none;" title="Adicionar Frota ao Cat√°logo">üöú</button>
        <button id="fabAddItemCatalogo" onclick="abrirPopupFormularioItemCatalogo()"
            class="fixed bottom-12 right-5 bg-purple-600 hover:bg-purple-700 text-white rounded-full w-14 h-14 flex items-center justify-center text-3xl shadow-lg z-50"
            style="display: none;" title="Adicionar Item ao Cat√°logo">+</button>
        <button id="fabCriarServico" onclick="adicionarServico()"
            class="fixed bottom-12 right-5 bg-green-500 hover:bg-green-600 text-white rounded-full w-14 h-14 flex items-center justify-center text-3xl shadow-lg z-50"
            style="display: none;" title="Adicionar Novo Servi√ßo">+</button>
        <button id="fabAddFrotaCatalogo" onclick="abrirPopupTipoFrota()"
            class="fixed bottom-12 right-5 bg-blue-600 hover:bg-blue-700 text-white rounded-full w-14 h-14 flex items-center justify-center text-2xl shadow-lg z-50"
            style="display: none;" title="Adicionar Frota ao Cat√°logo">üöú</button>
        <button id="fabAddItemCatalogo" onclick="abrirPopupFormularioItemCatalogo()"
            class="fixed bottom-12 right-5 bg-purple-600 hover:bg-purple-700 text-white rounded-full w-14 h-14 flex items-center justify-center text-3xl shadow-lg z-50"
            style="display: none;" title="Adicionar Item ao Cat√°logo">+</button>

        <button id="fabCadastroRapidoFrota" onclick="iniciarCadastroRapidoFrota()"
            class="fixed bottom-28 right-5 bg-blue-600 hover:bg-blue-700 text-white rounded-full w-14 h-14 flex items-center justify-center text-3xl shadow-lg z-50"
            style="display: flex;" title="Cadastrar Frota R√°pida">üöú</button>
        <button id="fabCriarServico" onclick="adicionarServico()"
            class="fixed bottom-12 right-5 bg-green-500 hover:bg-green-600 text-white rounded-full w-14 h-14 flex items-center justify-center text-3xl shadow-lg z-50"
            style="display: none;" title="Adicionar Novo Servi√ßo">+</button>
    </main>

    <div id="toast"></div>

    <div class="popup-overlay" id="overlayGenerico"></div>
    <div class="popup" id="popupGenerico">
        <h3 id="popupTitulo" class="text-xl font-semibold mb-3"></h3>
        <div id="popupMensagem" class="text-sm text-gray-600 mb-4"></div>
        <div class="flex justify-end space-x-2" id="popupBotoes"></div>
    </div>

    <div id="update-popup"
        class="hidden fixed bottom-5 left-1/2 transform -translate-x-1/2 bg-blue-600 text-white py-3 px-6 rounded-lg shadow-lg z-[10001] font-semibold">
        Nova vers√£o dispon√≠vel. <button onclick="window.location.reload()"
            class="ml-2 bg-white text-blue-600 py-1 px-3 rounded-md font-bold">Atualizar</button>
    </div>

    <template id="servico-template">
        <article class="bg-white rounded-lg shadow mb-4">
            <div class="servico-cabecalho">
                <div class="servico-cabecalho-info"></div><span class="servico-cabecalho-toggler"></span>
            </div>
            <div class="servico-detalhes" style="display:none;"></div>
        </article>
    </template>

    <script>
        'use strict';
        const SENHA_LIMPEZA_CATALOGO = 'mudar1234';
        document.addEventListener("DOMContentLoaded", main);

        // =================================================================================
        // 1. ESTADO GLOBAL E CONSTANTES
        // =================================================================================
        let equipe = [], frotasTurno = [], servicos = [], db, graficoOS = null, callbackPopup = null, debounceTimer;
        let catalogoFrotas = [];
        let catalogoLocal = [];

        const DB_NAME = 'meuturnoDB', DB_VERSION = 7;
        const STORE_TURNO = 'turno', STORE_HISTORICO = 'historicoOS', STORE_FROTAS = 'catalogoFrotas';
        const TURNO_ATUAL_ID = 'currentTurno';
        const atividades = ["P001 - AFERIDO", "P002 - AJUSTADO", "P003 - ALINHADO", "P004 - APERTADO", "P005 - BALANCEADO", "P006 - CALIBRADO", "P007 - COMPLETADO", "P008 - CONSERTADO COMPONENTE", "P009 - DESAMASSADO", "P010 - DESOBSTRUIDO", "P011 - EMBUCHADO", "P012 - FIXADO", "P013 - FURADO", "P014 - HIGIENIZADO", "P015 - INSPECIONADO", "P016 - INSTALADO", "P017 - ISOLADO", "P018 - LIMPO", "P019 - LUBRIFICADO", "P020 - MODIFICADO", "P021 - REAPERTADO", "P022 - RECARREGADO", "P023 - RECUPERADO", "P024 - REFORMADO", "P025 - REGULADO", "P026 - REMONTADO", "P027 - REPROGRAMADO", "P028 - RETIFICADO", "P029 - SOLDADO", "P030 - SUBSTITUIDO - TROCADO", "P031 - USINADO", "P032 - VEDADO", "H01 - Atraso de transporte", "H02 - DDS", "H03 - Refei√ß√£o", "H04 - Organiza√ß√£o/Limpeza", "H05 - Aguardando pe√ßa", "H06 - Aguardando Ferramenta", "H07 - Aguardando Servi√ßo", "H08 - Falta do colaborador", "H09 - Reuni√£o", "H10 - Ambulatorio", "H11 - Treinamento", "H12 - Outros", "H13 - Deslocamento a terceiros", "H14 - Carregamento de pneus pra conserto", "H15 - Inventario", "H16 - Apoio a Opera√ß√£o"];
        const sistemas = { "Tratores": [{ cod: "1", nome: "Estrutura" }, { cod: "2", nome: "Cabine" }, { cod: "3", nome: "Motor Combustao" }, { cod: "4", nome: "Eletrico" }, { cod: "5", nome: "Trem de Forca" }, { cod: "6", nome: "Tracao" }, { cod: "7", nome: "Hidraulico" }, { cod: "8", nome: "Direcao" }, { cod: "9", nome: "Freio" }], "Implementos": [{ cod: "10", nome: "Estrutura" }, { cod: "11", nome: "Tracao" }, { cod: "12", nome: "Adubo" }, { cod: "13", nome: "Hidraulico" }, { cod: "14", nome: "Eletrico" }, { cod: "15", nome: "V-SHEAR" }] };
        const subsistemas = { "1": ["1.1 - Chassi", "1.2 - Protecao", "1.3 - Escapamento", "1.4 - Suportes", "1.5 - Escada", "1.6 - Fixacao", "1.7 - Paralama", "1.8 - Tanque", "1.9 - Eixo", "1.10 - Chaparia", "1.11 - Alavanca"], "2": ["2.1 - Refrigecao", "2.2 - Banco", "2.3 - Vidros", "2.4 - Painel", "2.5 - Portas", "2.6 - Hodometro", "2.7 - Radio", "2.8 - Tacografo", "2.9 - Cinto de Seguranca", "2.10 - Cabine", "2.11 - Capo", "2.12 - Buzina"], "3": ["3.1 - Radiador", "3.2 - Motor", "3.3 - Intercooler", "3.4 - Arla", "3.5 - Filtro", "3.6 - Ignicao"], "4": ["4.1 - Iluminacao", "4.2 - Eletrica", "4.3 - Bateria", "4.4 - Chicote", "4.5 - Rastreador", "4.6 - Alternador", "4.7 - Encoder", "4.8 - Camera", "4.9 - Modulo", "4.10 - Comutador", "4.11 - Fluxometro", "4.12 - GPS"], "5": ["5.1 - Cubo", "5.2 - Embreagem", "5.3 - Cambio", "5.4 - Diferencial", "5.5 - Transmissao"], "6": ["6.1 - Pneu", "6.2 - Roda", "6.3 - Esteira", "6.4 - Roda Motriz", "6.5 - Roda Estrelada"], "7": ["7.1 - Mangueiras", "7.2 - Valvulas", "7.3 - Atuador", "7.4 - Bombas", "7.5 - Cilindro", "7.6 - VCR"], "8": ["8.1 - Barra de direcao", "8.2 - Coluna Direcao", "8.3 - Volante"], "9": ["9.1 - Freio", "9.2 - Acumulador"], "10": ["10.1 - Disco de Corte", "10.2 - Cabecalho", "10.3 - Ferramenta Traseira", "10.4 - Limpa Trilho", "10.5 - Quadro", "10.6 - Escarificador", "10.7 - Fixacao", "10.8 - Tanque", "10.9 - Eixo", "10.10 - Braco"], "11": ["11.1 - Pneus", "11.2 - Roda", "11.3 - Mancal"], "12": ["12.1 - Caixa de Adubo"], "13": ["13.1 - Cilindro", "13.2 - Mangueira", "13.3 - Bloco", "13.4 - Valvula"], "14": ["14.1 - Sensores", "14.2 - Chicote"], "15": ["15.1 - Lamina", "15.2 - Ball"] };
        const firebaseConfig = { apiKey: "AIzaSyDYVPQ2XFdsg5ViKnE5tyzczTZEVsM2kok", authDomain: "meu-turno-app.firebaseapp.com", projectId: "meu-turno-app", storageBucket: "meu-turno-app.firebasestorage.app", messagingSenderId: "967200929614", appId: "1:967200929614:web:3acbf1049a10cdbf87501f" };
        const firebaseApp = firebase.initializeApp(firebaseConfig);
        const firestore = firebase.firestore();
        firestore.enablePersistence().catch((err) => { console.warn('Falha na persist√™ncia do Firestore:', err.code); });

        // =================================================================================
        // 2. INICIALIZA√á√ÉO E L√ìGICA DO PWA
        // =================================================================================
        async function main() {
    try {
        registrarServiceWorker();
        await initDB();
        
        // 1. Inicia todas as sincroniza√ß√µes do Firebase (Nuvem)
        iniciarSincronizacaoAuxiliares();
        iniciarSincronizacaoEquipe();
        
       // <--- MELHOR LUGAR (Logo ap√≥s o banco abrir)

        // 2. Carrega dados do turno (Local)
        await carregarDadosIniciais();
        
        // 3. Desenha a tela (j√° com as listas carregando ou carregadas)
        renderizarLayoutInicial();
        
        inicializarMenuHamburguer();

        // 4. Navega√ß√£o
        const secaoInicial = localStorage.getItem('secaoAtiva') || 'turno';
        abrir(secaoInicial);
        
    } catch (err) { 
        console.error("Erro fatal ao inicializar:", err); 
        showToast("Erro grave ao iniciar. Tente recarregar.", 'error'); 
    }
}


        function registrarServiceWorker() { if ('serviceWorker' in navigator) { navigator.serviceWorker.register('./service-worker.js').then(reg => { reg.onupdatefound = () => { const newWorker = reg.installing; newWorker.onstatechange = () => { if (newWorker.state === 'installed' && navigator.serviceWorker.controller) { document.getElementById('update-popup')?.classList.remove('hidden'); } }; }; }).catch(err => console.error('Erro no SW:', err)); } }

        // =================================================================================
        // 3. CAMADA DE ABSTRA√á√ÉO DO BANCO DE DADOS (INDEXEDDB)
        // =================================================================================
       const STORE_FAZENDAS = 'lista_fazendas';
const STORE_FRENTES = 'lista_frentes';
const STORE_EQUIPE = 'lista_equipe';

function initDB() {
    return new Promise((resolve, reject) => {
        if (db) return resolve(db);
        
        // INCREMENTEI A VERS√ÉO PARA 10
        const request = indexedDB.open(DB_NAME, 10); 
        
        request.onupgradeneeded = e => {
            const currentDb = e.target.result;
            
            // Stores Antigas (Mantidas)
            if (!currentDb.objectStoreNames.contains(STORE_TURNO)) currentDb.createObjectStore(STORE_TURNO, { keyPath: 'id' });
            if (!currentDb.objectStoreNames.contains(STORE_HISTORICO)) { 
                const hStore = currentDb.createObjectStore(STORE_HISTORICO, { keyPath: 'uniqueId', autoIncrement: true }); 
                hStore.createIndex('dataKeyIndex', 'dataKey', { unique: false }); 
            }
            if (!currentDb.objectStoreNames.contains('catalogo')) currentDb.createObjectStore('catalogo', { keyPath: 'docId' });
            if (!currentDb.objectStoreNames.contains(STORE_FROTAS)) currentDb.createObjectStore(STORE_FROTAS, { keyPath: 'docId' });
            if (!currentDb.objectStoreNames.contains(STORE_FAZENDAS)) currentDb.createObjectStore(STORE_FAZENDAS, { keyPath: 'docId' });
            if (!currentDb.objectStoreNames.contains(STORE_FRENTES)) currentDb.createObjectStore(STORE_FRENTES, { keyPath: 'docId' });

            // --- NOVA STORE EQUIPE ---
            if (!currentDb.objectStoreNames.contains(STORE_EQUIPE)) {
                currentDb.createObjectStore(STORE_EQUIPE, { keyPath: 'docId' });
            }
        };
        request.onsuccess = e => { db = e.target.result; resolve(db); };
        request.onerror = e => { console.error("Erro DB:", e); reject(e); };
    });
}

        async function dbExec(storeName, mode, operation) { try { await initDB(); return new Promise((resolve, reject) => { const t = db.transaction([storeName], mode); const s = t.objectStore(storeName); const r = operation(s); r.onsuccess = e => resolve(e.target.result); r.onerror = e => { reject(e.target.error); }; }); } catch (err) { showToast(`Erro no banco de dados.`, 'error'); throw err; } }

        // =================================================================================
        // 4. GEST√ÉO DE DADOS GLOBAIS
        // =================================================================================
        async function carregarDadosIniciais() {
            try {
                catalogoFrotas = await dbExec(STORE_FROTAS, 'readonly', s => s.getAll());
                catalogoLocal = await dbExec('catalogo', 'readonly', s => s.getAll());
                const dados = await dbExec(STORE_TURNO, 'readonly', s => s.get(TURNO_ATUAL_ID));
                const dataHoje = dataHojeInputLocal();
                if (dados) {
                    if (dados.data && dados.data !== dataHoje) {
                        const confirmado = await new Promise(resolve => abrirPopupConfirmar('Iniciar Novo Turno?', `Dados de ${formatarDataParaExibicao(dados.data)} encontrados. Deseja iniciar um novo turno para hoje? <br><br><strong>A equipe e as frotas do turno anterior ser√£o mantidas.</strong>`, resolve));
                        if (confirmado) {
                            equipe = dados.equipe || []; frotasTurno = dados.frotas || []; servicos = [];
                            await salvarTudo(true);
                            showToast("Novo turno iniciado!", 'success');
                        } else { carregarEstado(dados); }
                    } else { carregarEstado(dados); }
                } else { inicializarEstadoVazio(); }
            } catch (err) { showToast('Erro ao carregar dados iniciais.', 'error'); inicializarEstadoVazio(); }
        }
        function carregarEstado(dados) { equipe = dados.equipe || []; frotasTurno = dados.frotas || []; servicos = dados.servicos || []; frotasTurno.forEach(f => f.tipo = f.tipo || 'maquina'); servicos.forEach(s => { s.isExpanded = s.isExpanded || false; s.foiCompartilhado = s.foiCompartilhado || false; s.pecasUtilizadas = s.pecasUtilizadas || []; }); }
        function inicializarEstadoVazio() { equipe = []; frotasTurno = []; servicos = []; }
        function salvarTudo(forcar = false) { clearTimeout(debounceTimer); const executar = async () => { try { const relatorioBruto = document.getElementById("relatorio_bruto")?.value || ''; const snapshotServicos = document.getElementById("relatorio_snapshot")?.value || '[]'; const dados = { id: TURNO_ATUAL_ID, data: document.getElementById("dataTurno")?.value, fazenda: document.getElementById("fazenda")?.value.trim(), frente: document.getElementById("frente")?.value.trim(), turno: document.getElementById("turnoLetra")?.value, equipe: equipe, frotas: frotasTurno, servicos: servicos, relatorio: relatorioBruto, relatorioGeradoComServicos: snapshotServicos }; await dbExec(STORE_TURNO, 'readwrite', s => s.put(dados)); } catch (err) { showToast('Erro ao salvar os dados.', 'error'); } }; if (forcar) executar(); else debounceTimer = setTimeout(executar, 1000); }
        function salvarDadosParciaisTurno() { validarCamposTurnoBasicos(); salvarTudo(); }

        // =================================================================================
        // 5. RENDERIZA√á√ÉO E UI
        // =================================================================================
        async function renderizarLayoutInicial() { 
    try { 
        // 1. Carrega as listas do cache local primeiro (Offline-first)
        // Isso garante que o <select> tenha op√ß√µes antes de tentar selecionar o valor
        await carregarFazendasDoCache();
        await carregarFrentesDoCache();

        // 2. Carrega os dados salvos do turno atual
        const d = await dbExec(STORE_TURNO, 'readonly', s => s.get(TURNO_ATUAL_ID)) || {}; 
        
        document.getElementById("dataTurno").value = d.data || dataHojeInputLocal(); 
        
        // 3. Define os valores nos selects de FAZENDA
        if (d.fazenda) {
            const el = document.getElementById("fazenda");
            el.value = d.fazenda;
            
            // L√≥gica de Seguran√ßa:
            // Se o valor salvo (ex: "FAZENDA X") n√£o estiver na lista carregada,
            // guardamos ele num atributo escondido. A fun√ß√£o 'atualizarSelectGenerico'
            // vai ler isso depois e criar a op√ß√£o visualmente para n√£o perder o dado.
            if (!el.value) {
                el.setAttribute('data-temp-value', d.fazenda);
            }
        }

        // 4. Define os valores nos selects de FRENTE
        if (d.frente) {
            const el = document.getElementById("frente");
            el.value = d.frente;
            if (!el.value) {
                el.setAttribute('data-temp-value', d.frente);
            }
        }

        document.getElementById("turnoLetra").value = d.turno || "A"; 
    } catch (e) { 
        console.error("Erro render inicial", e); 
    } 
}

        // SUBSTITUI√á√ÉO: Esta √© a fun√ß√£o 'abrir' modificada para persist√™ncia de tela
        function abrir(secaoId) {
            // Esconde todas as sec√ß√µes
            document.querySelectorAll('main section').forEach(s => s.classList.add('hidden'));

            // Mostra a sec√ß√£o ativa e chama a sua fun√ß√£o de renderiza√ß√£o
            const secaoAtiva = document.getElementById(secaoId);
            if (secaoAtiva) {
                secaoAtiva.classList.remove('hidden');
                
                  // --- L√ìGICA INTELIGENTE DE ECONOMIA ---
        if (secaoId === 'catalogo') {
            // S√≥ baixa o cat√°logo se o usu√°rio entrar nesta tela!
            sincronizarCatalogoPecas();
            renderizarCatalogo(); // Renderiza o que j√° tem no cache local enquanto baixa
        }
        
        // --- NOVA L√ìGICA DE ECONOMIA DE FROTAS ---
    if (secaoId === 'frotas') {
        sincronizarCatalogoFrotas(); 
        renderizarCatalogoFrotas();
    }
        // --------------------------------------
                
                const renderFunc = window[`renderizarSecao${secaoId.charAt(0).toUpperCase() + secaoId.slice(1)}`];
                if (typeof renderFunc === 'function') {
                    renderFunc(secaoAtiva);
                }
            }

            // NOVO: Salva a se√ß√£o ativa no LocalStorage
            localStorage.setItem('secaoAtiva', secaoId);

            // Atualiza o t√≠tulo do cabe√ßalho
            document.getElementById('header-titulo').textContent = secaoId === 'catalogo' ? 'Cat√°logo de Pe√ßas' : secaoId.charAt(0).toUpperCase() + secaoId.slice(1);

            // Pega a refer√™ncia de todos os bot√µes flutuantes
            const fabCriarServico = document.getElementById('fabCriarServico');
            const fabAddItemCatalogo = document.getElementById('fabAddItemCatalogo');
            const fabAddFrotaCatalogo = document.getElementById('fabAddFrotaCatalogo');
            const fabCadastroRapidoFrota = document.getElementById('fabCadastroRapidoFrota');

            // Esconde todos eles por padr√£o
            if (fabCriarServico) fabCriarServico.style.display = 'none';
            if (fabAddItemCatalogo) fabAddItemCatalogo.style.display = 'none';
            if (fabAddFrotaCatalogo) fabAddFrotaCatalogo.style.display = 'none';
            if (fabCadastroRapidoFrota) fabCadastroRapidoFrota.style.display = 'none';

            // Mostra os bot√µes corretos para a sec√ß√£o atual
            if (secaoId === 'servicos') {
                if (fabCriarServico) fabCriarServico.style.display = 'flex';
                if (fabCadastroRapidoFrota) fabCadastroRapidoFrota.style.display = 'flex';
            } else if (secaoId === 'catalogo') {
                if (fabAddItemCatalogo) fabAddItemCatalogo.style.display = 'flex';
            } else if (secaoId === 'frotas') {
                if (fabAddFrotaCatalogo) fabAddFrotaCatalogo.style.display = 'flex';
            }
        }
        function inicializarMenuHamburguer() { const btn = document.getElementById('hamburger-btn'); const overlay = document.getElementById('menu-overlay'); const links = document.querySelectorAll('#menu-lateral a'); const fecharMenu = () => document.body.classList.remove('menu-open'); btn.addEventListener('click', e => { e.stopPropagation(); document.body.classList.toggle('menu-open'); }); overlay.addEventListener('click', fecharMenu); links.forEach(link => link.addEventListener('click', e => { e.preventDefault(); abrir(link.getAttribute('data-secao')); fecharMenu(); })); }
        let toastTimer; function showToast(msg, type = 'info', duration = 2000) { const t = document.getElementById("toast"); if (!t) return; clearTimeout(toastTimer); t.textContent = msg; t.className = ''; t.classList.add(type); requestAnimationFrame(() => { t.classList.add('show'); }); toastTimer = setTimeout(() => { t.classList.remove('show'); }, duration); }
        function abrirPopup(titulo, mensagem, botoes = []) { document.getElementById('popupTitulo').innerHTML = titulo; document.getElementById('popupMensagem').innerHTML = mensagem; const divBotoes = document.getElementById('popupBotoes'); divBotoes.innerHTML = ''; if (botoes.length === 0) botoes.push({ texto: 'Fechar', classe: 'bg-gray-300 text-gray-800 hover:bg-gray-400', acao: fecharPopup }); botoes.forEach(b => { const btn = document.createElement('button'); btn.className = `py-2 px-4 rounded-md font-semibold transition-colors duration-150 ${b.classe}`; btn.innerHTML = b.texto; btn.onclick = () => { fecharPopup(); if (b.acao) b.acao(); }; divBotoes.appendChild(btn); }); document.getElementById('popupGenerico').style.display = 'block'; document.getElementById('overlayGenerico').style.display = 'block'; }
        function fecharPopup() { document.getElementById('popupGenerico').style.display = 'none'; document.getElementById('overlayGenerico').style.display = 'none'; }
        function abrirPopupConfirmar(titulo, mensagem, callback, acaoConfirmar = 'Confirmar') { abrirPopup(titulo, mensagem, [{ texto: acaoConfirmar, classe: 'bg-blue-600 text-white hover:bg-blue-700', acao: () => callback(true) }, { texto: 'Cancelar', classe: 'bg-gray-300 text-gray-800 hover:bg-gray-400', acao: () => callback(false) }]); }
        function abrirPopupInput(titulo, label, placeholder, valorInicial, callback, tipoInput = 'text') { const conteudoPopup = `<label for="popup-input-field" class="block text-sm font-medium text-gray-700 mb-1">${label}</label><input type="${tipoInput}" id="popup-input-field" class="w-full p-2 border border-gray-300 rounded-md" placeholder="${placeholder}" value="${valorInicial}">`; const botoes = [{ texto: 'Confirmar', classe: 'bg-blue-600 text-white hover:bg-blue-700', acao: () => callback(document.getElementById('popup-input-field').value) }, { texto: 'Cancelar', classe: 'bg-gray-300 text-gray-800 hover:bg-gray-400', acao: () => callback(null) }]; abrirPopup(titulo, `<div id="popup-content-wrapper">${conteudoPopup}</div>`, botoes); setTimeout(() => document.getElementById('popup-input-field')?.focus(), 50); }
        function abrirPopupLoading(mensagem) { const conteudoPopup = `<div class="flex flex-col items-center justify-center py-4"><div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mb-4"></div><p class="text-gray-700 text-center">${mensagem}</p></div>`; abrirPopup("A Processar...", conteudoPopup, []); }
        function validarCamposTurnoBasicos() { const campos = ['dataTurno', 'fazenda', 'frente']; let todosValidos = true; campos.forEach(id => { const el = document.getElementById(id); if (!el?.value.trim()) { el?.classList.add('campo-invalido'); todosValidos = false; } else { el?.classList.remove('campo-invalido'); } }); if (!todosValidos) showToast("Preencha os campos obrigat√≥rios do turno!", 'error'); return todosValidos; }
        function dataHojeInputLocal() { return new Date().toLocaleDateString('en-CA'); }
        function formatarDataParaExibicao(dataStr) { if (!dataStr || !/^\d{4}-\d{2}-\d{2}$/.test(dataStr)) return "Sem Data"; const [ano, mes, dia] = dataStr.split('-'); return `${dia}/${mes}/${ano}`; }
        function interpretarMarkdown(texto) { if (!texto) return ""; return texto.replace(/\*(.*?)\*/g, '<strong>$1</strong>').replace(/\n/g, '<br>'); }
        function minimizarServico(id) { const servico = servicos.find(s => s.id === id); if (servico && servico.isExpanded) { toggleDetalhesServico(id); } }
                function gerarTextoCabecalhoServico(servico) {
            const frota = servico.frota || "N/D";
            const codAtividade = (servico.atividade || "P000").split(" - ")[0];
            const codSistema = servico.sistema || "0";
            const codSubsistema = (servico.subsistema || "0.0").split(" - ")[0];
            const horaInicio = servico.inicio || "--:--";
            const horaFim = servico.fim || "--:--";
            const infoServico = `${codAtividade} - ${codSistema} - ${codSubsistema} [${horaInicio} - ${horaFim}]`;

            // --- IN√çCIO DA MODIFICA√á√ÉO ---

            // 1. Criamos uma vari√°vel para guardar o texto do tipo de manuten√ß√£o.
            let tipoSpan = '';

            // 2. Verificamos o tipo do servi√ßo e definimos o HTML correspondente.
            if (servico.tipo === 'CORRETIVA') {
                // Se for 'CORRETIVA', criamos um span com texto vermelho escuro, negrito e it√°lico.
                tipoSpan = ` <span class="font-bold italic text-red-700">Corretiva</span>`;
            } else if (servico.tipo === 'CONDICIONAL') {
                // Se for 'CONDICIONAL', criamos um span com texto azul, negrito e it√°lico.
                tipoSpan = ` <span class="font-bold italic text-blue-600">Condicional</span>`;
            } else if (servico.tipo === 'MELHORIA') {
                // Se for 'MELHORIA', criamos um span com texto amarelo, negrito e it√°lico.
                tipoSpan = ` <span class="font-bold italic text-yellow-600">Melhoria</span>`;
            }

            // 3. Juntamos o texto original com o nosso novo span.
            return `<strong>Frota:</strong> <span class="frota-destaque">${frota}</span> <span class="atividade-info">| ${infoServico}</span>${tipoSpan}`;
            
            // --- FIM DA MODIFICA√á√ÉO ---
        }
        
        // NOVO: Fun√ß√£o auxiliar para validar o tempo de um servi√ßo
        function validarTempoServico(servico) {
            if (!servico.inicio || !servico.fim) return true; // Se um dos campos estiver vazio, √© v√°lido temporariamente.

            try {
                // Junta data e hora para criar objetos Date, garantindo a compara√ß√£o correta.
                const inicioStr = `${servico.data}T${servico.inicio}`;
                const fimStr = `${servico.dataFinal}T${servico.fim}`;
                
                const dataInicio = new Date(inicioStr);
                const dataFim = new Date(fimStr);

                // Retorna falso se a hora final for anterior ou igual √† inicial
                return dataFim.getTime() > dataInicio.getTime();
            } catch (e) {
                console.error("Erro na valida√ß√£o de tempo:", e);
                return true; // Assume v√°lido em caso de erro de parse.
            }
        }


        function formatarDescricao(texto) { if (!texto) return 'Nenhuma descri√ß√£o fornecida.'; return texto.trim().split('\n').map(linha => `- ${linha.trim()}`).join('\n'); }
        function getTipoTexto(tipo) { switch (tipo) { case 'maquina': return 'M√°quina Principal'; case 'implemento': return 'Implemento'; case 'caminhao': return 'Caminh√£o'; default: return 'N/D'; } }
        function getTipoCor(tipo) { switch (tipo) { case 'maquina': return 'text-blue-600'; case 'implemento': return 'text-gray-500'; case 'caminhao': return 'text-green-600'; default: return 'text-gray-400'; } }
        function removerAcentos(texto) {
            if (!texto) return "";
            return texto.normalize("NFD").replace(/[\u0300-\u036f]/g, "");
        }

        // =================================================================================
        // 6. L√ìGICA POR M√ìDULO (SE√á√ÉO)
        // =================================================================================
        // ---------------------------------
        // M√ìDULO: TURNO (TELA INICIAL)
        // ---------------------------------
        function renderizarSecaoTurno(container) { renderizarEquipe(); renderizarFrotasDoTurno(); }
        function adicionarEquipe() { if (!validarCamposTurnoBasicos()) return; const nomeEl = document.getElementById('nomeEquipe'); const matEl = document.getElementById('matriculaEquipe'); if (nomeEl.value.trim() && matEl.value.trim()) { equipe.push({ nome: nomeEl.value.trim(), matricula: matEl.value.trim() }); renderizarEquipe(); salvarTudo(); nomeEl.value = matEl.value = ''; nomeEl.focus(); showToast('Membro adicionado!', 'success'); } else { showToast('Preencha nome e matr√≠cula.', 'error'); } }
        function removerEquipe(index) { equipe.splice(index, 1); renderizarEquipe(); salvarTudo(); showToast('Membro removido.', 'success'); }
        function renderizarEquipe() { const box = document.getElementById('boxEquipe'); if (!box) return; if (equipe.length === 0) { box.innerHTML = '<p class="text-sm text-gray-500">Nenhum membro na equipe.</p>'; return; } box.innerHTML = equipe.map((item, i) => `<div class="flex justify-between items-center p-2 border-b text-sm"><span><strong>${item.nome}</strong> - ${item.matricula}</span><button onclick="removerEquipe(${i})" class="text-red-500 hover:text-red-700 text-xl font-bold px-2" title="Remover membro">&times;</button></div>`).join(''); }
        function renderizarFrotasDoTurno() { const div = document.getElementById('listaFrotas'); if (!div) return; if (frotasTurno.length === 0) { div.innerHTML = '<p class="text-sm text-gray-500">Nenhuma frota adicionada a este turno.</p>'; return; } frotasTurno.sort((a, b) => a.nome.localeCompare(b.nome)); div.innerHTML = frotasTurno.map((f, i) => `<div class="flex justify-between items-center p-2 border-b text-sm"><span><strong class="font-semibold">${f.nome}</strong> <span class="text-xs font-semibold ${getTipoCor(f.tipo)}">${getTipoTexto(f.tipo)}</span> - <input type="number" step="0.1" value="${f.horas}" onchange="atualizarHorasFrotaTurno(${i}, this.value)" class="w-20 p-1 border rounded">h</span><button onclick="removerFrotaDoTurno(${i})" class="text-red-500 hover:text-red-700 text-xl font-bold px-2" title="Remover frota do turno">&times;</button></div>`).join(''); }
        async function removerFrotaDoTurno(index) { const confirmado = await new Promise(resolve => abrirPopupConfirmar('Remover Frota do Turno', 'Tem certeza?', resolve)); if (confirmado) { frotasTurno.splice(index, 1); renderizarFrotasDoTurno(); salvarTudo(); showToast('Frota removida do turno.', 'success'); } }
        function atualizarHorasFrotaTurno(index, novasHoras) { const horas = parseFloat(novasHoras); if (!isNaN(horas) && horas > 0) { frotasTurno[index].horas = horas; salvarTudo(); showToast('Horas da frota atualizadas.', 'success'); } else { showToast('Valor de horas inv√°lido.', 'error'); renderizarFrotasDoTurno(); } }
        
// ============================================================
// GEST√ÉO DE FAZENDAS E FRENTES (Sincronizado)
// ============================================================

let listaFazendas = [];
let listaFrentes = [];

// 1. Inicia a escuta do Firebase (Chamar no main)
function iniciarSincronizacaoAuxiliares() {
    // Sincronizar FAZENDAS
    firestore.collection('lista_fazendas').orderBy('nome').onSnapshot(snapshot => {
        const tx = db.transaction(STORE_FAZENDAS, 'readwrite');
        const store = tx.objectStore(STORE_FAZENDAS);
        
        snapshot.docChanges().forEach(change => {
            const item = { ...change.doc.data(), docId: change.doc.id };
            if (change.type === 'added' || change.type === 'modified') store.put(item);
            if (change.type === 'removed') store.delete(item.docId);
        });

        tx.oncomplete = () => carregarFazendasDoCache();
    });

    // Sincronizar FRENTES
    firestore.collection('lista_frentes').orderBy('nome').onSnapshot(snapshot => {
        const tx = db.transaction(STORE_FRENTES, 'readwrite');
        const store = tx.objectStore(STORE_FRENTES);
        
        snapshot.docChanges().forEach(change => {
            const item = { ...change.doc.data(), docId: change.doc.id };
            if (change.type === 'added' || change.type === 'modified') store.put(item);
            if (change.type === 'removed') store.delete(item.docId);
        });

        tx.oncomplete = () => carregarFrentesDoCache();
    });
}

// 2. Carrega do IndexedDB para a Tela
async function carregarFazendasDoCache() {
    try {
        listaFazendas = await dbExec(STORE_FAZENDAS, 'readonly', s => s.getAll());
        atualizarSelectGenerico('fazenda', listaFazendas);
    } catch(e) { console.error(e); }
}

async function carregarFrentesDoCache() {
    try {
        listaFrentes = await dbExec(STORE_FRENTES, 'readonly', s => s.getAll());
        atualizarSelectGenerico('frente', listaFrentes);
    } catch(e) { console.error(e); }
}

// Fun√ß√£o auxiliar para preencher os selects
function atualizarSelectGenerico(elementId, dados) {
    const select = document.getElementById(elementId);
    if (!select) return;

    // Tenta preservar o valor que j√° estava selecionado ou salvo
    const valorAtual = select.value || select.getAttribute('data-temp-value');

    select.innerHTML = '<option value="">Selecione...</option>';
    
    // Ordena√ß√£o alfab√©tica
    dados.sort((a, b) => a.nome.localeCompare(b.nome));

    dados.forEach(item => {
        const option = document.createElement('option');
        option.value = item.nome;
        option.textContent = item.nome;
        option.dataset.docId = item.docId; // ID do Firebase para exclus√£o
        select.appendChild(option);
    });

    // Restaura a sele√ß√£o
    if (valorAtual) {
        select.value = valorAtual;
        // Se o valor salvo n√£o existe na lista (foi apagado por outro usu√°rio), cria visualmente
        if (!select.value) {
            const opt = document.createElement('option');
            opt.value = valorAtual;
            opt.text = valorAtual + " (Arquivado)";
            opt.selected = true;
            select.appendChild(opt);
        }
    }
}

// 3. Fun√ß√µes de CRUD (Adicionar / Remover)

function adicionarNovaFazenda() {
    abrirPopupInput('Nova Fazenda', 'Nome:', 'Ex: FAZENDA SANTA MARIA', '', async (nome) => {
        if (!nome) return;
        const nomeUpper = nome.trim().toUpperCase();
        
        if (listaFazendas.some(f => f.nome === nomeUpper)) {
            showToast("Esta fazenda j√° existe.", "error");
            return;
        }

        try {
            await firestore.collection('lista_fazendas').add({ nome: nomeUpper });
            showToast("Fazenda adicionada!", "success");
            // For√ßa sele√ß√£o imediata
            setTimeout(() => {
                const el = document.getElementById('fazenda');
                el.value = nomeUpper;
                salvarDadosParciaisTurno();
            }, 500);
        } catch (e) { showToast("Erro ao salvar: " + e.message, "error"); }
    });
}

function removerFazendaSelecionada() {
    const select = document.getElementById('fazenda');
    const nome = select.value;
    const option = select.options[select.selectedIndex];
    const docId = option.dataset.docId;

    if (!nome || !docId) {
        showToast("Selecione uma fazenda da lista para remover.", "error");
        return;
    }

    abrirPopupConfirmar("Apagar Fazenda", `Deseja remover <b>${nome}</b>? <br>Isso afetar√° todos os usu√°rios.`, async (ok) => {
        if (ok) {
            try {
                await firestore.collection('lista_fazendas').doc(docId).delete();
                showToast("Fazenda removida.", "success");
                select.value = "";
                salvarDadosParciaisTurno();
            } catch (e) { showToast("Erro ao remover.", "error"); }
        }
    });
}

function adicionarNovaFrente() {
    abrirPopupInput('Nova Frente', 'Nome:', 'Ex: M√ìDULO 1', '', async (nome) => {
        if (!nome) return;
        const nomeUpper = nome.trim().toUpperCase();
        
        if (listaFrentes.some(f => f.nome === nomeUpper)) {
            showToast("Esta frente j√° existe.", "error");
            return;
        }

        try {
            await firestore.collection('lista_frentes').add({ nome: nomeUpper });
            showToast("Frente adicionada!", "success");
            setTimeout(() => {
                const el = document.getElementById('frente');
                el.value = nomeUpper;
                salvarDadosParciaisTurno();
            }, 500);
        } catch (e) { showToast("Erro ao salvar.", "error"); }
    });
}

function removerFrenteSelecionada() {
    const select = document.getElementById('frente');
    const nome = select.value;
    const option = select.options[select.selectedIndex];
    const docId = option.dataset.docId;

    if (!nome || !docId) {
        showToast("Selecione uma frente da lista para remover.", "error");
        return;
    }

    abrirPopupConfirmar("Apagar Frente", `Deseja remover <b>${nome}</b>?`, async (ok) => {
        if (ok) {
            try {
                await firestore.collection('lista_frentes').doc(docId).delete();
                showToast("Frente removida.", "success");
                select.value = "";
                salvarDadosParciaisTurno();
            } catch (e) { showToast("Erro ao remover.", "error"); }
        }
    });
}

// ============================================================
// GEST√ÉO DE EQUIPE (FIREBASE + LOCAL)
// ============================================================

let listaEquipeCache = [];

// 1. SINCRONIZA√á√ÉO (Firebase -> App)
// Chamar no main()
function iniciarSincronizacaoEquipe() {
    firestore.collection('lista_equipe').orderBy('nome').onSnapshot(snapshot => {
        const tx = db.transaction(STORE_EQUIPE, 'readwrite');
        const store = tx.objectStore(STORE_EQUIPE);
        
        listaEquipeCache = []; // Limpa RAM

        snapshot.docChanges().forEach(change => {
            const item = { ...change.doc.data(), docId: change.doc.id };
            if (change.type === 'added' || change.type === 'modified') store.put(item);
            if (change.type === 'removed') store.delete(item.docId);
        });

        // Atualiza cache em mem√≥ria
        tx.oncomplete = async () => {
            listaEquipeCache = await dbExec(STORE_EQUIPE, 'readonly', s => s.getAll());
            // Atualiza tamb√©m o select do apontamento se estiver aberto
            renderizarSecaoApontamento(); 
        };
    });
}

function abrirPopupSelecaoEquipe() {
    listaEquipeCache.sort((a, b) => a.nome.localeCompare(b.nome));

    const listaHTML = listaEquipeCache.map(colab => {
        const jaNoTurno = equipe.some(e => e.matricula === colab.matricula);
        const checked = jaNoTurno ? 'checked' : '';
        const style = jaNoTurno ? 'bg-blue-50 border-blue-200' : 'bg-white border-gray-200';
        
        return `
        <div class="flex items-center justify-between p-3 mb-2 border rounded-md ${style} hover:bg-gray-50 transition-colors">
            <label class="flex items-center flex-grow cursor-pointer gap-3">
                <input type="checkbox" class="w-6 h-6 text-blue-600 rounded focus:ring-blue-500 checkbox-equipe" 
                    value="${colab.matricula}" data-nome="${colab.nome}" ${checked}>
                <div class="flex flex-col">
                    <span class="font-bold text-gray-800 text-sm">${colab.nome}</span>
                    <span class="text-xs text-gray-500">Mat: ${colab.matricula}</span>
                </div>
            </label>
            <button onclick="removerColaboradorDoBanco('${colab.docId}', '${colab.nome}')" class="text-gray-300 hover:text-red-500 p-2 text-lg" title="Apagar do Banco">üóëÔ∏è</button>
        </div>`;
    }).join('');

    // --- CONTE√öDO CORRIGIDO COM ALTURA FIXA ---
    const conteudo = `
        <div class="space-y-3 mb-4">
            <button onclick="abrirPopupNovoColaborador()" class="w-full bg-green-600 hover:bg-green-700 text-white py-3 rounded-md font-bold text-sm shadow-sm flex items-center justify-center gap-2">
                <span>+</span> Novo Colaborador
            </button>
            <input type="text" id="filtroEquipe" oninput="filtrarListaEquipe()" placeholder="üîé Buscar nome..." class="w-full p-2 border rounded text-sm bg-gray-50">
        </div>

        <div id="listaCheckboxesEquipe" class="max-h-80 overflow-y-auto border border-gray-200 rounded p-2 space-y-1">
            ${listaHTML || '<p class="text-center text-gray-500 text-sm py-4">Nenhum colaborador cadastrado.</p>'}
        </div>
    `;

    abrirPopup('Gerir Equipe do Turno', conteudo, [
        { texto: 'Cancelar', classe: 'bg-gray-300 text-gray-800 hover:bg-gray-400 py-3 rounded-lg font-bold', acao: fecharPopup },
        { texto: 'Confirmar Sele√ß√£o', classe: 'bg-blue-600 text-white hover:bg-blue-700 py-3 rounded-lg font-bold shadow-lg', acao: confirmarSelecaoEquipe }
    ]);
}


// Filtro r√°pido no popup
function filtrarListaEquipe() {
    const termo = removerAcentos(document.getElementById('filtroEquipe').value.toLowerCase());
    const container = document.getElementById('listaCheckboxesEquipe');
    const items = container.querySelectorAll('div'); // Pega as divs das linhas

    items.forEach(div => {
        const nome = removerAcentos(div.querySelector('span.font-bold').innerText.toLowerCase());
        const mat = div.querySelector('span.text-xs').innerText.toLowerCase();
        
        if (nome.includes(termo) || mat.includes(termo)) {
            div.style.display = 'flex';
        } else {
            div.style.display = 'none';
        }
    });
}

// 3. A√á√ïES DE CADASTRO (GLOBAL) - VERS√ÉO VISUAL CORRIGIDA

// ============================================================
// CORRE√á√ÉO: MODAL DE NOVO COLABORADOR (COM Z-INDEX ALTO)
// ============================================================

// Fun√ß√£o auxiliar para fechar este modal e RESTAURAR o anterior
function fecharModalNovoColaborador(modalId) {
    const modal = document.getElementById(modalId);
    if (modal) modal.remove();
    
    // 3. REABRE O POPUP E A SOMBRA ANTERIORES
    document.getElementById('popupGenerico').style.display = 'block';
    document.getElementById('overlayGenerico').style.display = 'block';
}

function abrirPopupNovoColaborador() {
    // 1. ESCONDE O POPUP ANTERIOR COMPLETO (Conte√∫do + Sombra)
    document.getElementById('popupGenerico').style.display = 'none';
    document.getElementById('overlayGenerico').style.display = 'none'; // CRUCIAL para evitar conflitos de Z-Index/sombra

    const htmlForm = `
        <div class="space-y-4">
            <div>
                <label class="block text-sm font-bold text-gray-700 mb-1">Nome Completo *</label>
                <input type="text" id="newColabNome" 
                    class="w-full p-3 border border-gray-300 rounded-lg bg-gray-50 focus:ring-2 focus:ring-blue-500 focus:bg-white outline-none uppercase font-semibold text-gray-800 transition-colors" 
                    placeholder="DIGITE O NOME">
            </div>
            <div>
                <label class="block text-sm font-bold text-gray-700 mb-1">Matr√≠cula *</label>
                <input type="text" id="newColabMat" 
                    class="w-full p-3 border border-gray-300 rounded-lg bg-gray-50 focus:ring-2 focus:ring-blue-500 focus:bg-white outline-none font-semibold text-gray-800 transition-colors" 
                    placeholder="00000">
            </div>
        </div>
    `;

    const modalId = 'modal-novo-colab';
    
    // 2. CRIA O NOVO MODAL COM Z-INDEX MUITO ALTO (FOR√áADO)
    const modalHTML = `
    <div id="${modalId}" style="z-index: 99999;" class="fixed inset-0 bg-black bg-opacity-60 backdrop-blur-sm flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl p-5 w-full max-w-sm border border-gray-100 transform transition-all scale-100 relative">
            
            <div class="flex justify-between items-center mb-5 border-b pb-3">
                <h3 class="text-lg font-bold text-blue-800 flex items-center gap-2">
                    <span>üë§</span> Novo Colaborador
                </h3>
                <button onclick="fecharModalNovoColaborador('${modalId}')" class="text-gray-400 hover:text-red-500 text-3xl leading-none">&times;</button>
            </div>

            ${htmlForm}

            <div class="flex justify-end gap-3 mt-6">
                <button onclick="fecharModalNovoColaborador('${modalId}')" 
                    class="px-4 py-2.5 bg-gray-100 text-gray-700 rounded-lg font-bold hover:bg-gray-200 transition-colors border border-gray-300">
                    Voltar
                </button>
                <button onclick="salvarNovoColaborador()" 
                    class="px-4 py-2.5 bg-green-600 text-white rounded-lg font-bold hover:bg-green-700 shadow-md transition-transform active:scale-95 flex items-center gap-2">
                    <span>üíæ</span> Salvar
                </button>
            </div>
        </div>
    </div>`;
    
    document.body.insertAdjacentHTML('beforeend', modalHTML);
    
    setTimeout(() => document.getElementById('newColabNome').focus(), 100);
}


async function salvarNovoColaborador() {
    const nome = document.getElementById('newColabNome').value.trim().toUpperCase();
    const matricula = document.getElementById('newColabMat').value.trim();

    // 1. Valida√ß√£o de Campos Vazios
    if (!nome || !matricula) {
        showToast("Preencha nome e matr√≠cula.", "error");
        return;
    }

    // 2. TRAVA DE DUPLICIDADE (A L√≥gica Nova)
    // Verifica se algum colaborador na lista cache j√° tem essa matr√≠cula
    const jaExiste = listaEquipeCache.some(colab => colab.matricula === matricula);

    if (jaExiste) {
        // Encontra o nome de quem j√° tem essa matr√≠cula para avisar
        const dono = listaEquipeCache.find(c => c.matricula === matricula).nome;
        showToast(`Erro: Matr√≠cula j√° usada por ${dono}.`, "error");
        
        // D√° um foco e efeito visual no campo de matr√≠cula para alertar
        const inputMat = document.getElementById('newColabMat');
        inputMat.classList.add('campo-invalido');
        inputMat.focus();
        setTimeout(() => inputMat.classList.remove('campo-invalido'), 2000);
        
        return; // P√°ra a execu√ß√£o aqui. N√£o salva no banco.
    }

    // 3. Salvar no Firebase (Se passou pela trava)
    try {
        await firestore.collection('lista_equipe').add({ nome, matricula });
        
        // Fecha modal
        fecharModalNovoColaborador('modal-novo-colab');
        
        showToast("Colaborador cadastrado!", "success");
        
        // N√£o precisa recarregar lista manualmente, o onSnapshot faz isso.
        // Apenas garantimos que o popup de sele√ß√£o esteja vis√≠vel.
        setTimeout(() => {
            document.getElementById('popupGenerico').style.display = 'block';
        }, 300);

    } catch (e) {
        showToast("Erro ao salvar: " + e.message, "error");
    }
}


function removerColaboradorDoBanco(docId, nome) {
    if(confirm(`Tem certeza que deseja apagar ${nome} do BANCO DE DADOS? Isso sumir√° para todos.`)) {
        firestore.collection('lista_equipe').doc(docId).delete();
        // Atualiza a lista visualmente
        setTimeout(abrirPopupSelecaoEquipe, 500);
    }
}

// 4. CONFIRMAR SELE√á√ÉO (ATUALIZA O TURNO)
function confirmarSelecaoEquipe() {
    const checkboxes = document.querySelectorAll('.checkbox-equipe:checked');
    
    // Limpa a equipe atual e reconstr√≥i baseada na sele√ß√£o
    equipe = [];
    
    checkboxes.forEach(cb => {
        equipe.push({
            nome: cb.getAttribute('data-nome'),
            matricula: cb.value
        });
    });

    renderizarEquipe(); // Atualiza a tela principal
    salvarTudo(); // Salva no turno
    fecharPopup();
    showToast("Equipe do turno atualizada!", "success");
}


        // ---------------------------------
        // M√ìDULO: CAT√ÅLOGO DE FROTAS (ONLINE)
        // ---------------------------------
        function renderizarSecaoFrotas(container) { container.innerHTML = `<div class="bg-white p-4 rounded-lg shadow"><h2 class="text-xl font-bold text-blue-800 mb-4">Cat√°logo de Frotas</h2><input type="text" id="buscaFrota" oninput="renderizarCatalogoFrotas()" placeholder="üîé Buscar por c√≥digo..." class="w-full p-3 border border-gray-300 rounded-lg mb-4"><div id="listaCatalogoFrotas" class="space-y-2"></div></div>`; renderizarCatalogoFrotas(); }
        // MODIFICADO: Aplica 'removerAcentos' na busca
        function renderizarCatalogoFrotas() {
            const listaDiv = document.getElementById('listaCatalogoFrotas');
            if (!listaDiv) return;

            // MODIFICADO: Aplica removerAcentos na busca
            const termoBusca = removerAcentos(document.getElementById('buscaFrota').value.toLowerCase());

            const frotasFiltradas = catalogoFrotas.filter(f => removerAcentos(f.nome.toLowerCase()).includes(termoBusca)); 
            
            if (frotasFiltradas.length === 0) { listaDiv.innerHTML = `<p class="text-center text-gray-500 py-4">Nenhuma frota encontrada no cat√°logo.</p>`; return; } frotasFiltradas.sort((a, b) => a.nome.localeCompare(b.nome)); listaDiv.innerHTML = frotasFiltradas.map(f => `<div class="border rounded-lg p-3 flex justify-between items-center"><div><p class="font-bold text-gray-800">${f.nome}</p><p class="text-sm font-semibold ${getTipoCor(f.tipo)}">${getTipoTexto(f.tipo)}</p></div><button onclick="removerFrotaCatalogo('${f.docId}')" class="p-2 text-red-600 hover:bg-red-100 rounded-full" title="Excluir do Cat√°logo">üóëÔ∏è</button></div>`).join('');
        }
        function abrirPopupTipoFrota(contexto = 'catalogo') {
            const conteudo = `<p class="mb-4">Selecione o tipo de frota para adicionar:</p>
        <div class="grid grid-cols-1 gap-3">
            <button onclick="abrirPopupAdicionarFrotaCatalogo('maquina', '${contexto}')" class="w-full text-left p-3 bg-blue-100 hover:bg-blue-200 rounded-md"><strong>M√°quina Principal</strong><p class="text-xs">Ex: Tratores...</p></button>
            <button onclick="abrirPopupAdicionarFrotaCatalogo('implemento', '${contexto}')" class="w-full text-left p-3 bg-gray-100 hover:bg-gray-200 rounded-md"><strong>Implemento</strong><p class="text-xs">Ex: Subsoladores...</p></button>
            <button onclick="abrirPopupAdicionarFrotaCatalogo('caminhao', '${contexto}')" class="w-full text-left p-3 bg-green-100 hover:bg-green-200 rounded-md"><strong>Caminh√£o</strong><p class="text-xs">Ex: Caminh√µes de apoio...</p></button>
        </div>`;
            abrirPopup('Adicionar Nova Frota', `<div>${conteudo}</div>`);
        }
        function abrirPopupAdicionarFrotaCatalogo(tipo, contexto = 'catalogo') {
            fecharPopup();
            abrirPopupInput(
                `Adicionar ${getTipoTexto(tipo)}`,
                'Digite o c√≥digo da frota:',
                'Ex: JD6115J',
                '',
                (nome) => {
                    if (nome) {
                        // Se o contexto for 'servico', chama a nova fun√ß√£o de cadastro r√°pido.
                        // Caso contr√°rio, usa a fun√ß√£o antiga que apenas salva no cat√°logo.
                        if (contexto === 'servico') {
                            salvarEAdicionarFrotaAoTurno(nome.trim().toUpperCase(), tipo);
                        } else {
                            salvarFrotaCatalogo(nome.trim().toUpperCase(), tipo);
                        }
                    }
                }
            );
        }
        async function salvarFrotaCatalogo(nome, tipo) { if (!nome) { showToast('O c√≥digo da frota n√£o pode ser vazio.', 'error'); return; } if (catalogoFrotas.some(f => f.nome === nome)) { showToast('Esta frota j√° existe no cat√°logo.', 'error'); return; } const novaFrota = { nome, tipo }; try { await firestore.collection('catalogoFrotas').add(novaFrota); showToast('Frota adicionada ao cat√°logo!', 'success'); } catch (error) { showToast('Erro ao salvar a frota.', 'error'); } }
        async function removerFrotaCatalogo(docId) { const confirmado = await new Promise(resolve => abrirPopupConfirmar('Excluir do Cat√°logo', `Deseja remover esta frota permanentemente do cat√°logo?`, resolve)); if (confirmado) { try { await firestore.collection('catalogoFrotas').doc(docId).delete(); showToast('Frota removida do cat√°logo.', 'success'); } catch (error) { showToast('Erro ao remover a frota.', 'error'); } } }
        // MODIFICADO: Adiciona campo de busca e renderiza o cat√°logo ordenado
// MODIFICADO: Inclui bot√£o "Cancelar" expl√≠cito na lista de bot√µes
function abrirPopupSelecaoFrota() {
sincronizarCatalogoFrotas(); 
    if (catalogoFrotas.length === 0) { 
        showToast("Carregando cat√°logo de frotas... Aguarde um momento.", 'info', 4000); 
        return; 
    } 
    
    // Filtra as frotas que J√Å est√£o no turno
    const frotasDisponiveis = catalogoFrotas.filter(cf => !frotasTurno.some(ft => ft.nome === cf.nome)); 
    
    if (frotasDisponiveis.length === 0) { 
        showToast("Todas as frotas do cat√°logo j√° est√£o no turno.", 'info'); 
        return; 
    } 
    
    // Adiciona campo de busca e cont√™iner para a lista
    let conteudo = `<input type="text" id="filtroSelecaoFrota" 
                        class="w-full p-2 border border-gray-300 rounded-md mb-3" 
                        placeholder="üîé Digite para buscar frota..." 
                        oninput="renderizarListaFrotasDisponiveis()">
                    <div id="listaFrotasDisponiveis" class="max-h-64 overflow-y-auto space-y-2"></div>`; 
    
    // NOVO: Define a lista de bot√µes no rodap√©
    const botoes = [
        { 
            texto: 'Cancelar', 
            classe: 'bg-gray-300 text-gray-800 hover:bg-gray-400', 
            acao: fecharPopup // A√ß√£o: apenas fechar o pop-up
        },
        { 
            texto: 'Adicionar Selecionadas', 
            classe: 'bg-blue-600 text-white hover:bg-blue-700', 
            acao: () => adicionarFrotasSelecionadasAoTurno() 
        }
    ]; 
    
    abrirPopup('Selecionar Frotas', `<div id="popup-content-wrapper">${conteudo}</div>`, botoes); 
    
    // Chama a renderiza√ß√£o inicial ap√≥s o pop-up abrir
    renderizarListaFrotasDisponiveis(frotasDisponiveis);
}

// NOVO: Fun√ß√£o para filtrar e renderizar as op√ß√µes de frota no pop-up de sele√ß√£o
function renderizarListaFrotasDisponiveis(frotasIniciais = null) {
    const listaDiv = document.getElementById('listaFrotasDisponiveis');
    if (!listaDiv) return;

    // 1. Obt√©m as frotas a serem processadas (ou as frotas dispon√≠veis se for a 1¬™ chamada)
    const frotasDisponiveis = frotasIniciais || catalogoFrotas.filter(cf => !frotasTurno.some(ft => ft.nome === cf.nome));

    // 2. Aplica o filtro de busca
    const termoBusca = document.getElementById('filtroSelecaoFrota')?.value;
    const frotasFiltradas = frotasDisponiveis.filter(f => {
        if (!termoBusca) return true;
        // Usa removerAcentos para uma busca mais flex√≠vel
        const termoNormalizado = removerAcentos(termoBusca).toLowerCase();
        const nomeNormalizado = removerAcentos(f.nome).toLowerCase();
        return nomeNormalizado.includes(termoNormalizado);
    });

    // 3. Aplica a ordena√ß√£o crescente (alfab√©tica/numeral)
    frotasFiltradas.sort((a, b) => a.nome.localeCompare(b.nome));

    if (frotasFiltradas.length === 0) {
        listaDiv.innerHTML = `<p class="text-center text-gray-500 py-4">Nenhuma frota encontrada com o filtro atual.</p>`;
        return;
    }
    
    // 4. Gera o HTML
    let listaHTML = frotasFiltradas.map(f => `
        <label class="flex items-center p-2 border rounded-md hover:bg-gray-100">
            <input type="checkbox" name="frota-selecao" value="${f.nome}" 
                   data-tipo="${f.tipo}" 
                   class="h-5 w-5 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
            <span class="ml-3 font-semibold">${f.nome}</span>
            <span class="ml-auto text-xs font-semibold ${getTipoCor(f.tipo)}">${getTipoTexto(f.tipo)}</span>
        </label>
    `).join('');
    
    listaDiv.innerHTML = listaHTML;
}
        // MODIFICADO: L√™ o tipo de frota do atributo do checkbox
// CORRIGIDO: Simplifica a l√≥gica de busca do tipo de frota e garante que s√≥ adicione frotas existentes no cat√°logo.
function adicionarFrotasSelecionadasAoTurno() { 
    const checkboxes = document.querySelectorAll('input[name="frota-selecao"]:checked'); 
    if (checkboxes.length === 0) { 
        showToast('Nenhuma frota selecionada.', 'info'); 
        return; 
    } 
    
    checkboxes.forEach(cb => { 
        const frotaDoCatalogo = catalogoFrotas.find(f => f.nome === cb.value);

        // Apenas adiciona se o item existir no cat√°logo global de frotas.
        if (frotaDoCatalogo) { 
            frotasTurno.push({ 
                nome: frotaDoCatalogo.nome, 
                tipo: frotaDoCatalogo.tipo, // Usa o tipo garantido do objeto do cat√°logo
                horas: 7.2 
            }); 
        } 
    }); 
    
    renderizarFrotasDoTurno(); 
    salvarTudo(); 
    showToast(`${checkboxes.length} frota(s) adicionada(s) ao turno.`, 'success'); 
}

        // ADICIONE ESTA NOVA FUN√á√ÉO
        /**
         * Inicia o fluxo de cadastro r√°pido a partir do FAB de servi√ßos.
         * Apenas chama o popup de sele√ß√£o de tipo, passando um contexto diferente.
         */
        function iniciarCadastroRapidoFrota() {
            abrirPopupTipoFrota('servico');
        }

        // ADICIONE ESTA NOVA FUN√á√ÉO
        /**
         * Fun√ß√£o central para o cadastro r√°pido:
         * 1. Verifica se a frota j√° existe no cat√°logo.
         * 2. Se n√£o, salva no Firebase.
         * 3. Adiciona a frota (nova ou existente) ao turno atual.
         * 4. Atualiza a interface.
         */
        async function salvarEAdicionarFrotaAoTurno(nome, tipo) {
            // 1. Verifica se a frota j√° existe no cat√°logo online
            if (catalogoFrotas.some(f => f.nome === nome)) {
                // Se j√° existe, apenas a adiciona ao turno atual
                if (!frotasTurno.some(ft => ft.nome === nome)) {
                    frotasTurno.push({ nome, tipo, horas: 7.2 });
                    salvarTudo(true);
                    showToast(`Frota ${nome} adicionada ao turno!`, 'success');
                    // Se a tela de servi√ßos estiver aberta, atualiza as listas de frotas nos cart√µes
                    if (document.getElementById('servicosLista')) {
                        renderizarServicos();
                    }
                } else {
                    showToast(`Frota ${nome} j√° est√° no turno atual.`, 'info');
                }
                return; // Termina a execu√ß√£o aqui
            }

            // 2. Se a frota √© nova, salva primeiro no cat√°logo do Firebase
            const novaFrota = { nome, tipo };
            try {
                await firestore.collection('catalogoFrotas').add(novaFrota);
                // A sincroniza√ß√£o autom√°tica do Firebase ir√° adicionar ao `catalogoFrotas` local.

                // 3. Em seguida, adiciona ao turno atual
                if (!frotasTurno.some(ft => ft.nome === nome)) {
                    frotasTurno.push({ nome, tipo, horas: 8.0 });
                    salvarTudo(true);
                    showToast(`Frota ${nome} cadastrada e adicionada ao turno!`, 'success');
                    if (document.getElementById('servicosLista')) {
                        renderizarServicos();
                    }
                }
            } catch (error) {
                showToast('Erro ao salvar a nova frota.', 'error');
                console.error("Erro ao salvar frota r√°pida:", error);
            }
        }

        // ---------------------------------
        // M√ìDULO: SERVI√áOS
        // ---------------------------------
        function renderizarSecaoServicos(container) { container.innerHTML = `<div class="bg-white p-4 rounded-lg shadow mb-4"><h4 class="text-lg font-semibold text-blue-700 mb-3 border-b pb-2">Filtrar Servi√ßos</h4><div class="grid grid-cols-1 md:grid-cols-2 gap-4"><input type="text" id="filtroServicoFrota" class="w-full p-2 border border-gray-300 rounded-md" placeholder="Filtrar por Frota..." oninput="renderizarServicos()"><input type="text" id="filtroServicoDescricao" class="w-full p-2 border border-gray-300 rounded-md" placeholder="Filtrar por Descri√ß√£o..." oninput="renderizarServicos()"></div></div><div id="servicosLista" class="space-y-4"></div>`; renderizarServicos(); }
        function renderizarServicos() { const lista = document.getElementById("servicosLista"); if (!lista) return; const filtroFrota = document.getElementById('filtroServicoFrota')?.value.toLowerCase() || ""; const filtroDescricao = document.getElementById('filtroServicoDescricao')?.value.toLowerCase() || ""; const servicosFiltrados = servicos.filter(s => (!filtroFrota || s.frota.toLowerCase().includes(filtroFrota)) && (!filtroDescricao || s.descricao.toLowerCase().includes(filtroDescricao))); servicosFiltrados.sort((a, b) => (a.data + a.inicio).localeCompare(b.data + b.inicio)); lista.innerHTML = ''; if (servicosFiltrados.length === 0) { lista.innerHTML = `<p class='text-center text-gray-500 p-4'>Nenhum servi√ßo encontrado.</p>`; } else { servicosFiltrados.forEach(s => { const template = document.getElementById('servico-template').content.cloneNode(true); const article = template.querySelector('article'); article.id = `servico_${s.id}`; lista.appendChild(article); preencherDetalhesServico(s); }); } }
        function preencherDetalhesServico(s) { 
            const article = document.getElementById(`servico_${s.id}`); 
            if (!article) return; 
            
            if (s.foiCompartilhado) { article.classList.add('servico-compartilhado'); } else { article.classList.remove('servico-compartilhado'); } 
            
            const osNaoGerada = !s.texto; 
            if (osNaoGerada) { article.classList.add('servico-pendente-os'); } else { article.classList.remove('servico-pendente-os'); } 
            
            const cabecalhoInfo = article.querySelector('.servico-cabecalho-info'); 
            const toggler = article.querySelector('.servico-cabecalho-toggler'); 
            const detalhes = article.querySelector('.servico-detalhes'); 
            const cabecalhoHTML = gerarTextoCabecalhoServico(s); 
            
            if (cabecalhoInfo.innerHTML !== cabecalhoHTML) { cabecalhoInfo.innerHTML = cabecalhoHTML; } 
            
            toggler.innerHTML = s.isExpanded ? '&#9650;' : '&#9660;'; 
            article.querySelector('.servico-cabecalho').onclick = () => toggleDetalhesServico(s.id); 
            detalhes.style.display = s.isExpanded ? 'block' : 'none'; 
            
            if (!s.isExpanded) return; 
            
            // NOVO: Renderiza a lista de pe√ßas
            let listaPecasHTML = '';
            if (s.pecasUtilizadas && s.pecasUtilizadas.length > 0) {
                listaPecasHTML = s.pecasUtilizadas.map((p, i) => `
                    <div class="flex justify-between items-center p-2 bg-gray-100 rounded-md text-sm border-l-4 border-blue-500">
                        <span class="truncate">
                            <strong class="text-blue-700">${p.quantidade || '1'}x</strong> ${p.descricao}
                            <span class="text-xs text-gray-500 ml-1">(SAP: ${p.codigoSap || 'N/D'})</span>
                        </span>
                        <button onclick="removerPecaUtilizada(${s.id}, ${i})" class="text-red-500 hover:text-red-700 font-bold text-lg leading-none" title="Remover Pe√ßa">&times;</button>
                    </div>
                `).join('');
            } else {
                listaPecasHTML = '<p class="text-sm text-gray-500 p-2 text-center border rounded-md">Nenhuma pe√ßa adicionada.</p>';
            }


            const subsistemasAtuais = subsistemas[s.sistema] || []; 
            const frotaOptions = '<option value="">Selecione</option>' + frotasTurno.map(f => `<option value="${f.nome}" ${s.frota === f.nome ? 'selected' : ''}>${f.nome}</option>`).join(''); 
            const atividadeOptions = '<option value="">Selecione</option>' + atividades.map(a => `<option value="${a}" ${s.atividade === a ? 'selected' : ''}>${a}</option>`).join(''); 
            const sistemaOptions = '<option value="">Selecione</option>' + Object.entries(sistemas).map(([g, lst]) => `<optgroup label="${g}">${lst.map(sys => `<option value="${sys.cod}" ${s.sistema === sys.cod ? 'selected' : ''}>${sys.cod} - ${sys.nome}</option>`).join('')}</optgroup>`).join(''); 
            const subsistemaOptions = '<option value="">Selecione</option>' + subsistemasAtuais.map(sub => `<option value="${sub}" ${s.subsistema === sub ? 'selected' : ''}>${sub}</option>`).join(''); 
            
            detalhes.innerHTML = `<div class="space-y-4">
                <div><h5 class="text-md font-semibold text-gray-700 border-b pb-1 mb-3">Identifica√ß√£o da O.S</h5><div class="grid grid-cols-2 gap-x-4 gap-y-3"><div><label class="block text-sm font-medium text-gray-700">Frota*</label><select data-id="${s.id}" data-field="frota" class="mt-1 w-full p-2 border rounded-md">${frotaOptions}</select></div><div><label class="block text-sm font-medium text-gray-700">Atividade*</label><select data-id="${s.id}" data-field="atividade" class="mt-1 w-full p-2 border rounded-md">${atividadeOptions}</select></div><div><label class="block text-sm font-medium text-gray-700">Sistema*</label><select data-id="${s.id}" data-field="sistema" class="mt-1 w-full p-2 border rounded-md">${sistemaOptions}</select></div><div><label class="block text-sm font-medium text-gray-700">Subsistema*</label><select data-id="${s.id}" data-field="subsistema" class="mt-1 w-full p-2 border rounded-md">${subsistemaOptions}</select></div></div></div>
                
                <div><h5 class="text-md font-semibold text-gray-700 border-b pb-1 mb-3">Pe√ßas Utilizadas</h5>
                    <div id="lista-pecas-servico-${s.id}" class="space-y-2 mb-4">${listaPecasHTML}</div>
                    <button onclick="abrirPopupSelecaoPecas(${s.id})" class="w-full py-2 px-4 rounded-md font-semibold bg-indigo-500 text-white hover:bg-indigo-600 text-sm">Adicionar Pe√ßa do Cat√°logo</button>
                </div>
                <div><h5 class="text-md font-semibold text-gray-700 border-b pb-1 mb-3">Opera√ß√£o</h5><div class="grid grid-cols-2 gap-x-4 gap-y-3"><div><label class="block text-sm font-medium">M√°quina parada?*</label><select data-id="${s.id}" data-field="parada" class="mt-1 w-full p-2 border rounded-md"><option value="sim" ${s.parada === "sim" ? 'selected' : ''}>Sim</option><option value="n√£o" ${s.parada === "n√£o" ? 'selected' : ''}>N√£o</option></select></div><div><label class="block text-sm font-medium">Falha operacional?*</label><select data-id="${s.id}" data-field="falha" class="mt-1 w-full p-2 border rounded-md"><option value="n√£o" ${s.falha === "n√£o" ? 'selected' : ''}>N√£o</option><option value="sim" ${s.falha === "sim" ? 'selected' : ''}>Sim</option></select></div><div class="col-span-2"><label class="block text-sm font-medium">Tipo de manuten√ß√£o*</label><select data-id="${s.id}" data-field="tipo" class="mt-1 w-full p-2 border rounded-md"><option value="CORRETIVA" ${s.tipo === "CORRETIVA" ? 'selected' : ''}>Corretiva</option><option value="CONDICIONAL" ${s.tipo === "CONDICIONAL" ? 'selected' : ''}>Condicional</option><option value="MELHORIA" ${s.tipo === "MELHORIA" ? 'selected' : ''}>Melhoria</option></select></div><div><label class="block text-sm font-medium">Data inicial*</label><input type="date" data-id="${s.id}" id="data-${s.id}" data-field="data" value="${s.data}" class="mt-1 w-full p-2 border rounded-md"></div><div><label class="block text-sm font-medium">Hora inicial*</label><input type="time" data-id="${s.id}" id="inicio-${s.id}" data-field="inicio" value="${s.inicio}" class="mt-1 w-full p-2 border rounded-md"></div><div><label class="block text-sm font-medium">Data final*</label><input type="date" data-id="${s.id}" id="dataFinal-${s.id}" data-field="dataFinal" value="${s.dataFinal}" class="mt-1 w-full p-2 border rounded-md"></div><div><label class="block text-sm font-medium">Hora final*</label><input type="time" data-id="${s.id}" id="fim-${s.id}" data-field="fim" value="${s.fim}" class="mt-1 w-full p-2 border rounded-md"></div></div></div><div><h5 class="text-md font-semibold text-gray-700 border-b pb-1 mb-2">Descri√ß√£o*</h5><textarea data-id="${s.id}" data-field="descricao" class="w-full p-2 border rounded-md h-28" placeholder="Detalhe o problema e a solu√ß√£o...">${s.descricao}</textarea></div><div><div class="flex flex-col space-y-2"><button onclick="processarOS(${s.id})" class="w-full py-2 px-4 rounded-md font-semibold bg-blue-600 text-white hover:bg-blue-700">${osNaoGerada ? "Gerar O.S." : "Regerar O.S."}</button>${osNaoGerada ? `<button onclick="removerServico(${s.id})" class="w-full py-2 px-4 rounded-md font-semibold bg-red-600 text-white hover:bg-red-700">Excluir Servi√ßo</button>` : ''}</div><div id="preview_container_${s.id}" class="${osNaoGerada ? 'hidden' : ''} mt-4"><div class="p-3 bg-gray-50 border rounded-md whitespace-pre-line">${interpretarMarkdown(s.texto || "")}</div><div class="mt-3 grid grid-cols-2 sm:grid-cols-4 gap-2"><button onclick="copiarTexto(${s.id}, this)" class="py-2 px-4 rounded-md font-semibold bg-gray-200 hover:bg-gray-300 text-sm">Copiar</button><button onclick="compartilharWhatsApp(${s.id})" class="py-2 px-4 rounded-md font-semibold bg-green-500 text-white hover:bg-green-600 text-sm">Compartilhar</button><button onclick="adicionarServicoDepois(${s.id})" class="py-2 px-4 rounded-md font-semibold bg-blue-500 text-white hover:bg-blue-600 text-sm">Adicionar Outro</button><button onclick="removerServico(${s.id})" class="py-2 px-4 rounded-md font-semibold bg-red-600 text-white hover:bg-red-700 text-sm">Excluir</button></div></div></div></div>`; 
            
            // NOVO: Adiciona a valida√ß√£o de tempo aqui
            const inputFim = detalhes.querySelector(`#fim-${s.id}`);
            const inputDataFinal = detalhes.querySelector(`#dataFinal-${s.id}`);
            const servicoValidado = servicos.find(item => item.id === s.id);
            if(inputFim && inputDataFinal) {
                if (!validarTempoServico(servicoValidado)) {
                    inputFim.classList.add('campo-invalido'); 
                    inputDataFinal.classList.add('campo-invalido');
                } else {
                    inputFim.classList.remove('campo-invalido');
                    inputDataFinal.classList.remove('campo-invalido');
                }
            }
            
            detalhes.querySelectorAll('input, select, textarea').forEach(el => { el.addEventListener('change', handleServicoInputChange); el.addEventListener('input', handleServicoInputChange); }); 
        }
        
        // MODIFICADO: Lida com a entrada de dados do servi√ßo E aplica valida√ß√£o de tempo
        function handleServicoInputChange(event) { 
            const el = event.target; 
            const id = parseInt(el.dataset.id); 
            const field = el.dataset.field; 
            const servico = servicos.find(s => s.id === id); 
            if (!servico) return; 
            
            servico[field] = el.value; 
            el.classList.remove('campo-invalido'); 
            
            if (field === 'sistema') { 
                servico.subsistema = ""; 
                renderizarServicos(); 
            } 
            
            // NOVO BLOCO: Valida√ß√£o Imediata do Tempo
            if (['data', 'inicio', 'dataFinal', 'fim'].includes(field)) {
                const isValid = validarTempoServico(servico);
                const inputFim = document.getElementById(`fim-${servico.id}`);
                const inputDataFinal = document.getElementById(`dataFinal-${servico.id}`);
                
                if (inputFim && inputDataFinal) {
                    if (!isValid) {
                        inputFim.classList.add('campo-invalido');
                        inputDataFinal.classList.add('campo-invalido');
                    } else {
                        inputFim.classList.remove('campo-invalido');
                        inputDataFinal.classList.remove('campo-invalido');
                    }
                }
            }
            
            const camposQueAtualizamCabecalho = ['frota', 'atividade', 'sistema', 'subsistema', 'inicio', 'fim']; 
            if (camposQueAtualizamCabecalho.includes(field)) { 
                const cabecalhoInfo = document.querySelector(`#servico_${id} .servico-cabecalho-info`); 
                if (cabecalhoInfo) { 
                    cabecalhoInfo.innerHTML = gerarTextoCabecalhoServico(servico); 
                } 
            } 
            
            salvarTudo(); 
        }
        function adicionarServico(dadosPreenchidos = null) { 
            if (!validarCamposTurnoBasicos()) return; 
            const id = Date.now(); 
            const novoServico = dadosPreenchidos || { 
                id, 
                frota: "", 
                atividade: "", 
                sistema: "", 
                subsistema: "", 
                descricao: "", 
                tipo: "CORRETIVA", 
                parada: "sim", 
                falha: "n√£o", 
                data: document.getElementById('dataTurno')?.value || dataHojeInputLocal(), 
                inicio: "", 
                dataFinal: document.getElementById('dataTurno')?.value || dataHojeInputLocal(), 
                fim: "", 
                texto: "", 
                oportunidade: "", 
                isExpanded: true, 
                foiCompartilhado: false,
                pecasUtilizadas: [] // NOVO: Inicializa o array de pe√ßas
            }; 
            servicos.push(novoServico); 
            renderizarServicos(); 
            salvarTudo(); 
            showToast("Novo servi√ßo adicionado.", 'success'); 
            setTimeout(() => document.getElementById(`servico_${id}`)?.scrollIntoView({ behavior: 'smooth', block: 'center' }), 100); 
        }
        async function removerServico(id) { const confirmado = await new Promise(resolve => abrirPopupConfirmar('Excluir Servi√ßo', 'Tem certeza?', resolve)); if (confirmado) { const index = servicos.findIndex(s => s.id === id); if (index > -1) { servicos.splice(index, 1); renderizarServicos(); salvarTudo(); showToast("Servi√ßo removido.", 'success'); } } }
        function toggleDetalhesServico(id) { const servico = servicos.find(s => s.id === id); if (!servico) return; servico.isExpanded = !servico.isExpanded; const article = document.getElementById(`servico_${id}`); if (!article) return; const detalhes = article.querySelector('.servico-detalhes'); const toggler = article.querySelector('.servico-cabecalho-toggler'); detalhes.style.display = servico.isExpanded ? 'block' : 'none'; toggler.innerHTML = servico.isExpanded ? '&#9650;' : '&#9660;'; if (servico.isExpanded) preencherDetalhesServico(servico); }
                async function processarOS(id) { 
            const servico = servicos.find(s => s.id === id); 
            if (!servico) return; 
            
            const camposObrigatorios = ['frota', 'atividade', 'sistema', 'subsistema', 'descricao', 'data', 'inicio', 'dataFinal', 'fim']; 
            let camposInvalidos = []; 
            const article = document.getElementById(`servico_${servico.id}`); 
            
            // Valida√ß√£o de campos vazios
            camposObrigatorios.forEach(field => { 
                const el = article.querySelector(`[data-field="${field}"]`); 
                if (!servico[field] || servico[field].trim() === "") { 
                    camposInvalidos.push(field); 
                    if (el) el.classList.add('campo-invalido'); 
                } else { 
                    if (el) el.classList.remove('campo-invalido'); 
                } 
            }); 
            
            if (camposInvalidos.length > 0) { 
                showToast('Preencha todos os campos obrigat√≥rios.', 'error'); 
                return; 
            } 
            
            // Valida√ß√£o de tempo (in√≠cio vs. fim)
            if (!validarTempoServico(servico)) {
                showToast('A data/hora final n√£o pode ser anterior √† inicial.', 'error');
                // Garante que o destaque de erro seja aplicado
                article.querySelector('[data-field="dataFinal"]').classList.add('campo-invalido');
                article.querySelector('[data-field="fim"]').classList.add('campo-invalido');
                return;
            }
            
            const gerarTextoFinal = () => { 
                const frente = document.getElementById("frente").value.trim() || "N√ÉO INFORMADA"; 
                const equipeTexto = equipe.length > 0 ? equipe.map(item => `${item.nome} - ${item.matricula}`).join('\n') : "Equipe n√£o informada."; 
                const dataFormatada = formatarDataParaExibicao(servico.data); 
                const dataFinalFormatada = formatarDataParaExibicao(servico.dataFinal); 

                // MODIFICADO: Gera√ß√£o da se√ß√£o de Pe√ßas
                let secaoPecas = '';
                if (servico.pecasUtilizadas && servico.pecasUtilizadas.length > 0) {
                    const pecasTexto = servico.pecasUtilizadas.map(p => {
                        const sap = p.codigoSap ? `SAP.[${p.codigoSap}]` : '';
                        const pn = p.partNumber ? `PartNumber [${p.partNumber}]` : '';
                        return `- qtd: *(${p.quantidade})* - ${p.descricao} - ${sap} - ${pn}`;
                    }).join('\n');
                    
                    // A se√ß√£o S√ì √â ADICIONADA SE HOUVER PE√áAS
                    secaoPecas = `\n\n‚öôÔ∏è *Pe√ßas:*\n\n${pecasTexto}`;
                }
                
                const txt = `*SOLICITA√á√ÉO DE O.S*\n\n*M√°quina est√° parada por manuten√ß√£o:*\n(${servico.parada === "sim" ? "‚ùå" : " "}) sim *(${servico.parada === "n√£o" ? "‚ùå" : " "}) n√£o*\n*se SIM abre ORDEM*\n*se N√ÉO abre Pr√©-Ordem*\n\n‚Ä¢Frota afetada: ${servico.frota}\n‚Ä¢Local/frente: ${frente}\n\n‚Ä¢Tipo de manuten√ß√£o:\n(${servico.tipo === "CORRETIVA" ? "‚ùå" : " "}) CORRETIVA ORDEM DE MANUTEN√á√ÉO\n(${servico.tipo === "CONDICIONAL" ? "‚ùå" : " "}) CONDICIONAL PR√â-ORDEM\n(${servico.tipo === "MELHORIA" ? "‚ùå" : " "}) MELHORIA PR√â-ORDEM\n\n‚Ä¢Descri√ß√£o servi√ßo\n${servico.descricao}\n(${servico.atividade.split(" - ")[0]} - ${servico.sistema} - ${(servico.subsistema || "").split(" - ")[0]})\n${servico.oportunidade ? `Oportunidade: ${servico.oportunidade}\n\n` : '\n'}‚Ä¢Foi falha operacional?\n(${servico.falha === "sim" ? "‚ùå" : " "}) Sim\n(${servico.falha === "n√£o" ? "‚ùå" : " "}) N√£o\n\nData inicial: ${dataFormatada}\nHora inicial: ${servico.inicio}\nData final: ${dataFinalFormatada}\nHora fim: ${servico.fim}\n\nSolicitante:\n${equipeTexto}${secaoPecas}`; 
                
                servico.texto = txt; 
                servico.isExpanded = true; 
                salvarOSnoHistorico(servico.id); 
                salvarTudo(true); 
                renderizarServicos(); 
                showToast("O.S. gerada/atualizada!", 'success'); 
                setTimeout(() => document.getElementById(`servico_${servico.id}`)?.scrollIntoView({ behavior: 'smooth', block: 'center' }), 100); 
            }; 
            if (servico.tipo === "CONDICIONAL" || servico.tipo === "MELHORIA") { abrirPopupInput('Informar Oportunidade', 'Para manuten√ß√£o Condicional/Melhoria, informe a oportunidade:', 'Ex: Refei√ß√£o, DDS...', servico.oportunidade || '', (oportunidade) => { if (oportunidade !== null) { servico.oportunidade = oportunidade; gerarTextoFinal(); } }); } else { servico.oportunidade = ""; gerarTextoFinal(); } 
        }

        async function copiarTexto(id, button) { const servico = servicos.find(s => s.id === id); if (!servico || !servico.texto) { showToast("Gere a O.S. primeiro.", 'error'); return; } try { await navigator.clipboard.writeText(servico.texto); showToast("Texto da O.S. copiado!", 'success'); button.innerText = 'Copiado!'; setTimeout(() => { minimizarServico(id); button.innerText = 'Copiar'; }, 1000); } catch (err) { showToast("Falha ao copiar texto.", 'error'); } }
        function compartilharWhatsApp(id) { const servico = servicos.find(s => s.id === id); if (!servico || !servico.texto) { showToast("Gere a O.S. primeiro.", 'error'); return; } servico.foiCompartilhado = true; salvarTudo(true); preencherDetalhesServico(servico); window.open(`https://wa.me/?text=${encodeURIComponent(servico.texto)}`, "_blank"); minimizarServico(id); }
        function adicionarServicoDepois(idReferencia) { const refServico = servicos.find(s => s.id === idReferencia); if (!refServico) return; minimizarServico(idReferencia); const novoServico = { id: Date.now(), frota: refServico.frota, atividade: "", sistema: refServico.sistema, subsistema: "", descricao: "", tipo: "CORRETIVA", parada: "sim", falha: "n√£o", data: refServico.dataFinal, dataFinal: refServico.dataFinal, inicio: refServico.fim, fim: "", texto: "", oportunidade: "", isExpanded: true, foiCompartilhado: false, pecasUtilizadas: [] }; const index = servicos.findIndex(s => s.id === idReferencia); servicos.splice(index + 1, 0, novoServico); renderizarServicos(); salvarTudo(); showToast("Novo servi√ßo adicionado abaixo.", 'success'); setTimeout(() => document.getElementById(`servico_${novoServico.id}`)?.scrollIntoView({ behavior: 'smooth', block: 'center' }), 100); }
        
        // ---------------------------------
        // NOVAS FUN√á√ïES: GEST√ÉO DE PE√áAS NO SERVI√áO
        // ---------------------------------
        
    function abrirPopupSelecaoPecas(servicoId) {
    // 1. Inicia o download (se ainda n√£o foi feito)
    sincronizarCatalogoPecas();

    // 2. Se a lista ainda estiver vazia, provavelmente est√° baixando
    if (catalogoLocal.length === 0) {
        showToast("Carregando cat√°logo... Aguarde alguns segundos e tente novamente.", 'info', 4000);
        return;
    }
    
    // Filtro inicial e renderiza√ß√£o do cat√°logo dentro do popup
    const itensFiltrados = catalogoLocal.sort((a, b) => (a.descricao || '').localeCompare(b.descricao || ''));
    
    let conteudo = `<input type="text" id="popupBuscaPeca" oninput="renderizarPecasParaServico(${servicoId})" placeholder="üîé Buscar pe√ßa por SAP/Descri√ß√£o..." class="w-full p-2 border border-gray-300 rounded-lg mb-3">
    <div id="listaPecasPopup" class="max-h-64 overflow-y-auto space-y-2">`;
    
    conteudo += renderizarPecasParaServicoHTML(itensFiltrados, servicoId);
    conteudo += `</div>`;

    abrirPopup('Selecionar Pe√ßa', `<div id="popup-content-wrapper">${conteudo}</div>`, [
        { texto: 'Fechar', classe: 'bg-gray-300 text-gray-800 hover:bg-gray-400', acao: fecharPopup }
    ]);
}

        function renderizarPecasParaServico(servicoId) {
            const listaDiv = document.getElementById('listaPecasPopup');
            if (!listaDiv) return;

            const termoBusca = removerAcentos(document.getElementById('popupBuscaPeca').value.toLowerCase());

            const itensFiltrados = catalogoLocal.filter(item => {
                const codigoSap = removerAcentos(String(item.codigoSap || '').toLowerCase());
                const partNumber = removerAcentos(String(item.partNumber || '').toLowerCase());
                const descricaoNormalizada = removerAcentos(String(item.descricao || '').toLowerCase());

                return (codigoSap.includes(termoBusca) || partNumber.includes(termoBusca) || descricaoNormalizada.includes(termoBusca));
            });

            listaDiv.innerHTML = renderizarPecasParaServicoHTML(itensFiltrados, servicoId);
        }

        function renderizarPecasParaServicoHTML(itens, servicoId) {
            if (itens.length === 0) {
                return `<p class="text-center text-gray-500 py-4">Nenhum item encontrado.</p>`;
            }

            return itens.map(item => `
                <div class="border rounded-lg p-3 flex justify-between items-center transition-all duration-200 hover:bg-blue-50">
                    <div class="flex-1 min-w-0">
                        <p class="font-bold text-gray-800 truncate">${item.descricao}</p>
                        <p class="text-xs text-gray-600">SAP: ${item.codigoSap || 'N/D'} | PN: ${item.partNumber || 'N/D'}</p>
                    </div>
                    <button onclick="selecionarPecaParaServico(${servicoId}, '${item.docId}')" class="py-1 px-3 rounded bg-indigo-600 text-white hover:bg-indigo-700 text-sm font-semibold ml-2">
                        Adicionar
                    </button>
                </div>
            `).join('');
        }

        function selecionarPecaParaServico(servicoId, docId) {
            const peca = catalogoLocal.find(p => p.docId === docId);
            if (!peca) return;

            abrirPopupInput(
                `Qtd. para: ${peca.descricao.substring(0, 30)}...`,
                'Digite a quantidade utilizada (apenas n√∫meros):',
                'Ex: 1, 5.5',
                '1',
                (quantidade) => {
                    if (quantidade && !isNaN(parseFloat(quantidade)) && parseFloat(quantidade) > 0) {
                        adicionarPecaUtilizada(servicoId, peca, parseFloat(quantidade));
                    } else {
                        showToast("Quantidade inv√°lida.", "error");
                    }
                },
                'number'
            );
        }

        function adicionarPecaUtilizada(servicoId, peca, quantidade) {
            const servico = servicos.find(s => s.id === servicoId);
            if (!servico) return;

            servico.pecasUtilizadas.push({
                ...peca, // Inclui docId, codigoSap, partNumber, descricao
                quantidade: quantidade
            });

            fecharPopup();
            salvarTudo();
            preencherDetalhesServico(servico); // Renderiza a lista de pe√ßas no cart√£o
            showToast(`Pe√ßa adicionada: ${quantidade}x ${peca.descricao}`, 'success');
        }

        function removerPecaUtilizada(servicoId, pecaIndex) {
            const servico = servicos.find(s => s.id === servicoId);
            if (!servico) return;

            servico.pecasUtilizadas.splice(pecaIndex, 1);

            salvarTudo();
            preencherDetalhesServico(servico); // Renderiza a lista de pe√ßas no cart√£o
            showToast(`Pe√ßa removida.`, 'success');
        }
// =================================================================================
// M√ìDULO: APONTAMENTO (NOVA L√ìGICA DE EDI√á√ÉO)
// =================================================================================

let linhasApontamento = []; // Armazena as linhas que ser√£o impressas

// Configura√ß√£o das coordenadas (Mantida, ajuste fino se necess√°rio)
const COORD_FORM = {
    imagemBase: 'fundo_apontamento.jpg',
    cabecalho: {
        oficinaInterna: { x: 323, y: 230 }, // Checkbox Interna
        oficinaExterna: { x: 1420, y: 230 }, // Checkbox Externa
        colaborador: { x: 280, y: 400 },
        id: { x: 280, y: 440}, // Ajustado X para ID n√£o sobrepor nome longo
        setor: { x: 900, y: 410 },
        dataDia: { x: 1720, y: 400 },
        dataMes: { x: 1780, y: 400},
        dataAno: { x: 1850, y: 400}
    },
    grid: {
        inicioY: 630, 
        alturaLinha: 90, 
        colunas: {
            os: 210,
            frota: 425,
            operacao: 620,
            atividade: 990,
            sistema: 1370,
            subsistema: 1570,
            inicio: 1748,
            fim: 1888,
            local: 2250
        }
    }
};
// Inicializa a tela de apontamento
function renderizarSecaoApontamento() {
    const sel = document.getElementById('apontamentoColaborador');
    const dataTurno = document.getElementById('dataTurno');
    const dataApont = document.getElementById('apontamentoData');

    if (sel) {
        sel.innerHTML = equipe.length 
            ? equipe.map(e => `<option value="${e.nome} - ${e.matricula}">${e.nome} - ${e.matricula}</option>`).join('') 
            : '<option>Sem equipe definida</option>';
    }
    
    // 1. SINCRONIZA√á√ÉO DE DATAS: O apontamento usa a data do turno principal
    if (dataTurno && dataApont) {
        dataApont.value = dataTurno.value;
    }

    // 2. Inicializar Linhas (DDS Padr√£o)
    if (linhasApontamento.length === 0) {
        linhasApontamento.push({
            id: Date.now(),
            tipo: 'manual',
            atividade: 'H02 - DDS',
            inicio: '07:00',
            fim: '07:20',
            os: '', frota: '', sistema: '', subsistema: ''
        });
    }
    
    // 3. Renderizar
    renderizarListaLinhas();
}

function renderizarListaLinhas() {
    const container = document.getElementById('listaLinhasApontamento');
    if (!container) return;
    
    container.innerHTML = '';

    if (linhasApontamento.length === 0) {
        container.innerHTML = `
            <div class="text-center p-6 text-gray-400 bg-gray-50 rounded-lg border-2 border-dashed border-gray-200">
                <p>Nenhuma atividade adicionada.</p>
                <p class="text-xs">Use os bot√µes acima para come√ßar.</p>
            </div>`;
        return;
    }

    linhasApontamento.forEach((linha, index) => {
        const isServico = linha.tipo === 'servico';
        let html = '';

        if (isServico) {
            // ============================================================
            // CART√ÉO DE SERVI√áO
            // ============================================================
            
            // Tratamento de seguran√ßa para textos
            const ativTexto = linha.atividade || '';
            const codAtiv = ativTexto.includes(' - ') ? ativTexto.split(' - ')[0] : ativTexto;
            const descAtiv = ativTexto.includes(' - ') ? ativTexto.split(' - ')[1] : '';
            
            const sist = linha.sistema || '?';
            const subRaw = linha.subsistema || '?';
            const sub = subRaw.includes(' - ') ? subRaw.split(' - ')[0] : subRaw;
            
            const infoTecnica = `${codAtiv} - ${sist} - ${sub} (${descAtiv})`;

            html = `
            <div class="bg-white rounded-lg shadow-sm mb-3 border-l-4 border-blue-600 overflow-hidden">
                
                <div class="flex justify-between items-center bg-gray-50 px-3 py-2 border-b border-gray-100">
                    <div class="flex items-center gap-2">
                        <span class="flex-shrink-0 w-6 h-6 flex items-center justify-center rounded-full bg-blue-600 text-white text-xs font-bold shadow-sm">
                            ${index + 1}
                        </span>
                        <span class="font-black text-gray-700 text-sm tracking-tight uppercase">
                            FROTA: ${linha.frota || 'N/A'}
                        </span>
                    </div>
                    <button onclick="removerLinhaApontamento(${index})" class="text-gray-400 hover:text-red-600 p-1">
                        <span class="text-xl font-bold">&times;</span>
                    </button>
                </div>

                <div class="px-3 py-2 border-b border-gray-50">
                    <div class="text-[10px] font-bold text-gray-400 uppercase tracking-wider mb-1">Atividade</div>
                    <div class="text-xs font-bold text-gray-800 leading-snug">
                        ‚öôÔ∏è ${infoTecnica}
                    </div>
                </div>

                <div class="px-3 py-2 bg-blue-50 flex items-center justify-between gap-2">
                    <div class="text-xs font-bold text-gray-700">
                        üìÑ O.S: <span class="bg-white px-1 py-0.5 rounded border border-blue-100 text-blue-800">${linha.os || 'PEND'}</span>
                    </div>
                    
                    <div class="flex items-center bg-white rounded border border-blue-200 px-1 shadow-sm h-8">
                        <input type="time" value="${linha.inicio}" 
                            onchange="atualizarLinha(${index}, 'inicio', this.value)" 
                            class="bg-transparent text-xs font-bold text-gray-800 w-[45px] text-center p-0 border-none outline-none h-full">
                        <span class="text-blue-300 font-bold mx-0.5">-</span>
                        <input type="time" value="${linha.fim}" 
                            onchange="atualizarLinha(${index}, 'fim', this.value)" 
                            class="bg-transparent text-xs font-bold text-gray-800 w-[45px] text-center p-0 border-none outline-none h-full">
                    </div>
                </div>
            </div>`;

        } else {
            // ============================================================
            // CART√ÉO MANUAL (ATUALIZADO PARA FICAR IGUAL AO DE SERVI√áO)
            // ============================================================
            
            const opsH = atividades.filter(a => a.startsWith('H')).map(a => {
                const isSelected = linha.atividade === a ? 'selected' : '';
                return `<option value="${a}" ${isSelected}>${a}</option>`;
            }).join('');
            
            html = `
            <div class="bg-white rounded-lg shadow-sm mb-3 border-l-4 border-orange-400 overflow-hidden">
                
                <div class="flex justify-between items-center bg-gray-50 px-3 py-2 border-b border-gray-100">
                    <div class="flex items-center gap-2">
                        <span class="flex-shrink-0 w-6 h-6 flex items-center justify-center rounded-full bg-gray-500 text-white text-xs font-bold shadow-sm">
                            ${index + 1}
                        </span>
                        <span class="font-black text-gray-700 text-xs uppercase tracking-tight">
                            ATIVIDADE N√ÉO PRODUTIVA
                        </span>
                    </div>
                    <button onclick="removerLinhaApontamento(${index})" class="text-gray-400 hover:text-red-600 p-1">
                        <span class="text-xl font-bold">&times;</span>
                    </button>
                </div>

                <div class="p-3 bg-orange-50/30 flex flex-col gap-2">
                    
                    <div>
                        <select onchange="atualizarLinha(${index}, 'atividade', this.value)" 
                            class="w-full p-2 text-xs font-bold text-gray-800 bg-white border border-gray-300 rounded focus:ring-1 focus:ring-orange-500 outline-none shadow-sm">
                            ${opsH}
                        </select>
                    </div>

                    <div class="flex justify-end pt-1">
                        <div class="flex items-center bg-white rounded border border-orange-200 px-1 shadow-sm h-8">
                            <input type="time" value="${linha.inicio}" 
                                onchange="atualizarLinha(${index}, 'inicio', this.value)" 
                                class="bg-transparent text-xs font-bold text-gray-800 w-[45px] text-center p-0 border-none outline-none h-full">
                            <span class="text-orange-300 font-bold mx-0.5">-</span>
                            <input type="time" value="${linha.fim}" 
                                onchange="atualizarLinha(${index}, 'fim', this.value)" 
                                class="bg-transparent text-xs font-bold text-gray-800 w-[45px] text-center p-0 border-none outline-none h-full">
                        </div>
                    </div>
                </div>

            </div>`;
        }
        
        container.innerHTML += html;
    });
}

// Atualiza dados da mem√≥ria quando o usu√°rio edita os inputs
function atualizarLinha(index, campo, valor) {
    linhasApontamento[index][campo] = valor;
}

function adicionarLinhaManual() {
    // Pega o hor√°rio final da √∫ltima linha para sugerir como in√≠cio desta
    const ultima = linhasApontamento[linhasApontamento.length - 1];
    const inicioSugerido = ultima ? ultima.fim : '07:00';

    linhasApontamento.push({
        id: Date.now(),
        tipo: 'manual',
        atividade: 'H03 - Refei√ß√£o', // Padr√£o, usu√°rio muda
        inicio: inicioSugerido,
        fim: '',
        os: '', frota: '', sistema: '', subsistema: ''
    });
    renderizarListaLinhas();
    // ADICIONE ESTA LINHA:
    rolarParaUltimoItemApontamento(); 
}

function removerLinhaApontamento(index) {
    linhasApontamento.splice(index, 1);
    renderizarListaLinhas();
}

// Popup para escolher qual servi√ßo importar
// ============================================================
// IMPORTA√á√ÉO DE SERVI√áOS (FILTRADA POR DATA SELECIONADA)
// ============================================================

async function abrirPopupImportarServico() {
    // 1. Pega a data que o usu√°rio selecionou no formul√°rio de Apontamento
    const inputData = document.getElementById('apontamentoData');
    const dataAlvo = inputData ? inputData.value : dataHojeInputLocal();

    if (!dataAlvo) {
        showToast("Selecione uma data no formul√°rio primeiro.", "error");
        return;
    }

    // Feedback visual de carregamento
    showToast(`Buscando servi√ßos de ${formatarDataParaExibicao(dataAlvo)}...`, "info", 1500);

    let listaCombinada = [];

    try {
        // A. Busca no Hist√≥rico (Servi√ßos Finalizados / Dias Anteriores)
        const historico = await dbExec(STORE_HISTORICO, 'readonly', store => store.getAll());
        const doHistorico = historico.filter(h => h.dataOS === dataAlvo);

        // B. Busca na Mem√≥ria Atual (Servi√ßos do dia que ainda n√£o foram pro hist√≥rico ou acabaram de ser feitos)
        // Filtramos para n√£o duplicar o que j√° veio do hist√≥rico (pelo ID)
        const idsNoHistorico = new Set(doHistorico.map(h => String(h.id)));
        const daMemoria = servicos.filter(s => s.data === dataAlvo && !idsNoHistorico.has(String(s.id)));

        // C. Combina as duas listas
        // Prioridade: Hist√≥rico (pois tem o n√∫mero da O.S.) + Mem√≥ria (pendentes)
        listaCombinada = [...doHistorico, ...daMemoria];

    } catch (e) {
        console.error(e);
        showToast("Erro ao ler banco de dados.", "error");
        return;
    }

    // 2. TRAVA: Se n√£o achou nada nesta data, avisa e PARA.
    if (listaCombinada.length === 0) {
        showToast(`üìÖ Nenhum servi√ßo encontrado na data ${formatarDataParaExibicao(dataAlvo)}.`, "error", 4000);
        return; // N√£o abre o popup
    }

    // 3. Ordena por hor√°rio
    listaCombinada.sort((a, b) => a.inicio.localeCompare(b.inicio));

    // 4. Gera o HTML
    const listaHtml = listaCombinada.map(s => {
        const temOS = s.osNumero && s.osNumero.trim() !== "";
        const numeroOS = temOS ? s.osNumero : "PENDENTE";

        // Dados formatados
        const codAtiv = s.atividade ? s.atividade.split(' - ')[0] : '???';
        const nomeAtiv = s.atividade ? (s.atividade.split(' - ')[1] || '') : '';
        const sist = s.sistema || '?';
        const sub = s.subsistema ? s.subsistema.split(' - ')[0] : '?'; 
        const infoTecnica = `${codAtiv} - ${sist} - ${sub}`;
        
        // A√ß√£o: Se tem OS, importa direto. Se n√£o, pede para gerar.
        // Nota: Se veio do hist√≥rico sem OS, for√ßamos a explica√ß√£o.
        const action = temOS 
            ? `importarServicoFinalizado('${s.id}', '${s.frota}', '${s.atividade}', '${s.sistema}', '${s.subsistema}', '${s.inicio}', '${s.fim}', '${numeroOS}')` 
            : `explicarFaltaOS()`;
        
        // Estilos visuais
        const borderClass = temOS ? "border-green-200 hover:border-green-500 bg-white" : "border-orange-300 bg-orange-50";
        const badgeColor = temOS ? "bg-green-100 text-green-700 border-green-200" : "bg-orange-100 text-orange-700 border-orange-300";
        const icon = temOS ? "‚úÖ" : "‚ö†Ô∏è";

        return `
        <div onclick="${action}" 
             class="group relative border rounded-xl p-3 mb-3 shadow-sm flex items-center justify-between transition-all cursor-pointer active:scale-95 ${borderClass}">
            
            <div class="flex-1 min-w-0 pr-3">
                <div class="flex items-center justify-between mb-1.5">
                    <span class="bg-blue-100 text-blue-800 text-[11px] font-black px-2 py-0.5 rounded uppercase tracking-wide">
                        ${s.frota || 'N/D'}
                    </span>
                    <span class="text-[10px] font-bold px-1.5 py-0.5 rounded border ${badgeColor}">
                        OS: ${numeroOS}
                    </span>
                </div>

                <div class="text-sm font-black text-gray-800 leading-tight">
                    ‚öôÔ∏è ${infoTecnica}
                </div>
                
                <div class="flex justify-between items-end mt-1">
                    <div class="text-xs text-gray-500 truncate max-w-[60%]">${nomeAtiv}</div>
                    <span class="text-[10px] text-gray-700 font-bold bg-gray-50 border border-gray-200 px-1.5 py-0.5 rounded">
                        üïí ${s.inicio} - ${s.fim}
                    </span>
                </div>
            </div>

            <div class="text-lg">${icon}</div>
        </div>`;
    }).join('');

    const conteudoFinal = `
        <div class="bg-gray-50 -m-5 p-4 mb-0">
            <div class="flex justify-between items-center mb-3 px-1">
                <p class="text-xs text-gray-500 uppercase font-bold tracking-wider">Data: ${formatarDataParaExibicao(dataAlvo)}</p>
                <span class="text-xs bg-blue-100 text-blue-800 px-2 rounded-full font-bold">${listaCombinada.length} itens</span>
            </div>
            <div class="max-h-[60vh] overflow-y-auto pr-1 custom-scrollbar">
                ${listaHtml}
            </div>
        </div>
    `;

    abrirPopup('üì• Importar Servi√ßo', conteudoFinal, [{ texto: 'Cancelar', classe: 'w-full bg-gray-200 text-gray-700 py-3 font-bold', acao: fecharPopup }]);
}

// Fun√ß√£o auxiliar para evitar erro no HTML
function atualizarPreviewSeNecessario() {
    // Se j√° houver linhas desenhadas, avisa que a data mudou
    if (linhasApontamento.length > 1) { // >1 porque o DDS padr√£o sempre existe
        showToast("Aten√ß√£o: A data do formul√°rio mudou. Verifique se as linhas de tempo conferem.", "info", 4000);
    }
}


//explica o.s pendente 
function explicarFaltaOS() {
    // Fecha o popup de sele√ß√£o atual para abrir o de alerta
    fecharPopup();

    setTimeout(() => {
        const conteudo = `
            <div class="text-center p-2">
                <div class="bg-orange-100 text-orange-600 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4 text-3xl">
                    ‚ö†Ô∏è
                </div>
                <h3 class="text-lg font-bold text-gray-800 mb-2">Falta o N√∫mero da O.S.</h3>
                <p class="text-sm text-gray-600 mb-4">
                    Para garantir a qualidade do apontamento, voc√™ precisa primeiro 
                    <strong>finalizar a O.S.</strong> no hist√≥rico.
                </p>
                <div class="bg-gray-100 p-3 rounded text-left text-xs text-gray-700 mb-4">
                    <strong>Passo a passo:</strong><br>
                    1. V√° na aba <b>Hist√≥rico</b>.<br>
                    2. Encontre este servi√ßo.<br>
                    3. Digite o n√∫mero e clique em <b>Finalizar</b>.
                </div>
            </div>
        `;

        const botoes = [
            { 
                texto: 'Ir para o Hist√≥rico Agora', 
                classe: 'bg-blue-600 text-white hover:bg-blue-700 w-full mb-2 shadow-lg', 
                acao: irParaAbaHistorico // Chama a navega√ß√£o
            },
            { 
                texto: 'Voltar', 
                classe: 'bg-gray-200 text-gray-700 hover:bg-gray-300 w-full', 
                acao: abrirPopupImportarServico // Reabre a lista
            }
        ];

        abrirPopup('Aten√ß√£o Necess√°ria', conteudo, botoes);
    }, 200); // Pequeno delay para transi√ß√£o suave
}

//direcionar ao hist√≥rico 
function irParaAbaHistorico() {
    fecharPopup();
    // Usa a sua fun√ß√£o 'abrir' existente para trocar a tela
    abrir('historico');
    showToast("Localize o servi√ßo e finalize a O.S.", "info", 4000);
}


// importar servi√ßo 
async function importarServico(servicoId) {
    const s = servicos.find(x => x.id === servicoId);
    
    if (s) {
        let numeroOS = "";

        try {
            const historico = await dbExec(STORE_HISTORICO, 'readonly', store => store.getAll());
            
            // --- CORRE√á√ÉO DE TIPO DE DADO AQUI ---
            const itemHist = historico.find(h => h.id == s.id); // <- Usando ==
            
            if (!itemHist || !itemHist.osNumero || itemHist.osNumero.trim() === "") {
                showToast("Erro: Finalize a O.S. no Hist√≥rico antes de importar!", "error");
                fecharPopup(); 
                return; 
            }

            numeroOS = itemHist.osNumero;

        } catch (e) {
            console.error("Erro ao buscar O.S.", e);
            showToast("Erro ao validar O.S.", "error");
            return;
        }

        // Se passou, adiciona:
        linhasApontamento.push({
            id: Date.now(),
            idOriginal: s.id,
            tipo: 'servico',
            atividade: s.atividade, 
            inicio: s.inicio,
            fim: s.fim,
            frota: s.frota,
            os: numeroOS,
            sistema: s.sistema,
            subsistema: s.subsistema
        });

        renderizarListaLinhas();
        fecharPopup();
        
        const msg = numeroOS ? `Servi√ßo importado (OS: ${numeroOS})` : "Servi√ßo importado (Sem OS)";
        showToast(msg, "success");
        
        rolarParaUltimoItemApontamento(); 
    }
}


// Fun√ß√£o auxiliar para rolar at√© o novo item
function rolarParaUltimoItemApontamento() {
    // Pequeno delay para garantir que o HTML foi desenhado
    setTimeout(() => {
        const container = document.getElementById('listaLinhasApontamento');
        if (container && container.lastElementChild) {
            container.lastElementChild.scrollIntoView({ 
                behavior: 'smooth', 
                block: 'center' 
            });
            
            // Opcional: Um flash visual para destacar
            container.lastElementChild.classList.add('ring-2', 'ring-blue-400', 'ring-offset-2');
            setTimeout(() => {
                container.lastElementChild.classList.remove('ring-2', 'ring-blue-400', 'ring-offset-2');
            }, 1000);
        }
    }, 150);
}

// =================================================================================
// GERA√á√ÉO DA IMAGEM (CANVAS)
// =================================================================================
async function gerarPreviewApontamento() {
    const canvas = document.getElementById('canvasApontamento');
    if (!canvas) return;
    const ctx = canvas.getContext('2d');
    
    const elAjuste = document.getElementById('ajusteYGlobal');
    const ajusteY = elAjuste ? parseFloat(elAjuste.value) || 0 : 0;

    const img = new Image();
    img.src = COORD_FORM.imagemBase;

    try {
        await new Promise((resolve, reject) => { img.onload = resolve; img.onerror = reject; });
    } catch (e) { 
        showToast("ERRO: Imagem 'fundo_apontamento.jpg' n√£o encontrada!", "error"); 
        return; 
    }

    canvas.width = img.width;
    canvas.height = img.height;
    ctx.drawImage(img, 0, 0);

    ctx.font = "28px Arial"; 
    ctx.fillStyle = "#000000"; 
    ctx.textBaseline = "middle";

    // --- CABE√áALHO ---
    const tipoOficina = document.getElementById('apontamentoTipoOficina')?.value || 'externa';
    const dadosColab = document.getElementById('apontamentoColaborador')?.value || ' - ';
    const [nome, matricula] = dadosColab.split(' - ');
    const setor = document.getElementById('apontamentoSetor')?.value || '';
    const dataRaw = document.getElementById('apontamentoData')?.value || '';

    if (tipoOficina === 'externa') {
        ctx.fillText("X", COORD_FORM.cabecalho.oficinaExterna.x, COORD_FORM.cabecalho.oficinaExterna.y);
    } else {
        ctx.fillText("X", COORD_FORM.cabecalho.oficinaInterna.x, COORD_FORM.cabecalho.oficinaInterna.y);
    }

    ctx.fillText(nome.toUpperCase(), COORD_FORM.cabecalho.colaborador.x, COORD_FORM.cabecalho.colaborador.y);
    ctx.fillText(matricula, COORD_FORM.cabecalho.id.x, COORD_FORM.cabecalho.id.y);
    ctx.fillText(setor.toUpperCase(), COORD_FORM.cabecalho.setor.x, COORD_FORM.cabecalho.setor.y);

    if (dataRaw) {
        const [ano, mes, dia] = dataRaw.split('-');
        ctx.fillText(dia, COORD_FORM.cabecalho.dataDia.x, COORD_FORM.cabecalho.dataDia.y);
        ctx.fillText(mes, COORD_FORM.cabecalho.dataMes.x, COORD_FORM.cabecalho.dataMes.y);
        ctx.fillText(ano.slice(-2), COORD_FORM.cabecalho.dataAno.x, COORD_FORM.cabecalho.dataAno.y);
    }

    // --- LINHAS ---
    linhasApontamento.forEach((linha, i) => {
        if (i > 19) return; 

        const y = COORD_FORM.grid.inicioY + (i * COORD_FORM.grid.alturaLinha) + ajusteY;
        const x = COORD_FORM.grid.colunas;

        const numOS = linha.os || '';
        const frota = linha.frota || '';
        
        // Pega apenas o c√≥digo (Ex: "P030")
        const codAtiv = linha.atividade ? linha.atividade.split(' - ')[0] : ''; 
        
        const sist = linha.sistema || '';
        const sub = linha.subsistema ? linha.subsistema.split(' - ')[0] : '';

        // --- DESENHO DAS COLUNAS ---
        
        // 1. O.S.
        ctx.fillText(numOS, x.os, y); 

        // 2. Frota
        ctx.fillText(frota, x.frota, y);

        // 3. N¬∫ Opera√ß√£o (Vazio)
        // ctx.fillText(codAtiv, x.operacao, y); 
        
        // 4. Atividade (C√≥digo Curto)
        ctx.fillText(codAtiv, x.atividade, y);

        // 5. Sistema e Subsistema
        ctx.fillText(sist, x.sistema, y);
        ctx.fillText(sub, x.subsistema, y);

        // 6. Hor√°rios
        ctx.fillText(linha.inicio, x.inicio, y);
        ctx.fillText(linha.fim, x.fim, y);
        
        // 7. Localiza√ß√£o (Vazio)
        // ctx.fillText(localPadrao, x.local, y);
    });

    showToast("Preview gerado com sucesso!", "success");
}

function baixarApontamento(tipo) {
    const canvas = document.getElementById('canvasApontamento');
    
    if (!canvas || canvas.width < 100) { 
        showToast("Gere o preview primeiro!", "error"); 
        return; 
    }

    const dataInput = document.getElementById('apontamentoData').value;
    const nomeArquivo = `Apontamento_${dataInput || 'sem_data'}`;

    if (tipo === 'jpg') {
        const link = document.createElement('a');
        link.download = `${nomeArquivo}.jpg`;
        link.href = canvas.toDataURL('image/jpeg', 0.9); 
        link.click();
    }
    
}

async function baixarOuCompartilharPDF() {
    const canvas = document.getElementById('canvasApontamento');
    if (!canvas || canvas.width < 100) { 
        showToast("Gere o preview primeiro!", "error"); 
        return; 
    }

    const dataInput = document.getElementById('apontamentoData').value;
    const nomeArquivo = `Apontamento_${dataInput || 'hoje'}.pdf`;

    showToast("Gerando PDF...", "info");

    try {
        // 1. Gerar o PDF
        if (!window.jspdf) throw new Error("Biblioteca PDF ausente");
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF('p', 'mm', 'a4');
        const pdfWidth = doc.internal.pageSize.getWidth();
        const pdfHeight = doc.internal.pageSize.getHeight();
        const imgData = canvas.toDataURL('image/jpeg', 0.9);
        const ratio = canvas.height / canvas.width;
        const finalHeight = pdfWidth * ratio;

        if (finalHeight <= pdfHeight) {
            doc.addImage(imgData, 'JPEG', 0, 0, pdfWidth, finalHeight);
        } else {
            const finalWidth = pdfHeight / ratio;
            const xOffset = (pdfWidth - finalWidth) / 2;
            doc.addImage(imgData, 'JPEG', xOffset, 0, finalWidth, pdfHeight);
        }

        // 2. Verificar se √© poss√≠vel compartilhar (Android/iOS)
        if (navigator.share && navigator.canShare) {
            const pdfBlob = doc.output('blob');
            const file = new File([pdfBlob], nomeArquivo, { type: "application/pdf" });
            
            if (navigator.canShare({ files: [file] })) {
                await navigator.share({
                    files: [file],
                    title: 'Apontamento',
                    text: `Segue apontamento do dia ${formatarDataParaExibicao(dataInput)}`
                });
                showToast("Compartilhado!", "success");
                return; // Sucesso, para por aqui
            }
        }

        // 3. Fallback: Se n√£o der pra compartilhar (PC), apenas baixa
        doc.save(nomeArquivo);
        showToast("PDF Baixado!", "success");

    } catch (error) {
        console.error(error);
        // Se cancelou o share, n√£o √© erro
        if (error.name !== 'AbortError') showToast("Erro ao processar PDF", "error");
    }
}


        // ---------------------------------
        // M√ìDULO: HIST√ìRICO
        // ---------------------------------
        async function renderizarSecaoHistorico(container) { container.innerHTML = `<div class="bg-white p-4 rounded-lg shadow mb-4"><button onclick="abrirPopupApagarPorData()" class="w-full sm:w-auto py-2 px-4 rounded-md font-semibold bg-red-600 text-white hover:bg-red-700">üóëÔ∏è Apagar Hist√≥rico por Data</button></div><div id="historico_lista" class="space-y-4"></div>`; await mostrarHistorico(); }
        async function salvarOSnoHistorico(serviceId) { const servico = servicos.find(s => s.id === serviceId); if (!servico || !servico.texto) return; try { const todosItens = await dbExec(STORE_HISTORICO, 'readonly', s => s.getAll()); let itemExistente = todosItens.find(item => item.id === servico.id); const itemHistorico = { id: servico.id, frota: servico.frota, tipo: servico.tipo, texto: servico.texto, descricao: servico.descricao, atividade: servico.atividade, sistema: servico.sistema, subsistema: servico.subsistema, inicio: servico.inicio, fim: servico.fim, dataOS: servico.data, dataKey: formatarDataParaExibicao(servico.data).replace(/\//g, '-'), status: itemExistente ? itemExistente.status : "pendente", osNumero: itemExistente ? itemExistente.osNumero : "", datahoraRegistro: itemExistente ? itemExistente.datahoraRegistro : new Date().toLocaleString('pt-BR') }; if (itemExistente) itemHistorico.uniqueId = itemExistente.uniqueId; await dbExec(STORE_HISTORICO, 'readwrite', s => s.put(itemHistorico)); } catch (err) { showToast("Erro ao salvar O.S. no hist√≥rico.", "error"); } }
        async function mostrarHistorico() { const div = document.getElementById("historico_lista"); if (!div) return; try { const todosItens = await dbExec(STORE_HISTORICO, 'readonly', s => s.getAll()); if (todosItens.length === 0) { div.innerHTML = "<p class='text-center text-gray-500 p-4'>Nenhuma O.S. registada no hist√≥rico.</p>"; return; } const agrupado = todosItens.reduce((acc, item) => { const dataKey = item.dataOS; if (!acc[dataKey]) acc[dataKey] = []; acc[dataKey].push(item); return acc; }, {}); const datasOrdenadas = Object.keys(agrupado).sort((a, b) => b.localeCompare(a));
div.innerHTML = datasOrdenadas.map(dataKey => `
    <div class="bg-white rounded-lg shadow-md">
        
        <h3 class="text-xl font-semibold text-blue-700 mb-0 border-b-2 pb-2 p-3 flex justify-between items-center cursor-pointer hover:bg-gray-50 transition-colors" onclick="toggleHistoricoDia('${dataKey}')">
            <span>Servi√ßos de: ${formatarDataParaExibicao(dataKey)}</span>
            <span id="toggler-dia-${dataKey}" class="text-lg">&#9650;</span>
        </h3>
        
        <div id="historico-dia-${dataKey}" class="p-3 space-y-3" style="display: block;">
            ${agrupado[dataKey].sort((a, b) => a.inicio.localeCompare(b.inicio)).map(s => `
                <div class="bg-gray-50 p-3 rounded-lg shadow-sm border-l-4 ${s.status === 'pendente' ? 'border-orange-500' : 'border-green-600'}">
                    <div class="mb-2 text-sm">
                        <span class="font-semibold text-blue-700">${s.frota}</span> | ${s.atividade.split(" - ")[0]} - ${s.sistema} - ${(s.subsistema || "").split(" - ")[0]} [${s.inicio} - ${s.fim}]
                    </div>
                    <div class="text-sm text-gray-800 mb-3">
                        <p class="font-semibold">Descri√ß√£o:</p>
                        <div class="pl-2 whitespace-pre-line">${formatarDescricao(s.descricao)}</div>
                    </div>
                    
<div class="flex flex-wrap items-center justify-between gap-x-4 gap-y-2 text-sm">
    <div class="flex items-center gap-x-4">
        <label class="font-medium whitespace-nowrap">N¬∫ O.S.:</label>
        <input id="os_input_${s.uniqueId}" class="w-28 p-1 border rounded" value="${s.osNumero || ""}" oninput="validarOSInput(${s.uniqueId})" ${s.status === "pendente" ? "" : "disabled"}>
        <span class="font-semibold ${s.status === 'pendente' ? 'text-orange-500' : 'text-green-600'}">${s.status === "pendente" ? "‚ùå Pendente" : "‚úÖ Finalizada"}</span>
    </div>
    
    <button onclick="toggleBotoesHistorico(${s.uniqueId})" class="py-1 px-3 rounded bg-gray-200 hover:bg-gray-300 text-xs font-semibold">
        A√ß√µes &#9776;
    </button>
</div>

<div id="botoes-historico-${s.uniqueId}" class="mt-3 grid grid-cols-2 sm:grid-cols-4 gap-2" style="display: none;">
    ${s.status === 'pendente' ? `<button id="btnFinalizarOS_${s.uniqueId}" onclick="finalizarOS(${s.uniqueId})" class="py-2 rounded bg-blue-600 text-white text-xs" ${!s.osNumero ? 'disabled' : ''}>Finalizar</button>` : `<button onclick="habilitarEdicaoOS(${s.uniqueId}, this)" class="py-2 rounded bg-yellow-500 text-white text-xs">Editar N¬∫</button>`}
    <button onclick="copiarHistorico(${s.uniqueId})" class="py-2 rounded bg-gray-200 text-xs">Copiar Texto O.S.</button>
    <button onclick="compartilharHistorico(${s.uniqueId})" class="py-2 rounded bg-green-500 text-white text-xs">Compartilhar O.S.</button>
    <button onclick="excluirHistoricoItem(${s.uniqueId})" class="py-2 rounded bg-red-600 text-white text-xs">Excluir</button>
</div>
<textarea id="texto_os_hist_${s.uniqueId}" class="hidden">${s.texto}</textarea>
                </div>
            `).join('')}
        </div>
    </div>
`).join('');
 } catch (e) { div.innerHTML = "<p class='text-center text-red-500 p-4'>Erro ao carregar hist√≥rico.</p>"; console.error(e); } }
        function validarOSInput(id) { document.getElementById(`btnFinalizarOS_${id}`).disabled = !document.getElementById(`os_input_${id}`).value.trim(); }
        function copiarHistorico(id) { const text = document.querySelector(`#texto_os_hist_${id}`).value; navigator.clipboard.writeText(text); showToast('Texto da O.S. copiado!', 'success'); }
        function compartilharHistorico(id) { const text = document.querySelector(`#texto_os_hist_${id}`).value; window.open(`https://wa.me/?text=${encodeURIComponent(text)}`, "_blank"); }
        async function finalizarOS(id) { const osNumero = document.getElementById(`os_input_${id}`).value.trim(); if (!osNumero) { showToast('Digite o n√∫mero da O.S.', 'error'); return; } try { const item = await dbExec(STORE_HISTORICO, 'readonly', s => s.get(id)); item.status = 'finalizada'; item.osNumero = osNumero; await dbExec(STORE_HISTORICO, 'readwrite', s => s.put(item)); await mostrarHistorico(); showToast('O.S. finalizada com sucesso!', 'success'); } catch (e) { showToast('Erro ao finalizar O.S.', 'error'); } }
        function habilitarEdicaoOS(id, btn) { const input = document.getElementById(`os_input_${id}`); input.disabled = false; input.focus(); btn.innerText = 'Salvar'; btn.onclick = () => confirmarEdicaoOS(id, btn); }
        async function confirmarEdicaoOS(id, btn) { const input = document.getElementById(`os_input_${id}`); const numero = input.value.trim(); if (!numero) { showToast("N¬∫ O.S n√£o pode ser vazio.", "error"); return; } try { const item = await dbExec(STORE_HISTORICO, 'readonly', s => s.get(id)); item.osNumero = numero; await dbExec(STORE_HISTORICO, 'readwrite', s => s.put(item)); await mostrarHistorico(); showToast("N¬∫ O.S atualizado!", 'success'); } catch (error) { showToast("Erro ao atualizar O.S.", 'error'); } }
        async function excluirHistoricoItem(id) { const confirmado = await new Promise(resolve => abrirPopupConfirmar('Excluir Registro', 'Tem certeza que deseja excluir este item do hist√≥rico?', resolve)); if (confirmado) { try { await dbExec(STORE_HISTORICO, 'readwrite', s => s.delete(id)); await mostrarHistorico(); showToast('Item exclu√≠do do hist√≥rico.', 'success'); } catch (e) { showToast('Erro ao excluir item.', 'error'); } } }
        async function abrirPopupApagarPorData() { try { const todosItens = await dbExec(STORE_HISTORICO, 'readonly', s => s.getAll()); if (todosItens.length === 0) { showToast('Hist√≥rico est√° vazio.', 'info'); return; } const datas = [...new Set(todosItens.map(item => item.dataOS))].sort((a, b) => b.localeCompare(a)); const options = datas.map(d => `<option value="${d}">${formatarDataParaExibicao(d)}</option>`).join(''); const selectHTML = `<select id="selectDataParaApagar" class="w-full p-2 border rounded">${options}</select>`; abrirPopupConfirmar('Apagar por Data', `Selecione a data para apagar todo o hist√≥rico correspondente:<br>${selectHTML}`, async confirmado => { if (confirmado) { const dataSelecionada = document.getElementById('selectDataParaApagar').value; const confirmadoFinal = await new Promise(resolve => abrirPopupConfirmar('Confirma√ß√£o Final', `Tem certeza que deseja apagar TODOS os registros de ${formatarDataParaExibicao(dataSelecionada)}?`, resolve)); if (confirmadoFinal) { const todos = await dbExec(STORE_HISTORICO, 'readonly', s => s.getAll()); const idsParaApagar = todos.filter(item => item.dataOS === dataSelecionada).map(item => item.uniqueId); const tx = db.transaction(STORE_HISTORICO, 'readwrite'); for (const id of idsParaApagar) { tx.objectStore(STORE_HISTORICO).delete(id); } tx.oncomplete = () => { mostrarHistorico(); showToast(`Hist√≥rico de ${formatarDataParaExibicao(dataSelecionada)} apagado!`, 'success'); }; } } }); } catch (e) { showToast("Erro ao carregar datas do hist√≥rico.", "error"); } }
        // ---------------------------------
        // OUTROS M√ìDULOS
        // ---------------------------------
        /**
 * NOVA FUN√á√ÉO: Controla a visibilidade (expandir/recolher) dos servi√ßos de um dia espec√≠fico no hist√≥rico.
 * @param {string} dataKey - A data (no formato YYYY-MM-DD) que serve como identificador do grupo.
 */
function toggleHistoricoDia(dataKey) {
    const listaServicos = document.getElementById(`historico-dia-${dataKey}`);
    const toggler = document.getElementById(`toggler-dia-${dataKey}`);

    if (listaServicos && toggler) {
        // Verifica se a lista de servi√ßos est√° escondida
        const isHidden = listaServicos.style.display === 'none';
        
        // Alterna a exibi√ß√£o e o √≠cone
        listaServicos.style.display = isHidden ? 'block' : 'none';
        toggler.innerHTML = isHidden ? '&#9650;' : '&#9660;'; // Seta para cima (‚ñ≤) / Seta para baixo (‚ñº)
    }
}
/**
 * NOVA FUN√á√ÉO: Controla a visibilidade (expandir/recolher) dos bot√µes de a√ß√£o
 * de um item espec√≠fico no hist√≥rico.
 * @param {number} uniqueId - O ID √∫nico do item de servi√ßo no hist√≥rico.
 */
function toggleBotoesHistorico(uniqueId) {
    const containerBotoes = document.getElementById(`botoes-historico-${uniqueId}`);
    if (containerBotoes) {
        const isHidden = containerBotoes.style.display === 'none';
        // Usamos 'grid' ao inv√©s de 'block' porque as classes do Tailwind usam display: grid para este elemento
        containerBotoes.style.display = isHidden ? 'grid' : 'none';
    }
}

        async function renderizarSecaoEstatisticas(container) { const maquinasPrincipais = frotasTurno.filter(f => f.tipo === 'maquina'); const totalHorasParadas = calcularHorasParadasCorretivasTotais(); const dmTurnoAtual = calcularDMGeral(maquinasPrincipais, totalHorasParadas); const osHistorico = await dbExec(STORE_HISTORICO, 'readonly', s => s.getAll()); const osPorDia = {}; osHistorico.forEach(item => { const dataKey = item.dataOS.split('-').reverse().join('/'); osPorDia[dataKey] = (osPorDia[dataKey] || 0) + 1; }); const labels = Object.keys(osPorDia).sort((a, b) => new Date(a.split('/').reverse().join('-')) - new Date(b.split('/').reverse().join('-'))).slice(-15); const data = labels.map(label => osPorDia[label]); container.innerHTML = `<div class="bg-white p-4 rounded-lg shadow space-y-6"><h2 class="text-2xl font-semibold text-blue-700 border-b pb-3 mb-6 text-center">Estat√≠sticas do Turno</h2><div class="p-4 border border-gray-200 rounded-lg text-center"><h4 class="text-lg font-semibold text-blue-700 mb-2">DM do Turno Atual</h4><p class="text-4xl font-bold text-green-600">${dmTurnoAtual}%</p><p class="text-sm text-gray-500 mt-1">Base: ${maquinasPrincipais.length} m√°quinas. Considera paradas corretivas de todas as frotas.</p></div><div class="p-4 border border-gray-200 rounded-lg"><h4 class="text-lg font-semibold text-blue-700 mb-3 text-center">O.S. Registradas (√öltimos 15 dias)</h4><canvas id="graficoHistoricoOS"></canvas></div></div>`; const ctx = document.getElementById('graficoHistoricoOS'); if (graficoOS) graficoOS.destroy(); if (ctx) { graficoOS = new Chart(ctx, { type: 'bar', data: { labels, datasets: [{ label: 'N¬∫ de O.S.', data, backgroundColor: 'rgba(37, 99, 235, 0.6)', borderColor: 'rgba(37, 99, 235, 1)', borderWidth: 1 }] }, options: { scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } } } }); } }
        async function renderizarSecaoRelatorio(container) { container.innerHTML = `<div class="bg-white p-4 rounded-lg shadow space-y-6"><div id="aviso_relatorio_desatualizado" class="hidden p-3 mb-4 text-sm text-yellow-700 bg-yellow-100 rounded-lg" role="alert"><span class="font-medium">Aten√ß√£o!</span> Existem servi√ßos novos ou alterados desde que este relat√≥rio foi gerado. Clique em "Gerar Relat√≥rio Final" para o atualizar.</div><div class="p-4 border border-gray-200 rounded-lg"><h4 class="text-lg font-semibold text-blue-700 mb-3 border-b pb-2 text-center">Visualiza√ß√£o</h4><div id="relatorio_formatado" class="p-3 bg-gray-50 border rounded-md min-h-[100px] whitespace-pre-line"></div><textarea id="relatorio_bruto" class="hidden mt-1 w-full p-2 border rounded-md font-mono h-64"></textarea><input type="hidden" id="relatorio_snapshot"></div><div class="p-4 border border-gray-200 rounded-lg"><h4 class="text-lg font-semibold text-blue-700 mb-3 border-b pb-2 text-center">A√ß√µes</h4><div class="grid grid-cols-1 sm:grid-cols-2 gap-3"><button onclick="gerarRelatorioFinal()" class="py-2 px-4 rounded-md font-semibold bg-blue-600 text-white hover:bg-blue-700">Gerar Relat√≥rio Final</button><button onclick="compartilharRelatorio()" class="py-2 px-4 rounded-md font-semibold bg-gray-500 hover:bg-gray-600 text-white">Compartilhar</button><button onclick="toggleEdicaoRelatorio(this)" class="py-2 px-4 rounded-md font-semibold bg-yellow-500 hover:bg-yellow-600 text-white">Editar Relat√≥rio</button><button onclick="limparRelatorio()" class="py-2 px-4 rounded-md font-semibold bg-red-600 text-white hover:bg-red-700">Limpar Relat√≥rio</button></div></div></div>`; try { const dados = await dbExec(STORE_TURNO, 'readonly', s => s.get(TURNO_ATUAL_ID)); const relatorioSalvo = dados?.relatorio || ''; const snapshotSalvo = dados?.relatorioGeradoComServicos || '[]'; if (relatorioSalvo) { document.getElementById('relatorio_bruto').value = relatorioSalvo; document.getElementById('relatorio_formatado').innerHTML = interpretarMarkdown(relatorioSalvo); document.getElementById('relatorio_snapshot').value = snapshotSalvo; if (snapshotSalvo !== JSON.stringify(servicos)) { document.getElementById('aviso_relatorio_desatualizado').classList.remove('hidden'); } } } catch (e) { console.error("Erro ao carregar relat√≥rio salvo:", e); } }
        async function gerarRelatorioFinal() { 
    if (!validarCamposTurnoBasicos()) return; 

    const data = document.getElementById("dataTurno").value; 
    const fazenda = document.getElementById("fazenda").value.trim().toUpperCase(); 
    const frente = document.getElementById("frente").value.trim().toUpperCase(); 
    const turnoLetra = document.getElementById("turnoLetra").value; 
    const equipeTexto = equipe.length > 0 ? equipe.map(item => `${item.nome.toUpperCase()} - ${item.matricula}`).join('\n') : "EQUIPE N√ÉO INFORMADA"; 
    
    // FILTRAGEM DE SERVI√áOS V√ÅLIDOS/GERADOS (Para Relat√≥rio Limpo)
    const servicosGerados = servicos.filter(s => s.texto && s.texto.trim() !== '');

    // 1. M√ÅQUINAS PRINCIPAIS (BASE para o DM Geral)
    const maquinasPrincipais = frotasTurno.filter(f => f.tipo === 'maquina'); 
    const horasPlanejadasTotaisGeral = maquinasPrincipais.reduce((soma, f) => soma + (f.horas || 0), 0);
    
    // 2. HORAS PARADAS TOTAIS (Numerador do DM Geral - Inclui TODAS as frotas)
    const horasParadasTotais = calcularHorasParadasCorretivasTotais(servicosGerados);
    
    // 3. C√ÅLCULO FINAL DO DM GERAL (Apenas m√°quinas principais na base)
    const dmGeral = calcularDMGeral(maquinasPrincipais, horasParadasTotais); 
    
    const mediaHorasPorMaquina = maquinasPrincipais.length > 0 ? (horasPlanejadasTotaisGeral / maquinasPrincipais.length) : 0; 
    
    // Gera√ß√£o do Cabe√ßalho
    let relatorio = `*MANUTEN√á√ÉO ${frente} BRACELL*\n\nüìÖ *DATA:* ${formatarDataParaExibicao(data)}\n*FAZENDA:* ${fazenda}\n*FRENTE:* ${frente}\n*TURNO:* ${turnoLetra}\n*EQUIPE:*\n${equipeTexto}\n\n*QTD DE M√ÅQUINAS PRINCIPAIS:* ${maquinasPrincipais.length}\n*HORAS PLANEJADAS (por m√°quina):* ${mediaHorasPorMaquina.toFixed(2).replace('.', ',')}h\n*HORAS PLANEJADAS TOTAIS (m√°quinas):* ${horasPlanejadasTotaisGeral.toFixed(2).replace('.', ',')}h\n*HORAS TOTAIS PARADAS (corretivas):* ${horasParadasTotais.toFixed(2).replace('.', ',')}h (${calcularDuracaoEmHorasMinutos(horasParadasTotais)})\n\nüü¢ *DM DO TURNO:* ${dmGeral}%\n\n--- DETALHAMENTO POR FROTA ---\n`; 
    
    // DETALHAMENTO POR FROTA (Itera sobre todas as frotas que tiveram servi√ßo gerado)
    const frotasComServico = [...new Set(servicosGerados.map(s => s.frota))].sort(); 
    
    frotasComServico.forEach(nomeFrota => { 
        const frota = frotasTurno.find(f => f.nome === nomeFrota); 
        if (!frota) return; 
        
        const horasPlanejadasFrota = frota.horas || 0;
        const servicosDaFrotaGerados = servicosGerados.filter(s => s.frota === nomeFrota);
        
        const horasParadaDaFrota = servicosDaFrotaGerados.filter(s => s.tipo === "CORRETIVA" && s.parada === "sim").reduce((total, s) => total + calcularDuracaoServico(s).horas, 0);
        
        // C√ÅLCULO DM POR FROTA INDIVIDUAL: 
        let dmFrota = "100.00"; // Padr√£o

        if (horasPlanejadasFrota > 0) {
            // M√°quina Principal: C√°lculo normal (usa Horas Planejadas como denominador)
            const horasOperando = Math.max(0, horasPlanejadasFrota - horasParadaDaFrota);
            dmFrota = ((horasOperando / horasPlanejadasFrota) * 100).toFixed(2); 
        } else if (horasParadaDaFrota > 0) {
            // Frota sem H.P. (Implemento/Apoio) que Parou: For√ßamos 0.00%
            dmFrota = "0.00"; 
        } 
        // Se horas planejadas = 0 e parada = 0, dmFrota permanece 100.00% (Impl√≠cito)

        relatorio += `\nüöú *${frota.nome.toUpperCase()}* ${getTipoTexto(frota.tipo)}\nHoras Planejada: ${horasPlanejadasFrota.toFixed(2).replace('.', ',')}h\nHoras Parada (Corretivas): ${horasParadaDaFrota.toFixed(2).replace('.', ',')}h (${calcularDuracaoEmHorasMinutos(horasParadaDaFrota)})\n*DM:* ${dmFrota}%\n*RELAT√ìRIO DE SERVI√áOS:*\n\n`; 
        
        servicosDaFrotaGerados.forEach(s => { 
            const duracao = calcularDuracaoServico(s); 
            const codAtiv = (s.atividade || "N/A").split(" - ")[0]; 
            const codSistema = s.sistema || "N/A"; 
            const codSub = (s.subsistema || "N/A").split(" - ")[0]; 
            const emoji = s.tipo === "CORRETIVA" ? "üîß" : (s.tipo === "CONDICIONAL" ? "‚è≥" : "‚ú®"); 
            
            relatorio += `${s.descricao.trim()}\n  (${codAtiv} - ${codSistema} - ${codSub}) ${emoji} [${s.tipo}]\n  ‚è±Ô∏è Dura√ß√£o: ${duracao.texto} (Decimal: ${duracao.horas.toFixed(2).replace('.', ',')}h)\n`; 
            
            if (s.oportunidade) { relatorio += `Oportunidade: ${s.oportunidade}\n`; } 
            relatorio += '\n'; 
        }); 
    }); 
    
    document.getElementById('relatorio_bruto').value = relatorio; 
    document.getElementById('relatorio_formatado').innerHTML = interpretarMarkdown(relatorio); 
    document.getElementById('relatorio_snapshot').value = JSON.stringify(servicos); 
    document.getElementById('aviso_relatorio_desatualizado').classList.add('hidden'); 
    salvarTudo(true); 
    showToast('Relat√≥rio gerado e salvo!', 'successo!'); 
}

        function calcularDuracaoEmHorasMinutos(horasDecimais) { if (isNaN(horasDecimais) || horasDecimais <= 0) return "0min"; const h = Math.floor(horasDecimais); const m = Math.round((horasDecimais - h) * 60); let texto = ""; if (h > 0) texto += `${h}h `; if (m > 0) texto += `${m}min`; return texto.trim() || "0min"; }
        function compartilharRelatorio() { const texto = document.getElementById("relatorio_bruto").value; if (!texto.trim()) { showToast("Gere o relat√≥rio primeiro.", "error"); return; } window.open(`https://wa.me/?text=${encodeURIComponent(texto)}`, "_blank"); }
        function toggleEdicaoRelatorio(button) { const textarea = document.getElementById("relatorio_bruto"); const div = document.getElementById("relatorio_formatado"); if (textarea.classList.contains('hidden')) { textarea.value = div.innerText; textarea.classList.remove('hidden'); div.classList.add('hidden'); button.innerText = 'Salvar Edi√ß√£o'; button.classList.replace('bg-yellow-500', 'bg-green-500'); } else { div.innerHTML = interpretarMarkdown(textarea.value); textarea.classList.add('hidden'); div.classList.remove('hidden'); button.innerText = 'Editar Relat√≥rio'; button.classList.replace('bg-green-500', 'bg-yellow-500'); showToast('Relat√≥rio atualizado.', 'success'); } }
        async function limparRelatorio() { const confirmado = await new Promise(resolve => abrirPopupConfirmar('Limpar Relat√≥rio', 'Deseja limpar o relat√≥rio atual?', resolve)); if (confirmado) { document.getElementById('relatorio_bruto').value = ''; document.getElementById('relatorio_formatado').innerHTML = ''; showToast('Relat√≥rio limpo.', 'success'); } }
        function renderizarSecaoConfig(container) { container.innerHTML = `<div class="bg-white p-6 rounded-lg shadow-lg max-w-2xl mx-auto space-y-6"><h2 class="text-2xl font-semibold text-blue-700 border-b pb-3 mb-6 text-center">Configura√ß√µes</h2><div class="space-y-2 text-center p-4 bg-gray-50 rounded-lg"><h3 class="text-lg font-semibold text-gray-800">Cat√°logo de Pe√ßas</h3><div class="space-y-4 mt-2"><label for="fileImportExcel" class="w-full cursor-pointer flex items-center justify-center gap-2 bg-green-600 hover:bg-teal-700 text-white py-3 px-4 rounded-md font-semibold transition-colors">‚¨ÜÔ∏è Importar Cat√°logo (Excel)</label><input type="file" id="fileImportExcel" accept=".xlsx, .xls" class="hidden" onchange="importarCatalogoExcel(event)"><label for="fileImportCatalogo" class="w-full cursor-pointer flex items-center justify-center gap-2 bg-green-600 hover:bg-green-700 text-white py-3 px-4 rounded-md font-semibold transition-colors">‚¨ÜÔ∏è Importar Cat√°logo (CSV)</label><input type="file" id="fileImportCatalogo" accept=".csv" class="hidden" onchange="importarCatalogoCSV(event)"><button onclick="exportarCatalogoCSV()" class="w-full flex items-center justify-center gap-2 bg-gray-500 hover:bg-gray-600 text-white py-3 px-4 rounded-md font-semibold transition-colors">‚¨áÔ∏è Exportar Cat√°logo (CSV)</button><button onclick="iniciarLimpezaCatalogo()" class="w-full flex items-center justify-center gap-2 bg-red-700 hover:bg-red-800 text-white py-3 px-4 rounded-md font-semibold transition-colors">üóëÔ∏è Limpar Cat√°logo Remoto (com senha)</button></div><p class="text-xs text-gray-500 mt-2">A importa√ß√£o/limpeza do cat√°logo afeta todos os utilizadores.</p></div><div class="space-y-2 text-center p-4 bg-gray-50 rounded-lg"><h3 class="text-lg font-semibold text-gray-800">Backup e Restauro</h3><div class="space-y-4 mt-2"><button onclick="gerarBackupCompleto()" class="w-full flex items-center justify-center gap-2 bg-blue-500 hover:bg-blue-600 text-white py-3 px-4 rounded-md font-semibold transition-colors">üóÑÔ∏è Exportar Dados Completos</button><div class="text-center"><label for="fileBackupCompletoInput" class="w-full cursor-pointer flex items-center justify-center gap-2 bg-blue-700 hover:bg-blue-800 text-white py-3 px-4 rounded-md font-semibold transition-colors">üîÑ Importar Dados Completos</label><input type="file" id="fileBackupCompletoInput" accept=".json" class="hidden" onchange="restaurarBackupCompleto(event)"><p class="text-xs text-gray-500 mt-1">Aten√ß√£o: <strong class="text-red-600">Isto substituir√° todos os dados atuais.</strong></p></div></div></div><div class="space-y-2 text-center p-4 bg-red-50 rounded-lg"><h3 class="text-lg font-semibold text-red-700">Zona de Perigo</h3><div class="space-y-4 mt-2"><button onclick="limparServicosTurnoAtual()" class="w-full py-3 px-4 rounded-md font-semibold bg-red-500 text-white hover:bg-red-600">üóëÔ∏è Limpar Servi√ßos do Turno Atual</button><button onclick="resetarAplicacao()" class="w-full py-3 px-4 rounded-md font-semibold bg-red-700 text-white hover:bg-red-800">üóëÔ∏è Resetar Todos os Dados da Aplica√ß√£o</button></div></div><div class="space-y-2 text-center mt-6"><h3 class="text-lg font-semibold text-gray-800">Desenvolvimento</h3><button onclick="forcarLimpezaCacheEAtualizar()" class="w-full md:w-3/4 lg:w-1/2 mx-auto py-3 px-4 rounded-md font-semibold bg-indigo-600 text-white hover:bg-indigo-700">üßπ For√ßar Atualiza√ß√£o de Cache</button><p class="text-xs text-gray-500 mt-1">Use se as altera√ß√µes visuais n√£o aparecerem.</p></div></div>`; }
        async function limparServicosTurnoAtual() { const confirmado = await new Promise(resolve => abrirPopupConfirmar('Limpar Servi√ßos', 'Tem a certeza que deseja apagar TODOS os servi√ßos do turno atual?', resolve)); if (confirmado) { servicos = []; salvarTudo(); showToast('Servi√ßos do turno atual limpos.', 'success'); if (document.getElementById('servicosLista')) renderizarServicos(); } }
        async function resetarAplicacao() { const confirmado = await new Promise(resolve => abrirPopupConfirmar('Resetar Aplica√ß√£o', '<strong>Aten√ß√£o!</strong><br>Isto apagar√° TODOS os dados. Fa√ßa um backup antes. Deseja continuar?', resolve)); if (confirmado) { try { if (db) db.close(); const deleteRequest = indexedDB.deleteDatabase(DB_NAME); deleteRequest.onsuccess = () => { showToast("Dados resetados. A aplica√ß√£o ser√° recarregada.", 'success'); setTimeout(() => window.location.reload(), 1500); }; deleteRequest.onerror = () => showToast("Erro ao apagar o banco de dados.", 'error'); deleteRequest.onblocked = () => showToast("A exclus√£o foi bloqueada. Feche outras abas desta aplica√ß√£o.", 'error'); } catch (e) { showToast("Erro ao tentar resetar a aplica√ß√£o.", 'error'); } } }
        async function gerarBackupCompleto() { try { const dadosTurno = await dbExec(STORE_TURNO, 'readonly', s => s.get(TURNO_ATUAL_ID)) || {}; const dadosHistorico = await dbExec(STORE_HISTORICO, 'readonly', s => s.getAll()) || []; if (Object.keys(dadosTurno).length <= 1 && dadosHistorico.length === 0) { showToast("Nenhum dado para fazer backup.", 'info'); return; } const dadosParaBackup = { turno: dadosTurno, historico: dadosHistorico }; const blob = new Blob([JSON.stringify(dadosParaBackup, null, 2)], { type: "application/json" }); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = `backup_meuturno_${new Date().toISOString().slice(0, 10)}.json`; a.click(); URL.revokeObjectURL(url); showToast("Backup gerado com sucesso!", 'success'); } catch (err) { showToast("Erro ao gerar o backup.", 'error'); } }
        async function restaurarBackupCompleto(event) { const file = event.target.files[0]; if (!file) return; const confirmado = await new Promise(resolve => abrirPopupConfirmar('Restaurar Backup', '<strong>Aten√ß√£o!</strong><br>Isto substituir√° TODOS os dados atuais. Deseja continuar?', resolve)); if (!confirmado) { event.target.value = null; return; } const reader = new FileReader(); reader.onload = async (e) => { try { const dados = JSON.parse(e.target.result); if (!dados.turno || !dados.historico) throw new Error("Formato de backup inv√°lido."); await dbExec(STORE_TURNO, 'readwrite', s => s.put(dados.turno)); const tx = db.transaction(STORE_HISTORICO, 'readwrite'); const hStore = tx.objectStore(STORE_HISTORICO); hStore.clear(); for (const item of dados.historico) { if (item.uniqueId) delete item.uniqueId; hStore.add(item); } tx.oncomplete = () => { showToast("Backup restaurado! A aplica√ß√£o ser√° recarregada.", 'success'); setTimeout(() => window.location.reload(), 1500); }; tx.onerror = () => { throw new Error("Falha na transa√ß√£o do hist√≥rico."); }; } catch (err) { showToast(`Erro ao restaurar: ${err.message}`, 'error'); } finally { event.target.value = null; } }; reader.readAsText(file); }
        async function forcarLimpezaCacheEAtualizar() { if (!('serviceWorker' in navigator && 'caches' in window)) { showToast("O seu navegador n√£o suporta as APIs necess√°rias.", "error"); return; } const confirmado = await new Promise(resolve => abrirPopupConfirmar('For√ßar Atualiza√ß√£o?', 'Isto ir√° limpar todos os dados em cache da aplica√ß√£o e recarregar a p√°gina. √â √∫til para garantir que as √∫ltimas altera√ß√µes de c√≥digo sejam aplicadas. Deseja continuar?', resolve, 'Sim, Limpar e Recarregar')); if (confirmado) { try { const registrations = await navigator.serviceWorker.getRegistrations(); for (const registration of registrations) { await registration.unregister(); } const cacheNames = await caches.keys(); const cachesToDelete = cacheNames.filter(name => name.startsWith('meu-turno-app-cache-')); await Promise.all(cachesToDelete.map(name => caches.delete(name))); showToast("Cache limpo! A recarregar a aplica√ß√£o...", "success"); setTimeout(() => { window.location.reload(true); }, 1500); } catch (error) { console.error('Erro ao for√ßar a limpeza de cache:', error); showToast("Ocorreu um erro ao tentar limpar o cache.", "error"); } } }

        async function importarCatalogoCSV(event) {
            const file = event.target.files[0];
            if (!file) return;

            const confirmado = await new Promise(resolve =>
                abrirPopupConfirmar('Importar Cat√°logo', 'Tem a certeza de que deseja importar este ficheiro? Itens com o mesmo C√≥digo SAP ser√£o ignorados.', resolve)
            );
            if (!confirmado) {
                event.target.value = '';
                return;
            }

            const reader = new FileReader();
            reader.onload = async (e) => {
                const text = e.target.result;
                try {
                    const itensDoCSV = parseCSV(text);
                    if (itensDoCSV.length === 0) {
                        showToast("Nenhum item v√°lido encontrado no ficheiro CSV.", "error");
                        return;
                    }
                    const codigosSapExistentes = new Set(catalogoLocal.map(item => item.codigoSap));
                    const itensNovos = itensDoCSV.filter(item => !codigosSapExistentes.has(item.codigoSap));

                    if (itensNovos.length === 0) {
                        showToast("Importa√ß√£o conclu√≠da. Nenhum item novo para adicionar.", "success");
                        return;
                    }

                    await enviarLoteParaFirestore(itensNovos);
                    showToast(`Importa√ß√£o conclu√≠da! ${itensNovos.length} de ${itensDoCSV.length} itens foram adicionados.`, "success");

                } catch (error) {
                    showToast(error.message, "error");
                } finally {
                    event.target.value = '';
                }
            };
            // AQUI EST√Å A CORRE√á√ÉO:
            // Trocamos 'latin1' por 'UTF-8' para ler corretamente os caracteres especiais do portugu√™s.
            reader.readAsText(file, 'UTF-8');
        }
        function parseCSV(text) { const lines = text.trim().split(/\r?\n/); if (lines.length < 2) throw new Error("Ficheiro CSV vazio ou sem dados."); const header = lines[0].split(',').map(h => h.trim()); const requiredHeaders = ['codigoSap', 'partNumber', 'descricao']; if (!requiredHeaders.every(h => header.includes(h))) { throw new Error(`Cabe√ßalho inv√°lido. Deve conter: ${requiredHeaders.join(',')}`); } const itens = []; for (let i = 1; i < lines.length; i++) { const values = lines[i].split(','); if (values.length !== header.length) continue; const item = {}; header.forEach((key, index) => { const value = (values[index] || '').trim().replace(/^"|"$/g, ''); item[key] = value; }); if (item.codigoSap || item.partNumber || item.descricao) { itens.push(item); } } return itens; }
        async function exportarCatalogoCSV() { if (catalogoLocal.length === 0) { showToast("Cat√°logo est√° vazio. Nada para exportar.", "info"); return; } try { let csvContent = "codigoSap,partNumber,descricao\n"; catalogoLocal.forEach(item => { const descricao = `"${(item.descricao || '').replace(/"/g, '""')}"`; csvContent += `${item.codigoSap},${item.partNumber},${descricao}\n`; }); const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' }); const url = URL.createObjectURL(blob); const a = document.createElement("a"); a.href = url; a.download = `catalogo_meuturno_${new Date().toISOString().slice(0, 10)}.csv`; a.click(); URL.revokeObjectURL(url); showToast("Cat√°logo exportado com sucesso!", "success"); } catch (error) { console.error("Erro ao exportar cat√°logo:", error); showToast("Ocorreu um erro ao exportar.", "error"); } }
        function iniciarLimpezaCatalogo() { abrirPopupInput('Confirma√ß√£o de Seguran√ßa', 'Para apagar TODO o cat√°logo, por favor, insira a senha:', '********', '', (senha) => { if (senha === null) return; if (senha === SENHA_LIMPEZA_CATALOGO) { executarLimpezaCatalogo(); } else { showToast("Senha incorreta.", "error"); } }, 'password'); }
        async function executarLimpezaCatalogo() { const confirmado = await new Promise(resolve => abrirPopupConfirmar('√öLTIMO AVISO', 'Tem a certeza absoluta de que deseja apagar TODOS os itens do cat√°logo para TODOS os utilizadores? Esta a√ß√£o √© irrevers√≠vel.', resolve, 'Sim, apagar tudo')); if (!confirmado) return; showToast("A iniciar limpeza do cat√°logo... Isto pode demorar.", "info"); try { const querySnapshot = await firestore.collection('catalogo').get(); if (querySnapshot.empty) { showToast("O cat√°logo j√° est√° vazio.", "info"); return; } const batchSize = 499; for (let i = 0; i < querySnapshot.docs.length; i += batchSize) { const lote = querySnapshot.docs.slice(i, i + batchSize); const batch = firestore.batch(); lote.forEach(doc => { batch.delete(doc.ref); }); await batch.commit(); } showToast("Cat√°logo limpo com sucesso!", "success"); } catch (error) { console.error("Erro ao limpar o cat√°logo:", error); showToast("Ocorreu um erro durante a limpeza.", "error"); } }
        async function importarCatalogoExcel(event) { const file = event.target.files[0]; if (!file) return; const confirmado = await new Promise(resolve => abrirPopupConfirmar('Importar Cat√°logo', 'Tem a certeza de que deseja importar este ficheiro Excel? Itens com o mesmo C√≥digo SAP ser√£o ignorados.', resolve)); if (!confirmado) { event.target.value = ''; return; } abrirPopupLoading("A ler o ficheiro Excel. Por favor, aguarde..."); const reader = new FileReader(); reader.onload = async (e) => { try { await new Promise(resolve => setTimeout(resolve, 50)); const data = new Uint8Array(e.target.result); const workbook = XLSX.read(data, { type: 'array' }); const firstSheetName = workbook.SheetNames[0]; const worksheet = workbook.Sheets[firstSheetName]; const itensDoExcel = XLSX.utils.sheet_to_json(worksheet, { header: ["codigoSap", "partNumber", "descricao"], defval: "" }); if (itensDoExcel.length === 0) { throw new Error("Nenhum item v√°lido encontrado no ficheiro Excel."); } const codigosSapExistentes = new Set(catalogoLocal.map(item => String(item.codigoSap).trim()).filter(sap => sap)); const itensNovos = itensDoExcel.filter(item => { const sap = String(item.codigoSap || '').trim(); return sap && !codigosSapExistentes.has(sap); }); if (itensNovos.length === 0) { showToast("Importa√ß√£o conclu√≠da. Nenhum item novo para adicionar.", "success"); fecharPopup(); return; } document.querySelector('#popupGenerico #popupMensagem').innerHTML = `<p>A enviar ${itensNovos.length} itens novos para a base de dados...</p>`; await enviarLoteParaFirestore(itensNovos); showToast(`Importa√ß√£o conclu√≠da! ${itensNovos.length} itens novos foram adicionados.`, "success"); } catch (error) { showToast(`Erro: ${error.message}`, "error"); } finally { fecharPopup(); event.target.value = ''; } }; reader.readAsArrayBuffer(file); }
        async function enviarLoteParaFirestore(itens) { const batchSize = 499; for (let i = 0; i < itens.length; i += batchSize) { const lote = itens.slice(i, i + batchSize); const batch = firestore.batch(); lote.forEach(item => { const docRef = firestore.collection('catalogo').doc(); const itemData = { codigoSap: item.codigoSap || '', partNumber: item.partNumber || '', descricao: item.descricao || '' }; batch.set(docRef, itemData); }); await batch.commit(); } }
        async function renderizarSecaoCatalogo(container) { try { catalogoLocal = await dbExec('catalogo', 'readonly', s => s.getAll()); } catch (e) { console.error("Erro ao carregar cat√°logo do IndexedDB:", e); catalogoLocal = []; } container.innerHTML = `<div class="bg-white p-4 rounded-lg shadow space-y-4"><h2 class="text-xl font-bold text-blue-800">Cat√°logo de Pe√ßas</h2><div><label for="buscaCatalogo" class="sr-only">Buscar</label><input type="text" id="buscaCatalogo" oninput="renderizarCatalogo()" placeholder="üîé Buscar por SAP, Part Number ou Descri√ß√£o..." class="w-full p-3 border border-gray-300 rounded-lg"></div><div id="listaCatalogo" class="space-y-2"></div></div>`; renderizarCatalogo(); }

        function renderizarCatalogo() {
            const listaDiv = document.getElementById('listaCatalogo');
            if (!listaDiv) return;

            // 1. Pega o termo de busca, converte para min√∫sculas E remove os acentos.
            const termoBusca = removerAcentos(document.getElementById('buscaCatalogo').value.toLowerCase());

            const itensFiltrados = catalogoLocal.filter(item => {
                // Converte para String para evitar erros caso os dados venham como n√∫meros
                const codigoSap = String(item.codigoSap || '').toLowerCase();
                const partNumber = String(item.partNumber || '').toLowerCase();

                // 2. Converte a descri√ß√£o do item para min√∫sculas E remove os acentos antes de comparar.
                const descricaoNormalizada = removerAcentos(String(item.descricao || '').toLowerCase());

                return (codigoSap.includes(termoBusca) || partNumber.includes(termoBusca) || descricaoNormalizada.includes(termoBusca));
            });

            if (itensFiltrados.length === 0) {
                listaDiv.innerHTML = `<p class="text-center text-gray-500 py-4">Nenhum item encontrado.</p>`;
                return;
            }

            itensFiltrados.sort((a, b) => (a.descricao || '').localeCompare(b.descricao || ''));
            listaDiv.innerHTML = itensFiltrados.map(item => `<div class="border rounded-lg p-3 flex justify-between items-center transition-all duration-200 hover:bg-gray-50"><div class="flex-1 min-w-0"><p class="font-bold text-gray-800 truncate">${item.descricao}</p><p class="text-sm text-gray-600">SAP: <span class="font-semibold text-blue-700">${item.codigoSap}</span></p><p class="text-sm text-gray-600">Part Number: <span class="font-semibold">${item.partNumber}</span></p></div><div class="flex space-x-2 pl-2"><button onclick="editarItemCatalogo('${item.docId}')" class="p-2 text-yellow-600 hover:bg-yellow-100 rounded-full" title="Editar">‚úèÔ∏è</button><button onclick="excluirItemCatalogo('${item.docId}')" class="p-2 text-red-600 hover:bg-red-100 rounded-full" title="Excluir">üóëÔ∏è</button></div></div>`).join('');
        }
        function abrirPopupFormularioItemCatalogo(item = null) { const isEditing = item !== null; const titulo = isEditing ? 'Editar Item do Cat√°logo' : 'Adicionar Novo Item'; const docId = item?.docId || ''; const codigoSap = item?.codigoSap || ''; const partNumber = item?.partNumber || ''; const descricao = item?.descricao || ''; const conteudoPopup = `<input type="hidden" id="popup-docId" value="${docId}"><div class="space-y-3 text-left"><div><label for="popup-sap" class="block text-sm font-medium text-gray-700">C√≥digo SAP</label><input type="text" id="popup-sap" class="mt-1 w-full p-2 border rounded-md" value="${codigoSap}" placeholder="C√≥digo SAP (opcional)"></div><div><label for="popup-partnumber" class="block text-sm font-medium text-gray-700">Part Number</label><input type="text" id="popup-partnumber" class="mt-1 w-full p-2 border rounded-md" value="${partNumber}" placeholder="Part number (opcional)"></div><div><label for="popup-descricao" class="block text-sm font-medium text-gray-700">Descri√ß√£o</label><textarea id="popup-descricao" class="mt-1 w-full p-2 border rounded-md h-24" placeholder="Descri√ß√£o da pe√ßa (opcional)">${descricao}</textarea></div></div>`; const botoes = [{ texto: 'Salvar', classe: 'bg-blue-600 text-white hover:bg-blue-700', acao: () => salvarItemCatalogo() }, { texto: 'Cancelar', classe: 'bg-gray-300 text-gray-800 hover:bg-gray-400', acao: fecharPopup }]; abrirPopup(titulo, `<div>${conteudoPopup}</div>`, botoes); }
        async function salvarItemCatalogo() { const docId = document.getElementById('popup-docId').value; const codigoSap = document.getElementById('popup-sap').value.trim(); const partNumber = document.getElementById('popup-partnumber').value.trim(); const descricao = document.getElementById('popup-descricao').value.trim(); if (!codigoSap && !partNumber && !descricao) { showToast("Preencha pelo menos um campo para salvar o item.", "error"); return; } const itemData = { codigoSap, partNumber, descricao }; try { if (docId) { await firestore.collection('catalogo').doc(docId).update(itemData); showToast("Item atualizado com sucesso!", "success"); } else { await firestore.collection('catalogo').add(itemData); showToast("Item adicionado com sucesso!", "success"); } fecharPopup(); } catch (error) { console.error("Erro ao salvar item no Firebase:", error); showToast("Erro ao salvar o item.", "error"); } }
        function editarItemCatalogo(docId) { const item = catalogoLocal.find(i => i.docId === docId); if (item) { abrirPopupFormularioItemCatalogo(item); } else { showToast("Item n√£o encontrado para edi√ß√£o.", "error"); } }
        async function excluirItemCatalogo(docId) { const item = catalogoLocal.find(i => i.docId === docId); const itemIdentifier = item?.descricao || item?.codigoSap || item?.partNumber || docId; const confirmado = await new Promise(resolve => abrirPopupConfirmar('Excluir Item', `Tem a certeza que deseja excluir o item <strong>${itemIdentifier}</strong>?`, resolve)); if (confirmado) { try { await firestore.collection('catalogo').doc(docId).delete(); showToast("Item exclu√≠do com sucesso!", "success"); } catch (error) { console.error("Erro ao excluir item no Firebase:", error); showToast("Erro ao excluir o item.", "error"); } } }
        function calcularDuracaoServico(servico) { if (!servico.inicio || !servico.fim || !servico.data || !servico.dataFinal) return { horas: 0, texto: "0min" }; const inicio = new Date(`${servico.data}T${servico.inicio}`); const fim = new Date(`${servico.dataFinal}T${servico.fim}`); if (isNaN(inicio.getTime()) || isNaN(fim.getTime()) || fim < inicio) return { horas: 0, texto: "Inv√°lido" }; const diffMin = (fim - inicio) / 60000; const h = Math.floor(diffMin / 60); const m = Math.round(diffMin % 60); let texto = ""; if (h > 0) texto += `${h}h `; if (m > 0) texto += `${m}min`; return { horas: diffMin / 60, texto: texto.trim() || "0min" }; }
        // MODIFICADO: Agora aceita uma lista de servi√ßos como argumento (padr√£o para todos)
function calcularHorasParadasCorretivasTotais(listaServicos = servicos) { 
    return listaServicos.filter(s => s.tipo === "CORRETIVA" && s.parada === "sim").reduce((total, s) => total + calcularDuracaoServico(s).horas, 0); 
}
        // MODIFICADO: Chamada para usar a nova vers√£o de calcularHorasParadasCorretivasTotais
function calcularDMGeral(maquinas, horasParadasTotais) { 
    const horasPlanejadasTotais = maquinas.reduce((soma, f) => soma + f.horas, 0); 
    if (horasPlanejadasTotais === 0) return maquinas.length > 0 ? "0.00" : "100.00"; 
    const horasOperandoTotais = Math.max(0, horasPlanejadasTotais - horasParadasTotais); 
    return ((horasOperandoTotais / horasPlanejadasTotais) * 100).toFixed(2); 
}

        // =================================================================================
        // 8. SINCRONIZA√á√ÉO COM FIREBASE
        // =================================================================================
        let monitoramentoCatalogoIniciado = false; // Vari√°vel de controle global

function sincronizarCatalogoPecas() {
    // SE j√° estiver monitorando, N√ÉO faz nada (Economiza leituras!)
    if (monitoramentoCatalogoIniciado) return;

    console.log("Iniciando download do cat√°logo de pe√ßas...");
    monitoramentoCatalogoIniciado = true; // Marca como iniciado

    firestore.collection('catalogo').onSnapshot(async (snapshot) => {
        // ... (seu c√≥digo existente de salvar no IndexedDB) ...
        const tx = db.transaction('catalogo', 'readwrite');
        const store = tx.objectStore('catalogo');
        let houveMudanca = false;
        
        // Dica de economia: Se for apenas metadados (fromCache), n√£o conta leitura
        if (snapshot.metadata.fromCache) console.log("Lendo do cache local");

        for (const change of snapshot.docChanges()) {
            houveMudanca = true;
            const item = { ...change.doc.data(), docId: change.doc.id };
            if (change.type === 'added' || change.type === 'modified') { store.put(item); }
            if (change.type === 'removed') { store.delete(item.docId); }
        }
        tx.oncomplete = async () => {
            if (houveMudanca) {
                catalogoLocal = await dbExec('catalogo', 'readonly', s => s.getAll());
                // S√≥ renderiza se a tela de cat√°logo estiver vis√≠vel
                if (document.getElementById('catalogo')?.classList.contains('hidden') === false) {
                    renderizarCatalogo();
                }
            }
        };
    }, (error) => { 
        console.error("Erro catalogo:", error); 
        monitoramentoCatalogoIniciado = false; // Reseta em caso de erro para tentar de novo
    });
}


        let monitoramentoFrotasIniciado = false; // Nova vari√°vel de controle

function sincronizarCatalogoFrotas() {
    // Se j√° iniciou, para aqui (Economia!)
    if (monitoramentoFrotasIniciado) return;

    console.log("Iniciando download do cat√°logo de frotas...");
    monitoramentoFrotasIniciado = true;

    firestore.collection('catalogoFrotas').onSnapshot(async (snapshot) => {
        const tx = db.transaction(STORE_FROTAS, 'readwrite');
        const store = tx.objectStore(STORE_FROTAS);
        let houveMudanca = false;
        
        if (snapshot.metadata.fromCache) console.log("Frotas: Lendo do cache local");

        for (const change of snapshot.docChanges()) {
            houveMudanca = true;
            const item = { ...change.doc.data(), docId: change.doc.id };
            if (change.type === 'added' || change.type === 'modified') { store.put(item); }
            if (change.type === 'removed') { store.delete(item.docId); }
        }
        tx.oncomplete = async () => {
            if (houveMudanca) {
                catalogoFrotas = await dbExec(STORE_FROTAS, 'readonly', s => s.getAll());
                // Atualiza a lista visual se a tela de frotas estiver aberta
                if (document.getElementById('frotas')?.classList.contains('hidden') === false) {
                    renderizarCatalogoFrotas();
                }
            }
        };
    }, (error) => { 
        console.error("Erro Frotas:", error); 
        monitoramentoFrotasIniciado = false; // Reseta em caso de erro
    });
}

    </script>
</body>

</html>
