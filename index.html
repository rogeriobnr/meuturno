<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="manifest" href="./manifest.json">
    <meta name="theme-color" content="#007acc">
    <title>Meu Turno</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: sans-serif; }
        #toast { position: fixed; left: 50%; bottom: 30px; transform: translateX(-50%); min-width: 250px; background-color: #333; color: #fff; text-align: center; border-radius: 0.375rem; padding: 1rem; z-index: 10000; visibility: hidden; }
        #toast.show { visibility: visible; animation: fadein_toast 0.5s, fadeout_toast 0.5s 2.5s; }
        @keyframes fadein_toast { from { bottom: 0; opacity: 0; } to { bottom: 30px; opacity: 1; } }
        @keyframes fadeout_toast { from { bottom: 30px; opacity: 1; } to { bottom: 0; opacity: 0; } }
        .popup-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); z-index: 9998; display: none; }
        .popup { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 1.25rem; border-radius: 0.75rem; box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3); z-index: 9999; width: 90%; max-width: 400px; display: none; }
        #historico_lista input:not([disabled]):not(.bg-gray-100),
        #historico_lista input:placeholder-shown:not([disabled]):not(.bg-gray-100) { border-color: #F59E0B; }
        .servico-pendente-os { border-left-width: 4px; border-left-color: #F97316; }
        .servico-pendente-os .servico-cabecalho { background-color: #FFF7ED; }
        nav button.active-nav-button { background-color: #2563EB; color: white; }
        .servico-cabecalho { display: flex; justify-content: space-between; align-items: center; cursor: pointer; padding: 0.75rem 1rem; background-color: #e9ecef; border-bottom-width: 1px; border-color: #ced4da; border-top-left-radius: 0.5rem; border-top-right-radius: 0.5rem; }
        .servico-cabecalho-info { flex-grow: 1; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; margin-right: 0.5rem; }
        .servico-cabecalho-info .frota-destaque { font-weight: bold; color: #0056b3; }
        .servico-cabecalho-info .atividade-info { color: #495057; font-size: 0.9em; margin-left: 0.25rem; }
        .servico-cabecalho-toggler { font-size: 1.1em; color: #495057; }
        .servico-detalhes { padding: 1rem; border-width: 1px; border-top-width: 0; border-color: #ced4da; border-bottom-left-radius: 0.5rem; border-bottom-right-radius: 0.5rem; }
        /* Estilos para o Menu Hamb√∫rguer */
.menu-link {
    padding: 1rem;
    border-bottom: 1px solid #e5e7eb; /* gray-200 */
    font-size: 1rem;
    color: #374151; /* gray-700 */
    text-decoration: none;
    transition: background-color 0.2s;
}

.menu-link:hover {
    background-color: #f3f4f6; /* gray-100 */
}

/* Classe que ser√° adicionada via JS para abrir o menu */
.menu-open #menu-lateral {
    transform: translateX(0);
}

.menu-open #menu-overlay {
    opacity: 1;
    pointer-events: auto; /* Permite que o overlay seja clic√°vel para fechar o menu */
}
    </style>
</head>

<body class="bg-gray-100 text-gray-800">

    <header class="bg-blue-600 text-white p-4 shadow-md flex items-center justify-between sticky top-0 z-10">
    <button id="hamburger-btn" class="text-2xl p-2">
        &#9776; </button>
    
    <div class="flex items-center gap-x-2">    
        <img src="logo.png" alt="Logo MeuTurno" class="h-8" onerror="this.style.display='none'">
        <h1 id="header-titulo" class="text-xl font-bold">Turno</h1>
</div>    

    <div class="w-10"></div> 
</header>
<nav id="menu-lateral" class="fixed top-0 left-0 h-full bg-white shadow-lg z-30 transform -translate-x-full transition-transform duration-300 ease-in-out w-3/4 max-w-sm">
    <div class="p-4 border-b">
        <h2 class="text-2xl font-bold text-blue-600">MeuTurno</h2>
        <img src="logo.png" alt="Logotipo" class="h-8" onerror="this.style.display='none'">
    </div>
    <div class="flex flex-col">
        <a href="#" class="menu-link" data-secao="turno">Turno</a>
        <a href="#" class="menu-link" data-secao="servicos">Servi√ßos</a>
        <a href="#" class="menu-link" data-secao="estatisticas">Estat√≠sticas</a>
        <a href="#" class="menu-link" data-secao="relatorio">Relat√≥rio</a>
        <a href="#" class="menu-link" data-secao="historico">Hist√≥rico</a>
        <a href="#" class="menu-link" data-secao="config">Configurar</a>
    </div>
</nav>

<div id="menu-overlay" class="fixed top-0 left-0 w-full h-full bg-black bg-opacity-50 z-20 opacity-0 pointer-events-none transition-opacity duration-300 ease-in-out"></div>
    <main class="p-4">
        <section id="turno" class="active">
            <div class="bg-white p-4 rounded-lg shadow space-y-6">
                <div class="p-4 border border-gray-200 rounded-lg">
                    <h4 class="text-lg font-semibold text-blue-700 mb-3 border-b pb-2">Dados do Turno</h4>
                    <div>
                        <label for="dataTurno"
                            class="block text-sm font-medium text-gray-700"><strong>Data*</strong></label>
                        <input id="dataTurno" type="date"
                            class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
                            onchange="salvarDadosParciaisTurno()" required>
                    </div>
                    <div class="mt-4">
                        <label for="fazenda"
                            class="block text-sm font-medium text-gray-700"><strong>Fazenda*</strong></label>
                        <input id="fazenda" type="text"
                            class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
                            placeholder="Digite o nome da fazenda" onblur="salvarDadosParciaisTurno()" required>
                    </div>
                    <div class="mt-4">
                        <label for="frente" class="block text-sm font-medium text-gray-700"><strong>Frente /
                                Local*</strong></label>
                        <input id="frente" type="text"
                            class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
                            placeholder="Digite a frente de trabalho" onblur="salvarDadosParciaisTurno()" required>
                    </div>
                    <div class="mt-4">
                        <label for="turnoLetra"
                            class="block text-sm font-medium text-gray-700"><strong>Turno</strong></label>
                        <select id="turnoLetra"
                            class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
                            onchange="salvarDadosParciaisTurno()">
                            <option value="A">A</option>
                            <option value="B">B</option>
                            <option value="C">C</option>
                        </select>
                    </div>
                </div>

                <div class="p-4 border border-gray-200 rounded-lg">
                    <h4 class="text-lg font-semibold text-blue-700 mb-3 border-b pb-2">Equipe</h4>
                    <div class="flex space-x-2 mb-2">
                        <input id="nomeEquipe" type="text"
                            class="flex-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
                            placeholder="Nome">
                        <input id="matriculaEquipe" type="text"
                            class="flex-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
                            placeholder="Matr√≠cula">
                    </div>
                    <button onclick="adicionarEquipe()"
                        class="w-full sm:w-auto bg-blue-500 hover:bg-blue-600 text-white text-sm py-2 px-3 rounded-md font-semibold transition-colors duration-150">Adicionar
                        Membro</button>
                    <div id="boxEquipe" class="mt-3"></div>
                </div>

                <div class="p-4 border border-gray-200 rounded-lg">
                    <h4 class="text-lg font-semibold text-blue-700 mb-3 border-b pb-2">Frotas</h4>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-2 mb-1">
                        <input id="novaFrota" type="text"
                            class="block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
                            placeholder="C√≥digo da frota">
                        <input id="novaHoraFrota" type="number" step="0.1"
                            class="block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
                            placeholder="Ex: 7.5 (7h30min)">
                    </div>
                    <div class="mt-2">
                        <label for="tipoFrota" class="block text-sm font-medium text-gray-700">Tipo de Frota*</label>
                        <select id="tipoFrota" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                            <option value="maquina">M√°quina Principal</option>
                            <option value="implemento">Implemento</option>
                        </select>
                    </div>
                    <small class="block text-xs text-gray-500 my-2">Use ponto para decimal (ex: 7 horas e 30 minutos =
                        7.5).</small>
                    <button onclick="adicionarFrota()"
                        class="w-full sm:w-auto bg-blue-500 hover:bg-blue-600 text-white text-sm py-2 px-3 rounded-md font-semibold transition-colors duration-150">Adicionar
                        Frota</button>
                    <div id="listaFrotas" class="mt-3 space-y-2"></div>
                </div>
            </div>
        </section>

        <section id="servicos" class="hidden">
            <div class="bg-white p-4 rounded-lg shadow mb-4">
                <h4 class="text-lg font-semibold text-blue-700 mb-3 border-b pb-2">Filtrar Servi√ßos</h4>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <input type="text" id="filtroServicoFrota"
                        class="block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
                        placeholder="Filtrar por Frota..." oninput="aplicarFiltrosServicos()">
                    <input type="text" id="filtroServicoDescricao"
                        class="block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
                        placeholder="Filtrar por Descri√ß√£o..." oninput="aplicarFiltrosServicos()">
                </div>
            </div>

            <div id="servicosLista" class="space-y-4">
                </div>
            <button id="btnAddServico" onclick="adicionarServico()"
                class="bg-green-500 hover:bg-green-600 text-white py-2 px-4 rounded-md block mx-auto mt-6 font-semibold transition-colors duration-150">
                Adicionar Novo Servi√ßo
            </button>
        </section>

        <section id="estatisticas" class="hidden">
            <div class="bg-white p-4 rounded-lg shadow space-y-6">
                <h2 class="text-2xl font-semibold text-blue-700 border-b pb-3 mb-6 text-center">Estat√≠sticas do Turno</h2>
                
                <div class="p-4 border border-gray-200 rounded-lg text-center">
                     <h4 class="text-lg font-semibold text-blue-700 mb-2">DM do Turno Atual</h4>
                     <p id="stat_dm_turno_atual" class="text-4xl font-bold text-green-600">--.--%</p>
                     <p id="stat_dm_info" class="text-sm text-gray-500 mt-1">Calculada com base em 0 m√°quinas principais.</p>
                </div>
    
                <div class="p-4 border border-gray-200 rounded-lg">
                    <h4 class="text-lg font-semibold text-blue-700 mb-3 text-center">O.S. Registradas no Hist√≥rico (√öltimos 15 dias)</h4>
                    <canvas id="graficoHistoricoOS"></canvas>
                    <p class="text-xs text-center text-gray-500 mt-4">
                        <strong>Nota:</strong> O c√°lculo de DM hist√≥rica ainda n√£o √© poss√≠vel.
                        Para futuras vers√µes, podemos aprimorar o salvamento de dados para permitir essa an√°lise.
                    </p>
                </div>
            </div>
        </section>

        <section id="relatorio" class="hidden">
             <div class="bg-white p-4 rounded-lg shadow space-y-6">
                 <div class="p-4 border border-gray-200 rounded-lg">
                     <h4 class="text-lg font-semibold text-blue-700 mb-3 border-b pb-2 text-center">Visualiza√ß√£o</h4>
                     <div id="relatorio_formatado"
                         class="p-3 bg-gray-50 border rounded-md min-h-[100px] whitespace-pre-line"></div>
                     <textarea id="relatorio_bruto"
                         class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm hidden mt-2 font-mono h-64"></textarea>
                 </div>
                 <div class="p-4 border border-gray-200 rounded-lg">
                     <h4 class="text-lg font-semibold text-blue-700 mb-3 border-b pb-2 text-center">A√ß√µes</h4>
                     <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                         <button onclick="gerarRelatorioFinal()"
                             class="py-2 px-4 rounded-md font-semibold transition-colors duration-150 bg-blue-600 text-white hover:bg-blue-700">Gerar
                             Relat√≥rio Final</button>
                         <button onclick="compartilharRelatorio()"
                             class="py-2 px-4 rounded-md font-semibold transition-colors duration-150 bg-gray-500 hover:bg-gray-600 text-white">Compartilhar</button>
                         <button onclick="toggleEdicaoRelatorio()"
                             class="py-2 px-4 rounded-md font-semibold transition-colors duration-150 bg-yellow-500 hover:bg-yellow-600 text-white">Editar
                             Relat√≥rio</button>
                         <button onclick="limparRelatorio()"
                             class="py-2 px-4 rounded-md font-semibold transition-colors duration-150 bg-red-600 text-white hover:bg-red-700">Limpar
                             Relat√≥rio</button>
                     </div>
                 </div>
             </div>
        </section>

        <section id="historico" class="hidden">
            <div class="bg-white p-4 rounded-lg shadow mb-4">
                <button onclick="abrirPopupApagarPorData()"
                    class="w-full sm:w-auto py-2 px-4 rounded-md font-semibold transition-colors duration-150 bg-red-600 text-white hover:bg-red-700">
                    üóëÔ∏è Apagar Hist√≥rico por Data
                </button>
            </div>
            <div id="historico_lista" class="space-y-4"></div>
            <div class="bg-white p-4 rounded-lg shadow mt-4">
                <button onclick="baixarBackupHistorico()"
                    class="bg-blue-500 hover:bg-blue-600 text-white w-full mb-2 py-2 px-4 rounded-md font-semibold transition-colors duration-150">&#128190;
                    Backup do Hist√≥rico</button>
                <button onclick="document.getElementById('fileBackupHistoricoInput').click()"
                    class="bg-blue-700 hover:bg-blue-800 text-white w-full py-2 px-4 rounded-md font-semibold transition-colors duration-150">Restaurar
                    Backup do Hist√≥rico</button>
                <input type="file" id="fileBackupHistoricoInput" accept=".json" class="hidden"
                    onchange="restaurarBackupHistorico(event)">
            </div>
        </section>

        <section id="config" class="hidden">
            <div class="bg-white p-6 rounded-lg shadow-lg max-w-2xl mx-auto space-y-6">
                <h2 class="text-2xl font-semibold text-blue-700 border-b pb-3 mb-6 text-center">Backup e Dados</h2>
                <p id="infoUltimoBackup" class="text-sm text-gray-600 italic mb-6 text-center">√öltimo backup: Nunca
                    realizado.</p>

                <div class="space-y-2 text-center">
                    <button onclick="gerarBackupCompleto()"
                        class="w-full md:w-3/4 lg:w-1/2 mx-auto bg-blue-500 hover:bg-blue-600 text-white py-3 px-4 rounded-md font-semibold transition-colors duration-150 text-base">
                        üóÑÔ∏è Exportar Dados Completos
                    </button>
                    <p class="text-xs text-gray-500 mt-1 text-center">Turno Atual + Hist√≥rico de O.S.</p>
                </div>
                <hr class="my-6 border-gray-300">
                <div class="space-y-2 text-center">
                    <button onclick="document.getElementById('fileBackupCompletoInput').click()"
                        class="w-full md:w-3/4 lg:w-1/2 mx-auto bg-blue-500 hover:bg-blue-600 text-white py-3 px-4 rounded-md font-semibold transition-colors duration-150 text-base">
                        üîÑ Importar Dados Completos
                    </button>
                    <input type="file" id="fileBackupCompletoInput" accept=".json" class="hidden"
                        onchange="restaurarBackupCompleto(event)">
                    <p class="text-xs text-gray-500 mt-1 text-center">Aten√ß√£o: <strong class="text-red-600">Isto
                            substituir√° todos os dados atuais.</strong></p>
                </div>
                <hr class="my-6 border-gray-300">
                <div class="space-y-2 text-center">
                    <button onclick="limparTodosServicos()"
                        class="w-full md:w-3/4 lg:w-1/2 mx-auto py-3 px-4 rounded-md font-semibold transition-colors duration-150 text-base bg-red-500 text-white hover:bg-red-600">
                        üóëÔ∏è Limpar Servi√ßos do Turno Atual</button>
                    <p class="text-xs text-red-500 mt-1 text-center">(Confirma√ß√£o necess√°ria)</p>
                </div>
                <hr class="my-6 border-gray-300">
                <div class="space-y-2 text-center">
                    <button onclick="limparStorage()"
                        class="w-full md:w-3/4 lg:w-1/2 mx-auto py-3 px-4 rounded-md font-semibold transition-colors duration-150 text-base bg-red-700 text-white hover:bg-red-800">
                        üóëÔ∏è Resetar Todos os Dados
                    </button>
                    <p class="text-xs text-red-500 mt-1 text-center">(Confirma√ß√£o necess√°ria)</p>
                </div>
            </div>
        </section>
    </main>

    <button id="fabAddFrota" onclick="abrirPopupFrota()"
        class="fixed bottom-28 right-5 bg-blue-600 hover:bg-blue-700 text-white rounded-full w-14 h-14 flex items-center justify-center text-2xl shadow-lg z-50"
        style="display: none;">
        üöú
    </button>
    <button id="fabCriarServico" onclick="verificarServicosPendentes()"
        class="fixed bottom-12 right-5 bg-green-500 hover:bg-green-600 text-white rounded-full w-14 h-14 flex items-center justify-center text-3xl shadow-lg z-50"
        style="display: none;">
        +
    </button>

    <div id="toast"></div>

    <div class="popup-overlay" id="overlayFrota"></div>
    <div class="popup" id="popupFrota">
        <h3 class="text-xl font-semibold mb-4">Adicionar Frota</h3>
        <label class="block text-sm font-medium text-gray-700">Frota</label>
        <input type="text" id="inputFrota" placeholder="Ex.: JD6115J"
            class="mt-1 mb-3 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
        <label class="block text-sm font-medium text-gray-700">Horas Planejadas</label>
        <input type="number" step="0.1" id="inputHoraFrota" placeholder="Ex.: 7.5 (7h30min)"
            class="mt-1 mb-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
        <div class="my-3">
             <label for="popupTipoFrota" class="block text-sm font-medium text-gray-700">Tipo de Frota*</label>
             <select id="popupTipoFrota" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                <option value="maquina">M√°quina Principal</option>
                <option value="implemento">Implemento</option>
            </select>
        </div>
        <small class="block text-xs text-gray-500 mb-4">Use ponto para decimal.</small>
        <div class="flex justify-end space-x-2">
            <button
                class="py-2 px-4 rounded-md font-semibold transition-colors duration-150 bg-blue-600 text-white hover:bg-blue-700"
                onclick="confirmarFrota()">Adicionar</button>
            <button
                class="py-2 px-4 rounded-md font-semibold transition-colors duration-150 bg-gray-300 text-gray-800 hover:bg-gray-400"
                onclick="fecharPopupFrota()">Cancelar</button>
        </div>
    </div>

    <div class="popup-overlay" id="overlayOportunidade"></div>
    <div class="popup" id="popupOportunidade">
        <h3 class="text-xl font-semibold mb-4">Informar Oportunidade</h3>
        <input type="text" id="inputOportunidade" placeholder="Ex.: Refei√ß√£o, DDS..."
            class="mb-4 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
        <div class="flex justify-end space-x-2">
            <button
                class="py-2 px-4 rounded-md font-semibold transition-colors duration-150 bg-blue-600 text-white hover:bg-blue-700"
                onclick="confirmarOportunidade()">Confirmar</button>
            <button
                class="py-2 px-4 rounded-md font-semibold transition-colors duration-150 bg-gray-300 text-gray-800 hover:bg-gray-400"
                onclick="cancelarOportunidade()">Cancelar</button>
        </div>
    </div>

    <div class="popup-overlay" id="overlayApagarData"></div>
    <div class="popup" id="popupApagarData">
        <h3 class="text-xl font-semibold mb-4">Selecione a Data do Hist√≥rico para Apagar</h3>
        <select id="selectDatas"
            class="mb-4 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"></select>
        <div class="flex justify-end space-x-2">
            <button
                class="py-2 px-4 rounded-md font-semibold transition-colors duration-150 bg-red-600 text-white hover:bg-red-700"
                onclick="confirmarApagarPorData()">Apagar</button>
            <button
                class="py-2 px-4 rounded-md font-semibold transition-colors duration-150 bg-gray-300 text-gray-800 hover:bg-gray-400"
                onclick="fecharPopupApagarData()">Cancelar</button>
        </div>
    </div>

    <div class="popup-overlay" id="overlayConfirmar"></div>
    <div class="popup" id="popupConfirmar">
        <h3 id="popupConfirmarTitulo" class="text-xl font-semibold mb-3">Confirma√ß√£o</h3>
        <p id="popupConfirmarMensagem" class="text-sm text-gray-600 mb-4">Mensagem aqui...</p>
        <div class="flex justify-end space-x-2">
            <button
                class="py-2 px-4 rounded-md font-semibold transition-colors duration-150 bg-blue-600 text-white hover:bg-blue-700"
                id="btnPopupConfirmarAcao" onclick="confirmarPopupAcao()">Confirmar</button>
            <button
                class="py-2 px-4 rounded-md font-semibold transition-colors duration-150 bg-gray-300 text-gray-800 hover:bg-gray-400"
                onclick="fecharPopupConfirmar()">Cancelar</button>
        </div>
    </div>

    <div class="popup-overlay" id="overlayPopup"></div>
    <div class="popup" id="popupGenerico">
        <h3 id="popupTitulo" class="text-xl font-semibold mb-3"></h3>
        <p id="popupMensagem" class="text-sm text-gray-600 mb-4"></p>
        <div class="flex justify-end space-x-2" id="popupBotoes"></div>
    </div>

    <div id="update-popup"
        class="hidden fixed bottom-5 left-1/2 transform -translate-x-1/2 bg-blue-600 text-white py-3 px-6 rounded-lg shadow-lg z-[10001] font-semibold">
        Nova vers√£o dispon√≠vel. <button onclick="location.reload()"
            class="ml-2 bg-white text-blue-600 py-1 px-3 rounded-md font-bold">Atualizar</button>
    </div>

    <template id="servico-template">
        <article class="bg-white p-4 rounded-lg shadow mb-4">
            <div class="servico-cabecalho">
                <div class="servico-cabecalho-info"></div>
                <span class="servico-cabecalho-toggler"></span>
            </div>
            <div class="servico-detalhes" style="display:none;">
                </div>
        </article>
    </template>

<script>
    // =================================================================================
    // VARI√ÅVEIS GLOBAIS E CONSTANTES
    // =================================================================================
    let equipe = [];
    let frotasTurno = [];
    let servicos = [];
    let callbackOportunidade = null;
    let callbackConfirmar = null;
    let db;
    let graficoOS = null; // Vari√°vel para o gr√°fico de estat√≠sticas

    const DB_NAME = 'meuturnoDB';
    const DB_VERSION = 1; 
    const STORE_TURNO = 'turno';
    const STORE_HISTORICO = 'historicoOS';
    const TURNO_ATUAL_ID = 'currentTurno';

    const atividades = [];
    const sistemas = {};
    const subsistemas = {};
    
    atividades.push(
        "P001 - AFERIDO", "P002 - AJUSTADO", "P003 - ALINHADO", "P004 - APERTADO",
        "P005 - BALANCEADO", "P006 - CALIBRADO", "P007 - COMPLETADO", "P008 - CONSERTADO COMPONENTE",
        "P009 - DESAMASSADO", "P010 - DESOBSTRUIDO", "P011 - EMBUCHADO", "P012 - FIXADO",
        "P013 - FURADO", "P014 - HIGIENIZADO", "P015 - INSPECIONADO", "P016 - INSTALADO",
        "P017 - ISOLADO", "P018 - LIMPO", "P019 - LUBRIFICADO", "P020 - MODIFICADO",
        "P021 - REAPERTADO", "P022 - RECARREGADO", "P023 - RECUPERADO", "P024 - REFORMADO",
        "P025 - REGULADO", "P026 - REMONTADO", "P027 - REPROGRAMADO", "P028 - RETIFICADO",
        "P029 - SOLDADO", "P030 - SUBSTITUIDO - TROCADO", "P031 - USINADO", "P032 - VEDADO",
        "H01 - Atraso de transporte", "H02 - DDS", "H03 - Refei√ß√£o", "H04 - Organiza√ß√£o/Limpeza",
        "H05 - Aguardando pe√ßa", "H06 - Aguardando Ferramenta", "H07 - Aguardando Servi√ßo",
        "H08 - Falta do colaborador", "H09 - Reuni√£o", "H10 - Ambulatorio", "H11 - Treinamento",
        "H12 - Outros", "H13 - Deslocamento a terceiros", "H14 - Carregamento de pneus pra conserto",
        "H15 - Inventario", "H16 - Apoio a Opera√ß√£o"
    );
    Object.assign(sistemas, {
        "Tratores": [
            { cod: "1", nome: "Estrutura" }, { cod: "2", nome: "Cabine" }, { cod: "3", nome: "Motor Combustao" },
            { cod: "4", nome: "Eletrico" }, { cod: "5", nome: "Trem de Forca" }, { cod: "6", nome: "Tracao" },
            { cod: "7", nome: "Hidraulico" }, { cod: "8", nome: "Direcao" }, { cod: "9", nome: "Freio" }
        ],
        "Implementos": [
            { cod: "10", nome: "Estrutura" }, { cod: "11", nome: "Tracao" }, { cod: "12", nome: "Adubo" },
            { cod: "13", nome: "Hidraulico" }, { cod: "14", nome: "Eletrico" }, { cod: "15", nome: "V-SHEAR" }
        ]
    });
    Object.assign(subsistemas, {
        "1": ["1.1 - Chassi", "1.2 - Protecao", "1.3 - Escapamento", "1.4 - Suportes", "1.5 - Escada", "1.6 - Fixacao", "1.7 - Paralama", "1.8 - Tanque", "1.9 - Eixo", "1.10 - Chaparia", "1.11 - Alavanca"],
        "2": ["2.1 - Refrigecao", "2.2 - Banco", "2.3 - Vidros", "2.4 - Painel", "2.5 - Portas", "2.6 - Hodometro", "2.7 - Radio", "2.8 - Tacografo", "2.9 - Cinto de Seguranca", "2.10 - Cabine", "2.11 - Capo", "2.12 - Buzina"],
        "3": ["3.1 - Radiador", "3.2 - Motor", "3.3 - Intercooler", "3.4 - Arla", "3.5 - Filtro", "3.6 - Ignicao"],
        "4": ["4.1 - Iluminacao", "4.2 - Eletrica", "4.3 - Bateria", "4.4 - Chicote", "4.5 - Rastreador", "4.6 - Alternador", "4.7 - Encoder", "4.8 - Camera", "4.9 - Modulo", "4.10 - Comutador", "4.11 - Fluxometro", "4.12 - GPS"],
        "5": ["5.1 - Cubo", "5.2 - Embreagem", "5.3 - Cambio", "5.4 - Diferencial", "5.5 - Transmissao"],
        "6": ["6.1 - Pneu", "6.2 - Roda", "6.3 - Esteira", "6.4 - Roda Motriz", "6.5 - Roda Estrelada"],
        "7": ["7.1 - Mangueiras", "7.2 - Valvulas", "7.3 - Atuador", "7.4 - Bombas", "7.5 - Cilindro", "7.6 - VCR"],
        "8": ["8.1 - Barra de direcao", "8.2 - Coluna Direcao", "8.3 - Volante"],
        "9": ["9.1 - Freio", "9.2 - Acumulador"],
        "10": ["10.1 - Disco de Corte", "10.2 - Cabecalho", "10.3 - Ferramenta Traseira", "10.4 - Limpa Trilho", "10.5 - Quadro", "10.6 - Escarificador", "10.7 - Fixacao", "10.8 - Tanque", "10.9 - Eixo", "10.10 - Braco"],
        "11": ["11.1 - Pneus", "11.2 - Roda", "11.3 - Mancal"],
        "12": ["12.1 - Caixa de Adubo"],
        "13": ["13.1 - Cilindro", "13.2 - Mangueira", "13.3 - Bloco", "13.4 - Valvula"],
        "14": ["14.1 - Sensores", "14.2 - Chicote"],
        "15": ["15.1 - Lamina", "15.2 - Ball"]
    });


    // =================================================================================
    // OPERA√á√ïES INDEXEDDB
    // =================================================================================
    async function initDB() {
        return new Promise((resolve, reject) => {
            if (db) { resolve(db); return; }
            const request = indexedDB.open(DB_NAME, DB_VERSION);
            request.onupgradeneeded = (event) => {
                const currentDb = event.target.result;
                if (!currentDb.objectStoreNames.contains(STORE_TURNO)) { currentDb.createObjectStore(STORE_TURNO, { keyPath: 'id' }); }
                if (!currentDb.objectStoreNames.contains(STORE_HISTORICO)) {
                    const historicoStore = currentDb.createObjectStore(STORE_HISTORICO, { keyPath: 'uniqueId', autoIncrement: true });
                    historicoStore.createIndex('dataKeyIndex', 'dataKey', { unique: false });
                    historicoStore.createIndex('serviceIdIndex', 'id', { unique: false });
                }
            };
            request.onsuccess = (event) => { db = event.target.result; resolve(db); };
            request.onerror = (event) => { console.error("Erro IndexedDB:", event.target.error); reject(event.target.error); };
        });
    }
    async function dbSave(storeName, data) { 
        await initDB();
        return new Promise((resolve, reject) => {
            try {
                const transaction = db.transaction([storeName], 'readwrite');
                const store = transaction.objectStore(storeName);
                const request = store.put(data);
                request.onsuccess = () => resolve();
                request.onerror = (event) => { console.error(`Erro ao guardar em ${storeName}:`, event.target.error); reject(event.target.error); };
            } catch (error) { console.error(`Exce√ß√£o ao tentar guardar em ${storeName}:`, error); reject(error); }
        });
    }
    async function dbGet(storeName, key) {
        await initDB();
        return new Promise((resolve, reject) => {
            try {
                const transaction = db.transaction([storeName], 'readonly');
                const store = transaction.objectStore(storeName);
                const request = store.get(key);
                request.onsuccess = (event) => resolve(event.target.result);
                request.onerror = (event) => { console.error(`Erro ao obter de ${storeName}:`, event.target.error); reject(event.target.error); };
            } catch (error) { console.error(`Exce√ß√£o ao tentar obter de ${storeName}:`, error); reject(error); }
        });
    }
    async function dbGetAll(storeName) {
        await initDB();
        return new Promise((resolve, reject) => {
            try {
                const transaction = db.transaction([storeName], 'readonly');
                const store = transaction.objectStore(storeName);
                const request = store.getAll();
                request.onsuccess = (event) => resolve(event.target.result || []);
                request.onerror = (event) => { console.error(`Erro ao obter todos de ${storeName}:`, event.target.error); reject(event.target.error); };
            } catch (error) { console.error(`Exce√ß√£o ao tentar obter todos de ${storeName}:`, error); reject(error); }
        });
    }
    async function dbDelete(storeName, key) {
        await initDB();
        return new Promise((resolve, reject) => {
            try {
                const transaction = db.transaction([storeName], 'readwrite');
                const store = transaction.objectStore(storeName);
                const request = store.delete(key);
                request.onsuccess = () => resolve();
                request.onerror = (event) => { console.error(`Erro ao apagar de ${storeName}:`, event.target.error); reject(event.target.error); };
            } catch (error) { console.error(`Exce√ß√£o ao tentar apagar de ${storeName}:`, error); reject(error); }
        });
    }
    async function dbClearStore(storeName) {
        await initDB();
        return new Promise((resolve, reject) => {
            try {
                const transaction = db.transaction([storeName], 'readwrite');
                const store = transaction.objectStore(storeName);
                const request = store.clear();
                request.onsuccess = () => resolve();
                request.onerror = (event) => { console.error(`Erro ao limpar ${storeName}:`, event.target.error); reject(event.target.error); };
            } catch (error) { console.error(`Exce√ß√£o ao tentar limpar ${storeName}:`, error); reject(error); }
        });
    }

    // =================================================================================
    // FUN√á√ïES UTILIT√ÅRIAS E DE UI 
    // =================================================================================
    function inicializarMenuHamburguer() {
    const btn = document.getElementById('hamburger-btn');
    const menu = document.getElementById('menu-lateral');
    const overlay = document.getElementById('menu-overlay');
    const links = document.querySelectorAll('.menu-link');
    const body = document.body;

    const abrirMenu = () => body.classList.add('menu-open');
    const fecharMenu = () => body.classList.remove('menu-open');

    btn.addEventListener('click', (e) => {
        e.stopPropagation(); // Impede que o clique se propague para outros elementos
        abrirMenu();
    });

    overlay.addEventListener('click', fecharMenu);

    links.forEach(link => {
        link.addEventListener('click', (e) => {
            e.preventDefault(); // Impede que o link mude a URL
            const secao = link.getAttribute('data-secao');
            if (secao) {
                abrir(secao);
                fecharMenu();
            }
        });
    });
}
    
    function showToast(msg) { 
        const toast = document.getElementById("toast");
        if (!toast) return;
        toast.innerText = msg;
        toast.className = "show";
        setTimeout(() => toast.className = toast.className.replace("show", ""), 3000);
    }
    function dataHojeInputLocal() {
        const hoje = new Date();
        const ano = hoje.getFullYear();
        const mes = (hoje.getMonth() + 1).toString().padStart(2, '0');
        const dia = hoje.getDate().toString().padStart(2, '0');
        return `${ano}-${mes}-${dia}`;
    }
    function fecharTeclado() {
        if (document.activeElement && typeof document.activeElement.blur === 'function') {
            document.activeElement.blur();
        }
    }
    function interpretarMarkdown(texto) { 
        if (!texto) return "";
        return texto.replace(/\*(.*?)\*/g, '<strong>$1</strong>').replace(/_(.*?)_/g, '<em>$1</em>').replace(/~(.*?)~/g, '<del>$1</del>').replace(/\n/g, '<br>');
    }
    
    function formatarDataParaExibicao(dataStringYyyyMmDd) {
        if (!dataStringYyyyMmDd || !/^\d{4}-\d{2}-\d{2}$/.test(dataStringYyyyMmDd)) {
            if (dataStringYyyyMmDd && /^\d{2}\/\d{2}\/\d{4}$/.test(dataStringYyyyMmDd)) {
                return dataStringYyyyMmDd; 
            }
            return "Sem Data";
        }
        const [ano, mes, dia] = dataStringYyyyMmDd.split('-');
        return `${dia}/${mes}/${ano}`;
    }

    function getCabecalhoServicoTexto(servico) { 
        const frota = servico.frota || "N/D";
        const codAtividade = (servico.atividade || "N/D").split(" - ")[0];
        const horaInicio = servico.inicio || "--:--";
        const horaFim = servico.fim || "--:--";
        return `<strong>Frota:</strong> <span class="frota-destaque">${frota}</span> <span class="atividade-info">| Atividade: ${codAtividade} - ${horaInicio} / ${horaFim}</span>`;
    }
    function atualizarCabecalhoServico(servicoId) {
        const servico = servicos.find(s => s.id === servicoId);
        if (!servico) return;
        const frotaInput = document.getElementById(`frota_${servicoId}`);
        if (frotaInput) servico.frota = frotaInput.value;
        const atividadeInput = document.getElementById(`atividade_${servicoId}`);
        if (atividadeInput) servico.atividade = atividadeInput.value;
        const inicioInput = document.getElementById(`inicio_${servicoId}`);
        if (inicioInput) servico.inicio = inicioInput.value;
        const fimInput = document.getElementById(`fim_${servicoId}`);
        if (fimInput) servico.fim = fimInput.value;
        const cabecalhoInfoDiv = document.querySelector(`#servico_${servicoId} .servico-cabecalho-info`);
        if (cabecalhoInfoDiv) { cabecalhoInfoDiv.innerHTML = getCabecalhoServicoTexto(servico); }
    }

    // =================================================================================
    // NAVEGA√á√ÉO E CONTROLO DE ABAS
    // =================================================================================
    async function abrir(modulo) {
    // Esconde todas as se√ß√µes
    document.querySelectorAll('main section').forEach(s => s.classList.add('hidden'));
    
    // Mostra a se√ß√£o ativa
    const secaoAtiva = document.getElementById(modulo);
    if (secaoAtiva) secaoAtiva.classList.remove('hidden');

    // Atualiza o t√≠tulo no cabe√ßalho
    const tituloHeader = document.getElementById('header-titulo');
    if(tituloHeader) {
        // Converte a primeira letra para mai√∫scula
        tituloHeader.textContent = modulo.charAt(0).toUpperCase() + modulo.slice(1);
    }
    
    // Controla a visibilidade dos bot√µes flutuantes (FABs)
    const fabCriarServico = document.getElementById('fabCriarServico');
    const fabFrota = document.getElementById('fabAddFrota');
    
    if (modulo === 'servicos') {
        renderizarServicos();
        if (fabCriarServico) fabCriarServico.style.display = 'flex';
        if (fabFrota) fabFrota.style.display = 'flex';
    } else {
        if (fabCriarServico) fabCriarServico.style.display = 'none';
        if (fabFrota) fabFrota.style.display = 'none';
    }
    
    // L√≥gica espec√≠fica de cada aba
    if (modulo === 'historico') { await mostrarHistorico(); }
    if (modulo === 'estatisticas') { await renderizarEstatisticas(); }
}

    // =================================================================================
    // GEST√ÉO DE POPUPS
    // =================================================================================
    function abrirPopup(titulo, mensagem, botoes = []) { 
        document.getElementById('popupTitulo').innerText = titulo;
        document.getElementById('popupMensagem').innerText = mensagem;
        const divBotoes = document.getElementById('popupBotoes');
        divBotoes.innerHTML = '';
        botoes.forEach(b => {
            const btn = document.createElement('button');
            btn.className = `py-2 px-4 rounded-md font-semibold transition-colors duration-150 ${b.classe || 'bg-blue-600 text-white hover:bg-blue-700'}`;
            btn.innerText = b.texto;
            btn.onclick = () => { fecharPopup(); if (b.acao) b.acao(); };
            divBotoes.appendChild(btn);
        });
        document.getElementById('popupGenerico').style.display = 'block';
        document.getElementById('overlayPopup').style.display = 'block';
        fecharTeclado();
    }
    function fecharPopup() { 
        document.getElementById('popupGenerico').style.display = 'none';
        document.getElementById('overlayPopup').style.display = 'none';
    }
    function abrirPopupConfirmar(mensagem, acao, titulo = "Confirma√ß√£o", isHtmlMensagem = false) { 
        document.getElementById('popupConfirmarTitulo').innerText = titulo;
        const mensagemElement = document.getElementById('popupConfirmarMensagem');
        if (isHtmlMensagem) mensagemElement.innerHTML = mensagem;
        else mensagemElement.innerText = mensagem;
        document.getElementById('overlayConfirmar').style.display = 'block';
        document.getElementById('popupConfirmar').style.display = 'block';
        callbackConfirmar = acao;
        fecharTeclado();
    }
    function confirmarPopupAcao() { 
        if (callbackConfirmar) callbackConfirmar();
        fecharPopupConfirmar();
    }
    function fecharPopupConfirmar() { 
        document.getElementById('overlayConfirmar').style.display = 'none';
        document.getElementById('popupConfirmar').style.display = 'none';
    }
    function abrirPopupOportunidade(callback) { 
        callbackOportunidade = callback;
        document.getElementById('popupOportunidade').style.display = 'block';
        document.getElementById('overlayOportunidade').style.display = 'block';
        const inputOportunidade = document.getElementById('inputOportunidade');
        inputOportunidade.value = ''; inputOportunidade.focus();
    }
    function fecharPopupOportunidade() {
        document.getElementById('popupOportunidade').style.display = 'none';
        document.getElementById('overlayOportunidade').style.display = 'none';
    }
    function confirmarOportunidade() {
        const valor = document.getElementById('inputOportunidade').value.trim();
        if (callbackOportunidade) callbackOportunidade(valor);
        fecharPopupOportunidade();
    }
    function cancelarOportunidade() {
        if (callbackOportunidade) callbackOportunidade('');
        fecharPopupOportunidade();
    }
    function abrirPopupFrota() {
        document.getElementById('popupFrota').style.display = 'block';
        document.getElementById('overlayFrota').style.display = 'block';
        document.getElementById('inputFrota').value = '';
        document.getElementById('inputHoraFrota').value = '';
        document.getElementById('inputFrota').focus();
    }
    function fecharPopupFrota() {
        document.getElementById('popupFrota').style.display = 'none';
        document.getElementById('overlayFrota').style.display = 'none';
    }
    async function abrirPopupApagarPorData() {
    try {
        // Pega os dados diretamente do banco de dados, em vez de ler o HTML
        const todosItens = await dbGetAll(STORE_HISTORICO);
        if (todosItens.length === 0) {
            showToast("Nenhum hist√≥rico para apagar.");
            return;
        }

        // Cria uma lista de datas √∫nicas e ordena da mais recente para a mais antiga
        const datas = [...new Set(todosItens.map(item => item.dataKey))].sort((a, b) => {
            const [diaA, mesA, anoA] = a.split('/').map(Number);
            const [diaB, mesB, anoB] = b.split('/').map(Number);
            return new Date(anoB, mesB - 1, diaB) - new Date(anoA, mesA - 1, diaA);
        });

        const select = document.getElementById('selectDatas');
        select.innerHTML = '<option value="">Selecione uma data</option>' + datas.map(d => `<option value="${d}">${d}</option>`).join('');
        
        document.getElementById('popupApagarData').style.display = 'block';
        document.getElementById('overlayApagarData').style.display = 'block';
        fecharTeclado();
    } catch (e) {
        showToast("Erro ao carregar as datas do hist√≥rico.");
        console.error("Erro em abrirPopupApagarPorData:", e);
    }
}
    function fecharPopupApagarData() {
        document.getElementById('popupApagarData').style.display = 'none';
        document.getElementById('overlayApagarData').style.display = 'none';
    }
    
    // =================================================================================
    // VALIDA√á√ÉO DE CAMPOS DO TURNO
    // =================================================================================
    function validarCamposTurnoBasicos() {
        const dataTurnoEl = document.getElementById('dataTurno');
        const fazendaEl = document.getElementById('fazenda');
        const frenteEl = document.getElementById('frente');
        [dataTurnoEl, fazendaEl, frenteEl].forEach(el => el?.classList.remove('border-red-500'));
        let camposValidos = true;
        if (!dataTurnoEl?.value) { dataTurnoEl?.classList.add('border-red-500'); camposValidos = false; }
        if (!fazendaEl?.value.trim()) { fazendaEl?.classList.add('border-red-500'); camposValidos = false; }
        if (!frenteEl?.value.trim()) { frenteEl?.classList.add('border-red-500'); camposValidos = false; }
        if (!camposValidos) {
            showToast("Aten√ß√£o: Preencha os campos obrigat√≥rios do turno (Data, Fazenda, Frente)!");
            if (!dataTurnoEl?.value) dataTurnoEl?.focus();
            else if (!fazendaEl?.value.trim()) fazendaEl?.focus();
            else if (!frenteEl?.value.trim()) frenteEl?.focus();
            return false;
        }
        return true;
    }

    // =================================================================================
    // GEST√ÉO DE EQUIPE
    // =================================================================================
    async function adicionarEquipe() {
        if (!validarCamposTurnoBasicos()) return;
        const nomeInput = document.getElementById('nomeEquipe');
        const matriculaInput = document.getElementById('matriculaEquipe');
        const nome = nomeInput.value.trim();
        const matricula = matriculaInput.value.trim();
        if (nome && matricula) {
            equipe.push({ nome, matricula });
            await salvarEquipe();
            renderizarEquipe();
            nomeInput.value = ''; matriculaInput.value = '';
            showToast('Membro adicionado √† equipe!');
        } else { showToast('Preencha nome e matr√≠cula corretamente!'); }
    }
    async function removerEquipe() {
        abrirPopupConfirmar("Tem certeza que deseja limpar toda a equipe?", async () => {
            equipe = []; await salvarEquipe(); renderizarEquipe(); showToast('Equipe limpa!');
        });
    }
    async function salvarEdicoesEquipe() {
        const inputsNome = document.querySelectorAll('.input-nome-equipe');
        const inputsMatricula = document.querySelectorAll('.input-matricula-equipe');
        const novaEquipe = [];
        for (let i = 0; i < inputsNome.length; i++) {
            const nome = inputsNome[i].value.trim(); const matricula = inputsMatricula[i].value.trim();
            if (nome && matricula) novaEquipe.push({ nome, matricula });
        }
        equipe = novaEquipe; await salvarEquipe(); renderizarEquipe(); showToast('Altera√ß√µes na equipe salvas!');
    }
    function renderizarEquipe() { 
        const box = document.getElementById('boxEquipe');
        if (!box) return;
        if (equipe.length === 0) { box.innerHTML = '<p class="text-sm text-gray-500">Nenhum membro na equipe.</p>'; return; }
        let html = `<div class="mt-2 p-3 bg-gray-50 border border-gray-200 rounded-md space-y-2">`;
        equipe.forEach((item) => {
            html += `<div class="flex space-x-2"><input class="input-nome-equipe flex-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" type="text" value="${item.nome}" placeholder="Nome"><input class="input-matricula-equipe flex-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" type="text" value="${item.matricula}" placeholder="Matr√≠cula"></div>`;
        });
        html += `</div><div class="mt-3 flex space-x-2"><button onclick="salvarEdicoesEquipe()" class="flex-1 py-2 px-4 rounded-md font-semibold transition-colors duration-150 bg-blue-600 text-white hover:bg-blue-700">Salvar</button><button onclick="removerEquipe()" class="flex-1 py-2 px-4 rounded-md font-semibold transition-colors duration-150 bg-red-600 text-white hover:bg-red-700">Limpar</button></div>`;
        box.innerHTML = html;
    }
    function obterEquipeTexto() {
        if (equipe.length === 0) return "Equipe n√£o informada.";
        return equipe.map(item => `${item.nome} - ${item.matricula}`).join('\n');
    }
    async function salvarEquipe() { await salvarTudo(); }

    // =================================================================================
    // GEST√ÉO DE FROTAS
    // =================================================================================
    async function adicionarFrota() {
    if (!validarCamposTurnoBasicos()) return;
    const nomeInput = document.getElementById('novaFrota');
    const horasInputEl = document.getElementById('novaHoraFrota');
    const tipoInput = document.getElementById('tipoFrota');
    const nome = nomeInput.value.trim();
    const horasInput = horasInputEl.value;
    const tipo = tipoInput.value;

    if (frotasTurno.some(f => f.nome.toUpperCase() === nome.toUpperCase())) {
        showToast("Erro: Frota j√° adicionada.");
        return;
    }
    if (!nome || horasInput === "") {
        showToast("Preencha frota e horas!");
        return;
    }
    const horas = parseFloat(horasInput);
    if (isNaN(horas) || horas <= 0) {
        showToast("Horas devem ser n√∫mero positivo!");
        return;
    }
    frotasTurno.push({ nome, horas, tipo });
    renderizarFrotas();
    atualizarSelectsDeFrotasNosServicos();
    nomeInput.value = '';
    horasInputEl.value = '';
    showToast("Frota adicionada!");
    await salvarTudo();

    // Linha adicionada para melhorar a experi√™ncia do usu√°rio
    nomeInput.focus(); 
}
    async function confirmarFrota() {
        if (!validarCamposTurnoBasicos()) return;
        const nome = document.getElementById('inputFrota').value.trim();
        const horasInput = document.getElementById('inputHoraFrota').value;
        const tipo = document.getElementById('popupTipoFrota').value;
        if (frotasTurno.some(f => f.nome.toUpperCase() === nome.toUpperCase())) {
            showToast("Erro: Esta frota j√° foi adicionada.");
            return;
        }
        if (!nome || horasInput === "") {
            showToast("Preencha corretamente a frota e as horas!");
            return;
        }
        const horas = parseFloat(horasInput);
        if (isNaN(horas) || horas <= 0) {
            showToast("As horas da frota devem ser um n√∫mero positivo!");
            return;
        }
        frotasTurno.push({ nome, horas, tipo });
        renderizarFrotas();
        atualizarSelectsDeFrotasNosServicos();
        fecharPopupFrota();
        showToast("Frota adicionada!");
        await salvarTudo();
    }
    function renderizarFrotas() {
        const div = document.getElementById('listaFrotas');
        if (!div) return;
        if (frotasTurno.length === 0) {
            div.innerHTML = "<p class='text-sm text-gray-500'>Nenhuma frota adicionada.</p>";
            return;
        }
        div.innerHTML = frotasTurno.map((f, i) =>
            `<div class="flex justify-between items-center p-2 border-b border-gray-200 text-sm">
                <span>
                    Frota: <strong class="font-semibold">${f.nome}</strong> 
                    <span class="text-xs font-semibold ${f.tipo === 'maquina' ? 'text-blue-600' : 'text-gray-500'}">
                        [${f.tipo === 'maquina' ? 'M√°quina' : 'Implemento'}]
                    </span>
                    - ${f.horas.toFixed(2)}h
                </span>
                <button onclick="removerFrota(${i})" class="py-1 px-2 rounded-md font-semibold transition-colors duration-150 bg-red-500 text-white hover:bg-red-600 text-xs">Remover</button>
            </div>`
        ).join('');
    }
    async function removerFrota(index) {
        abrirPopupConfirmar('Remover esta frota?', async () => {
            frotasTurno.splice(index, 1); renderizarFrotas(); atualizarSelectsDeFrotasNosServicos();
            showToast("Frota removida!"); await salvarTudo();
        });
    }
    function atualizarSelectsDeFrotasNosServicos() {
        servicos.forEach(s => {
            const select = document.getElementById(`frota_${s.id}`);
            if (select) {
                const valorSel = select.value || s.frota;
                select.innerHTML = '<option value="">Nenhuma</option>' + frotasTurno.map(f => `<option value="${f.nome}" ${f.nome === valorSel ? 'selected' : ''}>${f.nome}</option>`).join('');
            }
        });
    }

    // =================================================================================
    // SERVI√áOS (O.S) 
    // =================================================================================
    function adicionarServico(dadosPreenchidos = null) {
        if (!validarCamposTurnoBasicos()) return;
        salvarValoresServicos(); const id = Date.now();
        const novoServico = dadosPreenchidos || {
            id, sistema: "", subsistema: "", frota: "", atividade: "", descricao: "", texto: "",
            tipo: "CORRETIVA", parada: "sim", falha: "n√£o", data: dataHojeInputLocal(), dataFinal: dataHojeInputLocal(), inicio: "", fim: "",
            oportunidade: "", isExpanded: true
        };
        novoServico.id = id; servicos.push(novoServico); renderizarServicos();
        showToast("Novo servi√ßo adicionado.");
        setTimeout(() => { const el = document.getElementById(`servico_${id}`); if (el) el.scrollIntoView({ behavior: 'smooth', block: 'end' }); }, 100);
    }
    function renderizarServicos() {
        const filtroFrota = document.getElementById('filtroServicoFrota')?.value.toLowerCase() || "";
        const filtroDescricao = document.getElementById('filtroServicoDescricao')?.value.toLowerCase() || "";
        const divLista = document.getElementById("servicosLista");
        if (!divLista) return;

        while (divLista.firstChild) {
            divLista.removeChild(divLista.firstChild);
        }

        let servicosFiltrados = servicos.filter(s => {
            const frotaMatch = !filtroFrota || (s.frota && s.frota.toLowerCase().includes(filtroFrota));
            const descricaoMatch = !filtroDescricao || (s.descricao && s.descricao.toLowerCase().includes(filtroDescricao));
            return frotaMatch && descricaoMatch;
        });

        servicosFiltrados.sort((a, b) => {
            const dataA = a.data || '0000-00-00';
            const dataB = b.data || '0000-00-00';
            const horaA = a.inicio || '00:00';
            const horaB = b.inicio || '00:00';
            if (dataA < dataB) return -1;
            if (dataA > dataB) return 1;
            if (horaA < horaB) return -1;
            if (horaA > horaB) return 1;
            return 0;
        });

        if (servicosFiltrados.length === 0) {
            let mensagem = "<p class='text-center text-gray-500'>Nenhum servi√ßo cadastrado neste turno ainda.</p>";
            if (filtroFrota || filtroDescricao) {
                mensagem = "<p class='text-center text-gray-500'>Nenhum servi√ßo encontrado para os filtros aplicados.</p>";
            }
            divLista.innerHTML = mensagem;
        } else {
            const servicoTemplate = document.getElementById('servico-template');
            const servicosAgrupados = servicosFiltrados.reduce((acc, s) => {
                const data = s.data || "Sem Data";
                if (!acc[data]) acc[data] = [];
                acc[data].push(s);
                return acc;
            }, {});

            Object.keys(servicosAgrupados).sort().forEach(dataKey => {
                const containerData = document.createElement('div');
                containerData.className = 'bg-gray-100 p-3 rounded-lg shadow-md';
                containerData.innerHTML = `<h3 class="text-xl font-semibold text-blue-700 mb-3 border-b-2 border-blue-200 pb-2">Servi√ßos de: ${formatarDataParaExibicao(dataKey)}</h3>`;
                
                servicosAgrupados[dataKey].forEach(s => {
                    const clone = servicoTemplate.content.cloneNode(true);
                    const article = clone.querySelector('article');
                    const cabecalho = article.querySelector('.servico-cabecalho');
                    const cabecalhoInfo = article.querySelector('.servico-cabecalho-info');
                    const toggler = article.querySelector('.servico-cabecalho-toggler');
                    const detalhes = article.querySelector('.servico-detalhes');

                    const osNaoGerada = !s.texto || s.texto.trim() === "";
                    article.id = `servico_${s.id}`;
                    if (osNaoGerada) {
                        article.classList.add('servico-pendente-os');
                    }

                    cabecalhoInfo.innerHTML = getCabecalhoServicoTexto(s);
                    toggler.textContent = s.isExpanded ? '‚ñ≤' : '‚ñº';
                    cabecalho.onclick = () => toggleDetalhesServico(s.id);
                    
                    if (s.isExpanded) {
                        detalhes.style.display = 'block';
                    }

                    const subsistemasAtuais = subsistemas[s.sistema] || [];
                    detalhes.innerHTML = `
                        <div class="mt-4 space-y-3">
                            <h5 class="text-md font-semibold text-gray-700 border-b pb-1">Identifica√ß√£o da O.S</h5>
                            <div class="grid grid-cols-2 gap-4">
                                <div><label for="frota_${s.id}" class="block text-sm font-medium text-gray-700">Frota*</label><select id="frota_${s.id}" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" onchange="atualizarCabecalhoServico(${s.id})"><option value="">Nenhuma</option>${frotasTurno.map(f => `<option value="${f.nome}" ${s.frota === f.nome ? 'selected' : ''}>${f.nome}</option>`).join('')}</select></div>
                                <div><label for="atividade_${s.id}" class="block text-sm font-medium text-gray-700">Atividade*</label><select id="atividade_${s.id}" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" onchange="atualizarCabecalhoServico(${s.id})"><option value="">Nenhuma</option>${atividades.map(a => `<option value="${a}" ${s.atividade === a ? 'selected' : ''}>${a}</option>`).join('')}</select></div>
                                <div><label for="sistema_${s.id}" class="block text-sm font-medium text-gray-700">Sistema*</label><select id="sistema_${s.id}" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" onchange="carregarSubsistema(${s.id});"><option value="">Nenhum</option>${Object.entries(sistemas).map(([g, lst]) => `<optgroup label="${g}">${lst.map(sys => `<option value="${sys.cod}" ${s.sistema === sys.cod ? 'selected' : ''}>${sys.cod} - ${sys.nome}</option>`).join('')}</optgroup>`).join('')}</select></div>
                                <div><label for="subsistema_${s.id}" class="block text-sm font-medium text-gray-700">Subsistema*</label><select id="subsistema_${s.id}" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"><option value="">Nenhum</option>${subsistemasAtuais.map(sub => `<option value="${sub}" ${s.subsistema === sub ? 'selected' : ''}>${sub}</option>`).join('')}</select></div>
                            </div>
                        </div>
                        <div class="mt-4 space-y-3">
                            <h5 class="text-md font-semibold text-gray-700 border-b pb-1">Opera√ß√£o</h5>
                            <div class="grid grid-cols-2 gap-4">
                                <div><label class="block text-sm font-medium text-gray-700">M√°quina parada?*</label><select id="parada_${s.id}" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"><option value="sim" ${s.parada === "sim" ? 'selected' : ''}>Sim</option><option value="n√£o" ${s.parada === "n√£o" ? 'selected' : ''}>N√£o</option></select></div>
                                <div><label class="block text-sm font-medium text-gray-700">Falha operacional?*</label><select id="falha_${s.id}" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"><option value="n√£o" ${s.falha === "n√£o" ? 'selected' : ''}>N√£o</option><option value="sim" ${s.falha === "sim" ? 'selected' : ''}>Sim</option></select></div>
                            </div>
                            <div><label class="block text-sm font-medium text-gray-700 mt-3">Tipo de manuten√ß√£o*</label><select id="tipo_${s.id}" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"><option value="CORRETIVA" ${s.tipo === "CORRETIVA" ? 'selected' : ''}>CORRETIVA</option><option value="CONDICIONAL" ${s.tipo === "CONDICIONAL" ? 'selected' : ''}>CONDICIONAL</option><option value="MELHORIA" ${s.tipo === "MELHORIA" ? 'selected' : ''}>MELHORIA</option></select></div>
                            <div class="grid grid-cols-2 gap-4 mt-3">
                                <div><label class="block text-sm font-medium text-gray-700">Data inicial*</label><input type="date" id="data_${s.id}" value="${s.data || dataHojeInputLocal()}" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" onchange="atualizarCabecalhoServico(${s.id})"></div>
                                <div><label class="block text-sm font-medium text-gray-700">Hora inicial*</label><input type="time" id="inicio_${s.id}" value="${s.inicio || ''}" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" onchange="atualizarCabecalhoServico(${s.id})"></div>
                            </div>
                            <div class="grid grid-cols-2 gap-4 mt-3">
                                <div><label class="block text-sm font-medium text-gray-700">Data final*</label><input type="date" id="dataFinal_${s.id}" value="${s.dataFinal || s.data || dataHojeInputLocal()}" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" onchange="atualizarCabecalhoServico(${s.id})"></div>
                                <div><label class="block text-sm font-medium text-gray-700">Hora final*</label><input type="time" id="fim_${s.id}" value="${s.fim || ''}" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" onchange="atualizarCabecalhoServico(${s.id})"></div>
                            </div>
                        </div>
                        <div class="mt-4 space-y-2">
                            <h5 class="text-md font-semibold text-gray-700 border-b pb-1">Descri√ß√£o*</h5>
                            <textarea id="descricao_${s.id}" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm h-28" placeholder="Detalhe o problema encontrado e a solu√ß√£o aplicada...">${s.descricao || ""}</textarea>
                        </div>
                        <div class="mt-4">
                            <div class="flex flex-col space-y-2">
                                <button id="botao_${s.id}" onclick="processarOS(${s.id})" class="py-2 px-4 rounded-md font-semibold transition-colors duration-150 bg-blue-600 text-white hover:bg-blue-700">${osNaoGerada ? "Gerar O.S." : "Regerar O.S."}</button>
                                ${osNaoGerada ? `<button onclick="removerServico(${s.id})" class="py-2 px-4 rounded-md font-semibold transition-colors duration-150 bg-red-600 text-white hover:bg-red-700">Excluir Este Servi√ßo</button>` : ''}
                            </div>
                            <div id="preview_container_${s.id}" class="${osNaoGerada ? 'hidden' : 'block'} mt-4">
                                <div id="preview_${s.id}" class="p-3 bg-gray-50 border rounded-md min-h-[80px] whitespace-pre-line">${interpretarMarkdown(s.texto || "")}</div>
                                <div class="mt-3 flex flex-col sm:flex-row sm:space-y-0 space-y-2 sm:space-x-2">
                                    <button onclick="copiarTexto(${s.id})" class="flex-1 py-2 px-4 rounded-md font-semibold transition-colors duration-150 bg-gray-200 hover:bg-gray-300 text-gray-700 text-sm">Copiar</button>
                                    <button onclick="compartilharWhatsApp(${s.id})" class="flex-1 py-2 px-4 rounded-md font-semibold transition-colors duration-150 bg-green-500 hover:bg-green-600 text-white text-sm">Compartilhar</button>
                                    <button onclick="adicionarServicoDepois(${s.id})" class="flex-1 py-2 px-4 rounded-md font-semibold transition-colors duration-150 bg-blue-500 hover:bg-blue-600 text-white text-sm">Adicionar Outro</button>
                                    <button onclick="removerServico(${s.id})" class="flex-1 py-2 px-4 rounded-md font-semibold transition-colors duration-150 bg-red-600 text-white hover:bg-red-700 text-sm">Excluir</button>
                                </div>
                            </div>
                            <textarea class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm hidden" id="texto_${s.id}">${s.texto || ""}</textarea>
                        </div>`;

                    containerData.appendChild(clone);
                });
                divLista.appendChild(containerData);
            });
        }

        aplicarEventosDeInput();
        const btnAddServicoGlobal = document.getElementById('btnAddServico');
        if (btnAddServicoGlobal) {
            btnAddServicoGlobal.style.display = (servicos.length === 0) ? 'block' : 'none';
        }
    }
    function toggleDetalhesServico(id) {
        const servico = servicos.find(s => s.id === id);
        if (!servico) return;
        servico.isExpanded = !servico.isExpanded;
        // A renderiza√ß√£o cuidar√° do resto, mas para uma resposta instant√¢nea, podemos manipular o DOM diretamente
        const detalhes = document.getElementById(`detalhes_${id}`);
        const toggler = document.getElementById(`toggler_${id}`);
        if (detalhes && toggler) {
            detalhes.style.display = servico.isExpanded ? 'block' : 'none';
            toggler.textContent = servico.isExpanded ? '‚ñ≤' : '‚ñº';
        }
    }
    function aplicarEventosDeInput() {
        document.querySelectorAll('#servicosLista article input, #servicosLista article select, #servicosLista article textarea').forEach(el => {
            el.removeEventListener('input', salvarValoresServicos);
            el.removeEventListener('change', salvarValoresServicos);
            el.addEventListener('input', salvarValoresServicos);
            el.addEventListener('change', salvarValoresServicos);
            if (el.id.startsWith('frota_') || el.id.startsWith('atividade_') || el.id.startsWith('inicio_') || el.id.startsWith('fim_') || el.id.startsWith('data_') || el.id.startsWith('dataFinal_') ) {
                const servicoId = parseInt(el.id.split('_')[1]);
                el.removeEventListener('change', () => atualizarCabecalhoServico(servicoId));
                el.addEventListener('change', () => atualizarCabecalhoServico(servicoId));
            }
        });
    }
    function aplicarFiltrosServicos() { renderizarServicos(); }
    function carregarSubsistema(id) {
        const servico = servicos.find(s => s.id === id);
        if (!servico) return;
        const sistemaSelecionado = document.getElementById(`sistema_${id}`).value;
        servico.sistema = sistemaSelecionado;
        const subsistemasDisponiveis = subsistemas[sistemaSelecionado] || [];
        const selectSub = document.getElementById(`subsistema_${id}`);
        const valorSubsistemaAnterior = servico.subsistema;
        selectSub.innerHTML = `<option value="">Nenhum</option>` +
            subsistemasDisponiveis.map(sub => `<option value="${sub}" ${sub === valorSubsistemaAnterior ? 'selected' : ''}>${sub}</option>`).join('');
        if (!subsistemasDisponiveis.includes(valorSubsistemaAnterior)) {
            servico.subsistema = ""; selectSub.value = "";
        } else {
            selectSub.value = valorSubsistemaAnterior;
        }
    }
    async function processarOS(id) {
        salvarValoresServicos();
        const servico = servicos.find(s => s.id === id);
        if (!servico) { showToast("Erro: Servi√ßo n√£o encontrado."); return; }
        if (!servico.frota || !servico.atividade || !servico.sistema || !servico.subsistema || !servico.descricao.trim() || !servico.data || !servico.inicio || !servico.dataFinal || !servico.fim) {
            abrirPopup("Campos Obrigat√≥rios", "Por favor, preencha todos os campos marcados com (*) na O.S antes de ger√°-la: Frota, Atividade, Sistema, Subsistema, Descri√ß√£o, Datas e Horas.", [{ texto: 'OK', classe: 'confirmar' }]);
            return;
        }
        const dataInicialObj = new Date(`${servico.data}T${servico.inicio}`);
        const dataFinalObj = new Date(`${servico.dataFinal}T${servico.fim}`);
        if (dataFinalObj < dataInicialObj) {
            abrirPopup("Erro de Data/Hora", "A data/hora final n√£o pode ser anterior √† data/hora inicial do servi√ßo.", [{ texto: 'OK', classe: 'confirmar' }]);
            return;
        }
        verificarDataCruzaMeiaNoite(servico, async () => {
            const botao = document.getElementById(`botao_${id}`);
            const osGeradaAnteriormente = servico.texto && servico.texto.trim() !== "";
            const acaoGerar = async () => {
                if (servico.tipo === "CONDICIONAL" || servico.tipo === "MELHORIA") {
                    abrirPopupOportunidade(async (oportunidadeInput) => {
                        servico.oportunidade = oportunidadeInput;
                        await gerarTextoOSFinal(servico);
                    });
                } else {
                    servico.oportunidade = '';
                    await gerarTextoOSFinal(servico);
                }
            };
            if (osGeradaAnteriormente) {
                abrirPopupConfirmar('Deseja realmente regerar esta O.S.? O texto anterior ser√° substitu√≠do.', async () => {
                    await acaoGerar();
                });
            } else {
                await acaoGerar();
            }
        });
    }
    function verificarDataCruzaMeiaNoite(servico, callbackContinua) {
        const dataIniStr = servico.data; const horaIniStr = servico.inicio;
        const dataFimStr = servico.dataFinal; const horaFimStr = servico.fim;
        if (!dataIniStr || !horaIniStr || !dataFimStr || !horaFimStr) { if (callbackContinua) callbackContinua(); return; }
        const [hIni, mIni] = horaIniStr.split(':').map(Number); const [hFim, mFim] = horaFimStr.split(':').map(Number);
        if (dataIniStr === dataFimStr && (hFim < hIni || (hFim === hIni && mFim < mIni))) {
            abrirPopupConfirmar(
                `O hor√°rio final (${horaFimStr}) √© menor que o inicial (${horaIniStr}) na mesma data (${dataIniStr.split('-').reverse().join('/')}). Deseja ajustar a Data Final para o dia seguinte?`,
                () => {
                    const novaData = new Date(dataFimStr + "T00:00:00"); novaData.setDate(novaData.getDate() + 1);
                    const novaDataFormatada = novaData.toISOString().split('T')[0];
                    servico.dataFinal = novaDataFormatada;
                    const inputDataFinal = document.getElementById(`dataFinal_${servico.id}`);
                    if (inputDataFinal) inputDataFinal.value = novaDataFormatada;
                    showToast(`Data final ajustada para ${novaDataFormatada.split('-').reverse().join('/')}.`);
                    if (callbackContinua) callbackContinua();
                }, "Ajuste de Data"
            );
        } else { if (callbackContinua) callbackContinua(); }
    }
    async function gerarTextoOSFinal(servico) {
        const frente = document.getElementById("frente").value.trim() || "N√ÉO INFORMADA";
        const equipeTexto = obterEquipeTexto();
        const [ano, mes, dia] = (servico.data).split('-');
        const dataFormatada = `${dia}/${mes}/${ano}`;
        const [anoF, mesF, diaF] = (servico.dataFinal).split('-');
        const dataFinalFormatada = `${diaF}/${mesF}/${anoF}`;
        const txt = `*SOLICITA√á√ÉO DE O.S*\n\n` +
            `*M√°quina est√° parada por manuten√ß√£o:* \n` +
            `*( ${servico.parada === "sim" ? "‚ùå" : " "} ) sim* *( ${servico.parada === "n√£o" ? "‚ùå" : " "} ) n√£o*\n` +
            `*se SIM abre ORDEM*\n*se N√ÉO abre Pr√©-Ordem*\n\n` +
            `‚Ä¢Frota afetada: ${servico.frota}\n` +
            `‚Ä¢Local/frente: ${frente}\n\n` +
            `‚Ä¢Tipo de manuten√ß√£o:\n` +
            `(${servico.tipo === "CORRETIVA" ? "‚ùå" : " "}) CORRETIVA ORDEM DE MANUTEN√á√ÉO\n` +
            `(${servico.tipo === "CONDICIONAL" ? "‚ùå" : " "}) CONDICIONAL PR√â-ORDEM\n` +
            `(${servico.tipo === "MELHORIA" ? "‚ùå" : " "}) MELHORIA PR√â-ORDEM\n\n` +
            `‚Ä¢Descri√ß√£o servi√ßo\n${servico.descricao}\n(${servico.atividade.split(" - ")[0]} - ${servico.sistema} - ${(servico.subsistema || "").split(" - ")[0]})\n` +
            `${servico.oportunidade ? `Oportunidade: ${servico.oportunidade}\n\n` : '\n'}` +
            `‚Ä¢Foi falha operacional?\n` +
            `(${servico.falha === "sim" ? "‚ùå" : " "}) Sim\n` +
            `(${servico.falha === "n√£o" ? "‚ùå" : " "}) N√£o\n\n` +
            `Data inicial: ${dataFormatada}\n` +
            `Hora inicial: ${servico.inicio}\n` +
            `Data final: ${dataFinalFormatada}\n` +
            `Hora fim: ${servico.fim}\n\n` +
            `Solicitante:\n${equipeTexto}`;
        servico.texto = txt;
        servico.isExpanded = true; 
        await salvarOSnoHistorico(servico.id);
        await salvarTudo();
        showToast("O.S gerada/atualizada!");
        renderizarServicos();
        setTimeout(() => {
            const el = document.getElementById(`preview_container_${servico.id}`);
            if (el) {
                el.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        }, 200);
    }
    function copiarTexto(id) {
        const txt = document.getElementById(`texto_${id}`).value;
        navigator.clipboard.writeText(txt)
            .then(() => {
                showToast("Texto da O.S. copiado!");
                const servico = servicos.find(s => s.id === id);
                if (servico && servico.isExpanded) { toggleDetalhesServico(id); }
            })
            .catch(err => { console.error('Erro ao copiar:', err); showToast("Falha ao copiar."); });
    }
    function compartilharWhatsApp(id) {
        const txt = document.getElementById(`texto_${id}`).value;
        if (!txt) { showToast("Gere a O.S. primeiro."); return; }
        window.open(`https://wa.me/?text=${encodeURIComponent(txt)}`, "_blank");
        const servico = servicos.find(s => s.id === id);
        if (servico && servico.isExpanded) { toggleDetalhesServico(id); }
    }
    async function removerServico(id) {
        abrirPopupConfirmar('Remover este servi√ßo?', async () => {
            const index = servicos.findIndex(s => s.id === id);
            if (index > -1) {
                servicos.splice(index, 1); renderizarServicos(); showToast("Servi√ßo removido!"); await salvarTudo();
            } else { showToast("Erro: Servi√ßo n√£o encontrado."); }
        });
    }
    async function adicionarServicoDepois(idReferencia) {
        salvarValoresServicos();
        const refServico = servicos.find(s => s.id === idReferencia);
        if (!refServico) { showToast("Erro: Servi√ßo de refer√™ncia n√£o encontrado."); adicionarServico(); return; }
        if (refServico.isExpanded) { toggleDetalhesServico(idReferencia); }
        const novoServico = {
            id: Date.now(), sistema: refServico.sistema, subsistema: refServico.subsistema,
            frota: refServico.frota, atividade: "", descricao: "", texto: "", tipo: "CORRETIVA", parada: "sim", falha: "n√£o",
            data: refServico.dataFinal || dataHojeInputLocal(), dataFinal: refServico.dataFinal || dataHojeInputLocal(),
            inicio: refServico.fim || "", fim: "", oportunidade: "", isExpanded: true
        };
        const indexReferencia = servicos.findIndex(s => s.id === idReferencia);
        servicos.splice(indexReferencia + 1, 0, novoServico); renderizarServicos();
        showToast("Novo servi√ßo adicionado abaixo.");
        setTimeout(() => {
            const el = document.getElementById(`servico_${novoServico.id}`);
            if (el) {
                el.scrollIntoView({ behavior: 'smooth', block: 'end' });
                const primeiroInput = document.getElementById(`detalhes_${novoServico.id}`)?.querySelector('select, input, textarea');
                if (primeiroInput) primeiroInput.focus();
            }
        }, 200);
    }
    function salvarValoresServicos() {
        servicos.forEach(s => {
            s.frota = document.getElementById(`frota_${s.id}`)?.value || s.frota || "";
            s.atividade = document.getElementById(`atividade_${s.id}`)?.value || s.atividade || "";
            s.sistema = document.getElementById(`sistema_${s.id}`)?.value || s.sistema || "";
            s.subsistema = document.getElementById(`subsistema_${s.id}`)?.value || s.subsistema || "";
            s.descricao = document.getElementById(`descricao_${s.id}`)?.value || s.descricao || "";
            s.tipo = document.getElementById(`tipo_${s.id}`)?.value || s.tipo || "CORRETIVA";
            s.parada = document.getElementById(`parada_${s.id}`)?.value || s.parada || "sim";
            s.falha = document.getElementById(`falha_${s.id}`)?.value || s.falha || "n√£o";
            s.data = document.getElementById(`data_${s.id}`)?.value || s.data || dataHojeInputLocal();
            s.dataFinal = document.getElementById(`dataFinal_${s.id}`)?.value || s.dataFinal || s.data || dataHojeInputLocal();
            s.inicio = document.getElementById(`inicio_${s.id}`)?.value || s.inicio || "";
            s.fim = document.getElementById(`fim_${s.id}`)?.value || s.fim || "";
            s.texto = document.getElementById(`texto_${s.id}`)?.value || s.texto || "";
        });
    }
    function verificarServicosPendentes() {
        salvarValoresServicos();
        const pendentes = servicos.filter(s => !s.texto || s.texto.trim() === "");
        if (pendentes.length > 0) {
            const mensagens = pendentes.map(s => {
                const frota = s.frota || "Sem Frota"; const atividade = (s.atividade || "Sem Atividade").split(" - ")[0];
                return `Frota: ${frota}, Atividade: ${atividade} - O.S. N√ÉO GERADA.`;
            }).join("\n");
            abrirPopup('Servi√ßos Pendentes',`Existem ${pendentes.length} servi√ßo(s) com O.S. n√£o gerada:\n\n${mensagens}\n\nPor favor, gere as O.S. pendentes.`, [{ texto: 'OK', classe: 'confirmar' }]);
            const primeiroPendente = pendentes[0]; const elemento = document.getElementById(`servico_${primeiroPendente.id}`);
            if (elemento) {
                elemento.scrollIntoView({ behavior: "smooth", block: "center" });
                if (!primeiroPendente.isExpanded) toggleDetalhesServico(primeiroPendente.id);
                showToast("Existem servi√ßos com O.S. n√£o gerada!");
            }
        } else { adicionarServico(); }
    }

    // =================================================================================
    // RELAT√ìRIO
    // =================================================================================
    async function toggleEdicaoRelatorio() {
        const textarea = document.getElementById("relatorio_bruto"); const divFormatado = document.getElementById("relatorio_formatado");
        const botao = document.querySelector('button[onclick="toggleEdicaoRelatorio()"]');
        if (textarea.classList.contains('hidden')) {
            textarea.value = divFormatado.innerText; textarea.classList.remove('hidden'); divFormatado.classList.add('hidden'); textarea.focus();
            botao.innerText = 'Salvar e Ver Formatado'; botao.classList.remove('bg-yellow-500', 'hover:bg-yellow-600'); botao.classList.add('bg-green-500', 'hover:bg-green-600');
        } else {
            divFormatado.innerHTML = interpretarMarkdown(textarea.value); textarea.classList.add('hidden'); divFormatado.classList.remove('hidden');
            botao.innerText = 'Editar Relat√≥rio'; botao.classList.remove('bg-green-500', 'hover:bg-green-600'); botao.classList.add('bg-yellow-500', 'hover:bg-yellow-600');
            await salvarTudo(); showToast("Relat√≥rio atualizado.");
        }
    }
    async function limparRelatorio() {
        abrirPopupConfirmar("Limpar o relat√≥rio atual?", async () => {
            document.getElementById("relatorio_bruto").value = ''; document.getElementById("relatorio_formatado").innerHTML = '';
            await salvarTudo(); showToast("Relat√≥rio limpo!");
        });
    }
    function compartilharRelatorio() {
        const texto = document.getElementById("relatorio_bruto").value.trim() || document.getElementById("relatorio_formatado").innerText.trim();
        if (!texto) { showToast("Relat√≥rio vazio."); return; }
        window.open(`https://wa.me/?text=${encodeURIComponent(texto)}`, "_blank");
    }
    function gerarRelatorioFinal() {
        if (!validarCamposTurnoBasicos()) return; salvarValoresServicos();
        const osPendentes = servicos.some(s => !s.texto || s.texto.trim() === "");
        if (osPendentes) {
            abrirPopupConfirmar("Aten√ß√£o: H√° O.S. n√£o geradas. Relat√≥rio pode ficar incompleto. Continuar?", () => { procederComGeracaoRelatorio(); });
        } else { procederComGeracaoRelatorio(); }
    }
    async function procederComGeracaoRelatorio() {
        const dataInput = document.getElementById("dataTurno").value;
        const fazenda = document.getElementById("fazenda").value.trim() || "N√ÉO INFORMADA";
        const frente = document.getElementById("frente").value.trim() || "N√ÉO INFORMADA";
        const turnoLetra = document.getElementById("turnoLetra").value;
        const equipeTextoRel = obterEquipeTexto();
        const maquinasPrincipais = frotasTurno.filter(f => f.tipo === 'maquina');
        const nomesFrotasComServicos = [...new Set(servicos.map(s => s.frota).filter(Boolean))];
        const frotasAtivasDoTurno = frotasTurno.filter(f => nomesFrotasComServicos.includes(f.nome));
        const horasTotaisPlanejadasCalculadas = calcularHorasTotaisPlanejadasGlobais(maquinasPrincipais);
        const horasTotaisPlanejadasRelatorio = horasTotaisPlanejadasCalculadas.toFixed(2);
        const horasParadasNumerico = calcularHorasParadasTurnoGlobais(frotasAtivasDoTurno);
        const horasParadasTurnoRelatorio = horasParadasNumerico.toFixed(2);
        const dmTurnoRelatorio = calcularDMGeralGlobal(maquinasPrincipais, horasParadasNumerico); 
        const horasPorMaquinaRef = maquinasPrincipais.length > 0 ? (parseFloat(maquinasPrincipais[0].horas) || 0).toFixed(2) : "0.00";
        const frenteUpper = frente.toUpperCase();
        const [ano, mes, dia] = (dataInput || dataHojeInputLocal()).split("-");
        const dataFormatada = `${dia}/${mes}/${ano}`;
        let relatorio = `*MANUTEN√á√ÉO ${frenteUpper} BRACELL*\n\n` +
            `üìÖ *DATA:* ${dataFormatada}\n` + `*FAZENDA:* ${fazenda}\n` + `*FRENTE:* ${frente}\n` + `*TURNO:* ${turnoLetra}\n` +
            `*EQUIPE:*\n${equipeTextoRel}\n\n` +
            `*QTD DE M√ÅQUINAS:* ${maquinasPrincipais.length}\n` +
            `*HORAS PLANEJADAS (por m√°quina):* ${horasPorMaquinaRef}h\n` +
            `*HORAS PLANEJADAS TOTAIS (m√°quinas):* ${horasTotaisPlanejadasRelatorio}h\n` +
            `*HORAS TOTAIS PARADAS (corretivas):* ${horasParadasTurnoRelatorio}h (${formatarHorasParaTexto(horasParadasTurnoRelatorio)})\n` +
            `üü¢ *DM DO TURNO:* ${dmTurnoRelatorio}%\n`;
        if (frotasAtivasDoTurno.length > 0) relatorio += `\n--- DETALHAMENTO POR FROTA ---\n`;
        frotasAtivasDoTurno.forEach(f => {
            const servicosDaFrota = servicos.filter(s => s.frota === f.nome);
            const paradaFrota = calcularHorasParadasPorFrota(f.nome);
            const dmFrota = calcularDMFrota(f.nome);
            const tipoFrotaTexto = f.tipo === 'maquina' ? '[M√ÅQUINA]' : '[IMPLEMENTO]';
            relatorio += `\nüöú *${f.nome.toUpperCase()}* ${tipoFrotaTexto}\n` +
                `Horas Planejada: ${(parseFloat(f.horas) || 0).toFixed(2)}h\n` +
                `Horas Parada (Corretivas): ${paradaFrota}h (${formatarHorasParaTexto(paradaFrota)})\n` +
                `*DM:* ${dmFrota}%\n*RELAT√ìRIO DE SERVI√áOS:*\n\n`;
            servicosDaFrota.forEach(s => {
                const codAtiv = (s.atividade || "N/A").split(" - ")[0];
                const codSub = (s.subsistema || "N/A").split(" - ")[0];
                const duracao = calcularDuracaoServico(s);
                relatorio += `- ${s.descricao.trim() || "Descri√ß√£o n√£o informada"}\n` +
                    `  (${codAtiv} - ${s.sistema || "N/A"} - ${codSub}) ${emojiTipo(s.tipo)} [${s.tipo.toUpperCase()}]\n` +
                    `  ‚è±Ô∏è Dura√ß√£o: ${duracao.texto} (Decimal: ${parseFloat(duracao.horas).toFixed(2)}h)\n`;
                if (s.tipo !== "CORRETIVA" && s.oportunidade) relatorio += `  Oportunidade: ${s.oportunidade}\n`;
                relatorio += `\n`;
            });
        });
        if (frotasAtivasDoTurno.length === 0) {
            relatorio += `\nNenhuma frota com servi√ßos registrados.\n`;
        }
        document.getElementById("relatorio_bruto").value = relatorio;
        document.getElementById("relatorio_formatado").innerHTML = interpretarMarkdown(relatorio);
        await salvarTudo();
        showToast("Relat√≥rio gerado com a l√≥gica de DM corrigida!");
    }
    function calcularHorasTotaisPlanejadasGlobais(listaFrotas) { return listaFrotas.reduce((soma, f) => soma + (parseFloat(f.horas) || 0), 0); }
    function calcularHorasParadasTurnoGlobais(listaFrotas) { let totalHorasParadas = 0; listaFrotas.forEach(f => { totalHorasParadas += parseFloat(calcularHorasParadasPorFrota(f.nome)); }); return totalHorasParadas; }
    function calcularDMGeralGlobal(listaMaquinas, horasParadasJaCalculadas = null) {
        const horasPlanejadas = calcularHorasTotaisPlanejadasGlobais(listaMaquinas);
        if (horasPlanejadas === 0) return listaMaquinas.length > 0 ? "0.00" : "100.00";
        const horasParadas = horasParadasJaCalculadas !== null ? horasParadasJaCalculadas : calcularHorasParadasTurnoGlobais(listaMaquinas);
        const horasOperando = Math.max(0, horasPlanejadas - horasParadas);
        const dm = (horasOperando / horasPlanejadas) * 100;
        return dm.toFixed(2);
    }
    function calcularDuracaoServico(servico) { const inicioVal = servico.inicio || "00:00"; const fimVal = servico.fim || "00:00"; if (!/^\d{2}:\d{2}$/.test(inicioVal) || !/^\d{2}:\d{2}$/.test(fimVal)) return { horas: 0, texto: "Hora inv√°lida" }; const dataInicialStr = servico.data || dataHojeInputLocal(); const dataFinalStr = servico.dataFinal || dataInicialStr; const dataIniObj = new Date(`${dataInicialStr}T${inicioVal}:00`); const dataFimObj = new Date(`${dataFinalStr}T${fimVal}:00`); if (isNaN(dataIniObj.getTime()) || isNaN(dataFimObj.getTime())) return { horas: 0, texto: "Data/Hora Inv." }; if (dataFimObj < dataIniObj) return { horas: 0, texto: "Fim < In√≠cio" }; const diffMs = dataFimObj - dataIniObj; const diffMin = Math.max(Math.floor(diffMs / 60000), 0); const horasDecimais = diffMin / 60; const h = Math.floor(diffMin / 60); const m = diffMin % 60; let textoCompleto = ""; if (h > 0) textoCompleto += `${h}h`; if (m > 0) textoCompleto += `${h > 0 ? " " : ""}${m}min`; if (textoCompleto === "") textoCompleto = "0min"; return { horas: horasDecimais, texto: textoCompleto }; }
    function formatarHorasParaTexto(horasDecimaisStr) { const horasDecimais = parseFloat(horasDecimaisStr); if (isNaN(horasDecimais)) return "N/A"; const horas = Math.floor(horasDecimais); const minutos = Math.round((horasDecimais - horas) * 60); if (horas > 0 && minutos > 0) return `${horas}h ${minutos}min`; else if (horas > 0) return `${horas}h`; else if (minutos > 0) return `${minutos}min`; else return `0min`; }
    function emojiTipo(tipo) { switch (tipo) { case "CORRETIVA": return "üîß"; case "CONDICIONAL": return "‚è≥"; case "MELHORIA": return "‚ú®"; default: return "‚ñ™Ô∏è"; } }
    function calcularHorasParadasPorFrota(nomeFrota) { let totalHorasParada = 0; servicos.filter(s => s.frota === nomeFrota && s.tipo === "CORRETIVA" && s.parada === "sim").forEach(s => { totalHorasParada += parseFloat(calcularDuracaoServico(s).horas); }); return totalHorasParada.toFixed(2); }
    function calcularDMFrota(nomeFrota) { const frotaInfo = frotasTurno.find(f => f.nome === nomeFrota); if (!frotaInfo || !frotaInfo.horas || parseFloat(frotaInfo.horas) <= 0) return "0.00"; const horasPlanejada = parseFloat(frotaInfo.horas); const horasParada = parseFloat(calcularHorasParadasPorFrota(nomeFrota)); const horasOperando = Math.max(0, horasPlanejada - horasParada); const dm = (horasOperando / horasPlanejada) * 100; return dm.toFixed(2); }

    // =================================================================================
    // HIST√ìRICO
    // =================================================================================
    async function salvarOSnoHistorico(idServico) {
        const servicoParaSalvar = servicos.find(s => s.id === idServico);
        if (!servicoParaSalvar || !servicoParaSalvar.texto) return;
        const dataKey = servicoParaSalvar.data.split('-').reverse().join('/');
        const agora = new Date();
        const datahoraRegistro = agora.toLocaleString('pt-BR', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit', second: '2-digit' });
        let itemExistente = null;
        try {
            const todosItens = await dbGetAll(STORE_HISTORICO);
            itemExistente = todosItens.find(item => item.id === servicoParaSalvar.id && item.dataKey === dataKey);
        } catch (e) {
            console.error("Erro ao procurar item existente no hist√≥rico:", e);
        }
        const itemHistorico = {
            id: servicoParaSalvar.id,
            frota: servicoParaSalvar.frota,
            tipo: servicoParaSalvar.tipo,
            texto: servicoParaSalvar.texto,
            atividade: servicoParaSalvar.atividade,
            subsistema: servicoParaSalvar.subsistema,
            inicio: servicoParaSalvar.inicio,
            fim: servicoParaSalvar.fim,
            status: itemExistente ? itemExistente.status : "pendente",
            datahoraRegistro: itemExistente ? itemExistente.datahoraRegistro : datahoraRegistro,
            osNumero: itemExistente ? itemExistente.osNumero : "",
            dataOS: servicoParaSalvar.data,
            dataKey: dataKey
        };
        if (itemExistente && itemExistente.uniqueId) {
            itemHistorico.uniqueId = itemExistente.uniqueId;
        }
        try {
            await dbSave(STORE_HISTORICO, itemHistorico);
            await mostrarHistorico();
        } catch (error) {
            console.error("Erro ao salvar OS no hist√≥rico:", error);
            showToast("Erro ao salvar OS no hist√≥rico.");
        }
    }
    async function mostrarHistorico() {
        try {
            const todosItensHistorico = await dbGetAll(STORE_HISTORICO);
            const historicoAgrupado = {};
            todosItensHistorico.forEach(item => {
                const dataKey = item.dataKey;
                if (!historicoAgrupado[dataKey]) {
                    historicoAgrupado[dataKey] = [];
                }
                historicoAgrupado[dataKey].push(item);
            });
            const div = document.getElementById("historico_lista");
            if (!div) return;
            const datasOrdenadas = Object.keys(historicoAgrupado).sort((a, b) => {
                const [diaA, mesA, anoA] = a.split('/').map(Number);
                const [diaB, mesB, anoB] = b.split('/').map(Number);
                return new Date(anoB, mesB - 1, diaB) - new Date(anoA, mesA - 1, diaA);
            });
            if (datasOrdenadas.length === 0) {
                div.innerHTML = "<p class='text-center text-gray-500'>Nenhuma O.S registada.</p>";
                return;
            }
            let html = "";
            datasOrdenadas.forEach(data => {
                html += `<div class="bg-white p-3 rounded-lg shadow mb-3"><h3 class="text-md font-semibold text-blue-600 mb-2 border-b pb-1">Data da O.S.: ${data}</h3>`;
                const osDoDia = historicoAgrupado[data].sort((a, b) => {
                    const horaA = a.inicio || "00:00";
                    const horaB = b.inicio || "00:00";
                    if (horaA < horaB) return -1;
                    if (horaA > horaB) return 1;
                    return 0;
                });
                osDoDia.forEach(s => {
                    const codAtividade = s.atividade ? s.atividade.split(" - ")[0] : "N/A";
                    const subsistemaInfo = s.subsistema ? s.subsistema.split(" - ")[0] : "N/D";
                    const horaInicioServico = s.inicio || "--:--";
                    const horaFimServico = s.fim || "--:--";
                    html += `<div class="bg-gray-50 p-3 rounded shadow-sm mt-2">
                        <div class="flex justify-between items-center mb-2 text-sm">
                            <div class="flex-grow">
                                <span class="text-gray-700">Frota: <strong class="font-semibold text-blue-700">${s.frota || "N/D"}</strong></span>
                                <span class="text-gray-600"> | ${codAtividade} - ${subsistemaInfo} [${horaInicioServico} - ${horaFimServico}]</span>
                            </div>
                            <button onclick="toggleCorpoHistorico(${s.uniqueId})" class="text-blue-500 hover:text-blue-700 text-xl p-1 ml-2">üëÅÔ∏è</button>
                        </div>
                        <div class="flex flex-wrap items-center gap-x-4 gap-y-1 text-sm mt-1">
                            <label class="font-medium whitespace-nowrap">N¬∫ O.S.:</label>
                            <input id="os_input_${s.uniqueId}" class="block w-28 p-1 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" value="${s.osNumero || ""}" oninput="validarOSInput(${s.uniqueId})" ${s.status === "pendente" ? "" : "disabled"} placeholder="Digite o N¬∫">
                            <span class="font-semibold whitespace-nowrap ${s.status === 'pendente' ? 'text-orange-500' : 'text-green-600'}">Status: ${s.status === "pendente" ? "‚ùå Pendente" : "‚úÖ Finalizada"}</span>
                        </div>
                        <div id="corpo_hist_${s.uniqueId}" class="hidden mt-3">
                            <textarea class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm text-xs font-mono h-32" id="htexto_${s.uniqueId}" readonly>${s.texto}</textarea>
                            <div class="mt-2 flex flex-col sm:flex-row gap-2">
                                ${s.status === "pendente" ? `<button onclick="finalizarOS(${s.uniqueId})" class="py-2 px-4 rounded-md font-semibold transition-colors duration-150 bg-blue-600 text-white hover:bg-blue-700 text-xs flex-1" id="btnFinalizarOS_${s.uniqueId}" ${(!s.osNumero || s.osNumero.trim() === "") ? 'disabled' : ''}>Marcar Finalizada</button>` : `<button id="editarOSBtn_${s.uniqueId}" onclick="habilitarEdicaoOS(${s.uniqueId})" class="py-2 px-4 rounded-md font-semibold transition-colors duration-150 bg-yellow-500 hover:bg-yellow-600 text-white text-xs flex-1">Editar N¬∫ O.S.</button>`}
                                <button onclick="copiarHistorico(${s.uniqueId})" class="py-2 px-4 rounded-md font-semibold transition-colors duration-150 bg-gray-200 hover:bg-gray-300 text-gray-700 text-xs flex-1">Copiar</button>
                                <button onclick="compartilharHistorico(${s.uniqueId})" class="py-2 px-4 rounded-md font-semibold transition-colors duration-150 bg-green-500 hover:bg-green-600 text-white text-xs flex-1">Compartilhar</button>
                                <button onclick="excluirHistoricoItem(${s.uniqueId})" class="py-2 px-4 rounded-md font-semibold transition-colors duration-150 bg-red-600 text-white hover:bg-red-700 text-xs flex-1">Excluir</button>
                            </div>
                        </div>
                    </div>`;
                });
                html += `</div>`;
            });
            div.innerHTML = html;
        } catch (error) {
            console.error("Erro ao mostrar hist√≥rico:", error);
            showToast("Erro ao carregar hist√≥rico.");
            const div = document.getElementById("historico_lista");
            if(div) div.innerHTML = "<p class='text-center text-red-500'>Erro ao carregar hist√≥rico.</p>";
        }
    }
    function validarOSInput(uniqueId) { const input = document.getElementById(`os_input_${uniqueId}`); const btnFinalizar = document.getElementById(`btnFinalizarOS_${uniqueId}`); if (input && btnFinalizar) { btnFinalizar.disabled = input.value.trim() === ""; } }
    function toggleCorpoHistorico(uniqueId) { const corpo = document.getElementById(`corpo_hist_${uniqueId}`); if (corpo) corpo.classList.toggle('hidden'); }
    async function finalizarOS(uniqueId) { const inputOSNumero = document.getElementById(`os_input_${uniqueId}`); const numeroOS = inputOSNumero.value.trim(); if (!numeroOS) { showToast("Preencha o n√∫mero da O.S."); inputOSNumero.focus(); return; } try { const item = await dbGet(STORE_HISTORICO, uniqueId); if (item) { item.status = "finalizada"; item.osNumero = numeroOS; await dbSave(STORE_HISTORICO, item); await mostrarHistorico(); showToast("O.S finalizada!"); } else { showToast("Erro: O.S n√£o encontrada."); } } catch (error) { console.error("Erro ao finalizar OS:", error); showToast("Erro ao atualizar O.S."); } }
    function habilitarEdicaoOS(uniqueId) { const input = document.getElementById(`os_input_${uniqueId}`); const btn = document.getElementById(`editarOSBtn_${uniqueId}`); if (input && btn) { input.disabled = false; input.focus(); btn.innerText = "Confirmar Edi√ß√£o"; btn.classList.remove('bg-yellow-500', 'hover:bg-yellow-600'); btn.classList.add('bg-green-500', 'hover:bg-green-600'); btn.onclick = () => confirmarEdicaoOS(uniqueId); } }
    async function confirmarEdicaoOS(uniqueId) { const input = document.getElementById(`os_input_${uniqueId}`); const numero = input.value.trim(); if (!numero) { showToast("N¬∫ O.S n√£o pode ser vazio."); return; } try { const item = await dbGet(STORE_HISTORICO, uniqueId); if (item) { item.osNumero = numero; await dbSave(STORE_HISTORICO, item); input.disabled = true; const btn = document.getElementById(`editarOSBtn_${uniqueId}`); if (btn) { btn.innerText = "Editar N¬∫ O.S."; btn.classList.remove('bg-green-500', 'hover:bg-green-600'); btn.classList.add('bg-yellow-500', 'hover:bg-yellow-600'); btn.onclick = () => habilitarEdicaoOS(uniqueId); } await mostrarHistorico(); showToast("N¬∫ O.S atualizado!"); } else { showToast("Erro: O.S n√£o encontrada."); } } catch (error) { console.error("Erro ao confirmar edi√ß√£o OS:", error); showToast("Erro ao atualizar O.S."); } }
    function copiarHistorico(uniqueId) { const texto = document.getElementById(`htexto_${uniqueId}`)?.value; if (texto) navigator.clipboard.writeText(texto).then(() => showToast("Texto copiado!")).catch(err => showToast("Falha ao copiar.")); else showToast("Texto n√£o encontrado."); }
    function compartilharHistorico(uniqueId) { const texto = document.getElementById(`htexto_${uniqueId}`)?.value; if (texto) window.open(`https://wa.me/?text=${encodeURIComponent(texto)}`, "_blank"); else showToast("Texto n√£o encontrado."); }
    async function excluirHistoricoItem(uniqueId) { abrirPopupConfirmar(`Excluir esta O.S. do hist√≥rico?`, async () => { try { await dbDelete(STORE_HISTORICO, uniqueId); await mostrarHistorico(); showToast("O.S. exclu√≠da do hist√≥rico!"); } catch (error) { console.error("Erro ao excluir OS do hist√≥rico:", error); showToast("Erro ao excluir O.S."); } }, "Confirmar Exclus√£o"); }
    async function confirmarApagarPorData() { const dataSel = document.getElementById('selectDatas').value; if (!dataSel) { showToast("Selecione uma data."); return; } abrirPopupConfirmar(`Apagar TODO o hist√≥rico de ${dataSel}?`, async () => { try { await initDB(); const store = db.transaction(STORE_HISTORICO, 'readwrite').objectStore(STORE_HISTORICO); const index = store.index('dataKeyIndex'); const request = index.openCursor(IDBKeyRange.only(dataSel)); let count = 0; request.onsuccess = e => { const cursor = e.target.result; if (cursor) { store.delete(cursor.primaryKey); count++; cursor.continue(); } else { if (count > 0) { mostrarHistorico(); showToast(`Hist√≥rico de ${dataSel} apagado!`); } else { showToast(`Nenhum item para ${dataSel}.`); } fecharPopupApagarData(); }}; request.onerror = () => { showToast("Erro ao apagar."); fecharPopupApagarData(); }; } catch (e) { showToast("Erro ao apagar."); fecharPopupApagarData(); } }, "Confirmar Exclus√£o"); }

    // =================================================================================
    // BACKUP E RESTAURA√á√ÉO
    // =================================================================================
    async function baixarBackup(tipo = "historico") { let dadosParaBackup = {}; let nomeArquivoBase; try { await initDB(); if (tipo === "historico") { dadosParaBackup.historicoOS = await dbGetAll(STORE_HISTORICO); nomeArquivoBase = "backup_meuturno_historico_"; if (!dadosParaBackup.historicoOS || dadosParaBackup.historicoOS.length === 0) { showToast("Nenhum dado no hist√≥rico."); return; } } else { dadosParaBackup.turno = await dbGet(STORE_TURNO, TURNO_ATUAL_ID) || {}; dadosParaBackup.historicoOS = await dbGetAll(STORE_HISTORICO); nomeArquivoBase = "backup_meuturno_completo_"; if (Object.keys(dadosParaBackup.turno).length === 0 && (!dadosParaBackup.historicoOS || dadosParaBackup.historicoOS.length === 0)) { showToast("Nenhum dado para backup."); return; } } } catch (error) { console.error(`Erro ao ler para backup (${tipo}):`, error); showToast(`Erro ao preparar backup.`); return; } const blob = new Blob([JSON.stringify(dadosParaBackup, null, 2)], { type: "application/json" }); const url = URL.createObjectURL(blob); const agora = new Date(); const dataHora = agora.toISOString().slice(0, 19).replace(/[:T]/g, '-'); const nomeArquivo = `${nomeArquivoBase}${dataHora}.json`; const a = document.createElement('a'); a.href = url; a.download = nomeArquivo; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url); try { localStorage.setItem("ultimoBackupTimestamp", new Date().toISOString()); } catch (e) { console.warn("Erro ao salvar timestamp:", e); } atualizarInfoUltimoBackup(); showToast(`Backup (${tipo}) criado: ${nomeArquivo}`); }
    function baixarBackupHistorico() { baixarBackup("historico"); }
    function gerarBackupCompleto() { baixarBackup("completo"); }
    async function restaurarBackupHistorico(event) { const file = event.target.files[0]; if (!file) return; abrirPopupConfirmar('Restaurar APENAS o HIST√ìRICO DE O.S.? Turno atual N√ÉO ser√° afetado. N√ÉO PODE SER DESFEITO.', async () => { const reader = new FileReader(); reader.onload = async function (e) { try { const dados = JSON.parse(e.target.result); if (dados && Array.isArray(dados.historicoOS)) { await initDB(); const store = db.transaction(STORE_HISTORICO, 'readwrite').objectStore(STORE_HISTORICO); await new Promise((resolve, reject) => { store.clear().onsuccess = resolve; store.clear().onerror = reject; }); for (const item of dados.historicoOS) { if (item.hasOwnProperty('uniqueId')) delete item.uniqueId; await new Promise((resolve, reject) => { store.add(item).onsuccess = resolve; store.add(item).onerror = reject; }); } await mostrarHistorico(); showToast("Backup do hist√≥rico restaurado!"); } else { showToast("Arquivo de backup de hist√≥rico inv√°lido."); } } catch (err) { console.error("Erro ao restaurar backup hist√≥rico:", err); showToast("Erro ao restaurar backup do hist√≥rico."); } }; reader.readAsText(file); event.target.value = null; }, "Restaurar Hist√≥rico"); }
    async function restaurarBackupCompleto(event) { const file = event.target.files[0]; if (!file) return; abrirPopupConfirmar('Restaurar backup COMPLETO? TODOS os dados atuais (turno, hist√≥rico) SER√ÉO SUBSTITU√çDOS. N√ÉO PODE SER DESFEITO.', async () => { const reader = new FileReader(); reader.onload = async function (e) { try { const dados = JSON.parse(e.target.result); if (dados && typeof dados === 'object') { await initDB(); if (dados.turno) { dados.turno.id = TURNO_ATUAL_ID; await dbSave(STORE_TURNO, dados.turno); } else { await dbClearStore(STORE_TURNO); } const historicoStore = db.transaction(STORE_HISTORICO, 'readwrite').objectStore(STORE_HISTORICO); await new Promise(r => { historicoStore.clear().onsuccess = r; }); if (dados.historicoOS && Array.isArray(dados.historicoOS)) { for (const item of dados.historicoOS) { if (item.hasOwnProperty('uniqueId')) delete item.uniqueId; await new Promise(r => { historicoStore.add(item).onsuccess = r; }); } } await carregarTudo(); await mostrarHistorico(); atualizarInfoUltimoBackup(); showToast("Backup completo restaurado!"); } else { showToast("Arquivo de backup completo inv√°lido."); } } catch (err) { console.error("Erro ao restaurar backup completo:", err); showToast("Erro ao restaurar backup completo."); } }; reader.readAsText(file); event.target.value = null; }, "Restaurar Backup Completo"); }
    function atualizarInfoUltimoBackup() { const pInfo = document.getElementById("infoUltimoBackup"); if (!pInfo) return; let timestamp; try { timestamp = localStorage.getItem("ultimoBackupTimestamp"); } catch (e) { pInfo.textContent = "N√£o foi poss√≠vel verificar."; return; } if (timestamp) { const dataBackup = new Date(timestamp); pInfo.textContent = `√öltimo backup: ${dataBackup.toLocaleDateString('pt-BR')} √†s ${dataBackup.toLocaleTimeString('pt-BR')}.`; const umaSemanaAtras = new Date(); umaSemanaAtras.setDate(umaSemanaAtras.getDate() - 7); if (dataBackup < umaSemanaAtras) pInfo.innerHTML += ' <strong class="text-orange-500">(Antigo!)</strong>'; } else { pInfo.textContent = "Nenhum backup. Recomend√°vel fazer um."; } }

    // =================================================================================
    // LIMPEZA DE DADOS
    // =================================================================================
    async function limparTodosServicos() { abrirPopupConfirmar("Apagar TODOS os servi√ßos do TURNO ATUAL?", async () => { servicos = []; renderizarServicos(); await salvarTudo(); showToast("Servi√ßos do turno atual apagados!"); }, "Limpar Servi√ßos"); }
    async function limparStorage() { abrirPopupConfirmar('Resetar TODOS OS DADOS (turno, hist√≥rico)? A√ß√£o IRREVERS√çVEL. Fa√ßa backup antes!', async () => { try { await initDB(); if (db) { db.close(); db = null; } const deleteRequest = indexedDB.deleteDatabase(DB_NAME); deleteRequest.onsuccess = () => { try { localStorage.clear(); } catch (e) { console.warn("Erro localStorage clear", e); } location.reload(); }; deleteRequest.onerror = () => { showToast("Erro ao apagar DB."); }; deleteRequest.onblocked = () => { showToast("Exclus√£o bloqueada. Feche abas."); }; } catch (e) { console.error("Erro limpar storage:", e); showToast("Erro ao limpar dados."); } }, "Resetar Aplicativo"); }
    
    // =================================================================================
    // PERSIST√äNCIA E CARREGAMENTO
    // =================================================================================
    async function salvarDadosParciaisTurno() { try { const dTurno = await dbGet(STORE_TURNO, TURNO_ATUAL_ID) || { id: TURNO_ATUAL_ID }; dTurno.data = document.getElementById("dataTurno")?.value; dTurno.fazenda = document.getElementById("fazenda")?.value.trim(); dTurno.frente = document.getElementById("frente")?.value.trim(); dTurno.turno = document.getElementById("turnoLetra")?.value; await dbSave(STORE_TURNO, dTurno); } catch (e) { showToast("Erro ao salvar dados parciais."); } }
    async function salvarTudo() { salvarValoresServicos(); const dTurno = { id: TURNO_ATUAL_ID, data: document.getElementById("dataTurno")?.value, fazenda: document.getElementById("fazenda")?.value.trim(), frente: document.getElementById("frente")?.value.trim(), turno: document.getElementById("turnoLetra")?.value, equipe: equipe, frotas: frotasTurno, servicos: servicos, relatorio: document.getElementById("relatorio_bruto")?.value }; try { await dbSave(STORE_TURNO, dTurno); } catch (e) { showToast("Erro cr√≠tico ao salvar."); } }
    async function carregarTudo() {
        try {
            await initDB();
            const dados = await dbGet(STORE_TURNO, TURNO_ATUAL_ID);
            const dataHj = dataHojeInputLocal();
            if (dados && dados.data && dados.data !== dataHj) {
                abrirPopupConfirmar(
                    `Dados de ${dados.data.split('-').reverse().join('/')} encontrados. Deseja iniciar um novo turno para hoje (${dataHj.split('-').reverse().join('/')})? <br><br><strong>Os servi√ßos e o relat√≥rio do dia anterior ser√£o limpos, mas a equipe e a lista de frotas ser√£o mantidas.</strong><br><br><span class="text-red-600 font-bold">PARA MANTER OS SERVI√áOS, CANCELE E ALTERE A DATA MANUALMENTE.</span>`,
                    async () => {
                        servicos = [];
                        document.getElementById("relatorio_bruto").value = '';
                        document.getElementById("relatorio_formatado").innerHTML = '';
                        await dbSave(STORE_TURNO, {
                            id: TURNO_ATUAL_ID,
                            data: dataHj,
                            fazenda: dados.fazenda,
                            frente: dados.frente,
                            turno: dados.turno,
                            equipe: dados.equipe || [],
                            frotas: dados.frotas || [],
                            servicos: [],
                            relatorio: ""
                        });
                        await carregarTudo();
                        showToast("Novo turno iniciado. Frotas e equipe mantidas!");
                    },
                    "Iniciar Novo Turno?",
                    true
                );
                return;
            }
            if (dados) {
                const elD = document.getElementById("dataTurno");
                if (elD) elD.value = dados.data || dataHj;
                const elFa = document.getElementById("fazenda");
                if (elFa) elFa.value = dados.fazenda || "";
                const elFr = document.getElementById("frente");
                if (elFr) elFr.value = dados.frente || "";
                const elTL = document.getElementById("turnoLetra");
                if (elTL) elTL.value = dados.turno || "A";
                equipe = dados.equipe || [];
                frotasTurno = dados.frotas || [];
                servicos = dados.servicos || [];
                frotasTurno.forEach(f => {
                    if (typeof f.tipo === 'undefined') f.tipo = 'maquina';
                });
                servicos.forEach(s => {
                    if (typeof s.isExpanded === 'undefined') s.isExpanded = false;
                });
                const rBruto = dados.relatorio || "";
                const elRBruto = document.getElementById("relatorio_bruto");
                if (elRBruto) elRBruto.value = rBruto;
                const elRForm = document.getElementById("relatorio_formatado");
                if (elRForm) elRForm.innerHTML = interpretarMarkdown(rBruto);
            } else {
                const elD = document.getElementById("dataTurno");
                if (elD) elD.value = dataHj;
                equipe = [];
                frotasTurno = [];
                servicos = [];
            }
        } catch (e) {
            showToast("Erro ao carregar dados.");
            console.error("Erro em carregarTudo:", e);
            const elD = document.getElementById("dataTurno");
            if (elD) elD.value = dataHojeInputLocal();
            equipe = [];
            frotasTurno = [];
            servicos = [];
        }
    }

    // =================================================================================
    // ESTAT√çSTICAS
    // =================================================================================
    async function renderizarEstatisticas() {
        const maquinasPrincipais = frotasTurno.filter(f => f.tipo === 'maquina');
        const dmTurnoAtual = calcularDMGeralGlobal(maquinasPrincipais);
        const dmElement = document.getElementById('stat_dm_turno_atual');
        const dmInfoElement = document.getElementById('stat_dm_info');
        if (dmElement) dmElement.textContent = `${dmTurnoAtual}%`;
        if (dmInfoElement) dmInfoElement.textContent = `Calculada com base em ${maquinasPrincipais.length} m√°quinas principais.`;
        const todosItensHistorico = await dbGetAll(STORE_HISTORICO);
        const osPorDia = {};
        todosItensHistorico.forEach(item => {
            osPorDia[item.dataKey] = (osPorDia[item.dataKey] || 0) + 1;
        });
        const labels = Object.keys(osPorDia).sort((a, b) => {
            const [diaA, mesA, anoA] = a.split('/').map(Number);
            const [diaB, mesB, anoB] = b.split('/').map(Number);
            return new Date(anoA, mesA - 1, diaA) - new Date(anoB, mesB - 1, diaB);
        }).slice(-15);
        const data = labels.map(label => osPorDia[label]);
        const ctx = document.getElementById('graficoHistoricoOS');
        if (!ctx) return;
        if (graficoOS) {
            graficoOS.destroy();
        }
        graficoOS = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'N¬∫ de O.S. Registradas',
                    data: data,
                    backgroundColor: 'rgba(37, 99, 235, 0.6)',
                    borderColor: 'rgba(37, 99, 235, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            stepSize: 1
                        }
                    }
                },
                responsive: true,
                plugins: {
                    legend: {
                        position: 'top',
                    },
                    title: {
                        display: true,
                        text: 'Contagem de O.S. por Dia'
                    }
                }
            }
        });
    }

    // =================================================================================
    // INICIALIZA√á√ÉO E SERVICE WORKER
    // =================================================================================
    async function main() {
    try {
        await initDB();
        await carregarTudo();
        renderizarEquipe();
        renderizarFrotas();
        // A linha abaixo n√£o √© mais necess√°ria pois a renderiza√ß√£o √© otimizada
        // atualizarSelectsDeFrotasNosServicos(); 
        await mostrarHistorico();
        atualizarInfoUltimoBackup();
        abrir('turno');
        const dataEl = document.getElementById("dataTurno");
        if (dataEl && !dataEl.value) dataEl.value = dataHojeInputLocal();
        
        // ADICIONE ESTA LINHA NO FINAL DA FUN√á√ÉO 'main'
        inicializarMenuHamburguer();

    } catch (e) {
        showToast("Erro grave ao iniciar.");
        console.error("Erro na fun√ß√£o main:", e);
    }
}
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('./service-worker.js').then(reg => {
            reg.onupdatefound = () => {
                const newWorker = reg.installing;
                newWorker.onstatechange = () => {
                    if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                        const popup = document.getElementById('update-popup');
                        if (popup) popup.classList.remove('hidden');
                    }
                };
            };
        }).catch(err => console.log('Erro SW:', err));
        navigator.serviceWorker.addEventListener('controllerchange', () => {
            window.location.reload();
        });
    }
    document.addEventListener("DOMContentLoaded", main);
</script>
</body>
</html>