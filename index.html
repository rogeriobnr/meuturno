<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="manifest" href="./manifest.json">
    <meta name="theme-color" content="#1d4ed8">
    <title>Meu Turno</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; }
        #toast {
    position: fixed;
    left: 50%;
    bottom: 30px;
    transform: translate(-50%, 100px); /* Come√ßa fora da tela */
    min-width: 280px;
    background-color: #2c3e50;
    color: #fff;
    text-align: center;
    border-radius: 0.375rem;
    padding: 1rem;
    z-index: 10000;
    box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.4s ease, transform 0.4s ease, visibility 0.4s;
}

#toast.show {
    opacity: 1;
    visibility: visible;
    transform: translate(-50%, 0); /* Move para a posi√ß√£o final */
}

#toast.error { background-color: #c0392b; }
#toast.success { background-color: #27ae60; }
        popup-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.6); z-index: 9998; display: none; backdrop-filter: blur(4px); }
        .popup { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 1.25rem; border-radius: 0.75rem; box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3); z-index: 9999; width: 90%; max-width: 400px; display: none; }
        .menu-open #menu-lateral { transform: translateX(0); }
        .menu-open #menu-overlay { opacity: 1; pointer-events: auto; }
        .campo-invalido { border-color: #ef4444 !important; box-shadow: 0 0 0 2px rgba(239, 68, 68, 0.4); }
        .servico-pendente-os { border-left-width: 4px; border-left-color: #F97316; }
        .servico-pendente-os .servico-cabecalho { background-color: #FFF7ED; }
        .servico-cabecalho { display: flex; justify-content: space-between; align-items: center; cursor: pointer; padding: 0.75rem 1rem; background-color: #e9ecef; border-bottom-width: 1px; border-color: #ced4da; border-top-left-radius: 0.5rem; border-top-right-radius: 0.5rem; }
        .servico-cabecalho-info { flex-grow: 1; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; margin-right: 0.5rem; }
        .servico-cabecalho-info .frota-destaque { font-weight: bold; color: #0056b3; }
        .servico-cabecalho-info .atividade-info { color: #495057; font-size: 0.9em; margin-left: 0.25rem; }
        .servico-cabecalho-toggler { font-size: 1.1em; color: #495057; }
        .servico-detalhes { padding: 1rem; border-width: 1px; border-top-width: 0; border-color: #ced4da; border-bottom-left-radius: 0.5rem; border-bottom-right-radius: 0.5rem; }
        .form-container-flex { display: flex; flex-wrap: wrap; margin-left: -0.5rem; margin-right: -0.5rem; }
        .form-item-half { width: 50%; padding-left: 0.5rem; padding-right: 0.5rem; margin-bottom: 1rem; }
        .form-item-full { width: 100%; padding-left: 0.5rem; padding-right: 0.5rem; margin-bottom: 1rem; }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">
    <header class="bg-blue-800 text-white p-4 shadow-md flex items-center justify-between sticky top-0 z-10">
        <button id="hamburger-btn" class="text-2xl p-2 rounded-full hover:bg-blue-700 transition-colors">&#9776;</button>
        <div class="flex items-center gap-x-3">   
            <img src="logo.png" alt="Logo MeuTurno" class="h-8" onerror="this.style.display='none'">
            <h1 id="header-titulo" class="text-xl font-bold">Turno</h1>
        </div>  
        <div class="w-10"></div> 
    </header>
    <nav id="menu-lateral" class="fixed top-0 left-0 h-full bg-white shadow-lg z-30 transform -translate-x-full transition-transform duration-300 ease-in-out w-3/4 max-w-sm">
        <div class="p-4 border-b"><h2 class="text-2xl font-bold text-blue-800">MeuTurno</h2></div>
         <div class="flex flex-col">
            <a href="#" class="p-4 border-b text-gray-700 hover:bg-gray-100 transition-colors" data-secao="turno">Turno</a>
            <a href="#" class="p-4 border-b text-gray-700 hover:bg-gray-100 transition-colors" data-secao="servicos">Servi√ßos</a>
            <a href="#" class="p-4 border-b text-gray-700 hover:bg-gray-100 transition-colors" data-secao="relatorio">Relat√≥rio</a>
            <a href="#" class="p-4 border-b text-gray-700 hover:bg-gray-100 transition-colors" data-secao="historico">Hist√≥rico</a>
            <a href="#" class="p-4 border-b text-gray-700 hover:bg-gray-100 transition-colors" data-secao="catalogo">Cat√°logo</a>
            <a href="#" class="p-4 border-b text-gray-700 hover:bg-gray-100 transition-colors" data-secao="estatisticas">Estat√≠sticas</a>
             <a href="#" class="p-4 border-b text-gray-700 hover:bg-gray-100 transition-colors" data-secao="config">Configurar</a>
          </div>
     </nav>

    <div id="menu-overlay" class="fixed top-0 left-0 w-full h-full bg-black bg-opacity-50 z-20 opacity-0 pointer-events-none transition-opacity duration-300 ease-in-out"></div>

    <main class="p-4">
        <section id="turno">
            <div class="bg-white p-4 rounded-lg shadow space-y-6">
                <div class="p-4 border border-gray-200 rounded-lg">
                    <h4 class="text-lg font-semibold text-blue-700 mb-3 border-b pb-2">Dados do Turno</h4>
                    <div>
                        <label for="dataTurno" class="block text-sm font-medium text-gray-700"><strong>Data*</strong></label>
                        <input id="dataTurno" type="date" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" onchange="salvarDadosParciaisTurno()" required>
                    </div>
                    <div class="mt-4">
                        <label for="fazenda" class="block text-sm font-medium text-gray-700"><strong>Fazenda*</strong></label>
                        <input id="fazenda" type="text" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" placeholder="Digite o nome da fazenda" onblur="salvarDadosParciaisTurno()" required>
                    </div>
                    <div class="mt-4">
                        <label for="frente" class="block text-sm font-medium text-gray-700"><strong>Frente / Local*</strong></label>
                        <input id="frente" type="text" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" placeholder="Digite a frente de trabalho" onblur="salvarDadosParciaisTurno()" required>
                    </div>
                    <div class="mt-4">
                        <label for="turnoLetra" class="block text-sm font-medium text-gray-700"><strong>Turno</strong></label>
                        <select id="turnoLetra" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" onchange="salvarDadosParciaisTurno()">
                            <option value="A">A</option><option value="B">B</option><option value="C">C</option>
                        </select>
                    </div>
                </div>
                <div class="p-4 border border-gray-200 rounded-lg">
                    <h4 class="text-lg font-semibold text-blue-700 mb-3 border-b pb-2">Equipe</h4>
                    <div class="flex flex-col space-y-2 sm:flex-row sm:space-y-0 sm:space-x-2 mb-2">
                        <input id="nomeEquipe" type="text" class="flex-1 p-2 border border-gray-300 rounded-md" placeholder="Nome">
                        <input id="matriculaEquipe" type="text" class="flex-1 p-2 border border-gray-300 rounded-md" placeholder="Matr√≠cula">
                    </div>
                    <button onclick="adicionarEquipe()" class="w-full sm:w-auto bg-blue-500 hover:bg-blue-600 text-white text-sm py-2 px-3 rounded-md font-semibold">Adicionar Membro</button>
                    <div id="boxEquipe" class="mt-3"></div>
                </div>
                <div class="p-4 border border-gray-200 rounded-lg">
                    <h4 class="text-lg font-semibold text-blue-700 mb-3 border-b pb-2">Frotas</h4>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-2 mb-1">
                        <input id="novaFrota" type="text" class="p-2 border border-gray-300 rounded-md" placeholder="C√≥digo da frota">
                        <input id="novaHoraFrota" type="number" step="0.1" class="p-2 border border-gray-300 rounded-md" placeholder="Ex: 7.5 (7h30min)">
                    </div>
                    <div class="mt-2">
                         <label for="tipoFrota" class="block text-sm font-medium text-gray-700">Tipo de Frota*</label>
                         <select id="tipoFrota" class="mt-1 block w-full p-2 border border-gray-300 rounded-md">
                             <option value="maquina">M√°quina Principal</option>
                             <option value="implemento">Implemento</option>
                             <option value="caminhao">Caminh√£o</option>
                         </select>
                    </div>
                    <small class="block text-xs text-gray-500 my-2">Use ponto para decimal (ex: 7.5).</small>
                    <button onclick="adicionarFrota()" class="w-full sm:w-auto bg-blue-500 hover:bg-blue-600 text-white text-sm py-2 px-3 rounded-md font-semibold">Adicionar Frota</button>
                    <div id="listaFrotas" class="mt-3 space-y-2"></div>
                </div>
            </div>
        </section>
        <section id="servicos" class="hidden"></section>
        <section id="estatisticas" class="hidden"></section>
        <section id="relatorio" class="hidden"></section>
        <section id="historico" class="hidden"></section>
        <section id="config" class="hidden"></section>
        <section id="catalogo" class="hidden"></section>
        <button id="fabAddItemCatalogo" onclick="abrirPopupFormularioItemCatalogo()" class="fixed bottom-12 right-5 bg-purple-600 hover:bg-purple-700 text-white rounded-full w-14 h-14 flex items-center justify-center text-3xl shadow-lg z-50" style="display: none;" title="Adicionar Item ao Cat√°logo">+</button>
        <button id="fabAddFrota" onclick="abrirPopupFrota()" class="fixed bottom-28 right-5 bg-blue-600 hover:bg-blue-700 text-white rounded-full w-14 h-14 flex items-center justify-center text-2xl shadow-lg z-50" style="display: none;" title="Adicionar Frota">üöú</button>
        <button id="fabCriarServico" onclick="adicionarServico()" class="fixed bottom-12 right-5 bg-green-500 hover:bg-green-600 text-white rounded-full w-14 h-14 flex items-center justify-center text-3xl shadow-lg z-50" style="display: none;" title="Adicionar Novo Servi√ßo">+</button>
    </main>
    
        
    <div id="toast"></div>
    
    <div class="popup-overlay" id="overlayGenerico"></div>
    <div class="popup" id="popupGenerico">
        <h3 id="popupTitulo" class="text-xl font-semibold mb-3"></h3>
        <p id="popupMensagem" class="text-sm text-gray-600 mb-4"></p>
        <div class="flex justify-end space-x-2" id="popupBotoes"></div>
    </div>
    
    <div class="popup-overlay" id="overlayFrota"></div>
    <div class="popup" id="popupFrota">
        <h3 class="text-xl font-semibold mb-4">Adicionar Frota</h3>
        <div class="space-y-3">
            <div>
                <label for="inputFrotaPopup" class="block text-sm font-medium text-gray-700">Frota*</label>
                <input type="text" id="inputFrotaPopup" placeholder="Ex.: JD6115J" class="mt-1 w-full p-2 border border-gray-300 rounded-md">
            </div>
            <div>
                <label for="inputHoraFrotaPopup" class="block text-sm font-medium text-gray-700">Horas Planejadas*</label>
                <input type="number" step="0.1" id="inputHoraFrotaPopup" placeholder="Ex.: 7.5 (7h30min)" class="mt-1 w-full p-2 border border-gray-300 rounded-md">
            </div>
            <div>
                <label for="popupTipoFrota" class="block text-sm font-medium text-gray-700">Tipo de Frota*</label>
                <select id="popupTipoFrota" class="mt-1 block w-full p-2 border border-gray-300 rounded-md">
                    <option value="maquina">M√°quina Principal</option>
                    <option value="implemento">Implemento</option>
                    <option value="caminhao">Caminh√£o</option>
                </select>
            </div>
        </div>
        <small class="block text-xs text-gray-500 my-4">Use ponto para decimal.</small>
        <div class="flex justify-end space-x-2">
            <button class="py-2 px-4 rounded-md font-semibold bg-blue-600 text-white hover:bg-blue-700" onclick="confirmarFrotaPopup()">Adicionar</button>
            <button class="py-2 px-4 rounded-md font-semibold bg-gray-300 text-gray-800 hover:bg-gray-400" onclick="fecharPopupFrota()">Cancelar</button>
        </div>
    </div>

    <div id="update-popup" class="hidden fixed bottom-5 left-1/2 transform -translate-x-1/2 bg-blue-600 text-white py-3 px-6 rounded-lg shadow-lg z-[10001] font-semibold">
        Nova vers√£o dispon√≠vel. <button onclick="window.location.reload()" class="ml-2 bg-white text-blue-600 py-1 px-3 rounded-md font-bold">Atualizar</button>
    </div>

    <template id="servico-template">
        <article class="bg-white rounded-lg shadow mb-4">
            <div class="servico-cabecalho"><div class="servico-cabecalho-info"></div><span class="servico-cabecalho-toggler"></span></div>
            <div class="servico-detalhes" style="display:none;"></div>
        </article>
    </template>
    
    <script>
  // A sua configura√ß√£o pessoal do Firebase
  const firebaseConfig = {
    apiKey: "AIzaSyDYVPQ2XFdsg5ViKnE5tyzczTZEVsM2kok",
    authDomain: "meu-turno-app.firebaseapp.com",
    projectId: "meu-turno-app",
    storageBucket: "meu-turno-app.firebasestorage.app",
    messagingSenderId: "967200929614",
    appId: "1:967200929614:web:3acbf1049a10cdbf87501f"
  };

  // Inicializa o Firebase e o Firestore
  const firebaseApp = firebase.initializeApp(firebaseConfig);
  const firestore = firebase.firestore();
  
  // Habilita a persist√™ncia offline (essencial para o seu requisito)
  firestore.enablePersistence()
    .catch((err) => {
        if (err.code == 'failed-precondition') {
            console.warn('Persist√™ncia do Firestore falhou: m√∫ltiplos separadores abertos.');
        } else if (err.code == 'unimplemented') {
            console.warn('O navegador atual n√£o suporta persist√™ncia offline.');
        }
    });
</script>
<script>
'use strict';
document.addEventListener("DOMContentLoaded", main);

// =================================================================================
// 1. ESTADO GLOBAL E CONSTANTES
// =================================================================================
let equipe = [], frotasTurno = [], servicos = [], db, graficoOS = null, callbackPopup = null, debounceTimer;
const DB_NAME = 'meuturnoDB', DB_VERSION = 3, STORE_TURNO = 'turno', STORE_HISTORICO = 'historicoOS', TURNO_ATUAL_ID = 'currentTurno';
const atividades = ["P001 - AFERIDO", "P002 - AJUSTADO", "P003 - ALINHADO", "P004 - APERTADO", "P005 - BALANCEADO", "P006 - CALIBRADO", "P007 - COMPLETADO", "P008 - CONSERTADO COMPONENTE", "P009 - DESAMASSADO", "P010 - DESOBSTRUIDO", "P011 - EMBUCHADO", "P012 - FIXADO", "P013 - FURADO", "P014 - HIGIENIZADO", "P015 - INSPECIONADO", "P016 - INSTALADO", "P017 - ISOLADO", "P018 - LIMPO", "P019 - LUBRIFICADO", "P020 - MODIFICADO", "P021 - REAPERTADO", "P022 - RECARREGADO", "P023 - RECUPERADO", "P024 - REFORMADO", "P025 - REGULADO", "P026 - REMONTADO", "P027 - REPROGRAMADO", "P028 - RETIFICADO", "P029 - SOLDADO", "P030 - SUBSTITUIDO - TROCADO", "P031 - USINADO", "P032 - VEDADO", "H01 - Atraso de transporte", "H02 - DDS", "H03 - Refei√ß√£o", "H04 - Organiza√ß√£o/Limpeza", "H05 - Aguardando pe√ßa", "H06 - Aguardando Ferramenta", "H07 - Aguardando Servi√ßo", "H08 - Falta do colaborador", "H09 - Reuni√£o", "H10 - Ambulatorio", "H11 - Treinamento", "H12 - Outros", "H13 - Deslocamento a terceiros", "H14 - Carregamento de pneus pra conserto", "H15 - Inventario", "H16 - Apoio a Opera√ß√£o"];
const sistemas = { "Tratores": [{ cod: "1", nome: "Estrutura" }, { cod: "2", nome: "Cabine" }, { cod: "3", nome: "Motor Combustao" }, { cod: "4", nome: "Eletrico" }, { cod: "5", nome: "Trem de Forca" }, { cod: "6", nome: "Tracao" }, { cod: "7", nome: "Hidraulico" }, { cod: "8", nome: "Direcao" }, { cod: "9", nome: "Freio" }], "Implementos": [{ cod: "10", nome: "Estrutura" }, { cod: "11", nome: "Tracao" }, { cod: "12", nome: "Adubo" }, { cod: "13", nome: "Hidraulico" }, { cod: "14", nome: "Eletrico" }, { cod: "15", nome: "V-SHEAR" }]};
const subsistemas = { "1": ["1.1 - Chassi", "1.2 - Protecao", "1.3 - Escapamento", "1.4 - Suportes", "1.5 - Escada", "1.6 - Fixacao", "1.7 - Paralama", "1.8 - Tanque", "1.9 - Eixo", "1.10 - Chaparia", "1.11 - Alavanca"], "2": ["2.1 - Refrigecao", "2.2 - Banco", "2.3 - Vidros", "2.4 - Painel", "2.5 - Portas", "2.6 - Hodometro", "2.7 - Radio", "2.8 - Tacografo", "2.9 - Cinto de Seguranca", "2.10 - Cabine", "2.11 - Capo", "2.12 - Buzina"], "3": ["3.1 - Radiador", "3.2 - Motor", "3.3 - Intercooler", "3.4 - Arla", "3.5 - Filtro", "3.6 - Ignicao"], "4": ["4.1 - Iluminacao", "4.2 - Eletrica", "4.3 - Bateria", "4.4 - Chicote", "4.5 - Rastreador", "4.6 - Alternador", "4.7 - Encoder", "4.8 - Camera", "4.9 - Modulo", "4.10 - Comutador", "4.11 - Fluxometro", "4.12 - GPS"], "5": ["5.1 - Cubo", "5.2 - Embreagem", "5.3 - Cambio", "5.4 - Diferencial", "5.5 - Transmissao"], "6": ["6.1 - Pneu", "6.2 - Roda", "6.3 - Esteira", "6.4 - Roda Motriz", "6.5 - Roda Estrelada"], "7": ["7.1 - Mangueiras", "7.2 - Valvulas", "7.3 - Atuador", "7.4 - Bombas", "7.5 - Cilindro", "7.6 - VCR"], "8": ["8.1 - Barra de direcao", "8.2 - Coluna Direcao", "8.3 - Volante"], "9": ["9.1 - Freio", "9.2 - Acumulador"], "10": ["10.1 - Disco de Corte", "10.2 - Cabecalho", "10.3 - Ferramenta Traseira", "10.4 - Limpa Trilho", "10.5 - Quadro", "10.6 - Escarificador", "10.7 - Fixacao", "10.8 - Tanque", "10.9 - Eixo", "10.10 - Braco"], "11": ["11.1 - Pneus", "11.2 - Roda", "11.3 - Mancal"], "12": ["12.1 - Caixa de Adubo"], "13": ["13.1 - Cilindro", "13.2 - Mangueira", "13.3 - Bloco", "13.4 - Valvula"], "14": ["14.1 - Sensores", "14.2 - Chicote"], "15": ["15.1 - Lamina", "15.2 - Ball"]};

// =================================================================================
// 2. INICIALIZA√á√ÉO E L√ìGICA DO PWA
// =================================================================================
async function main() {
    try {
        registrarServiceWorker();
        await initDB();
        sincronizarCatalogo(); 
        
        await carregarDadosIniciais();
        renderizarLayoutInicial();
        inicializarMenuHamburguer();
        abrir('turno');
    } catch (err) {
        console.error("Erro fatal ao inicializar:", err);
        showToast("Erro grave ao iniciar. Tente recarregar.", 'error');
    }
}

function registrarServiceWorker() {
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('./service-worker.js').then(reg => {
            console.log('SW registado:', reg.scope);
            reg.onupdatefound = () => {
                const newWorker = reg.installing;
                newWorker.onstatechange = () => {
                    if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                        document.getElementById('update-popup')?.classList.remove('hidden');
                    }
                };
            };
        }).catch(err => console.error('Erro no SW:', err));
    }
}

// =================================================================================
// 3. CAMADA DE ABSTRA√á√ÉO DO BANCO DE DADOS (INDEXEDDB)
// =================================================================================
function initDB() {
    return new Promise((resolve, reject) => {
        if (db) return resolve(db);
        const request = indexedDB.open(DB_NAME, DB_VERSION);
        request.onupgradeneeded = e => {
            const currentDb = e.target.result;
            if (!currentDb.objectStoreNames.contains(STORE_TURNO)) currentDb.createObjectStore(STORE_TURNO, { keyPath: 'id' });
            if (!currentDb.objectStoreNames.contains(STORE_HISTORICO)) {
                const hStore = currentDb.createObjectStore(STORE_HISTORICO, { keyPath: 'uniqueId', autoIncrement: true });
                hStore.createIndex('dataKeyIndex', 'dataKey', { unique: false });
            }
        };
        request.onsuccess = e => { db = e.target.result; resolve(db); };
        request.onerror = e => { console.error("Erro IndexedDB:", e.target.error); reject(e.target.error); };
    });
}

async function dbExec(storeName, mode, operation) {
    try {
        await initDB();
        return new Promise((resolve, reject) => {
            const t = db.transaction([storeName], mode);
            const s = t.objectStore(storeName);
            const r = operation(s);
            r.onsuccess = e => resolve(e.target.result);
            r.onerror = e => {
                console.error(`Erro na DB store "${storeName}":`, e.target.error);
                reject(e.target.error);
            };
        });
    } catch (err) {
        showToast(`Erro no banco de dados.`, 'error');
        throw err;
    }
}

// =================================================================================
// 4. GEST√ÉO DE DADOS GLOBAIS
// =================================================================================
async function carregarDadosIniciais() {
    try {
        const dados = await dbExec(STORE_TURNO, 'readonly', s => s.get(TURNO_ATUAL_ID));
        const dataHoje = dataHojeInputLocal();
        if (dados) {
            if (dados.data && dados.data !== dataHoje) {
                const confirmado = await new Promise(resolve => abrirPopupConfirmar('Iniciar Novo Turno?', `Dados de ${formatarDataParaExibicao(dados.data)} encontrados. Deseja iniciar um novo turno para hoje? <br><br><strong>A equipe e as frotas ser√£o mantidas, mas os servi√ßos e o relat√≥rio ser√£o limpos.</strong>`, resolve));
                if (confirmado) {
                    equipe = dados.equipe || [];
                    frotasTurno = dados.frotas || [];
                    servicos = [];
                    await salvarTudo(true);
                    showToast("Novo turno iniciado!", 'success');
                } else {
                    carregarEstado(dados);
                }
            } else {
                carregarEstado(dados);
            }
        } else {
            inicializarEstadoVazio();
        }
    } catch (err) {
        showToast('Erro ao carregar dados do turno.', 'error');
        inicializarEstadoVazio();
    }
}

function carregarEstado(dados) {
    equipe = dados.equipe || [];
    frotasTurno = dados.frotas || [];
    servicos = dados.servicos || [];
    frotasTurno.forEach(f => f.tipo = f.tipo || 'maquina');
    servicos.forEach(s => s.isExpanded = s.isExpanded || false);
}

function inicializarEstadoVazio() {
    equipe = [];
    frotasTurno = [];
    servicos = [];
}

function salvarTudo(forcar = false) {
    clearTimeout(debounceTimer);
    const executar = async () => {
        try {
            // Pega o estado atual do relat√≥rio para salvar junto
            const relatorioBruto = document.getElementById("relatorio_bruto")?.value || '';
            const snapshotServicos = document.getElementById("relatorio_snapshot")?.value || '[]';

            const dados = {
                id: TURNO_ATUAL_ID,
                data: document.getElementById("dataTurno")?.value,
                fazenda: document.getElementById("fazenda")?.value.trim(),
                frente: document.getElementById("frente")?.value.trim(),
                turno: document.getElementById("turnoLetra")?.value,
                equipe: equipe,
                frotas: frotasTurno,
                servicos: servicos,
                relatorio: relatorioBruto,
                // ADI√á√ÉO: Guarda a "fotografia" dos servi√ßos usados no relat√≥rio
                relatorioGeradoComServicos: snapshotServicos 
            };
            await dbExec(STORE_TURNO, 'readwrite', s => s.put(dados));
            console.log('Dados salvos (incluindo snapshot do relat√≥rio).');
        } catch (err) {
            showToast('Erro ao salvar os dados.', 'error');
        }
    };
    if (forcar) executar();
    else debounceTimer = setTimeout(executar, 1000);
}

function salvarDadosParciaisTurno() {
    validarCamposTurnoBasicos();
    salvarTudo();
}

// =================================================================================
// 5. RENDERIZA√á√ÉO E UI
// =================================================================================
async function renderizarLayoutInicial() {
    try {
        const d = await dbExec(STORE_TURNO, 'readonly', s => s.get(TURNO_ATUAL_ID)) || {};
        document.getElementById("dataTurno").value = d.data || dataHojeInputLocal();
        document.getElementById("fazenda").value = d.fazenda || "";
        document.getElementById("frente").value = d.frente || "";
        document.getElementById("turnoLetra").value = d.turno || "A";
    } catch (e) {
        console.error("Erro ao renderizar layout inicial", e);
    }
}

// Substitua a sua fun√ß√£o 'abrir' por esta vers√£o completa e corrigida
function abrir(secaoId) {
    // Esconde todas as sec√ß√µes principais
    document.querySelectorAll('main section').forEach(s => s.classList.add('hidden'));
    
    // Mostra a sec√ß√£o ativa e chama a sua fun√ß√£o de renderiza√ß√£o
    const secaoAtiva = document.getElementById(secaoId);
    if (secaoAtiva) {
        secaoAtiva.classList.remove('hidden');
        const renderFunc = window[`renderizarSecao${secaoId.charAt(0).toUpperCase() + secaoId.slice(1)}`];
        if (typeof renderFunc === 'function') {
            renderFunc(secaoAtiva);
        }
    }

    // Atualiza o t√≠tulo no cabe√ßalho
    document.getElementById('header-titulo').textContent = secaoId.charAt(0).toUpperCase() + secaoId.slice(1);
    
    // --- L√ìGICA DE VISIBILIDADE DOS BOT√ïES FLUTUANTES (CORRIGIDA) ---

    // 1. Pega a refer√™ncia de todos os bot√µes flutuantes
    const fabCriarServico = document.getElementById('fabCriarServico');
    const fabFrota = document.getElementById('fabAddFrota');
    const fabAddItemCatalogo = document.getElementById('fabAddItemCatalogo');

    // 2. Esconde todos eles por padr√£o
    fabCriarServico.style.display = 'none';
    fabFrota.style.display = 'none';
    fabAddItemCatalogo.style.display = 'none';

    // 3. Mostra apenas os bot√µes necess√°rios para a sec√ß√£o atual
    if (secaoId === 'servicos') {
        fabCriarServico.style.display = 'flex';
        fabFrota.style.display = 'flex';
    } else if (secaoId === 'catalogo') {
        // Mostra o bot√£o roxo "+" apenas na sec√ß√£o do cat√°logo
        fabAddItemCatalogo.style.display = 'flex';
    }
}

function inicializarMenuHamburguer() {
    const btn = document.getElementById('hamburger-btn');
    const overlay = document.getElementById('menu-overlay');
    const links = document.querySelectorAll('#menu-lateral a');
    const fecharMenu = () => document.body.classList.remove('menu-open');
    btn.addEventListener('click', e => { e.stopPropagation(); document.body.classList.toggle('menu-open'); });
    overlay.addEventListener('click', fecharMenu);
    links.forEach(link => link.addEventListener('click', e => {
        e.preventDefault();
        abrir(link.getAttribute('data-secao'));
        fecharMenu();
    }));
}

// Vari√°vel para controlar o timer do toast e evitar sobreposi√ß√£o
let toastTimer;

function showToast(msg, type = 'info') {
    const t = document.getElementById("toast");
    if (!t) return;

    // Limpa qualquer timer anterior para o caso de toasts muito r√°pidos
    clearTimeout(toastTimer);

    t.textContent = msg;
    // Remove classes antigas e adiciona a nova
    t.className = '';
    t.classList.add(type);
    
    // For√ßa o navegador a reconhecer a mudan√ßa antes de adicionar a classe .show
    // para que a transi√ß√£o CSS funcione sempre.
    requestAnimationFrame(() => {
        t.classList.add('show');
    });

    // Define um timer para esconder o toast
    toastTimer = setTimeout(() => {
        t.classList.remove('show');
    }, 2000); // IMPORTANTE: Aqui voc√™ define a dura√ß√£o em milissegundos. 3000ms = 3 segundos. Mude para 200 se preferir.
}

/**
 * Abre um popup gen√©rico com um campo de input de texto.
 * @param {string} titulo - O t√≠tulo do popup.
 * @param {string} label - O texto da label para o campo de input.
 * @param {string} placeholder - O placeholder para o campo de input.
 * @param {string} valorInicial - O valor inicial para o campo de input.
 * @param {(valor: string|null) => void} callback - Fun√ß√£o chamada com o valor inserido ou null se for cancelado.
 */
function abrirPopupInput(titulo, label, placeholder, valorInicial, callback) {
    // Cria o HTML para o formul√°rio dentro do popup
    const conteudoPopup = `
        <label for="popup-input-field" class="block text-sm font-medium text-gray-700 mb-1">${label}</label>
        <input type="text" id="popup-input-field" class="w-full p-2 border border-gray-300 rounded-md" placeholder="${placeholder}" value="${valorInicial}">
    `;
    
    // Define os bot√µes de a√ß√£o
    const botoes = [
        { 
            texto: 'Confirmar', 
            classe: 'bg-blue-600 text-white hover:bg-blue-700', 
            acao: () => {
                const valor = document.getElementById('popup-input-field').value;
                callback(valor); // Retorna o texto digitado
            } 
        },
        { 
            texto: 'Cancelar', 
            classe: 'bg-gray-300 text-gray-800 hover:bg-gray-400', 
            acao: () => {
                callback(null); // Retorna null para indicar que a a√ß√£o foi cancelada
            } 
        }
    ];
    
    // Abre o popup gen√©rico com o conte√∫do e os bot√µes que cri√°mos
    abrirPopup(titulo, conteudoPopup, botoes);

    // Foca no campo de input assim que o popup abre para facilitar a digita√ß√£o
    setTimeout(() => document.getElementById('popup-input-field')?.focus(), 50);
}

function abrirPopup(titulo, mensagem, botoes = []) {
    document.getElementById('popupTitulo').innerHTML = titulo;
    document.getElementById('popupMensagem').innerHTML = mensagem;
    const divBotoes = document.getElementById('popupBotoes');
    divBotoes.innerHTML = '';
    if (botoes.length === 0) botoes.push({ texto: 'Fechar', classe: 'bg-gray-300 text-gray-800 hover:bg-gray-400', acao: fecharPopup });
    botoes.forEach(b => {
        const btn = document.createElement('button');
        btn.className = `py-2 px-4 rounded-md font-semibold transition-colors duration-150 ${b.classe}`;
        btn.innerHTML = b.texto;
        btn.onclick = () => { fecharPopup(); if (b.acao) b.acao(); };
        divBotoes.appendChild(btn);
    });
    document.getElementById('popupGenerico').style.display = 'block';
    document.getElementById('overlayGenerico').style.display = 'block';
}

function fecharPopup() {
    document.getElementById('popupGenerico').style.display = 'none';
    document.getElementById('overlayGenerico').style.display = 'none';
}

function abrirPopupConfirmar(titulo, mensagem, callback, acaoConfirmar = 'Confirmar') {
    callbackPopup = callback;
    abrirPopup(titulo, mensagem, [
        { texto: acaoConfirmar, classe: 'bg-blue-600 text-white hover:bg-blue-700', acao: () => callback(true) },
        { texto: 'Cancelar', classe: 'bg-gray-300 text-gray-800 hover:bg-gray-400', acao: () => callback(false) }
    ]);
}

// =================================================================================
// 6. VALIDA√á√ÉO E UTILIT√ÅRIOS
// =================================================================================
function validarCamposTurnoBasicos() {
    const campos = ['dataTurno', 'fazenda', 'frente'];
    let todosValidos = true;
    campos.forEach(id => {
        const el = document.getElementById(id);
        if (!el?.value.trim()) {
            el?.classList.add('campo-invalido');
            todosValidos = false;
        } else {
            el?.classList.remove('campo-invalido');
        }
    });
    if (!todosValidos) showToast("Preencha os campos obrigat√≥rios do turno!", 'error');
    return todosValidos;
}

function dataHojeInputLocal() { return new Date().toLocaleDateString('en-CA'); }

function formatarDataParaExibicao(dataStr) {
    if (!dataStr || !/^\d{4}-\d{2}-\d{2}$/.test(dataStr)) return "Sem Data";
    const [ano, mes, dia] = dataStr.split('-');
    return `${dia}/${mes}/${ano}`;
}

function interpretarMarkdown(texto) {
    if (!texto) return "";
    return texto.replace(/\*(.*?)\*/g, '<strong>$1</strong>').replace(/\n/g, '<br>');
}

/**
 * Garante que um cart√£o de servi√ßo espec√≠fico seja minimizado.
 * @param {number} id - O ID do servi√ßo a ser minimizado.
 */
function minimizarServico(id) {
    const servico = servicos.find(s => s.id === id);
    // S√≥ executa a a√ß√£o se o servi√ßo existir e estiver expandido
    if (servico && servico.isExpanded) {
        toggleDetalhesServico(id);
    }
}
/**
 * Gera o texto formatado para o cabe√ßalho de um cart√£o de servi√ßo.
 * @param {object} servico - O objeto do servi√ßo.
 * @returns {string} O HTML formatado para o cabe√ßalho.
 */
function gerarTextoCabecalhoServico(servico) {
    const frota = servico.frota || "N/D";
    const codAtividade = (servico.atividade || "P000").split(" - ")[0];
    const codSistema = servico.sistema || "0";
    const codSubsistema = (servico.subsistema || "0.0").split(" - ")[0];
    const horaInicio = servico.inicio || "--:--";
    const horaFim = servico.fim || "--:--";

    const infoServico = `${codAtividade} - ${codSistema} - ${codSubsistema} [${horaInicio} - ${horaFim}]`;
    
    // Usamos as classes CSS que j√° existem para a estiliza√ß√£o
    return `<strong>Frota:</strong> <span class="frota-destaque">${frota}</span> <span class="atividade-info">| ${infoServico}</span>`;
}

// =================================================================================
// 7. L√ìGICA POR M√ìDULO (SE√á√ÉO)
// =================================================================================
// ---------------------------------
// M√ìDULO: TURNO (TELA INICIAL)
// ---------------------------------
function renderizarSecaoTurno(container) {
    renderizarEquipe();
    renderizarFrotas();
}

function adicionarEquipe() {
    if (!validarCamposTurnoBasicos()) return;
    const nomeEl = document.getElementById('nomeEquipe');
    const matEl = document.getElementById('matriculaEquipe');
    if (nomeEl.value.trim() && matEl.value.trim()) {
        equipe.push({ nome: nomeEl.value.trim(), matricula: matEl.value.trim() });
        renderizarEquipe();
        salvarTudo();
        nomeEl.value = matEl.value = '';
        nomeEl.focus();
        showToast('Membro adicionado!', 'success');
    } else {
        showToast('Preencha nome e matr√≠cula.', 'error');
    }
}

function removerEquipe(index) {
    equipe.splice(index, 1);
    renderizarEquipe();
    salvarTudo();
    showToast('Membro removido.', 'success');
}

function renderizarEquipe() {
    const box = document.getElementById('boxEquipe');
    if (!box) return;
    if (equipe.length === 0) {
        box.innerHTML = '<p class="text-sm text-gray-500">Nenhum membro na equipe.</p>';
        return;
    }
    box.innerHTML = equipe.map((item, i) => `
        <div class="flex justify-between items-center p-2 border-b text-sm">
            <span><strong>${item.nome}</strong> - ${item.matricula}</span>
            <button onclick="removerEquipe(${i})" class="text-red-500 hover:text-red-700 text-xl font-bold px-2" title="Remover membro">&times;</button>
        </div>
    `).join('');
}

function adicionarFrota() {
    if (!validarCamposTurnoBasicos()) return;
    const nomeEl = document.getElementById('novaFrota');
    const horasEl = document.getElementById('novaHoraFrota');
    const tipoEl = document.getElementById('tipoFrota');
    const nome = nomeEl.value.trim().toUpperCase();
    const horas = parseFloat(horasEl.value);
    if (!nome || isNaN(horas) || horas <= 0) {
        showToast('Preencha frota e horas corretamente.', 'error'); return;
    }
    if (frotasTurno.some(f => f.nome === nome)) {
        showToast('Esta frota j√° foi adicionada.', 'error'); return;
    }
    frotasTurno.push({ nome, horas, tipo: tipoEl.value });
    renderizarFrotas();
    salvarTudo();
    nomeEl.value = horasEl.value = '';
    nomeEl.focus();
    showToast('Frota adicionada!', 'success');
}

async function removerFrota(index) {
    const confirmado = await new Promise(resolve => abrirPopupConfirmar('Remover Frota', 'Tem certeza?', resolve));
    if (confirmado) {
        frotasTurno.splice(index, 1);
        renderizarFrotas();
        salvarTudo();
        showToast('Frota removida.', 'success');
    }
}

function renderizarFrotas() {
    const div = document.getElementById('listaFrotas');
    if (!div) return;
    if (frotasTurno.length === 0) {
        div.innerHTML = '<p class="text-sm text-gray-500">Nenhuma frota adicionada.</p>'; return;
    }
    const getTipoTexto = (tipo) => {
        switch (tipo) {
            case 'maquina': return '[M√°quina]';
            case 'implemento': return '[Implemento]';
            case 'caminhao': return '[Caminh√£o]';
            default: return '[N/D]';
        }
    };
    const getTipoCor = (tipo) => {
        switch (tipo) {
            case 'maquina': return 'text-blue-600';
            case 'implemento': return 'text-gray-500';
            case 'caminhao': return 'text-green-600';
            default: return 'text-gray-400';
        }
    };
    frotasTurno.sort((a,b) => a.nome.localeCompare(b.nome));
    div.innerHTML = frotasTurno.map((f, i) => `
        <div class="flex justify-between items-center p-2 border-b text-sm">
            <span>
                <strong class="font-semibold">${f.nome}</strong> 
                <span class="text-xs font-semibold ${getTipoCor(f.tipo)}">${getTipoTexto(f.tipo)}</span>
                 - ${f.horas.toFixed(2).replace('.',',')}h
            </span>
            <button onclick="removerFrota(${i})" class="text-red-500 hover:text-red-700 text-xl font-bold px-2" title="Remover frota">&times;</button>
        </div>
    `).join('');
}

// ---------------------------------
// M√ìDULO: SERVI√áOS
// ---------------------------------
function renderizarSecaoServicos(container) {
    container.innerHTML = `
        <div class="bg-white p-4 rounded-lg shadow mb-4">
            <h4 class="text-lg font-semibold text-blue-700 mb-3 border-b pb-2">Filtrar Servi√ßos</h4>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <input type="text" id="filtroServicoFrota" class="w-full p-2 border border-gray-300 rounded-md" placeholder="Filtrar por Frota..." oninput="renderizarServicos()">
                <input type="text" id="filtroServicoDescricao" class="w-full p-2 border border-gray-300 rounded-md" placeholder="Filtrar por Descri√ß√£o..." oninput="renderizarServicos()">
            </div>
        </div>
        <div id="servicosLista" class="space-y-4"></div>`;
    renderizarServicos();
}

function renderizarServicos() {
    const lista = document.getElementById("servicosLista");
    if(!lista) return;
    const filtroFrota = document.getElementById('filtroServicoFrota')?.value.toLowerCase() || "";
    const filtroDescricao = document.getElementById('filtroServicoDescricao')?.value.toLowerCase() || "";
    
    const servicosFiltrados = servicos.filter(s => 
        (!filtroFrota || s.frota.toLowerCase().includes(filtroFrota)) &&
        (!filtroDescricao || s.descricao.toLowerCase().includes(filtroDescricao))
    );
    servicosFiltrados.sort((a, b) => (a.data + a.inicio).localeCompare(b.data + b.inicio));
    
    lista.innerHTML = ''; 
    if (servicosFiltrados.length === 0) {
        lista.innerHTML = `<p class='text-center text-gray-500 p-4'>Nenhum servi√ßo encontrado.</p>`;
    } else {
        servicosFiltrados.forEach(s => {
            const template = document.getElementById('servico-template').content.cloneNode(true);
            const article = template.querySelector('article');
            article.id = `servico_${s.id}`;
            lista.appendChild(article);
            preencherDetalhesServico(s);
        });
    }
}

function preencherDetalhesServico(s) {
    const article = document.getElementById(`servico_${s.id}`);
    if (!article) return;
    const osNaoGerada = !s.texto;
    if (osNaoGerada) article.classList.add('servico-pendente-os');
    else article.classList.remove('servico-pendente-os');
    const cabecalhoInfo = article.querySelector('.servico-cabecalho-info');
    const toggler = article.querySelector('.servico-cabecalho-toggler');
    const detalhes = article.querySelector('.servico-detalhes');
    
    // ALTERA√á√ÉO AQUI: Usando a nova fun√ß√£o para gerar o cabe√ßalho
    const cabecalhoHTML = gerarTextoCabecalhoServico(s);
    if (cabecalhoInfo.innerHTML !== cabecalhoHTML) {
        cabecalhoInfo.innerHTML = cabecalhoHTML;
    }

    toggler.innerHTML = s.isExpanded ? '&#9650;' : '&#9660;';
    article.querySelector('.servico-cabecalho').onclick = () => toggleDetalhesServico(s.id);
    
    detalhes.style.display = s.isExpanded ? 'block' : 'none';
    if (!s.isExpanded) return; 
    
    const subsistemasAtuais = subsistemas[s.sistema] || [];
    const frotaOptions = '<option value="">Selecione</option>' + frotasTurno.map(f => `<option value="${f.nome}" ${s.frota === f.nome ? 'selected' : ''}>${f.nome}</option>`).join('');
    const atividadeOptions = '<option value="">Selecione</option>' + atividades.map(a => `<option value="${a}" ${s.atividade === a ? 'selected' : ''}>${a}</option>`).join('');
    const sistemaOptions = '<option value="">Selecione</option>' + Object.entries(sistemas).map(([g, lst]) => `<optgroup label="${g}">${lst.map(sys => `<option value="${sys.cod}" ${s.sistema === sys.cod ? 'selected' : ''}>${sys.cod} - ${sys.nome}</option>`).join('')}</optgroup>`).join('');
    const subsistemaOptions = '<option value="">Selecione</option>' + subsistemasAtuais.map(sub => `<option value="${sub}" ${s.subsistema === sub ? 'selected' : ''}>${sub}</option>`).join('');
    
    detalhes.innerHTML = `
        <div class="space-y-4">
            <div>
                <h5 class="text-md font-semibold text-gray-700 border-b pb-1 mb-3">Identifica√ß√£o da O.S</h5>
                <div class="grid grid-cols-2 gap-x-4 gap-y-3">
                    <div><label class="block text-sm font-medium text-gray-700">Frota*</label><select data-id="${s.id}" data-field="frota" class="mt-1 w-full p-2 border rounded-md">${frotaOptions}</select></div>
                    <div><label class="block text-sm font-medium text-gray-700">Atividade*</label><select data-id="${s.id}" data-field="atividade" class="mt-1 w-full p-2 border rounded-md">${atividadeOptions}</select></div>
                    <div><label class="block text-sm font-medium text-gray-700">Sistema*</label><select data-id="${s.id}" data-field="sistema" class="mt-1 w-full p-2 border rounded-md">${sistemaOptions}</select></div>
                    <div><label class="block text-sm font-medium text-gray-700">Subsistema*</label><select data-id="${s.id}" data-field="subsistema" class="mt-1 w-full p-2 border rounded-md">${subsistemaOptions}</select></div>
                </div>
            </div>
            <div>
                 <h5 class="text-md font-semibold text-gray-700 border-b pb-1 mb-3">Opera√ß√£o</h5>
                 <div class="grid grid-cols-2 gap-x-4 gap-y-3">
                    <div><label class="block text-sm font-medium">M√°quina parada?*</label><select data-id="${s.id}" data-field="parada" class="mt-1 w-full p-2 border rounded-md"><option value="sim" ${s.parada === "sim" ? 'selected' : ''}>Sim</option><option value="n√£o" ${s.parada === "n√£o" ? 'selected' : ''}>N√£o</option></select></div>
                    <div><label class="block text-sm font-medium">Falha operacional?*</label><select data-id="${s.id}" data-field="falha" class="mt-1 w-full p-2 border rounded-md"><option value="n√£o" ${s.falha === "n√£o" ? 'selected' : ''}>N√£o</option><option value="sim" ${s.falha === "sim" ? 'selected' : ''}>Sim</option></select></div>
                    <div class="col-span-2"><label class="block text-sm font-medium">Tipo de manuten√ß√£o*</label><select data-id="${s.id}" data-field="tipo" class="mt-1 w-full p-2 border rounded-md"><option value="CORRETIVA" ${s.tipo === "CORRETIVA" ? 'selected' : ''}>Corretiva</option><option value="CONDICIONAL" ${s.tipo === "CONDICIONAL" ? 'selected' : ''}>Condicional</option><option value="MELHORIA" ${s.tipo === "MELHORIA" ? 'selected' : ''}>Melhoria</option></select></div>
                    <div><label class="block text-sm font-medium">Data inicial*</label><input type="date" data-id="${s.id}" data-field="data" value="${s.data}" class="mt-1 w-full p-2 border rounded-md"></div>
                    <div><label class="block text-sm font-medium">Hora inicial*</label><input type="time" data-id="${s.id}" data-field="inicio" value="${s.inicio}" class="mt-1 w-full p-2 border rounded-md"></div>
                    <div><label class="block text-sm font-medium">Data final*</label><input type="date" data-id="${s.id}" data-field="dataFinal" value="${s.dataFinal}" class="mt-1 w-full p-2 border rounded-md"></div>
                    <div><label class="block text-sm font-medium">Hora final*</label><input type="time" data-id="${s.id}" data-field="fim" value="${s.fim}" class="mt-1 w-full p-2 border rounded-md"></div>
                 </div>
            </div>
            <div>
                <h5 class="text-md font-semibold text-gray-700 border-b pb-1 mb-2">Descri√ß√£o*</h5>
                <textarea data-id="${s.id}" data-field="descricao" class="w-full p-2 border rounded-md h-28" placeholder="Detalhe o problema e a solu√ß√£o...">${s.descricao}</textarea>
            </div>
            <div>
                 <div class="flex flex-col space-y-2">
                    <button onclick="processarOS(${s.id})" class="w-full py-2 px-4 rounded-md font-semibold bg-blue-600 text-white hover:bg-blue-700">${osNaoGerada ? "Gerar O.S." : "Regerar O.S."}</button>
                    ${osNaoGerada ? `<button onclick="removerServico(${s.id})" class="w-full py-2 px-4 rounded-md font-semibold bg-red-600 text-white hover:bg-red-700">Excluir Servi√ßo</button>` : ''}
                 </div>
                 <div id="preview_container_${s.id}" class="${osNaoGerada ? 'hidden' : ''} mt-4">
                     <div class="p-3 bg-gray-50 border rounded-md whitespace-pre-line">${interpretarMarkdown(s.texto || "")}</div>
                     <div class="mt-3 grid grid-cols-2 sm:grid-cols-4 gap-2">
                        <button onclick="copiarTexto(${s.id}, this)" class="py-2 px-4 rounded-md font-semibold bg-gray-200 hover:bg-gray-300 text-sm">Copiar</button>
                        <button onclick="compartilharWhatsApp(${s.id})" class="py-2 px-4 rounded-md font-semibold bg-green-500 text-white hover:bg-green-600 text-sm">Compartilhar</button>
                        <button onclick="adicionarServicoDepois(${s.id})" class="py-2 px-4 rounded-md font-semibold bg-blue-500 text-white hover:bg-blue-600 text-sm">Adicionar Outro</button>
                        <button onclick="removerServico(${s.id})" class="py-2 px-4 rounded-md font-semibold bg-red-600 text-white hover:bg-red-700 text-sm">Excluir</button>
                     </div>
                 </div>
            </div>
        </div>
    `;
    detalhes.querySelectorAll('input, select, textarea').forEach(el => {
        el.addEventListener('change', handleServicoInputChange);
        el.addEventListener('input', handleServicoInputChange);
    });
}

function handleServicoInputChange(event) {
    const el = event.target;
    const id = parseInt(el.dataset.id);
    const field = el.dataset.field;
    const servico = servicos.find(s => s.id === id);
    if (!servico) return;

    servico[field] = el.value;
    el.classList.remove('campo-invalido');
    
    // Se o sistema for alterado, limpa o subsistema e re-renderiza para atualizar as op√ß√µes
    if(field === 'sistema') {
        servico.subsistema = ""; 
        renderizarServicos(); 
    }
    
    // ALTERA√á√ÉO AQUI: Lista de campos que devem atualizar o cabe√ßalho
    const camposQueAtualizamCabecalho = ['frota', 'atividade', 'sistema', 'subsistema', 'inicio', 'fim'];
    if (camposQueAtualizamCabecalho.includes(field)) {
        const cabecalhoInfo = document.querySelector(`#servico_${id} .servico-cabecalho-info`);
        if(cabecalhoInfo) {
            // Usa a nova fun√ß√£o para gerar o cabe√ßalho atualizado
            cabecalhoInfo.innerHTML = gerarTextoCabecalhoServico(servico);
        }
    }
    
    salvarTudo();
}

function adicionarServico(dadosPreenchidos = null) {
    if (!validarCamposTurnoBasicos()) return;
    const id = Date.now();
    const novoServico = dadosPreenchidos || {
        id, frota: "", atividade: "", sistema: "", subsistema: "", descricao: "",
        tipo: "CORRETIVA", parada: "sim", falha: "n√£o", 
        data: document.getElementById('dataTurno')?.value || dataHojeInputLocal(),
        inicio: "",
        dataFinal: document.getElementById('dataTurno')?.value || dataHojeInputLocal(),
        fim: "", texto: "", oportunidade: "", isExpanded: true
    };
    servicos.push(novoServico);
    renderizarServicos();
    salvarTudo();
    showToast("Novo servi√ßo adicionado.", 'success');
    setTimeout(() => document.getElementById(`servico_${id}`)?.scrollIntoView({ behavior: 'smooth', block: 'center' }), 100);
}

async function removerServico(id) {
    const confirmado = await new Promise(resolve => abrirPopupConfirmar('Excluir Servi√ßo', 'Tem certeza?', resolve));
    if(confirmado) {
        const index = servicos.findIndex(s => s.id === id);
        if (index > -1) {
            servicos.splice(index, 1);
            renderizarServicos();
            salvarTudo();
            showToast("Servi√ßo removido.", 'success');
        }
    }
}

function toggleDetalhesServico(id) {
    const servico = servicos.find(s => s.id === id);
    if (!servico) return;
    servico.isExpanded = !servico.isExpanded;
    const article = document.getElementById(`servico_${id}`);
    if (!article) return;
    const detalhes = article.querySelector('.servico-detalhes');
    const toggler = article.querySelector('.servico-cabecalho-toggler');
    detalhes.style.display = servico.isExpanded ? 'block' : 'none';
    toggler.innerHTML = servico.isExpanded ? '&#9650;' : '&#9660;';
    if(servico.isExpanded) preencherDetalhesServico(servico);
}

// =================================================================================
// FUN√á√ïES PARA O POPUP DE ADICIONAR FROTA (FAB)
// =================================================================================
function abrirPopupFrota() {
    document.getElementById('inputFrotaPopup').value = '';
    document.getElementById('inputHoraFrotaPopup').value = '';
    document.getElementById('popupFrota').style.display = 'block';
    document.getElementById('overlayFrota').style.display = 'block';
    document.getElementById('inputFrotaPopup').focus();
}

function fecharPopupFrota() {
    document.getElementById('popupFrota').style.display = 'none';
    document.getElementById('overlayFrota').style.display = 'none';
}

function confirmarFrotaPopup() {
    if (!validarCamposTurnoBasicos()) return;
    const nomeInput = document.getElementById('inputFrotaPopup');
    const horasInput = document.getElementById('inputHoraFrotaPopup');
    const tipoInput = document.getElementById('popupTipoFrota');
    const nome = nomeInput.value.trim().toUpperCase();
    const horas = parseFloat(horasInput.value);
    
    if (!nome || isNaN(horas) || horas <= 0) {
        showToast('Preencha a frota e as horas corretamente.', 'error');
        return;
    }
    if (frotasTurno.some(f => f.nome === nome)) {
        showToast('Esta frota j√° foi adicionada.', 'error');
        return;
    }
    
    frotasTurno.push({ nome, horas, tipo: tipoInput.value });
    
    renderizarFrotas(); 
    if(document.getElementById('servicosLista')) {
        renderizarServicos(); 
    }
    salvarTudo(true);
    fecharPopupFrota();
    showToast('Frota adicionada com sucesso!', 'success');
}

async function processarOS(id) {
    const servico = servicos.find(s => s.id === id);
    if (!servico) return;
    const camposObrigatorios = ['frota', 'atividade', 'sistema', 'subsistema', 'descricao', 'data', 'inicio', 'dataFinal', 'fim'];
    let camposInvalidos = [];
    
    
    const article = document.getElementById(`servico_${servico.id}`);
    camposObrigatorios.forEach(field => {
        const el = article.querySelector(`[data-field="${field}"]`);
        if (!servico[field] || servico[field].trim() === "") {
            camposInvalidos.push(field);
            if(el) el.classList.add('campo-invalido');
        } else {
            if(el) el.classList.remove('campo-invalido');
        }
    });

    if (camposInvalidos.length > 0) {
        showToast('Preencha todos os campos obrigat√≥rios.', 'error');
        return;
    }
    
    const dataInicialObj = new Date(`${servico.data}T${servico.inicio}`);
    const dataFinalObj = new Date(`${servico.dataFinal}T${servico.fim}`);
    if (dataFinalObj < dataInicialObj) {
        showToast('A data/hora final n√£o pode ser anterior √† inicial.', 'error');
        article.querySelector('[data-field="dataFinal"]').classList.add('campo-invalido');
        article.querySelector('[data-field="fim"]').classList.add('campo-invalido');
        return;
    }

    const gerarTextoFinal = () => {
        const frente = document.getElementById("frente").value.trim() || "N√ÉO INFORMADA";
        const equipeTexto = equipe.length > 0 ? equipe.map(item => `${item.nome} - ${item.matricula}`).join('\n') : "Equipe n√£o informada.";
        const dataFormatada = formatarDataParaExibicao(servico.data);
        const dataFinalFormatada = formatarDataParaExibicao(servico.dataFinal);
        const txt = `*SOLICITA√á√ÉO DE O.S*\n\n` +
            `*M√°quina est√° parada por manuten√ß√£o:*\n(${servico.parada === "sim" ? "‚ùå" : " "}) sim *(${servico.parada === "n√£o" ? "‚ùå" : " "}) n√£o*\n*se SIM abre ORDEM*\n*se N√ÉO abre Pr√©-Ordem*\n\n` +
            `‚Ä¢Frota afetada: ${servico.frota}\n` +
            `‚Ä¢Local/frente: ${frente}\n\n` +
            `‚Ä¢Tipo de manuten√ß√£o:\n(${servico.tipo === "CORRETIVA" ? "‚ùå" : " "}) CORRETIVA ORDEM DE MANUTEN√á√ÉO\n(${servico.tipo === "CONDICIONAL" ? "‚ùå" : " "}) CONDICIONAL PR√â-ORDEM\n(${servico.tipo === "MELHORIA" ? "‚ùå" : " "}) MELHORIA PR√â-ORDEM\n\n` +
            `‚Ä¢Descri√ß√£o servi√ßo\n${servico.descricao}\n(${servico.atividade.split(" - ")[0]} - ${servico.sistema} - ${(servico.subsistema || "").split(" - ")[0]})\n` +
            `${servico.oportunidade ? `Oportunidade: ${servico.oportunidade}\n\n` : '\n'}` +
            `‚Ä¢Foi falha operacional?\n(${servico.falha === "sim" ? "‚ùå" : " "}) Sim\n(${servico.falha === "n√£o" ? "‚ùå" : " "}) N√£o\n\n` +
            `Data inicial: ${dataFormatada}\n` +
            `Hora inicial: ${servico.inicio}\n` +
            `Data final: ${dataFinalFormatada}\n` +
            `Hora fim: ${servico.fim}\n\n` +
            `Solicitante:\n${equipeTexto}`;
        
        servico.texto = txt;
        servico.isExpanded = true;
        salvarOSnoHistorico(servico.id);
        salvarTudo(true);
        renderizarServicos();
        showToast("O.S. gerada/atualizada!", 'success');
        setTimeout(() => document.getElementById(`servico_${servico.id}`)?.scrollIntoView({ behavior: 'smooth', block: 'center' }), 100);
    };

    if (servico.tipo === "CONDICIONAL" || servico.tipo === "MELHORIA") {
        abrirPopupInput(
            'Informar Oportunidade', 
            'Para manuten√ß√£o Condicional/Melhoria, informe a oportunidade:', 
            'Ex: Refei√ß√£o, DDS...',
            servico.oportunidade || '',
            (oportunidade) => {
                if (oportunidade !== null) {
                    servico.oportunidade = oportunidade;
                    gerarTextoFinal();
                }
            }
        );
    } else {
        servico.oportunidade = "";
        gerarTextoFinal();
    }
}

async function copiarTexto(id, button) {
    const servico = servicos.find(s => s.id === id);
    if (!servico || !servico.texto) {
        showToast("Gere a O.S. primeiro.", 'error'); 
        return;
    }
    try {
        await navigator.clipboard.writeText(servico.texto);
        showToast("Texto da O.S. copiado!", 'success');
        button.innerText = 'Copiado!';
        
        // Minimiza o cart√£o ap√≥s um pequeno atraso para o usu√°rio ver o feedback
        setTimeout(() => {
            minimizarServico(id); 
            button.innerText = 'Copiar';
        }, 1000);

    } catch (err) {
        showToast("Falha ao copiar texto.", 'error');
    }
}

function compartilharWhatsApp(id) {
    const servico = servicos.find(s => s.id === id);
    if (!servico || !servico.texto) {
        showToast("Gere a O.S. primeiro.", 'error'); 
        return;
    }
    window.open(`https://wa.me/?text=${encodeURIComponent(servico.texto)}`, "_blank");
    
    // Minimiza o cart√£o logo ap√≥s abrir o WhatsApp
    minimizarServico(id); 
}

function adicionarServicoDepois(idReferencia) {
    const refServico = servicos.find(s => s.id === idReferencia);
    if (!refServico) return;

    // Minimiza o cart√£o atual primeiro
    minimizarServico(idReferencia);

    const novoServico = {
        id: Date.now(), frota: refServico.frota, atividade: "", sistema: refServico.sistema, subsistema: "",
        descricao: "", tipo: "CORRETIVA", parada: "sim", falha: "n√£o",
        data: refServico.dataFinal, dataFinal: refServico.dataFinal,
        inicio: refServico.fim, fim: "", texto: "", oportunidade: "", isExpanded: true
    };
    
    const index = servicos.findIndex(s => s.id === idReferencia);
    servicos.splice(index + 1, 0, novoServico);
    renderizarServicos();
    salvarTudo();
    showToast("Novo servi√ßo adicionado abaixo.", 'success');
    setTimeout(() => document.getElementById(`servico_${novoServico.id}`)?.scrollIntoView({ behavior: 'smooth', block: 'center' }), 100);
}

// ---------------------------------
// M√ìDULO: ESTAT√çSTICAS
// ---------------------------------
async function renderizarSecaoEstatisticas(container) {
    const maquinasPrincipais = frotasTurno.filter(f => f.tipo === 'maquina');
    const totalHorasParadas = calcularHorasParadasCorretivasTotais();
    const dmTurnoAtual = calcularDMGeral(maquinasPrincipais, totalHorasParadas);
    
    const osHistorico = await dbExec(STORE_HISTORICO, 'readonly', s => s.getAll());
    const osPorDia = {};
    osHistorico.forEach(item => {
        const dataKey = item.dataOS.split('-').reverse().join('/');
        osPorDia[dataKey] = (osPorDia[dataKey] || 0) + 1;
    });
    
    const labels = Object.keys(osPorDia).sort((a,b) => new Date(a.split('/').reverse().join('-')) - new Date(b.split('/').reverse().join('-'))).slice(-15);
    const data = labels.map(label => osPorDia[label]);
    
    container.innerHTML = `
        <div class="bg-white p-4 rounded-lg shadow space-y-6">
            <h2 class="text-2xl font-semibold text-blue-700 border-b pb-3 mb-6 text-center">Estat√≠sticas do Turno</h2>
            <div class="p-4 border border-gray-200 rounded-lg text-center">
                <h4 class="text-lg font-semibold text-blue-700 mb-2">DM do Turno Atual</h4>
                <p class="text-4xl font-bold text-green-600">${dmTurnoAtual}%</p>
                <p class="text-sm text-gray-500 mt-1">Base: ${maquinasPrincipais.length} m√°quinas. Considera paradas corretivas de todas as frotas.</p>
            </div>
            <div class="p-4 border border-gray-200 rounded-lg">
                <h4 class="text-lg font-semibold text-blue-700 mb-3 text-center">O.S. Registradas (√öltimos 15 dias)</h4>
                <canvas id="graficoHistoricoOS"></canvas>
            </div>
        </div>
    `;

    const ctx = document.getElementById('graficoHistoricoOS');
    if(graficoOS) graficoOS.destroy();
    if(ctx){
        graficoOS = new Chart(ctx, {
            type: 'bar',
            data: { labels, datasets: [{ label: 'N¬∫ de O.S.', data, backgroundColor: 'rgba(37, 99, 235, 0.6)', borderColor: 'rgba(37, 99, 235, 1)', borderWidth: 1 }] },
            options: { scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } } }
        });
    }
}
    
// ---------------------------------
// M√ìDULO: RELAT√ìRIO
// ---------------------------------
async function renderizarSecaoRelatorio(container) {
    container.innerHTML = `
        <div class="bg-white p-4 rounded-lg shadow space-y-6">
            <div id="aviso_relatorio_desatualizado" class="hidden p-3 mb-4 text-sm text-yellow-700 bg-yellow-100 rounded-lg" role="alert">
                <span class="font-medium">Aten√ß√£o!</span> Existem servi√ßos novos ou alterados desde que este relat√≥rio foi gerado. Clique em "Gerar Relat√≥rio Final" para o atualizar.
            </div>

            <div class="p-4 border border-gray-200 rounded-lg">
                <h4 class="text-lg font-semibold text-blue-700 mb-3 border-b pb-2 text-center">Visualiza√ß√£o</h4>
                <div id="relatorio_formatado" class="p-3 bg-gray-50 border rounded-md min-h-[100px] whitespace-pre-line"></div>
                <textarea id="relatorio_bruto" class="hidden mt-1 w-full p-2 border rounded-md font-mono h-64"></textarea>
                <input type="hidden" id="relatorio_snapshot">
            </div>
            <div class="p-4 border border-gray-200 rounded-lg">
                <h4 class="text-lg font-semibold text-blue-700 mb-3 border-b pb-2 text-center">A√ß√µes</h4>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                    <button onclick="gerarRelatorioFinal()" class="py-2 px-4 rounded-md font-semibold bg-blue-600 text-white hover:bg-blue-700">Gerar Relat√≥rio Final</button>
                    <button onclick="compartilharRelatorio()" class="py-2 px-4 rounded-md font-semibold bg-gray-500 hover:bg-gray-600 text-white">Compartilhar</button>
                    <button onclick="toggleEdicaoRelatorio(this)" class="py-2 px-4 rounded-md font-semibold bg-yellow-500 hover:bg-yellow-600 text-white">Editar Relat√≥rio</button>
                    <button onclick="limparRelatorio()" class="py-2 px-4 rounded-md font-semibold bg-red-600 text-white hover:bg-red-700">Limpar Relat√≥rio</button>
                </div>
            </div>
        </div>`;

    try {
        const dados = await dbExec(STORE_TURNO, 'readonly', s => s.get(TURNO_ATUAL_ID));
        const relatorioSalvo = dados?.relatorio || '';
        const snapshotSalvo = dados?.relatorioGeradoComServicos || '[]';

        if (relatorioSalvo) {
            document.getElementById('relatorio_bruto').value = relatorioSalvo;
            document.getElementById('relatorio_formatado').innerHTML = interpretarMarkdown(relatorioSalvo);
            document.getElementById('relatorio_snapshot').value = snapshotSalvo;

            // Compara o snapshot com os servi√ßos atuais para ver se h√° mudan√ßas
            if (snapshotSalvo !== JSON.stringify(servicos)) {
                document.getElementById('aviso_relatorio_desatualizado').classList.remove('hidden');
            }
        }
    } catch (e) {
        console.error("Erro ao carregar relat√≥rio salvo:", e);
    }
}


async function gerarRelatorioFinal() {
    if (!validarCamposTurnoBasicos()) return;
    
    // ... (toda a l√≥gica de gera√ß√£o do texto do relat√≥rio permanece a mesma) ...
    const data = document.getElementById("dataTurno").value;
    const fazenda = document.getElementById("fazenda").value.trim().toUpperCase();
    const frente = document.getElementById("frente").value.trim().toUpperCase();
    const turnoLetra = document.getElementById("turnoLetra").value;
    const equipeTexto = equipe.length > 0 ? equipe.map(item => `${item.nome.toUpperCase()} - ${item.matricula}`).join('\n') : "EQUIPE N√ÉO INFORMADA";
    const maquinasPrincipais = frotasTurno.filter(f => f.tipo === 'maquina');
    const horasPlanejadasTotais = maquinasPrincipais.reduce((soma, f) => soma + f.horas, 0);
    const horasParadasTotais = calcularHorasParadasCorretivasTotais();
    const dmGeral = calcularDMGeral(maquinasPrincipais, horasParadasTotais);
    const mediaHorasPorMaquina = maquinasPrincipais.length > 0 ? (horasPlanejadasTotais / maquinasPrincipais.length) : 0;
    let relatorio = `*MANUTEN√á√ÉO ${frente} BRACELL*\n\n` + `üìÖ *DATA:* ${formatarDataParaExibicao(data)}\n` + `*FAZENDA:* ${fazenda}\n` + `*FRENTE:* ${frente}\n` + `*TURNO:* ${turnoLetra}\n` + `*EQUIPE:*\n${equipeTexto}\n\n` + `*QTD DE M√ÅQUINAS:* ${maquinasPrincipais.length}\n` + `*HORAS PLANEJADAS (por m√°quina):* ${mediaHorasPorMaquina.toFixed(2).replace('.',',')}h\n` + `*HORAS PLANEJADAS TOTAIS (m√°quinas):* ${horasPlanejadasTotais.toFixed(2).replace('.',',')}h\n` + `*HORAS TOTAIS PARADAS (corretivas):* ${horasParadasTotais.toFixed(2).replace('.',',')}h (${calcularDuracaoEmHorasMinutos(horasParadasTotais)})\n\n` + `üü¢ *DM DO TURNO:* ${dmGeral}%\n\n` + `--- DETALHAMENTO POR FROTA ---\n`;
    const frotasComServico = [...new Set(servicos.map(s => s.frota))].sort();
    frotasComServico.forEach(nomeFrota => {
        const frota = frotasTurno.find(f => f.nome === nomeFrota);
        if(!frota) return;
        const dmFrota = calcularDMFrota(nomeFrota);
        const horasParadaDaFrota = servicos.filter(s => s.frota === nomeFrota && s.tipo === "CORRETIVA" && s.parada === "sim").reduce((total, s) => total + calcularDuracaoServico(s).horas, 0);
        const getTipoTexto = (tipo) => {
            switch (tipo) {
                case 'maquina': return '[M√ÅQUINA]';
                case 'implemento': return '[IMPLEMENTO]';
                case 'caminhao': return '[CAMINH√ÉO]';
                default: return '[N/D]';
            }
        };
        relatorio += `\nüöú *${frota.nome.toUpperCase()}* ${getTipoTexto(frota.tipo)}\n` + `Horas Planejada: ${frota.horas.toFixed(2).replace('.',',')}h\n` + `Horas Parada (Corretivas): ${horasParadaDaFrota.toFixed(2).replace('.',',')}h (${calcularDuracaoEmHorasMinutos(horasParadaDaFrota)})\n` + `*DM:* ${dmFrota}%\n` + `*RELAT√ìRIO DE SERVI√áOS:*\n\n`;
        servicos.filter(s => s.frota === nomeFrota).forEach(s => {
            const duracao = calcularDuracaoServico(s);
            const codAtiv = (s.atividade || "N/A").split(" - ")[0];
            const codSistema = s.sistema || "N/A";
            const codSub = (s.subsistema || "N/A").split(" - ")[0];
            const emoji = s.tipo === "CORRETIVA" ? "üîß" : (s.tipo === "CONDICIONAL" ? "‚è≥" : "‚ú®");
            relatorio += `${s.descricao.trim()}\n` + `  (${codAtiv} - ${codSistema} - ${codSub}) ${emoji} [${s.tipo}]\n` + `  ‚è±Ô∏è Dura√ß√£o: ${duracao.texto} (Decimal: ${duracao.horas.toFixed(2).replace('.',',')}h)\n`;
            if (s.oportunidade) {
                relatorio += `Oportunidade: ${s.oportunidade}\n`;
            }
            relatorio += '\n'; 
        });
    });

    document.getElementById('relatorio_bruto').value = relatorio;
    document.getElementById('relatorio_formatado').innerHTML = interpretarMarkdown(relatorio);
    // ADI√á√ÉO: Guarda a "fotografia" dos servi√ßos no momento da gera√ß√£o
    document.getElementById('relatorio_snapshot').value = JSON.stringify(servicos);
    // Esconde o aviso, pois o relat√≥rio est√° atualizado
    document.getElementById('aviso_relatorio_desatualizado').classList.add('hidden');
    
    salvarTudo(true);
    showToast('Relat√≥rio gerado e salvo!', 'success');
}

/**
 * Fun√ß√£o auxiliar para converter horas decimais em texto (ex: 1.5 -> "1h 30min")
 * @param {number} horasDecimais - O valor de horas em decimal.
 * @returns {string} O texto formatado.
 */
function calcularDuracaoEmHorasMinutos(horasDecimais) {
    if (isNaN(horasDecimais) || horasDecimais <= 0) return "0min";
    const h = Math.floor(horasDecimais);
    const m = Math.round((horasDecimais - h) * 60);
    let texto = "";
    if (h > 0) texto += `${h}h `;
    if (m > 0) texto += `${m}min`;
    return texto.trim() || "0min";
}

function compartilharRelatorio() {
    const texto = document.getElementById("relatorio_bruto").value;
    if (!texto.trim()) {
        showToast("Gere o relat√≥rio primeiro.", "error"); return;
    }
    window.open(`https://wa.me/?text=${encodeURIComponent(texto)}`, "_blank");
}

function toggleEdicaoRelatorio(button) {
    const textarea = document.getElementById("relatorio_bruto");
    const div = document.getElementById("relatorio_formatado");
    if (textarea.classList.contains('hidden')) {
        textarea.value = div.innerText; 
        textarea.classList.remove('hidden');
        div.classList.add('hidden');
        button.innerText = 'Salvar Edi√ß√£o';
        button.classList.replace('bg-yellow-500', 'bg-green-500');
    } else {
        div.innerHTML = interpretarMarkdown(textarea.value);
        textarea.classList.add('hidden');
        div.classList.remove('hidden');
        button.innerText = 'Editar Relat√≥rio';
        button.classList.replace('bg-green-500', 'bg-yellow-500');
        showToast('Relat√≥rio atualizado.', 'success');
    }
}

async function limparRelatorio() {
    const confirmado = await new Promise(resolve => abrirPopupConfirmar('Limpar Relat√≥rio', 'Deseja limpar o relat√≥rio atual?', resolve));
    if (confirmado) {
        document.getElementById('relatorio_bruto').value = '';
        document.getElementById('relatorio_formatado').innerHTML = '';
        showToast('Relat√≥rio limpo.', 'success');
    }
}

// ---------------------------------
// M√ìDULO: HIST√ìRICO
// ---------------------------------
async function renderizarSecaoHistorico(container) {
    container.innerHTML = `
        <div class="bg-white p-4 rounded-lg shadow mb-4">
            <button onclick="abrirPopupApagarPorData()" class="w-full sm:w-auto py-2 px-4 rounded-md font-semibold bg-red-600 text-white hover:bg-red-700">
                üóëÔ∏è Apagar Hist√≥rico por Data
            </button>
        </div>
        <div id="historico_lista" class="space-y-4"></div>`;
    await mostrarHistorico();
}

async function salvarOSnoHistorico(serviceId) {
    const servico = servicos.find(s => s.id === serviceId);
    if (!servico || !servico.texto) return;
    try {
        const todosItens = await dbExec(STORE_HISTORICO, 'readonly', s => s.getAll());
        let itemExistente = todosItens.find(item => item.id === servico.id);
        
        const itemHistorico = {
            id: servico.id,
            frota: servico.frota,
            tipo: servico.tipo,
            texto: servico.texto,
            atividade: servico.atividade,
            subsistema: servico.subsistema,
            inicio: servico.inicio,
            fim: servico.fim,
            dataOS: servico.data,
            dataKey: formatarDataParaExibicao(servico.data).replace(/\//g, '-'),
            status: itemExistente ? itemExistente.status : "pendente",
            osNumero: itemExistente ? itemExistente.osNumero : "",
            datahoraRegistro: itemExistente ? itemExistente.datahoraRegistro : new Date().toLocaleString('pt-BR')
        };
        
        if (itemExistente) itemHistorico.uniqueId = itemExistente.uniqueId;
        await dbExec(STORE_HISTORICO, 'readwrite', s => s.put(itemHistorico));
    } catch(err) {
        showToast("Erro ao salvar O.S. no hist√≥rico.", "error");
    }
}

async function mostrarHistorico() {
    const div = document.getElementById("historico_lista");
    if(!div) return;
    try {
        const todosItens = await dbExec(STORE_HISTORICO, 'readonly', s => s.getAll());
        if (todosItens.length === 0) {
            div.innerHTML = "<p class='text-center text-gray-500 p-4'>Nenhuma O.S. registada no hist√≥rico.</p>";
            return;
        }
        const agrupado = todosItens.reduce((acc, item) => {
            const dataKey = item.dataOS;
            if(!acc[dataKey]) acc[dataKey] = [];
            acc[dataKey].push(item);
            return acc;
        }, {});
        
        const datasOrdenadas = Object.keys(agrupado).sort((a,b) => b.localeCompare(a));
        
        div.innerHTML = datasOrdenadas.map(dataKey => `
            <div class="bg-gray-100 p-3 rounded-lg shadow-md">
                <h3 class="text-xl font-semibold text-blue-700 mb-3 border-b-2 pb-2">Servi√ßos de: ${formatarDataParaExibicao(dataKey)}</h3>
                ${agrupado[dataKey].sort((a,b) => a.inicio.localeCompare(b.inicio)).map(s => `
                    <div class="bg-white p-3 rounded-lg shadow-sm mt-2">
                        <div class="flex justify-between items-center mb-2 text-sm">
                            <div class="flex-grow">
                                <span class="font-semibold text-blue-700">${s.frota}</span> | ${s.atividade.split(" - ")[0]} [${s.inicio} - ${s.fim}]
                            </div>
                            <button onclick="toggleCorpoHistorico(${s.uniqueId})" class="text-blue-500 hover:text-blue-700 text-xl p-1 ml-2">üëÅÔ∏è</button>
                        </div>
                        <div class="flex flex-wrap items-center gap-x-4 gap-y-1 text-sm mt-1">
                             <label class="font-medium whitespace-nowrap">N¬∫ O.S.:</label>
                             <input id="os_input_${s.uniqueId}" class="w-28 p-1 border rounded" value="${s.osNumero || ""}" oninput="validarOSInput(${s.uniqueId})" ${s.status === "pendente" ? "" : "disabled"}>
                             <span class="font-semibold ${s.status === 'pendente' ? 'text-orange-500' : 'text-green-600'}">${s.status === "pendente" ? "‚ùå Pendente" : "‚úÖ Finalizada"}</span>
                        </div>
                        <div id="corpo_hist_${s.uniqueId}" class="hidden mt-3">
                             <textarea class="w-full p-2 border rounded text-xs h-32" readonly>${s.texto}</textarea>
                             <div class="mt-2 grid grid-cols-2 sm:grid-cols-4 gap-2">
                                 ${s.status === 'pendente' ? `<button id="btnFinalizarOS_${s.uniqueId}" onclick="finalizarOS(${s.uniqueId})" class="py-2 rounded bg-blue-600 text-white text-xs" ${!s.osNumero ? 'disabled' : ''}>Finalizar</button>` : `<button onclick="habilitarEdicaoOS(${s.uniqueId}, this)" class="py-2 rounded bg-yellow-500 text-white text-xs">Editar N¬∫</button>`}
                                 <button onclick="copiarHistorico(${s.uniqueId})" class="py-2 rounded bg-gray-200 text-xs">Copiar</button>
                                 <button onclick="compartilharHistorico(${s.uniqueId})" class="py-2 rounded bg-green-500 text-white text-xs">Compartilhar</button>
                                 <button onclick="excluirHistoricoItem(${s.uniqueId})" class="py-2 rounded bg-red-600 text-white text-xs">Excluir</button>
                             </div>
                        </div>
                    </div>
                `).join('')}
            </div>
        `).join('');
    } catch(e) {
        div.innerHTML = "<p class='text-center text-red-500 p-4'>Erro ao carregar hist√≥rico.</p>";
    }
}

function validarOSInput(id) { document.getElementById(`btnFinalizarOS_${id}`).disabled = !document.getElementById(`os_input_${id}`).value.trim(); }
function toggleCorpoHistorico(id) { document.getElementById(`corpo_hist_${id}`)?.classList.toggle('hidden'); }
function copiarHistorico(id) { navigator.clipboard.writeText(document.querySelector(`#corpo_hist_${id} textarea`).value); showToast('Copiado!', 'success'); }
function compartilharHistorico(id) { window.open(`https://wa.me/?text=${encodeURIComponent(document.querySelector(`#corpo_hist_${id} textarea`).value)}`, "_blank"); }

async function finalizarOS(id) {
    const osNumero = document.getElementById(`os_input_${id}`).value.trim();
    if(!osNumero) { showToast('Digite o n√∫mero da O.S.', 'error'); return; }
    try {
        const item = await dbExec(STORE_HISTORICO, 'readonly', s => s.get(id));
        item.status = 'finalizada';
        item.osNumero = osNumero;
        await dbExec(STORE_HISTORICO, 'readwrite', s => s.put(item));
        await mostrarHistorico();
        showToast('O.S. finalizada com sucesso!', 'success');
    } catch(e) {
        showToast('Erro ao finalizar O.S.', 'error');
    }
}

function habilitarEdicaoOS(id, btn) {
    const input = document.getElementById(`os_input_${id}`);
    input.disabled = false;
    input.focus();
    btn.innerText = 'Salvar';
    btn.onclick = () => confirmarEdicaoOS(id, btn);
}

async function confirmarEdicaoOS(id, btn) {
    const input = document.getElementById(`os_input_${id}`);
    const numero = input.value.trim();
    if (!numero) { showToast("N¬∫ O.S n√£o pode ser vazio.", "error"); return; }
    try {
        const item = await dbExec(STORE_HISTORICO, 'readonly', s => s.get(id));
        item.osNumero = numero;
        await dbExec(STORE_HISTORICO, 'readwrite', s => s.put(item));
        await mostrarHistorico();
        showToast("N¬∫ O.S atualizado!", 'success');
    } catch (error) { showToast("Erro ao atualizar O.S.", 'error'); }
}

async function excluirHistoricoItem(id) {
    const confirmado = await new Promise(resolve => abrirPopupConfirmar('Excluir Registro', 'Tem certeza que deseja excluir este item do hist√≥rico?', resolve));
    if(confirmado) {
        try {
            await dbExec(STORE_HISTORICO, 'readwrite', s => s.delete(id));
            await mostrarHistorico();
            showToast('Item exclu√≠do do hist√≥rico.', 'success');
        } catch(e) {
            showToast('Erro ao excluir item.', 'error');
        }
    }
}

async function abrirPopupApagarPorData() {
    try {
        const todosItens = await dbExec(STORE_HISTORICO, 'readonly', s => s.getAll());
        if(todosItens.length === 0) { showToast('Hist√≥rico est√° vazio.', 'info'); return; }
        const datas = [...new Set(todosItens.map(item => item.dataOS))].sort((a,b) => b.localeCompare(a));
        const options = datas.map(d => `<option value="${d}">${formatarDataParaExibicao(d)}</option>`).join('');
        const selectHTML = `<select id="selectDataParaApagar" class="w-full p-2 border rounded">${options}</select>`;
        
        abrirPopupConfirmar('Apagar por Data', `Selecione a data para apagar todo o hist√≥rico correspondente:<br>${selectHTML}`, async confirmado => {
            if(confirmado) {
                const dataSelecionada = document.getElementById('selectDataParaApagar').value;
                const confirmadoFinal = await new Promise(resolve => abrirPopupConfirmar('Confirma√ß√£o Final', `Tem certeza que deseja apagar TODOS os registros de ${formatarDataParaExibicao(dataSelecionada)}?`, resolve));
                if(confirmadoFinal) {
                    const todos = await dbExec(STORE_HISTORICO, 'readonly', s => s.getAll());
                    const idsParaApagar = todos.filter(item => item.dataOS === dataSelecionada).map(item => item.uniqueId);
                    const tx = db.transaction(STORE_HISTORICO, 'readwrite');
                    for(const id of idsParaApagar){
                        tx.objectStore(STORE_HISTORICO).delete(id);
                    }
                    tx.oncomplete = () => {
                        mostrarHistorico();
                        showToast(`Hist√≥rico de ${formatarDataParaExibicao(dataSelecionada)} apagado!`, 'success');
                    };
                }
            }
        });
    } catch (e) {
        showToast("Erro ao carregar datas do hist√≥rico.", "error");
    }
}

// ---------------------------------
// M√ìDULO: CONFIGURA√á√ïES
// ---------------------------------
function renderizarSecaoConfig(container) {
     container.innerHTML = `
        <div class="bg-white p-6 rounded-lg shadow-lg max-w-2xl mx-auto space-y-6">
            <h2 class="text-2xl font-semibold text-blue-700 border-b pb-3 mb-6 text-center">Backup e Dados</h2>
            <div class="space-y-4">
                <button onclick="gerarBackupCompleto()" class="w-full flex items-center justify-center gap-2 bg-blue-500 hover:bg-blue-600 text-white py-3 px-4 rounded-md font-semibold transition-colors">üóÑÔ∏è Exportar Dados Completos</button>
                <div class="text-center">
                    <label for="fileBackupCompletoInput" class="w-full cursor-pointer flex items-center justify-center gap-2 bg-blue-700 hover:bg-blue-800 text-white py-3 px-4 rounded-md font-semibold transition-colors">üîÑ Importar Dados Completos</label>
                    <input type="file" id="fileBackupCompletoInput" accept=".json" class="hidden" onchange="restaurarBackupCompleto(event)">
                    <p class="text-xs text-gray-500 mt-1">Aten√ß√£o: <strong class="text-red-600">Isto substituir√° todos os dados atuais.</strong></p>
                </div>
            </div>
            
            <hr class="my-6 border-gray-300">
            <div class="space-y-2 text-center">
                <h3 class="text-lg font-semibold text-gray-800">Desenvolvimento</h3>
                <button onclick="forcarLimpezaCacheEAtualizar()" class="w-full md:w-3/4 lg:w-1/2 mx-auto py-3 px-4 rounded-md font-semibold bg-indigo-600 text-white hover:bg-indigo-700">
                    üßπ For√ßar Atualiza√ß√£o de Cache
                </button>
                <p class="text-xs text-gray-500 mt-1">Use se as altera√ß√µes visuais n√£o aparecerem.</p>
            </div>
            <hr class="my-6 border-gray-300">
            <div class="space-y-2 text-center">
                <button onclick="limparServicosTurnoAtual()" class="w-full md:w-3/4 lg:w-1/2 mx-auto py-3 px-4 rounded-md font-semibold bg-red-500 text-white hover:bg-red-600">üóëÔ∏è Limpar Servi√ßos do Turno Atual</button>
            </div>
            <hr class="my-6 border-gray-300">
            <div class="space-y-2 text-center">
                <button onclick="resetarAplicacao()" class="w-full md:w-3/4 lg:w-1/2 mx-auto py-3 px-4 rounded-md font-semibold bg-red-700 text-white hover:bg-red-800">üóëÔ∏è Resetar Todos os Dados</button>
            </div>
        </div>
    `;
}

async function limparServicosTurnoAtual() {
    const confirmado = await new Promise(resolve => abrirPopupConfirmar('Limpar Servi√ßos', 'Tem a certeza que deseja apagar TODOS os servi√ßos do turno atual?', resolve));
    if (confirmado) {
        servicos = [];
        salvarTudo();
        showToast('Servi√ßos do turno atual limpos.', 'success');
        if(document.getElementById('servicosLista')) renderizarServicos();
    }
}

async function resetarAplicacao() {
    const confirmado = await new Promise(resolve => abrirPopupConfirmar('Resetar Aplica√ß√£o', '<strong>Aten√ß√£o!</strong><br>Isto apagar√° TODOS os dados. Fa√ßa um backup antes. Deseja continuar?', resolve));
    if (confirmado) {
        try {
            if (db) db.close();
            const deleteRequest = indexedDB.deleteDatabase(DB_NAME);
            deleteRequest.onsuccess = () => {
                showToast("Dados resetados. A aplica√ß√£o ser√° recarregada.", 'success');
                setTimeout(() => window.location.reload(), 1500);
            };
            deleteRequest.onerror = () => showToast("Erro ao apagar o banco de dados.", 'error');
            deleteRequest.onblocked = () => showToast("A exclus√£o foi bloqueada. Feche outras abas desta aplica√ß√£o.", 'error');
        } catch(e) {
            showToast("Erro ao tentar resetar a aplica√ß√£o.", 'error');
        }
    }
}

async function gerarBackupCompleto() {
    try {
        const dadosTurno = await dbExec(STORE_TURNO, 'readonly', s => s.get(TURNO_ATUAL_ID)) || {};
        const dadosHistorico = await dbExec(STORE_HISTORICO, 'readonly', s => s.getAll()) || [];
        
        if (Object.keys(dadosTurno).length <= 1 && dadosHistorico.length === 0) {
            showToast("Nenhum dado para fazer backup.", 'info'); return;
        }
        const dadosParaBackup = { turno: dadosTurno, historico: dadosHistorico };
        const blob = new Blob([JSON.stringify(dadosParaBackup, null, 2)], { type: "application/json" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `backup_meuturno_${new Date().toISOString().slice(0,10)}.json`;
        a.click();
        URL.revokeObjectURL(url);
        showToast("Backup gerado com sucesso!", 'success');
    } catch (err) {
        showToast("Erro ao gerar o backup.", 'error');
    }
}

async function restaurarBackupCompleto(event) {
    const file = event.target.files[0];
    if (!file) return;
    const confirmado = await new Promise(resolve => abrirPopupConfirmar('Restaurar Backup', '<strong>Aten√ß√£o!</strong><br>Isto substituir√° TODOS os dados atuais. Deseja continuar?', resolve));
    if (!confirmado) {
        event.target.value = null; return;
    }
    const reader = new FileReader();
    reader.onload = async (e) => {
        try {
            const dados = JSON.parse(e.target.result);
            if (!dados.turno || !dados.historico) throw new Error("Formato de backup inv√°lido.");
            
            await dbExec(STORE_TURNO, 'readwrite', s => s.put(dados.turno));
            
            const tx = db.transaction(STORE_HISTORICO, 'readwrite');
            const hStore = tx.objectStore(STORE_HISTORICO);
            hStore.clear();
            for (const item of dados.historico) {
                if (item.uniqueId) delete item.uniqueId; 
                hStore.add(item);
            }
            
            tx.oncomplete = () => {
                showToast("Backup restaurado! A aplica√ß√£o ser√° recarregada.", 'success');
                setTimeout(() => window.location.reload(), 1500);
            };
            tx.onerror = () => { throw new Error("Falha na transa√ß√£o do hist√≥rico."); };
        } catch (err) {
            showToast(`Erro ao restaurar: ${err.message}`, 'error');
        } finally {
            event.target.value = null;
        }
    };
    reader.readAsText(file);
}

/**
 * For√ßa a limpeza completa do cache da aplica√ß√£o e recarrega a p√°gina.
 * √ötil para desenvolvimento para garantir que as altera√ß√µes mais recentes sejam aplicadas.
 */
async function forcarLimpezaCacheEAtualizar() {
    if (!('serviceWorker' in navigator && 'caches' in window)) {
        showToast("O seu navegador n√£o suporta as APIs necess√°rias.", "error");
        return;
    }
    const confirmado = await new Promise(resolve => 
        abrirPopupConfirmar(
            'For√ßar Atualiza√ß√£o?', 
            'Isto ir√° limpar todos os dados em cache da aplica√ß√£o e recarregar a p√°gina. √â √∫til para garantir que as √∫ltimas altera√ß√µes de c√≥digo sejam aplicadas. Deseja continuar?', 
            resolve,
            'Sim, Limpar e Recarregar'
        )
    );
    if (confirmado) {
        try {
            // 1. Desregistar todos os Service Workers ativos
            const registrations = await navigator.serviceWorker.getRegistrations();
            for (const registration of registrations) {
                await registration.unregister();
                console.log('Service Worker desregistado:', registration);
            }
            // 2. Apagar todos os caches da nossa aplica√ß√£o
            const cacheNames = await caches.keys();
            const cachesToDelete = cacheNames.filter(name => name.startsWith('meu-turno-app-cache-'));
            await Promise.all(cachesToDelete.map(name => caches.delete(name)));
            console.log('Caches da aplica√ß√£o apagados:', cachesToDelete);
            showToast("Cache limpo! A recarregar a aplica√ß√£o...", "success");
            // 3. Recarregar a p√°gina
            setTimeout(() => {
                window.location.reload(true);
            }, 1500);
        } catch (error) {
            console.error('Erro ao for√ßar a limpeza de cache:', error);
            showToast("Ocorreu um erro ao tentar limpar o cache.", "error");
        }
    }
}

// =================================================================================
// 8. M√ìDULO: CAT√ÅLOGO (NOVO)
// =================================================================================

// Vari√°vel global para guardar a c√≥pia local do cat√°logo
let catalogoLocal = [];

/**
 * Fun√ß√£o principal que inicializa a sincroniza√ß√£o com o Firebase.
 * Ouve por altera√ß√µes em tempo real e atualiza o banco de dados local (IndexedDB).
 */
function sincronizarCatalogo() {
    firestore.collection('catalogo').onSnapshot(async (snapshot) => {
        console.log("Recebidos dados do Firebase.");
        const tx = db.transaction('catalogo', 'readwrite');
        const store = tx.objectStore('catalogo');

        for (const change of snapshot.docChanges()) {
            const item = { ...change.doc.data(), codigoSap: change.doc.id };

            if (change.type === 'added' || change.type === 'modified') {
                console.log('Adicionado/Modificado:', item.codigoSap);
                store.put(item); // Adiciona ou atualiza no IndexedDB
            }
            if (change.type === 'removed') {
                console.log('Removido:', item.codigoSap);
                store.delete(item.codigoSap); // Remove do IndexedDB
            }
        }

        // Ap√≥s todas as altera√ß√µes, atualiza a nossa vari√°vel local e a tela
        tx.oncomplete = async () => {
            catalogoLocal = await dbExec('catalogo', 'readonly', s => s.getAll());
            // Se o utilizador estiver na p√°gina do cat√°logo, atualiza a lista
            if (document.getElementById('catalogo')?.classList.contains('hidden') === false) {
                renderizarCatalogo();
            }
            console.log("Sincroniza√ß√£o com IndexedDB conclu√≠da.");
        };
    }, (error) => {
        console.error("Erro ao ouvir o Firebase:", error);
        showToast("Falha ao sincronizar com a base de dados.", "error");
    });
}


/**
 * Renderiza a estrutura inicial da sec√ß√£o do cat√°logo.
 */
function renderizarSecaoCatalogo(container) {
    container.innerHTML = `
        <div class="bg-white p-4 rounded-lg shadow space-y-4">
            <h2 class="text-xl font-bold text-blue-800">Cat√°logo de Pe√ßas</h2>
            <div>
                <label for="buscaCatalogo" class="sr-only">Buscar</label>
                <input type="text" id="buscaCatalogo" oninput="renderizarCatalogo()" placeholder="üîé Buscar por SAP, Part Number ou Descri√ß√£o..." class="w-full p-3 border border-gray-300 rounded-lg">
            </div>
            <div id="listaCatalogo" class="space-y-2">
                </div>
        </div>
    `;
    renderizarCatalogo();
}

/**
 * Renderiza a lista de itens do cat√°logo na tela, aplicando o filtro de busca.
 */
function renderizarCatalogo() {
    const listaDiv = document.getElementById('listaCatalogo');
    if (!listaDiv) return;

    const termoBusca = document.getElementById('buscaCatalogo').value.toLowerCase();
    
    // Filtra o cat√°logo local com base no termo de busca
    const itensFiltrados = catalogoLocal.filter(item => {
        return (
            item.codigoSap.toLowerCase().includes(termoBusca) ||
            item.partNumber.toLowerCase().includes(termoBusca) ||
            item.descricao.toLowerCase().includes(termoBusca)
        );
    });

    if (itensFiltrados.length === 0) {
        listaDiv.innerHTML = `<p class="text-center text-gray-500 py-4">Nenhum item encontrado.</p>`;
        return;
    }

    listaDiv.innerHTML = itensFiltrados.map(item => `
        <div class="border rounded-lg p-3 flex justify-between items-center">
            <div>
                <p class="font-bold text-gray-800">${item.descricao}</p>
                <p class="text-sm text-gray-600">SAP: <span class="font-semibold text-blue-700">${item.codigoSap}</span></p>
                <p class="text-sm text-gray-600">Part Number: <span class="font-semibold">${item.partNumber}</span></p>
            </div>
            <div class="flex space-x-2">
                <button onclick="editarItemCatalogo('${item.codigoSap}')" class="p-2 text-yellow-600 hover:bg-yellow-100 rounded-full">‚úèÔ∏è</button>
                <button onclick="excluirItemCatalogo('${item.codigoSap}')" class="p-2 text-red-600 hover:bg-red-100 rounded-full">üóëÔ∏è</button>
            </div>
        </div>
    `).join('');
}

/// =================================================================================
// C√ìDIGO FINAL PARA AS A√á√ïES DO CAT√ÅLOGO (ADICIONAR, EDITAR, EXCLUIR)
// =================================================================================

/**
 * Abre um formul√°rio num popup para criar ou editar um item do cat√°logo.
 * @param {object|null} item - O item a ser editado, ou null para criar um novo.
 */
function abrirPopupFormularioItemCatalogo(item = null) {
    const isEditing = item !== null;
    const titulo = isEditing ? 'Editar Item do Cat√°logo' : 'Adicionar Novo Item';
    
    // Preenche os valores com os dados do item existente ou deixa em branco para um novo
    const codigoSap = item?.codigoSap || '';
    const partNumber = item?.partNumber || '';
    const descricao = item?.descricao || '';

    const conteudoPopup = `
        <div class="space-y-3 text-left">
            <div>
                <label for="popup-sap" class="block text-sm font-medium text-gray-700">C√≥digo SAP*</label>
                <input type="text" id="popup-sap" class="mt-1 w-full p-2 border rounded-md" value="${codigoSap}" ${isEditing ? 'readonly bg-gray-100' : ''} placeholder="C√≥digo SAP √∫nico">
                ${isEditing ? '<p class="text-xs text-gray-500 mt-1">O C√≥digo SAP n√£o pode ser alterado.</p>' : ''}
            </div>
            <div>
                <label for="popup-partnumber" class="block text-sm font-medium text-gray-700">Part Number*</label>
                <input type="text" id="popup-partnumber" class="mt-1 w-full p-2 border rounded-md" value="${partNumber}" placeholder="Pode incluir m√∫ltiplos, separados por v√≠rgula">
            </div>
            <div>
                <label for="popup-descricao" class="block text-sm font-medium text-gray-700">Descri√ß√£o*</label>
                <textarea id="popup-descricao" class="mt-1 w-full p-2 border rounded-md h-24" placeholder="Descri√ß√£o da pe√ßa ou item">${descricao}</textarea>
            </div>
        </div>
    `;
    
    const botoes = [
        { 
            texto: 'Salvar', 
            classe: 'bg-blue-600 text-white hover:bg-blue-700', 
            acao: () => salvarItemCatalogo(isEditing) // Passa a informa√ß√£o se √© uma edi√ß√£o
        },
        { texto: 'Cancelar', classe: 'bg-gray-300 text-gray-800 hover:bg-gray-400', acao: fecharPopup }
    ];

    abrirPopup(titulo, conteudoPopup, botoes);
}

/**
 * Salva um item novo ou editado no Firebase.
 * @param {boolean} isEditing - Indica se a opera√ß√£o √© de edi√ß√£o.
 */
async function salvarItemCatalogo(isEditing) {
    const codigoSapEl = document.getElementById('popup-sap');
    const partNumberEl = document.getElementById('popup-partnumber');
    const descricaoEl = document.getElementById('popup-descricao');

    // Remove destaque de erro anterior
    [codigoSapEl, partNumberEl, descricaoEl].forEach(el => el.classList.remove('campo-invalido'));

    const codigoSap = codigoSapEl.value.trim();
    const partNumber = partNumberEl.value.trim();
    const descricao = descricaoEl.value.trim();

    // Valida√ß√£o
    let invalido = false;
    if (!codigoSap) { codigoSapEl.classList.add('campo-invalido'); invalido = true; }
    if (!partNumber) { partNumberEl.classList.add('campo-invalido'); invalido = true; }
    if (!descricao) { descricaoEl.classList.add('campo-invalido'); invalido = true; }
    
    if (invalido) {
        showToast("Todos os campos s√£o obrigat√≥rios.", "error");
        return;
    }

    const itemData = { partNumber, descricao };

    try {
        if (isEditing) {
            // Atualiza um documento existente
            await firestore.collection('catalogo').doc(codigoSap).update(itemData);
            showToast("Item atualizado com sucesso!", "success");
        } else {
            // Cria um novo documento
            await firestore.collection('catalogo').doc(codigoSap).set(itemData);
            showToast("Item adicionado com sucesso!", "success");
        }
        fecharPopup();
        // A interface ser√° atualizada automaticamente pelo listener 'onSnapshot' que j√° cri√°mos!
    } catch (error) {
        console.error("Erro ao salvar item no Firebase:", error);
        showToast("Erro ao salvar o item.", "error");
    }
}

/**
 * Inicia o processo de edi√ß√£o de um item do cat√°logo.
 * @param {string} codigoSap - O ID do item a ser editado.
 */
function editarItemCatalogo(codigoSap) {
    const item = catalogoLocal.find(i => i.codigoSap === codigoSap);
    if (item) {
        abrirPopupFormularioItemCatalogo(item);
    } else {
        showToast("Item n√£o encontrado para edi√ß√£o.", "error");
    }
}

/**
 * Exclui um item do cat√°logo no Firebase.
 * @param {string} codigoSap - O ID do item a ser exclu√≠do.
 */
async function excluirItemCatalogo(codigoSap) {
    const confirmado = await new Promise(resolve => 
        abrirPopupConfirmar('Excluir Item', `Tem a certeza que deseja excluir o item com SAP <strong>${codigoSap}</strong>? Esta a√ß√£o n√£o pode ser desfeita.`, resolve)
    );

    if (confirmado) {
        try {
            await firestore.collection('catalogo').doc(codigoSap).delete();
            showToast("Item exclu√≠do com sucesso!", "success");
            // A interface ser√° atualizada automaticamente pelo listener 'onSnapshot'!
        } catch (error) {
            console.error("Erro ao excluir item no Firebase:", error);
            showToast("Erro ao excluir o item.", "error");
        }
    }
}
// ---------------------------------
// FUN√á√ïES DE C√ÅLCULO
// ---------------------------------
function calcularDuracaoServico(servico) {
    if (!servico.inicio || !servico.fim || !servico.data || !servico.dataFinal) return { horas: 0, texto: "0min" };
    const inicio = new Date(`${servico.data}T${servico.inicio}`);
    const fim = new Date(`${servico.dataFinal}T${servico.fim}`);
    if (isNaN(inicio.getTime()) || isNaN(fim.getTime()) || fim < inicio) return { horas: 0, texto: "Inv√°lido" };
    
    const diffMin = (fim - inicio) / 60000;
    const h = Math.floor(diffMin / 60);
    const m = Math.round(diffMin % 60);
    let texto = "";
    if (h > 0) texto += `${h}h `;
    if (m > 0) texto += `${m}min`;
    
    return { horas: diffMin / 60, texto: texto.trim() || "0min" };
}
    
/**
 * Calcula o total de horas paradas em manuten√ß√£o CORRETIVA de TODOS os servi√ßos,
 * independentemente do tipo de frota.
 */
function calcularHorasParadasCorretivasTotais() {
    return servicos
        .filter(s => s.tipo === "CORRETIVA" && s.parada === "sim")
        .reduce((total, s) => total + calcularDuracaoServico(s).horas, 0);
}

/**
 * Calcula a DM de uma frota espec√≠fica.
 * Usado no relat√≥rio detalhado.
 */
/**
 * Calcula a DM de uma frota espec√≠fica para o relat√≥rio detalhado.
 * A regra √© a mesma para todos os tipos de equipamento.
 */
function calcularDMFrota(nomeFrota) {
    const frota = frotasTurno.find(f => f.nome === nomeFrota);

    // Se a frota n√£o for encontrada ou n√£o tiver horas planeadas, n√£o √© poss√≠vel calcular a DM.
    if (!frota || !frota.horas || frota.horas <= 0) {
        return "N/A";
    }

    // Calcula as horas paradas em corretiva apenas para esta frota espec√≠fica.
    const horasParadasDaFrota = servicos
        .filter(s => s.frota === nomeFrota && s.tipo === "CORRETIVA" && s.parada === "sim")
        .reduce((total, s) => total + calcularDuracaoServico(s).horas, 0);

    // O c√°lculo da DM √© o mesmo para TODOS os tipos de frota.
    // Se n√£o houver paradas, o resultado ser√° 100%.
    const horasOperando = Math.max(0, frota.horas - horasParadasDaFrota);
    return ((horasOperando / frota.horas) * 100).toFixed(2);
}

/**
 * Calcula a DM GERAL do turno.
 * @param {Array} maquinas - A lista de frotas do tipo 'maquina'.
 * @param {number} horasParadasTotais - O total de horas paradas j√° calculado.
 */
function calcularDMGeral(maquinas, horasParadasTotais) {
    const horasPlanejadasTotais = maquinas.reduce((soma, f) => soma + f.horas, 0);
    if (horasPlanejadasTotais === 0) return maquinas.length > 0 ? "0.00" : "100.00";
    
    const horasOperandoTotais = Math.max(0, horasPlanejadasTotais - horasParadasTotais);
    
    return ((horasOperandoTotais / horasPlanejadasTotais) * 100).toFixed(2);
}
</script>
</body>
</html>