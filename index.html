<!DOCTYPE html>
<html lang="pt-BR">
    
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="manifest" href="./manifest.json">
    <meta name="theme-color" content="#1d4ed8">
    <title>Meu Turno</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">

    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
        }

        /* --- TOAST (Notifica√ß√µes) --- */
        #toast {
            position: fixed;
            left: 50%;
            bottom: 30px;
            transform: translate(-50%, 100px);
            min-width: 280px;
            background-color: #2c3e50;
            color: #fff;
            text-align: center;
            border-radius: 0.375rem;
            padding: 1rem;
            z-index: 10000;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.4s ease, transform 0.4s ease, visibility 0.4s;
        }

        #toast.show {
            opacity: 1;
            visibility: visible;
            transform: translate(-50%, 0);
        }

        #toast.error { background-color: #c0392b; }
        #toast.success { background-color: #27ae60; }

        /* --- POPUP (Janelas Modais) --- */
        .popup-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.6);
            z-index: 9998;
            display: none;
            backdrop-filter: blur(4px);
        }

        .popup {
            position: fixed;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 1.25rem;
            border-radius: 0.75rem;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
            z-index: 9999;
            width: 90%;
            max-width: 400px;
            display: none;
            max-height: 90vh;
            overflow-y: auto;
        }

        /* --- MENU LATERAL (Anima√ß√£o) --- */
        .menu-open #menu-lateral {
            transform: translateX(0);
        }

        .menu-open #menu-overlay {
            opacity: 1;
            pointer-events: auto;
        }

        /* --- UTILIT√ÅRIOS --- */
        .campo-invalido {
            border-color: #ef4444 !important;
            box-shadow: 0 0 0 2px rgba(239, 68, 68, 0.4) !important;
        }

        /* Barra de rolagem personalizada (fina) */
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    </style>


</head>

<body class="bg-gray-50 text-gray-800">

    <header class="bg-blue-800 text-white p-4 shadow-md flex items-center justify-between sticky top-0 z-10">
       
        <button id="hamburger-btn"
            class="text-2xl p-2 rounded-full hover:bg-blue-700 transition-colors">&#9776;</button>
        <div class="flex:wrap text-center text-base gap-x-2">
           <!-- <img src="logo.png" alt="Logo MeuTurno" class="h-8" onerror="this.style.display='none'">
           -->
            <h1 id="header-titulo" class="shadow-lg bg-blue rounded-lg text-xl p-1 font-bold">
                MeuTurno
            </h1>
                  <!--   <p class="text-sm animate-pulse">Deus √© fiel!
                    </p>
                 -->
        </div> 
        <div class="w-10"></div>
    </header>

    <nav id="menu-lateral" class="fixed top-0 left-0 h-full bg-white shadow-2xl z-30 transform -translate-x-full transition-transform duration-300 ease-in-out w-3/4 max-w-xs flex flex-col">
    
    <div class="p-6 border-b border-gray-100 bg-gray-50">
        <div class="flex items-center gap-3 mb-1">
            <img src="logo.png" alt="Logo" class="h-8 w-8" onerror="this.style.display='none'">
            <h2 class="text-xl font-extrabold text-blue-800 tracking-tight">MeuTurno</h2>
        </div>
        <p class="text-xs text-gray-500 font-medium ml-1">Gest√£o Inteligente de Campo</p>
    </div>

    <div class="flex-1 overflow-y-auto py-4 space-y-1">
        
        <div class="px-4 mb-2 text-[10px] font-bold text-gray-400 uppercase tracking-wider">Operacional</div>
        
        <a href="#" class="flex items-center gap-3 px-6 py-3 text-sm font-medium text-gray-600 hover:bg-gray-50 transition-all" data-secao="turno">
            <span class="text-lg">üìÖ</span> Turno Atual
        </a>
        <a href="#" class="flex items-center gap-3 px-6 py-3 text-sm font-medium text-gray-600 hover:bg-gray-50 transition-all" data-secao="servicos">
                  <span class="text-lg">üîß</span> Servi√ßos
        </a>
        <a href="#" class="flex items-center gap-3 px-6 py-3 text-sm font-medium text-gray-600 hover:bg-gray-50 transition-all" data-secao="apontamento">
            <span class="text-lg">‚è±Ô∏è</span> Apontamento Di√°rio
        </a>
        

        <div class="px-4 mt-6 mb-2 text-[10px] font-bold text-gray-400 uppercase tracking-wider">Gest√£o</div>

        <a href="#" class="flex items-center gap-3 px-6 py-3 text-sm font-medium text-gray-600 hover:bg-gray-50 transition-all" data-secao="historico">
            <span class="text-lg">üóÑÔ∏è</span> Hist√≥rico de O.S.
        </a>
        <a href="#" class="flex items-center gap-3 px-6 py-3 text-sm font-medium text-gray-600 hover:bg-gray-50 transition-all" data-secao="frotas">
            <span class="text-lg">üöú</span> Frotas Ativas
        </a>
        <a href="#" class="flex items-center gap-3 px-6 py-3 text-sm font-medium text-gray-600 hover:bg-gray-50 transition-all" data-secao="catalogo">
            <span class="text-lg">üì¶</span> Cat√°logo de Pe√ßas
        </a>
        
        <div class="px-4 mt-6 mb-2 text-[10px] font-bold text-gray-400 uppercase tracking-wider">Relat√≥rios</div>

        <a href="#" class="flex items-center gap-3 px-6 py-3 text-sm font-medium text-gray-600 hover:bg-gray-50 transition-all" data-secao="relatorio">
            <span class="text-lg">üìÑ</span> Relat√≥rio Final
        </a>
        <a href="#" class="flex items-center gap-3 px-6 py-3 text-sm font-medium text-gray-600 hover:bg-gray-50 transition-all" data-secao="estatisticas">
            <span class="text-lg">üìä</span> Estat√≠sticas
        </a>

        <div class="my-4 border-t border-gray-100"></div>

        <a href="#" class="flex items-center gap-3 px-6 py-3 text-sm font-medium text-gray-600 hover:bg-gray-50 transition-all" data-secao="config">
            <span class="text-lg">‚öôÔ∏è</span> Configura√ß√µes
        </a>
    </div>

    <div class="p-4 border-t border-gray-200 bg-gray-50 text-center">
        <p class="text-xs text-gray-400">Vers√£o 2.0 (2025, RojaDev's CreatedBy ¬©)</p>
    </div>
</nav>


    <div id="menu-overlay"
        class="fixed top-0 left-0 w-full h-full bg-black bg-opacity-50 z-20 opacity-0 pointer-events-none transition-opacity duration-300 ease-in-out">
    </div>

    <main class="p-4">
        <section id="turno">
    <div class="space-y-6">

        <div class="bg-white p-5 border border-gray-200 rounded-xl shadow-sm">
            <div class="flex items-center gap-3 pb-3 border-b border-gray-100 mb-4">
                <div class="w-10 h-10 rounded-full bg-blue-50 text-blue-600 flex items-center justify-center shadow-sm">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                    </svg>
                </div>
                <h2 class="text-lg font-bold text-gray-800">Dados do Turno</h2>
            </div>
            
            <div class="space-y-4">
                <div>
                    <label for="dataTurno" class="block text-xs font-bold text-gray-500 uppercase mb-1">Data</label>
                    <input id="dataTurno" type="date" class="block w-full p-3 bg-gray-50 border border-gray-200 rounded-lg text-gray-700 font-semibold focus:bg-white focus:ring-2 focus:ring-blue-500 outline-none transition-all" onchange="salvarDadosParciaisTurno()" required>
                </div>

                <div>
                    <label for="fazenda" class="block text-xs font-bold text-gray-500 uppercase mb-1">Fazenda</label>
                    <div class="flex gap-2">
                        <select id="fazenda" class="block w-full p-3 bg-gray-50 border border-gray-200 rounded-lg text-gray-700 font-semibold focus:bg-white focus:ring-2 focus:ring-blue-500 outline-none transition-all" onchange="salvarDadosParciaisTurno()" required>
                            <option value="">Carregando...</option>
                        </select>
                        <button onclick="adicionarNovaFazenda()" class="bg-green-50 hover:bg-green-100 text-green-700 border border-green-200 px-4 rounded-lg font-bold text-xl shadow-sm transition-transform active:scale-95 flex items-center justify-center" title="Adicionar">
                            <span>+</span>
                        </button>
                        <button onclick="removerFazendaSelecionada()" class="bg-red-50 hover:bg-red-100 text-red-600 border border-red-200 px-4 rounded-lg font-bold shadow-sm transition-colors flex items-center justify-center" title="Apagar">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                        </button>
                    </div>
                </div>

                <div>
                    <label for="frente" class="block text-xs font-bold text-gray-500 uppercase mb-1">Frente</label>
                    <div class="flex gap-2">
                        <select id="frente" class="block w-full p-3 bg-gray-50 border border-gray-200 rounded-lg text-gray-700 font-semibold focus:bg-white focus:ring-2 focus:ring-blue-500 outline-none transition-all" onchange="salvarDadosParciaisTurno();iniciarSincronizacaoHistorico()" required>
                            <option value="">Carregando...</option>
                        </select>
                        <button onclick="adicionarNovaFrente()" class="bg-green-50 hover:bg-green-100 text-green-700 border border-green-200 px-4 rounded-lg font-bold text-xl shadow-sm transition-transform active:scale-95 flex items-center justify-center" title="Adicionar">
                            <span>+</span>
                        </button>
                        <button onclick="removerFrenteSelecionada()" class="bg-red-50 hover:bg-red-100 text-red-600 border border-red-200 px-4 rounded-lg font-bold shadow-sm transition-colors flex items-center justify-center" title="Apagar">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                        </button>
                    </div>
                </div>

                <div>
                    <label for="turnoLetra" class="block text-xs font-bold text-gray-500 uppercase mb-1">Turno</label>
                    <select id="turnoLetra" class="block w-full p-3 bg-gray-50 border border-gray-200 rounded-lg text-gray-700 font-semibold focus:bg-white focus:ring-2 focus:ring-blue-500 outline-none transition-all" onchange="salvarDadosParciaisTurno();iniciarSincronizacaoHistorico()" required>
                        <option value="">Selecione...</option>
                        <option value="A">TURNO A</option>
                        <option value="B">TURNO B</option>
                        <option value="C">TURNO C</option>
                    </select>
                </div>
            </div>
        </div>

        <div class="bg-white p-5 border border-gray-200 rounded-xl shadow-sm">
            <div class="flex justify-between items-center border-b border-gray-100 pb-3 mb-3">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-full bg-blue-50 text-blue-600 flex items-center justify-center shadow-sm">
                         <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
                        </svg>
                    </div>
                    <h2 class="text-lg font-bold text-gray-800">Equipe</h2>
                </div>
                <button onclick="abrirPopupSelecaoEquipe()" class="bg-white border border-gray-300 text-gray-700 hover:bg-gray-50 text-xs py-2 px-4 rounded-lg font-bold shadow-sm flex items-center gap-2 transition-all active:scale-95">
                    <span>‚öôÔ∏è</span> Gerenciar
                </button>
            </div>
            
            <div id="boxEquipe" class="space-y-3"></div>
        </div>

        <div class="bg-white p-5 border border-gray-200 rounded-xl shadow-sm">
            <div class="flex justify-between items-center border-b border-gray-100 pb-3 mb-3">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-full bg-blue-50 text-blue-600 flex items-center justify-center shadow-sm">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path d="M9 17a2 2 0 11-4 0 2 2 0 014 0zM19 17a2 2 0 11-4 0 2 2 0 014 0z" />
                            <path stroke-linecap="round" stroke-linejoin="round" d="M13 16V6a1 1 0 00-1-1H4a1 1 0 00-1 1v10a1 1 0 001 1h1m8-1a1 1 0 01-1 1H9m4-1V8a1 1 0 011-1h2.586a1 1 0 01.707.293l3.414 3.414a1 1 0 01.293.707V16a1 1 0 01-1 1h-1m-6-1a1 1 0 001 1h1M5 17a2 2 0 104 0m-4 0a2 2 0 114 0m6 0a2 2 0 104 0m-4 0a2 2 0 114 0" />
                        </svg>
                    </div>
                    <h2 class="text-lg font-bold text-gray-800">Frotas</h2>
                </div>
                <button onclick="abrirPopupSelecaoFrota()" class="bg-green-600 text-white hover:bg-green-700 text-xs py-2 px-4 rounded-lg font-bold shadow-md shadow-green-100 flex items-center gap-1 transition-all active:scale-95">
                    <span>+</span> Adicionar
                </button>
            </div>

            <div id="listaFrotas" class="space-y-3"></div>
        </div>

    </div>
</section>


        <section id="servicos" class="hidden"></section>
        <section id="frotas" class="hidden"></section>
        <section id="catalogo" class="hidden"></section>
        <section id="estatisticas" class="hidden"></section>
        <section id="relatorio" class="hidden"></section>
        <section id="historico" class="hidden"></section>
        <section id="config" class="hidden"></section>
        
      <section id="apontamento" class="hidden">
    <div class="space-y-6">
        
        <div class="bg-white p-4 rounded-xl border border-gray-200 shadow-sm flex items-center gap-3">
            <div class="w-12 h-12 rounded-full bg-indigo-50 text-indigo-600 flex items-center justify-center shadow-sm shrink-0">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01" />
                </svg>
            </div>
            <div>
                <h2 class="text-xl font-bold text-gray-800">Apontamento Di√°rio</h2>
                <p class="text-xs text-gray-500 font-medium">Preenchimento das atividades de campo</p>
            </div>
        </div>
        <div class="space-y-3">
            <div>
                <label class="block text-xs font-bold text-gray-500 mb-1 flex items-center gap-1">
                    <span>üè≠</span> Tipo de Oficina
                </label>
                <select id="apontamentoTipoOficina" class="w-full p-2.5 bg-gray-50 border border-gray-200 rounded-lg text-sm text-gray-700 focus:ring-2 focus:ring-blue-500 outline-none transition-all font-medium">
                    <option value="externa">Oficina Externa (Campo)</option>
                    <option value="interna">Oficina Interna (Automotiva)</option>
                </select>
            </div>

            <div>
                <label class="block text-xs font-bold text-gray-500 mb-1 flex items-center gap-1">
                    <span>üë§</span> Colaborador
                </label>
                <select id="apontamentoColaborador" class="w-full p-2.5 bg-gray-50 border border-gray-200 rounded-lg text-sm text-gray-700 focus:ring-2 focus:ring-blue-500 outline-none font-medium"></select>
            </div>

            <div class="grid grid-cols-2 gap-3">
                <div>
                    <label class="block text-xs font-bold text-gray-500 mb-1">Setor</label>
                    <input type="text" id="apontamentoSetor" value="Manuten√ß√£o Silvicultura" class="w-full p-2.5 bg-gray-50 border border-gray-200 rounded-lg text-sm text-gray-700 focus:ring-2 focus:ring-blue-500 outline-none">
                </div>
                <div>
    <label class="block text-xs font-bold text-gray-500 mb-1">Data do Apontamento</label>
    <input type="date" id="apontamentoData" 
           class="w-full p-2.5 bg-white border border-gray-200 rounded-lg text-sm text-gray-800 focus:ring-2 focus:ring-blue-500 outline-none font-bold"
           onchange="atualizarPreviewSeNecessario()">
</div>

            </div>
        </div>
    </div>

            <div class="mt-6">
    <div class="flex items-center justify-between mb-3">
        <h3 class="text-base font-bold text-gray-800 flex items-center gap-2">
            <span class="bg-blue-100 text-blue-600 w-8 h-8 flex items-center justify-center rounded-full text-lg">üïí</span>
            Linha do Tempo
        </h3>
        <span class="text-xs font-medium text-gray-500 bg-gray-100 px-2 py-1 rounded-full">
            Sequ√™ncia do Dia
        </span>
    </div>

          <div class="grid grid-cols-3 gap-2 mb-3">
        
        <button onclick="adicionarLinhaManual()" 
            class="flex items-center justify-center gap-1 py-2 px-1 bg-white border border-dashed border-gray-300 rounded-lg hover:border-yellow-400 hover:bg-yellow-50 transition-all group shadow-sm h-12">
            <span class="text-base group-hover:scale-110 transition-transform">‚òï</span>
            <span class="text-sm font-bold text-gray-700 group-hover:text-yellow-600 uppercase leading-tight text-center">Adicionar<br>Manual</span>
        </button>

        <button onclick="abrirPopupAddPreventiva()" 
            class="flex items-center justify-center gap-1 py-2 px-1 bg-purple-50 border border-purple-200 rounded-lg hover:bg-purple-100 hover:border-purple-300 transition-all group shadow-sm h-12">
            <span class="text-base group-hover:scale-110 transition-transform">üìã</span>
            <span class="text-sm font-bold text-purple-700 uppercase leading-tight text-center">Adicionar<br>Preventiva</span>
        </button>

        <button onclick="abrirPopupImportarServico()" 
            class="flex items-center justify-center gap-1 py-2 px-1 bg-blue-50 border border-blue-200 rounded-lg hover:bg-blue-100 hover:border-blue-300 transition-all group shadow-sm h-12">
            <span class="text-base group-hover:scale-110 transition-transform">üîß</span>
            <span class="text-sm font-bold text-blue-700 uppercase leading-tight text-center">Importar<br>Servi√ßo</span>
        </button>

    </div>



    <div id="listaLinhasApontamento" class="space-y-3 min-h-[100px]">
        <div class="text-center py-8 text-gray-400 text-sm italic">
            Nenhuma atividade registrada ainda.
        </div>
    </div>
</div>
         </div>        

<div class="pt-4 mt-4 border-t border-gray-200">
    <div class="grid grid-cols-3 gap-2">
        
        <button id="btnGerarPreview" onclick="gerarPreviewApontamento()" 
    class="flex flex-col items-center justify-center py-3 px-1 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg shadow active:scale-95 transition-all">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mb-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                <path stroke-linecap="round" stroke-linejoin="round" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
            </svg>
            <span class="text-[10px] font-bold uppercase leading-tight">Atualizar</span>
        </button>

        <button onclick="baixarApontamento('jpg')" 
            class="flex flex-col items-center justify-center py-3 px-1 bg-green-600 hover:bg-green-700 text-white rounded-lg shadow active:scale-95 transition-all">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mb-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
            </svg>
            <span class="text-[10px] font-bold uppercase leading-tight">Salvar JPG</span>
        </button>

        <button onclick="baixarOuCompartilharPDF()" 
            class="flex flex-col items-center justify-center py-3 px-1 bg-red-600 hover:bg-red-700 text-white rounded-lg shadow active:scale-95 transition-all">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mb-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z" />
            </svg>
            <span class="text-[10px] font-bold uppercase leading-tight">PDF / Enviar</span>
        </button>
        
    </div>
</div>

        <div class="overflow-auto border border-gray-300 rounded mt-4 bg-gray-200 flex justify-center p-2">
            <canvas id="canvasApontamento" class="max-w-full h-auto shadow-lg bg-white"></canvas>
        </div>
    </div>
</section>



        <button id="fabAddFrotaCatalogo" onclick="abrirPopupTipoFrota()"
            class="fixed bottom-12 right-5 bg-blue-600 hover:bg-blue-700 text-white rounded-full w-14 h-14 flex items-center justify-center text-2xl shadow-lg z-50"
            style="display: none;" title="Adicionar Frota ao Cat√°logo">üöú</button>
        <button id="fabAddItemCatalogo" onclick="abrirPopupFormularioItemCatalogo()"
            class="fixed bottom-12 right-5 bg-purple-600 hover:bg-purple-700 text-white rounded-full w-14 h-14 flex items-center justify-center text-3xl shadow-lg z-50"
            style="display: none;" title="Adicionar Item ao Cat√°logo">+</button>
        <button id="fabCriarServico" onclick="adicionarServico()"
            class="fixed bottom-12 right-5 bg-green-500 hover:bg-green-600 text-white rounded-full w-14 h-14 flex items-center justify-center text-3xl shadow-lg z-50"
            style="display: none;" title="Adicionar Novo Servi√ßo">+</button>
        <button id="fabAddFrotaCatalogo" onclick="abrirPopupTipoFrota()"
            class="fixed bottom-12 right-5 bg-blue-600 hover:bg-blue-700 text-white rounded-full w-14 h-14 flex items-center justify-center text-2xl shadow-lg z-50"
            style="display: none;" title="Adicionar Frota ao Cat√°logo">üöú</button>
        <button id="fabAddItemCatalogo" onclick="abrirPopupFormularioItemCatalogo()"
            class="fixed bottom-12 right-5 bg-purple-600 hover:bg-purple-700 text-white rounded-full w-14 h-14 flex items-center justify-center text-3xl shadow-lg z-50"
            style="display: none;" title="Adicionar Item ao Cat√°logo">+</button>

        <button id="fabCadastroRapidoFrota" onclick="iniciarCadastroRapidoFrota()"
            class="fixed bottom-28 right-5 bg-blue-600 hover:bg-blue-700 text-white rounded-full w-14 h-14 flex items-center justify-center text-3xl shadow-lg z-50"
            style="display: flex;" title="Cadastrar Frota R√°pida">üöú</button>
        <button id="fabCriarServico" onclick="adicionarServico()"
            class="fixed bottom-12 right-5 bg-green-500 hover:bg-green-600 text-white rounded-full w-14 h-14 flex items-center justify-center text-3xl shadow-lg z-50"
            style="display: none;" title="Adicionar Novo Servi√ßo">+</button>
    </main>

    <div id="toast"></div>

    <div class="popup-overlay" id="overlayGenerico"></div>
    <div class="popup" id="popupGenerico">
        <h3 id="popupTitulo" class="text-xl font-semibold mb-3"></h3>
        <div id="popupMensagem" class="text-sm text-gray-600 mb-4"></div>
        <div class="flex justify-end space-x-2" id="popupBotoes"></div>
    </div>

<div id="modalUpdate" class="fixed inset-0 z-[10001] hidden">
    
    <div class="absolute inset-0 bg-black/80 backdrop-blur-sm transition-opacity duration-500 opacity-0" id="modalUpdateBackdrop"></div>
    
    <div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-[90%] max-w-sm bg-white rounded-2xl shadow-2xl overflow-hidden scale-90 opacity-0 transition-all duration-300 delay-100" id="modalUpdateWindow">
        
        <div class="bg-gradient-to-r from-blue-700 to-indigo-800 p-6 text-center relative overflow-hidden">
            <div class="absolute top-0 left-0 w-full h-full bg-white/10 transform -skew-y-12 scale-150 origin-top-left"></div>
            
            <div class="relative z-10">
                <div class="w-16 h-16 bg-white/20 rounded-full flex items-center justify-center mx-auto mb-3 backdrop-blur-md shadow-inner border border-white/20">
                    <span class="text-3xl">üöÄ</span>
                </div>
                <h3 class="text-xl font-bold text-white tracking-tight">Nova Vers√£o Dispon√≠vel!</h3>
                <p class="text-blue-100 text-xs mt-1 font-medium">Melhorias e corre√ß√µes prontas para voc√™.</p>
            </div>
        </div>

        <div class="p-6 bg-white">
            <p class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-3">O que mudou:</p>
            
            <ul id="listaNovidades" class="text-sm text-gray-600 space-y-2.5 mb-6 pl-1">
                </ul>

            <div class="space-y-3 pt-2">
                <button id="btnUpdateConfirm" class="w-full py-4 bg-blue-600 hover:bg-blue-700 text-white rounded-xl font-bold shadow-lg shadow-blue-200 active:scale-95 transition-all flex items-center justify-center gap-2 group">
                    <span class="group-hover:animate-pulse">‚ú®</span> 
                    <span>Atualizar Agora</span>
                </button>
                
                <button onclick="fecharModalUpdate()" class="w-full py-3 text-gray-400 hover:text-gray-600 text-xs font-bold transition-colors">
                    Agora n√£o, atualizar depois
                </button>
            </div>
        </div>
    </div>
</div>


<template id="servico-template">
    <article class="bg-white rounded-xl shadow-sm mb-4 border border-gray-200 transition-all hover:shadow-md">
        <div class="servico-cabecalho flex justify-between items-center cursor-pointer p-4 bg-gray-50 border-b border-gray-100 rounded-t-xl hover:bg-gray-100 transition-colors">
            <div class="servico-cabecalho-info flex-1 text-sm text-gray-700 font-medium pr-2 overflow-hidden text-ellipsis"></div>
            <span class="servico-cabecalho-toggler text-gray-400 font-bold text-lg">‚ñº</span>
        </div>
        <div class="servico-detalhes p-4 bg-white rounded-b-xl" style="display:none;"></div>
    </article>
</template>


    <script>
    // ============================================================
// L√ìGICA DO TUTORIAL (ONBOARDING)
// ============================================================

// Verifica se o usu√°rio j√° viu o tutorial
function verificarOnboarding() {
    const versaoTutorial = localStorage.getItem('tutorial_v2_visto');
    if (versaoTutorial !== 'true') {
        document.getElementById('modalOnboarding').classList.remove('hidden');
    }
}

// Navega√ß√£o entre slides
function proximoSlide(numero) {
    // Esconde todos
    document.getElementById('slide1').classList.add('hidden');
    document.getElementById('slide2').classList.add('hidden');
    document.getElementById('slide3').classList.add('hidden');
    document.getElementById('slide4').classList.add('hidden');
    
    // Mostra o atual
    document.getElementById(`slide${numero}`).classList.remove('hidden');
}

// Ativa o bot√£o final apenas se o checkbox for marcado
document.addEventListener('DOMContentLoaded', () => {
    const check = document.getElementById('checkTermos');
    const btn = document.getElementById('btnConcluirOnboarding');
    
    if(check && btn) {
        check.addEventListener('change', function() {
            if(this.checked) {
                btn.disabled = false;
                btn.classList.remove('bg-gray-300', 'cursor-not-allowed');
                btn.classList.add('bg-green-600', 'hover:bg-green-700', 'shadow-lg');
            } else {
                btn.disabled = true;
                btn.classList.add('bg-gray-300', 'cursor-not-allowed');
                btn.classList.remove('bg-green-600', 'hover:bg-green-700', 'shadow-lg');
            }
        });
    }
});

// Salva que o usu√°rio j√° viu e fecha
function concluirOnboarding() {
    localStorage.setItem('tutorial_v2_visto', 'true');
    document.getElementById('modalOnboarding').classList.add('hidden');
    showToast("Configura√ß√£o conclu√≠da! Bom trabalho.", "success");
}

    
    
        'use strict';
        const SENHA_LIMPEZA_CATALOGO = 'mudar1234';
        document.addEventListener("DOMContentLoaded", main);

        // =================================================================================
        // 1. ESTADO GLOBAL E CONSTANTES
        // =================================================================================
        let equipe = [], frotasTurno = [], servicos = [], db, graficoOS = null, callbackPopup = null, debounceTimer;
        let catalogoFrotas = [];
        let catalogoLocal = [];

        const DB_NAME = 'meuturnoDB', DB_VERSION = 7;
        const STORE_TURNO = 'turno', STORE_HISTORICO = 'historicoOS', STORE_FROTAS = 'catalogoFrotas';
        const TURNO_ATUAL_ID = 'currentTurno';
        const atividades = ["P001 - AFERIDO", "P002 - AJUSTADO", "P003 - ALINHADO", "P004 - APERTADO", "P005 - BALANCEADO", "P006 - CALIBRADO", "P007 - COMPLETADO", "P008 - CONSERTADO COMPONENTE", "P009 - DESAMASSADO", "P010 - DESOBSTRUIDO", "P011 - EMBUCHADO", "P012 - FIXADO", "P013 - FURADO", "P014 - HIGIENIZADO", "P015 - INSPECIONADO", "P016 - INSTALADO", "P017 - ISOLADO", "P018 - LIMPO", "P019 - LUBRIFICADO", "P020 - MODIFICADO", "P021 - REAPERTADO", "P022 - RECARREGADO", "P023 - RECUPERADO", "P024 - REFORMADO", "P025 - REGULADO", "P026 - REMONTADO", "P027 - REPROGRAMADO", "P028 - RETIFICADO", "P029 - SOLDADO", "P030 - SUBSTITUIDO - TROCADO", "P031 - USINADO", "P032 - VEDADO", "H01 - Atraso de transporte", "H02 - DDS", "H03 - Refei√ß√£o", "H04 - Organiza√ß√£o/Limpeza", "H05 - Aguardando pe√ßa", "H06 - Aguardando Ferramenta", "H07 - Aguardando Servi√ßo", "H08 - Falta do colaborador", "H09 - Reuni√£o", "H10 - Ambulatorio", "H11 - Treinamento", "H12 - Outros", "H13 - Deslocamento a terceiros", "H14 - Carregamento de pneus pra conserto", "H15 - Inventario", "H16 - Apoio a Opera√ß√£o"];
        const sistemas = { "Tratores": [{ cod: "1", nome: "Estrutura" }, { cod: "2", nome: "Cabine" }, { cod: "3", nome: "Motor Combustao" }, { cod: "4", nome: "Eletrico" }, { cod: "5", nome: "Trem de Forca" }, { cod: "6", nome: "Tracao" }, { cod: "7", nome: "Hidraulico" }, { cod: "8", nome: "Direcao" }, { cod: "9", nome: "Freio" }], "Implementos": [{ cod: "10", nome: "Estrutura" }, { cod: "11", nome: "Tracao" }, { cod: "12", nome: "Adubo" }, { cod: "13", nome: "Hidraulico" }, { cod: "14", nome: "Eletrico" }, { cod: "15", nome: "V-SHEAR" }] };
        const subsistemas = { "1": ["1.1 - Chassi", "1.2 - Protecao", "1.3 - Escapamento", "1.4 - Suportes", "1.5 - Escada", "1.6 - Fixacao", "1.7 - Paralama", "1.8 - Tanque", "1.9 - Eixo", "1.10 - Chaparia", "1.11 - Alavanca"], "2": ["2.1 - Refrigecao", "2.2 - Banco", "2.3 - Vidros", "2.4 - Painel", "2.5 - Portas", "2.6 - Hodometro", "2.7 - Radio", "2.8 - Tacografo", "2.9 - Cinto de Seguranca", "2.10 - Cabine", "2.11 - Capo", "2.12 - Buzina"], "3": ["3.1 - Radiador", "3.2 - Motor", "3.3 - Intercooler", "3.4 - Arla", "3.5 - Filtro", "3.6 - Ignicao"], "4": ["4.1 - Iluminacao", "4.2 - Eletrica", "4.3 - Bateria", "4.4 - Chicote", "4.5 - Rastreador", "4.6 - Alternador", "4.7 - Encoder", "4.8 - Camera", "4.9 - Modulo", "4.10 - Comutador", "4.11 - Fluxometro", "4.12 - GPS"], "5": ["5.1 - Cubo", "5.2 - Embreagem", "5.3 - Cambio", "5.4 - Diferencial", "5.5 - Transmissao"], "6": ["6.1 - Pneu", "6.2 - Roda", "6.3 - Esteira", "6.4 - Roda Motriz", "6.5 - Roda Estrelada"], "7": ["7.1 - Mangueiras", "7.2 - Valvulas", "7.3 - Atuador", "7.4 - Bombas", "7.5 - Cilindro", "7.6 - VCR"], "8": ["8.1 - Barra de direcao", "8.2 - Coluna Direcao", "8.3 - Volante"], "9": ["9.1 - Freio", "9.2 - Acumulador"], "10": ["10.1 - Disco de Corte", "10.2 - Cabecalho", "10.3 - Ferramenta Traseira", "10.4 - Limpa Trilho", "10.5 - Quadro", "10.6 - Escarificador", "10.7 - Fixacao", "10.8 - Tanque", "10.9 - Eixo", "10.10 - Braco"], "11": ["11.1 - Pneus", "11.2 - Roda", "11.3 - Mancal"], "12": ["12.1 - Caixa de Adubo"], "13": ["13.1 - Cilindro", "13.2 - Mangueira", "13.3 - Bloco", "13.4 - Valvula"], "14": ["14.1 - Sensores", "14.2 - Chicote"], "15": ["15.1 - Lamina", "15.2 - Ball"] };
        
        const firebaseConfig = { apiKey: "AIzaSyDYVPQ2XFdsg5ViKnE5tyzczTZEVsM2kok", authDomain: "meu-turno-app.firebaseapp.com", projectId: "meu-turno-app", storageBucket: "meu-turno-app.firebasestorage.app", messagingSenderId: "967200929614", appId: "1:967200929614:web:3acbf1049a10cdbf87501f" };
        // 1. Inicializa o App
// 1. Inicializa o App
const firebaseApp = firebase.initializeApp(firebaseConfig);

// 2. Cria a inst√¢ncia do Firestore
const firestore = firebase.firestore();

// 3. AQUI EST√Å A CORRE√á√ÉO: For√ßar Long Polling
firestore.settings({
    experimentalForceLongPolling: true, // <--- ISSO RESOLVE 90% DOS CASOS NO ANDROID
    merge: true
});

// 4. Ativa persist√™ncia (se poss√≠vel)
firestore.enablePersistence({ synchronizeTabs: true })
    .catch((err) => { 
        console.warn('Persist√™ncia desativada (pode ser o ambiente restrito):', err.code); 
    });

/**
 * M√ìDULO GUARDIAN - Manuten√ß√£o Preventiva e Sa√∫de do Sistema
 * Vers√£o: 1.0
 */
const Guardian = {
    // Configura√ß√µes
    config: {
        maxLogs: 50,
        quotaWarningPercent: 0.8
    },

    // 1. Inicializa√ß√£o
    init: async function() {
        console.log("üõ°Ô∏è Guardian: Iniciando protocolos de prote√ß√£o...");
        this.setupGlobalErrorHandling();
        this.sanitizeLocalStorage();
        await this.checkStorageQuota();
        this.injectSafeRender();
    },

    // 2. Preven√ß√£o de Corrup√ß√£o (O "Bug do Null")
    sanitizeLocalStorage: function() {
        const criticalKeys = ['secaoAtiva', 'tutorial_v2_visto'];
        let repaired = false;

        criticalKeys.forEach(key => {
            const val = localStorage.getItem(key);
            if (val === "null" || val === "undefined" || val === null) {
                console.warn(`üõ°Ô∏è Guardian: Corrup√ß√£o detectada em '${key}'. Reparando...`);
                // Define valores padr√£o seguros
                if (key === 'secaoAtiva') localStorage.setItem(key, 'turno');
                repaired = true;
            }
        });

        if (repaired && window.showToast) {
            window.showToast("Sistema auto-reparado com sucesso.", "success");
        }
    },

    // 3. Monitoramento de Armazenamento (IndexedDB)
    checkStorageQuota: async function() {
        if ('storage' in navigator && 'estimate' in navigator.storage) {
            try {
                const estimate = await navigator.storage.estimate();
                const usagePercent = estimate.usage / estimate.quota;
                
                // Formata√ß√£o para MB
                const usageMB = (estimate.usage / 1024 / 1024).toFixed(2);
                console.log(`üõ°Ô∏è Guardian: Uso de Disco: ${usageMB} MB (${(usagePercent * 100).toFixed(2)}%)`);

                if (usagePercent > this.config.quotaWarningPercent) {
                    alert("‚ö†Ô∏è ATEN√á√ÉO: O espa√ßo no seu dispositivo est√° acabando! O Meu Turno pode parar de salvar dados offline. Libere espa√ßo no celular.");
                }
            } catch (e) {
                console.error("Erro ao verificar quota", e);
            }
        }
    },

    // 4. Captura Global de Erros (Log Local)
    setupGlobalErrorHandling: function() {
        window.onerror = (msg, url, line, col, error) => {
            this.logError('JS_CRASH', { msg, line, stack: error?.stack });
            // N√£o bloqueia o erro, mas avisa o usu√°rio se for cr√≠tico
            if (msg.toLowerCase().includes('quota') || msg.toLowerCase().includes('database')) {
                alert("Erro Cr√≠tico de Dados: O sistema tentar√° reiniciar.");
                window.location.reload();
            }
        };

        window.onunhandledrejection = (event) => {
            this.logError('PROMISE_FAIL', { reason: event.reason });
        };
    },

    logError: function(type, details) {
        // Salva no LocalStorage temporariamente para debug
        const logs = JSON.parse(localStorage.getItem('guardian_logs') || '[]');
        logs.unshift({ ts: new Date().toISOString(), type, details });
        if (logs.length > this.config.maxLogs) logs.pop();
        localStorage.setItem('guardian_logs', JSON.stringify(logs));
        console.error(`üõ°Ô∏è [${type}]`, details);
    },

    // 5. Utilit√°rio de Renderiza√ß√£o Segura (Anti-XSS)
    // Substitua seus innerHTML diretos por chamadas a esta fun√ß√£o quando lidar com input de usu√°rio
    escapeHTML: function(str) {
        if (!str) return "";
        return String(str)
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#039;");
    },

    // 6. Diagn√≥stico Manual (Para chamar no console ou menu secreto)
    runDiagnostics: async function() {
        const dbStatus = await this.testDBConnection();
        const network = navigator.onLine ? "Online" : "Offline";
        const logs = JSON.parse(localStorage.getItem('guardian_logs') || '[]');
        
        return `
        === DIAGN√ìSTICO GUARDIAN ===
        Status Rede: ${network}
        Banco de Dados: ${dbStatus ? "OK" : "ERRO"}
        Erros Registrados: ${logs.length}
        √öltimo Erro: ${logs[0] ? JSON.stringify(logs[0].details) : "Nenhum"}
        ============================
        `;
    },

    testDBConnection: async function() {
        try {
            // Tenta abrir uma transa√ß√£o de leitura r√°pida
            if (!db) return false;
            const tx = db.transaction('turno', 'readonly');
            return true;
        } catch(e) { return false; }
    },
    
    injectSafeRender: function() {
        // Exp√µe globalmente para uso nas suas fun√ß√µes de renderiza√ß√£o
        window.safeText = this.escapeHTML;
    }
};

/**
 * FAXINA AUTOM√ÅTICA
 * Remove do celular dados muito antigos para economizar mem√≥ria.
 * Crit√©rios: Mais de 120 dias E Status Finalizado.
 * Itens Pendentes NUNCA s√£o apagados.
 */
async function limparHistoricoAntigoLocal() {
    console.log("üßπ Iniciando faxina de cache local...");
    
    try {
        const todos = await dbExec(STORE_HISTORICO, 'readonly', s => s.getAll());
        
        // Define o limite (120 dias atr√°s)
        // Damos uma folga de 30 dias em rela√ß√£o ao sync da nuvem (90 dias) para seguran√ßa
        const dataLimite = new Date();
        dataLimite.setDate(dataLimite.getDate() - 120);
        const dataLimiteStr = dataLimite.toISOString().split('T')[0];

        const tx = db.transaction(STORE_HISTORICO, 'readwrite');
        const store = tx.objectStore(STORE_HISTORICO);
        let contagem = 0;

        todos.forEach(item => {
            // 1. Verifica a data
            if (item.dataOS < dataLimiteStr) {
                // 2. TRAVA DE SEGURAN√áA: S√≥ apaga se estiver FINALIZADA ou SINCRONIZADA
                // Se for "pendente", o mec√¢nico pode ter esquecido de enviar, ent√£o N√ÉO APAGA.
                if (item.status === 'finalizada' || (item.osNumero && item.osNumero.length > 0)) {
                    // Garante ID num√©rico para exclus√£o
                    const idParaApagar = item.uniqueId || item.id;
                    store.delete(idParaApagar);
                    contagem++;
                }
            }
        });

        tx.oncomplete = () => {
            if (contagem > 0) {
                console.log(`üßπ Faxina conclu√≠da: ${contagem} itens antigos removidos do celular.`);
                // Atualiza a lista se estiver aberta para sumir com os velhos
                if (document.getElementById('historico_lista')) {
                    mostrarHistorico();
                }
            } else {
                console.log("üßπ Nenhum item antigo para limpar.");
            }
        };

    } catch (e) {
        console.error("Erro na faxina autom√°tica:", e);
    }
}

        // =================================================================================
        // 2. INICIALIZA√á√ÉO E L√ìGICA DO PWA
        // =================================================================================
        async function main() {
            await Guardian.init(); 
    try {
        registrarServiceWorker();
        await initDB();
        
        sincronizarCatalogoFrotas();
        iniciarSincronizacaoAuxiliares();
        iniciarSincronizacaoEquipe();
        
        await carregarDadosIniciais();
        
           // --- NOVO: FAXINA DE DADOS VELHOS ---
        // Roda em segundo plano sem travar o app
        setTimeout(() => limparHistoricoAntigoLocal(), 5000); // Espera 5s para n√£o pesar a inicializa√ß√£o
        // ------------------------------------
        
        renderizarLayoutInicial();
        inicializarMenuHamburguer();
        verificarOnboarding(); 
        // --- NOVAS CHAMADAS DE L√ìGICA ---
        migrarDadosLocaisParaNuvem();     // Salva o legado
        iniciarSincronizacaoHistorico();  // Baixa o novo
        // -------------------------------

        const secaoInicial = localStorage.getItem('secaoAtiva') || 'turno';
        abrir(secaoInicial);
        
    } catch (err) { console.error("Erro main:", err); }
}


// --- CONFIGURA√á√ÉO DAS NOVIDADES ---
// EDITE AQUI SEMPRE QUE SUBIR UMA VERS√ÉO NOVA PARA O GITHUB
const NOVIDADES_VERSAO = [
    "‚úÖ Novo visual na Linha do Tempo",
    "‚úÖ Corre√ß√£o no salvamento Offline",
    "‚úÖ Hist√≥rico agora mostra status colorido",
    "‚ö° Melhoria de performance"
];

let newWorker = null; // Vari√°vel para guardar o SW esperando

function registrarServiceWorker() {
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('./service-worker.js').then(reg => {
            
            // 1. Se j√° tem um SW esperando (atualiza√ß√£o baixada em background)
            if (reg.waiting) {
                newWorker = reg.waiting;
                abrirModalUpdate();
                return;
            }

            // 2. Se encontrar uma atualiza√ß√£o nova
            reg.onupdatefound = () => {
                const worker = reg.installing;
                worker.onstatechange = () => {
                    if (worker.state === 'installed' && navigator.serviceWorker.controller) {
                        newWorker = worker;
                        abrirModalUpdate();
                    }
                };
            };
        }).catch(err => console.error('Erro no SW:', err));

        // Ouve o evento de recarregar a p√°gina quando o novo SW assumir
        let refreshing = false;
        navigator.serviceWorker.addEventListener('controllerchange', () => {
            if (!refreshing) {
                window.location.reload();
                refreshing = true;
            }
        });
    }
}

// Adicione uma propriedade 'critico'
const UPDATE_CONFIG = {
    critico: false, // MUDE PARA TRUE SE FOR OBRIGAT√ìRIO
    novidades: [
        "‚úÖ Novo visual na Linha do Tempo",
        "‚ö° Melhoria de performance"
    ]
};
// --- FUN√á√ïES VISUAIS DO NOVO MODAL ---

function abrirModalUpdate() {
    const modal = document.getElementById('modalUpdate');
    const backdrop = document.getElementById('modalUpdateBackdrop');
    const windowEl = document.getElementById('modalUpdateWindow');
    const lista = document.getElementById('listaNovidades');
    const btn = document.getElementById('btnUpdateConfirm');

    if (!modal) return;


    // 1. Preenche a lista de novidades
    lista.innerHTML = NOVIDADES_VERSAO.map(item => 
        `<li class="flex items-start gap-2"><span class="text-blue-500 mt-0.5">‚ûú</span> ${item}</li>`
    ).join('');

   // 2. L√≥gica Cr√≠tica
   const btnCancelar = document.querySelector('button[onclick="fecharModalUpdate()"]');
   
   if (UPDATE_CONFIG.critico) {
       // Esconde o bot√£o de cancelar e o fundo n√£o fecha
       
       btnCancelar.style.display = 'none';
       backdrop.onclick = null; // Impede clicar fora para fechar
       // Muda o texto para ser mais urgente
       document.querySelector('#modalUpdateWindow h3').innerText = "Atualiza√ß√£o Obrigat√≥ria";
       document.querySelector('#modalUpdateWindow p').innerText = "Esta vers√£o cont√©m corre√ß√µes de seguran√ßa cr√≠ticas.";
   } else {
       btnCancelar.style.display = 'block';
   }


    // 2. Define a a√ß√£o do bot√£o
    btn.onclick = () => {
        if (newWorker) {
            // Manda o novo Service Worker assumir o controle
            newWorker.postMessage({ action: 'skipWaiting' });
            btn.innerHTML = "Atualizando...";
            btn.disabled = true;
        } else {
            window.location.reload();
        }
    };

    // 3. Mostra com anima√ß√£o
    modal.classList.remove('hidden');
    // Pequeno delay para permitir a transi√ß√£o CSS
    setTimeout(() => {
        backdrop.classList.remove('opacity-0');
        windowEl.classList.remove('opacity-0', 'scale-90');
        windowEl.classList.add('scale-100');
    }, 10);
}

function fecharModalUpdate() {
    const modal = document.getElementById('modalUpdate');
    const backdrop = document.getElementById('modalUpdateBackdrop');
    const windowEl = document.getElementById('modalUpdateWindow');

    if (!modal) return;

    // Anima√ß√£o de sa√≠da
    backdrop.classList.add('opacity-0');
    windowEl.classList.remove('scale-100');
    windowEl.classList.add('opacity-0', 'scale-90');
   
    document.getElementById('btnUpdateBadge')?.classList.remove('hidden');

    

    setTimeout(() => {
        modal.classList.add('hidden');
    }, 300); // Espera a transi√ß√£o acabar
}

        // =================================================================================
        // 3. CAMADA DE ABSTRA√á√ÉO DO BANCO DE DADOS (INDEXEDDB)
        // =================================================================================
       const STORE_FAZENDAS = 'lista_fazendas';
const STORE_FRENTES = 'lista_frentes';
const STORE_EQUIPE = 'lista_equipe';

function initDB() {
    return new Promise((resolve, reject) => {
        if (db) return resolve(db);
        
        // INCREMENTEI A VERS√ÉO PARA 22
        const request = indexedDB.open(DB_NAME, 22); 
        
        request.onupgradeneeded = e => {
            const currentDb = e.target.result;
            
            // Stores Antigas (Mantidas)
            if (!currentDb.objectStoreNames.contains(STORE_TURNO)) currentDb.createObjectStore(STORE_TURNO, { keyPath: 'id' });
            if (!currentDb.objectStoreNames.contains(STORE_HISTORICO)) { 
                const hStore = currentDb.createObjectStore(STORE_HISTORICO, { keyPath: 'uniqueId', autoIncrement: true }); 
                hStore.createIndex('dataKeyIndex', 'dataKey', { unique: false }); 
            }
            if (!currentDb.objectStoreNames.contains('catalogo')) currentDb.createObjectStore('catalogo', { keyPath: 'docId' });
            if (!currentDb.objectStoreNames.contains(STORE_FROTAS)) currentDb.createObjectStore(STORE_FROTAS, { keyPath: 'docId' });
            if (!currentDb.objectStoreNames.contains(STORE_FAZENDAS)) currentDb.createObjectStore(STORE_FAZENDAS, { keyPath: 'docId' });
            if (!currentDb.objectStoreNames.contains(STORE_FRENTES)) currentDb.createObjectStore(STORE_FRENTES, { keyPath: 'docId' });

            // --- NOVA STORE EQUIPE ---
            if (!currentDb.objectStoreNames.contains(STORE_EQUIPE)) {
                currentDb.createObjectStore(STORE_EQUIPE, { keyPath: 'docId' });
            }
        };
        request.onsuccess = e => { db = e.target.result; resolve(db); };
        request.onerror = e => { console.error("Erro DB:", e); reject(e); };
    });
}

        async function dbExec(storeName, mode, operation) { try { await initDB(); return new Promise((resolve, reject) => { const t = db.transaction([storeName], mode); const s = t.objectStore(storeName); const r = operation(s); r.onsuccess = e => resolve(e.target.result); r.onerror = e => { reject(e.target.error); }; }); } catch (err) { showToast(`Erro no banco de dados.`, 'error'); throw err; } }

        // =================================================================================
        // 4. GEST√ÉO DE DADOS GLOBAIS
        // =================================================================================
        async function carregarDadosIniciais() {
            try {
                catalogoFrotas = await dbExec(STORE_FROTAS, 'readonly', s => s.getAll());
                catalogoLocal = await dbExec('catalogo', 'readonly', s => s.getAll());
                const dados = await dbExec(STORE_TURNO, 'readonly', s => s.get(TURNO_ATUAL_ID));
                const dataHoje = dataHojeInputLocal();
                if (dados) {
                    if (dados.data && dados.data !== dataHoje) {
                        const confirmado = await new Promise(resolve => abrirPopupConfirmar('Iniciar Novo Turno?', `Dados de ${formatarDataParaExibicao(dados.data)} encontrados. Deseja iniciar um novo turno para hoje? <br><br><strong>A equipe e as frotas do turno anterior ser√£o mantidas.</strong>`, resolve));
                        if (confirmado) {
                            equipe = dados.equipe || []; frotasTurno = dados.frotas || []; servicos = [];
                            await salvarTudo(true);
                            showToast("Novo turno iniciado!", 'success');
                        } else { carregarEstado(dados); }
                    } else { carregarEstado(dados); }
                } else { inicializarEstadoVazio(); }
            } catch (err) { showToast('Erro ao carregar dados iniciais.', 'error'); inicializarEstadoVazio(); }
        }
        function carregarEstado(dados) { 
    equipe = dados.equipe || []; 
    frotasTurno = dados.frotas || []; 
    servicos = dados.servicos || []; 
    
    // --- RECUPERANDO A LINHA DO TEMPO SALVA ---
    linhasApontamento = dados.linhasApontamento || [];
    // ------------------------------------------

    frotasTurno.forEach(f => f.tipo = f.tipo || 'maquina'); 
    servicos.forEach(s => { 
        s.isExpanded = s.isExpanded || false; 
        s.foiCompartilhado = s.foiCompartilhado || false; 
        s.pecasUtilizadas = s.pecasUtilizadas || []; 
    }); 
}

        function inicializarEstadoVazio() { equipe = []; frotasTurno = []; servicos = []; }
        
        function salvarTudo(forcar = false) { 
    clearTimeout(debounceTimer); 
    const executar = async () => { 
        try { 
            const relatorioBruto = document.getElementById("relatorio_bruto")?.value || ''; 
            const snapshotServicos = document.getElementById("relatorio_snapshot")?.value || '[]'; 
            
            const dados = { 
                id: TURNO_ATUAL_ID, 
                data: document.getElementById("dataTurno")?.value, 
                fazenda: document.getElementById("fazenda")?.value.trim(), 
                frente: document.getElementById("frente")?.value.trim(), 
                turno: document.getElementById("turnoLetra")?.value, 
                equipe: equipe, 
                frotas: frotasTurno, 
                servicos: servicos, 
                // --- AQUI EST√Å A NOVIDADE: SALVAR A LINHA DO TEMPO ---
                linhasApontamento: linhasApontamento, 
                // -----------------------------------------------------
                relatorio: relatorioBruto, 
                relatorioGeradoComServicos: snapshotServicos 
            }; 
            
            await dbExec(STORE_TURNO, 'readwrite', s => s.put(dados)); 
        } catch (err) { 
            console.error("Erro ao salvar:", err); // Mudei para console para n√£o spammar toast
        } 
    }; 
    
    if (forcar) executar(); 
    else debounceTimer = setTimeout(executar, 1000); 
}

        
        function salvarDadosParciaisTurno() { validarCamposTurnoBasicos(); salvarTudo(); }

        // =================================================================================
        // 5. RENDERIZA√á√ÉO E UI
        // =================================================================================
                async function renderizarLayoutInicial() { 
            try { 
                // 1. Carrega as listas do cache local primeiro (Offline-first)
                await carregarFazendasDoCache();
                await carregarFrentesDoCache();

                // 2. Carrega os dados salvos do turno atual
                const d = await dbExec(STORE_TURNO, 'readonly', s => s.get(TURNO_ATUAL_ID)) || {}; 
                
                document.getElementById("dataTurno").value = d.data || dataHojeInputLocal(); 
                
                // 3. Define os valores nos selects de FAZENDA
                if (d.fazenda) {
                    const el = document.getElementById("fazenda");
                    el.value = d.fazenda;
                    if (!el.value) el.setAttribute('data-temp-value', d.fazenda);
                }

                // 4. Define os valores nos selects de FRENTE
                if (d.frente) {
                    const el = document.getElementById("frente");
                    el.value = d.frente;
                    if (!el.value) el.setAttribute('data-temp-value', d.frente);
                }

                // 5. Define o Turno (Agora respeita o vazio se n√£o houver dado salvo)
                document.getElementById("turnoLetra").value = d.turno || ""; 

            } catch (e) { 
                console.error("Erro render inicial", e); 
            } 
        }


        // SUBSTITUI√á√ÉO: Esta √© a fun√ß√£o 'abrir' modificada para persist√™ncia de tela
        function abrir(secaoId) {
            // Esconde todas as sec√ß√µes
            document.querySelectorAll('main section').forEach(s => s.classList.add('hidden'));

            // Mostra a sec√ß√£o ativa e chama a sua fun√ß√£o de renderiza√ß√£o
            const secaoAtiva = document.getElementById(secaoId);
            if (secaoAtiva) {
                secaoAtiva.classList.remove('hidden');
                
                  // --- L√ìGICA INTELIGENTE DE ECONOMIA ---
        if (secaoId === 'catalogo') {
            // S√≥ baixa o cat√°logo se o usu√°rio entrar nesta tela!
            sincronizarCatalogoPecas();
            renderizarCatalogo(); // Renderiza o que j√° tem no cache local enquanto baixa
        }
        
        // --- NOVA L√ìGICA DE ECONOMIA DE FROTAS ---
    if (secaoId === 'frotas') {
        sincronizarCatalogoFrotas(); 
        renderizarCatalogoFrotas();
    }
        // --------------------------------------
                
                const renderFunc = window[`renderizarSecao${secaoId.charAt(0).toUpperCase() + secaoId.slice(1)}`];
                if (typeof renderFunc === 'function') {
                    renderFunc(secaoAtiva);
                }
            }

            // NOVO: Salva a se√ß√£o ativa no LocalStorage
            localStorage.setItem('secaoAtiva', secaoId);

            // Atualiza o t√≠tulo do cabe√ßalho
            
            //document.getElementById('header-titulo').textContent = secaoId === 'catalogo' ? 'Cat√°logo de Pe√ßas' : secaoId.charAt(0).toUpperCase() + secaoId.slice(1);
            

            // Pega a refer√™ncia de todos os bot√µes flutuantes
            const fabCriarServico = document.getElementById('fabCriarServico');
            const fabAddItemCatalogo = document.getElementById('fabAddItemCatalogo');
            const fabAddFrotaCatalogo = document.getElementById('fabAddFrotaCatalogo');
            const fabCadastroRapidoFrota = document.getElementById('fabCadastroRapidoFrota');

            // Esconde todos eles por padr√£o
            if (fabCriarServico) fabCriarServico.style.display = 'none';
            if (fabAddItemCatalogo) fabAddItemCatalogo.style.display = 'none';
            if (fabAddFrotaCatalogo) fabAddFrotaCatalogo.style.display = 'none';
            if (fabCadastroRapidoFrota) fabCadastroRapidoFrota.style.display = 'none';

            // Mostra os bot√µes corretos para a sec√ß√£o atual
            if (secaoId === 'servicos') {
                if (fabCriarServico) fabCriarServico.style.display = 'flex';
                if (fabCadastroRapidoFrota) fabCadastroRapidoFrota.style.display = 'flex';
            } else if (secaoId === 'catalogo') {
                if (fabAddItemCatalogo) fabAddItemCatalogo.style.display = 'flex';
            } else if (secaoId === 'frotas') {
                if (fabAddFrotaCatalogo) fabAddFrotaCatalogo.style.display = 'flex';
            }
            // ... c√≥digo anterior da fun√ß√£o abrir ...

    // --- ATUALIZA√á√ÉO VISUAL DO MENU ---
    document.querySelectorAll('#menu-lateral a').forEach(link => {
        // Remove classes de ativo de todos
        link.classList.remove('bg-blue-50', 'text-blue-700', 'border-l-4', 'border-blue-600');
        link.classList.add('text-gray-600', 'hover:bg-gray-50');

        // Adiciona destaque no ativo
        if (link.getAttribute('data-secao') === secaoId) {
            link.classList.remove('text-gray-600', 'hover:bg-gray-50');
            link.classList.add('bg-blue-50', 'text-blue-700', 'border-l-4', 'border-blue-600');
        }
    });


        }
        function inicializarMenuHamburguer() { const btn = document.getElementById('hamburger-btn'); const overlay = document.getElementById('menu-overlay'); const links = document.querySelectorAll('#menu-lateral a'); const fecharMenu = () => document.body.classList.remove('menu-open'); btn.addEventListener('click', e => { e.stopPropagation(); document.body.classList.toggle('menu-open'); }); overlay.addEventListener('click', fecharMenu); links.forEach(link => link.addEventListener('click', e => { e.preventDefault(); abrir(link.getAttribute('data-secao')); fecharMenu(); })); }
        let toastTimer; function showToast(msg, type = 'info', duration = 2000) { const t = document.getElementById("toast"); if (!t) return; clearTimeout(toastTimer); t.textContent = msg; t.className = ''; t.classList.add(type); requestAnimationFrame(() => { t.classList.add('show'); }); toastTimer = setTimeout(() => { t.classList.remove('show'); }, duration); }
        function abrirPopup(titulo, mensagem, botoes = []) { 
    document.getElementById('popupTitulo').innerHTML = titulo; 
    document.getElementById('popupMensagem').innerHTML = mensagem; 
    const divBotoes = document.getElementById('popupBotoes'); 
    divBotoes.innerHTML = ''; 
    
    if (botoes.length === 0) {
        botoes.push({ texto: 'Fechar', classe: 'bg-gray-300 text-gray-800 hover:bg-gray-400', acao: fecharPopup }); 
    }
    
    botoes.forEach(b => { 
        const btn = document.createElement('button'); 
        const classesBase = "py-2.5 px-5 rounded-lg text-sm font-bold transition-all active:scale-95 shadow-sm";
        btn.className = `${classesBase} ${b.classe}`; 
        btn.innerHTML = b.texto; 
        
        // --- CORRE√á√ÉO DA L√ìGICA DE FECHAMENTO ---
        btn.onclick = () => { 
            // 1. Executa a a√ß√£o se existir
            const resultado = b.acao ? b.acao() : undefined;
            
            // 2. L√ìGICA ROBUSTA:
            // S√≥ mant√©m aberto se a fun√ß√£o retornar EXPLICITAMENTE 'false'.
            // Qualquer outra coisa (true, undefined, Promise do async) FECHA o popup.
            if (resultado !== false) {
                fecharPopup();
            }
        }; 
        
        divBotoes.appendChild(btn); 
    }); 
    
    document.getElementById('popupGenerico').style.display = 'block'; 
    document.getElementById('overlayGenerico').style.display = 'block'; 
}


        function fecharPopup() { document.getElementById('popupGenerico').style.display = 'none'; document.getElementById('overlayGenerico').style.display = 'none'; }
        function abrirPopupConfirmar(titulo, mensagem, callback, acaoConfirmar = 'Confirmar') { abrirPopup(titulo, mensagem, [{ texto: acaoConfirmar, classe: 'bg-blue-600 text-white hover:bg-blue-700', acao: () => callback(true) }, { texto: 'Cancelar', classe: 'bg-gray-300 text-gray-800 hover:bg-gray-400', acao: () => callback(false) }]); }
        function abrirPopupInput(titulo, label, placeholder, valorInicial, callback, tipoInput = 'text') { const conteudoPopup = `<label for="popup-input-field" class="block text-sm font-medium text-gray-700 mb-1">${label}</label><input type="${tipoInput}" id="popup-input-field" class="w-full p-2 border border-gray-300 rounded-md" placeholder="${placeholder}" value="${valorInicial}">`; const botoes = [{ texto: 'Confirmar', classe: 'bg-blue-600 text-white hover:bg-blue-700', acao: () => callback(document.getElementById('popup-input-field').value) }, { texto: 'Cancelar', classe: 'bg-gray-300 text-gray-800 hover:bg-gray-400', acao: () => callback(null) }]; abrirPopup(titulo, `<div id="popup-content-wrapper">${conteudoPopup}</div>`, botoes); setTimeout(() => document.getElementById('popup-input-field')?.focus(), 50); }
        function abrirPopupLoading(mensagem) { const conteudoPopup = `<div class="flex flex-col items-center justify-center py-4"><div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mb-4"></div><p class="text-gray-700 text-center">${mensagem}</p></div>`; abrirPopup("A Processar...", conteudoPopup, []); }
        function validarCamposTurnoBasicos() { 
            // Adicionado 'turnoLetra' na lista de obrigat√≥rios
            const campos = ['dataTurno', 'fazenda', 'frente', 'turnoLetra']; 
            let todosValidos = true; 
            
            campos.forEach(id => { 
                const el = document.getElementById(id); 
                if (!el?.value.trim()) { 
                    el?.classList.add('campo-invalido'); 
                    todosValidos = false; 
                } else { 
                    el?.classList.remove('campo-invalido'); 
                } 
            }); 
            
            if (!todosValidos) showToast("Preencha todos os campos do turno (Data, Fazenda, Frente e Turno)!", 'error'); 
            return todosValidos; 
        }
        function dataHojeInputLocal() { return new Date().toLocaleDateString('en-CA'); }
        function formatarDataParaExibicao(dataStr) { if (!dataStr || !/^\d{4}-\d{2}-\d{2}$/.test(dataStr)) return "Sem Data"; const [ano, mes, dia] = dataStr.split('-'); return `${dia}/${mes}/${ano}`; }
        function interpretarMarkdown(texto) { if (!texto) return ""; return texto.replace(/\*(.*?)\*/g, '<strong>$1</strong>').replace(/\n/g, '<br>'); }
        function minimizarServico(id) { const servico = servicos.find(s => s.id === id); if (servico && servico.isExpanded) { toggleDetalhesServico(id); } }
                function gerarTextoCabecalhoServico(servico) {
            const frota = servico.frota || "N/D";
            const codAtividade = (servico.atividade || "P000").split(" - ")[0];
            const codSistema = servico.sistema || "0";
            const codSubsistema = (servico.subsistema || "0.0").split(" - ")[0];
            const horaInicio = servico.inicio || "--:--";
            const horaFim = servico.fim || "--:--";
            const infoServico = `${codAtividade} - ${codSistema} - ${codSubsistema} [${horaInicio} - ${horaFim}]`;

            // --- IN√çCIO DA MODIFICA√á√ÉO ---

            // 1. Criamos uma vari√°vel para guardar o texto do tipo de manuten√ß√£o.
            let tipoSpan = '';

            // 2. Verificamos o tipo do servi√ßo e definimos o HTML correspondente.
            if (servico.tipo === 'CORRETIVA') {
                // Se for 'CORRETIVA', criamos um span com texto vermelho escuro, negrito e it√°lico.
                tipoSpan = ` <span class="font-bold italic text-red-700">Corretiva</span>`;
            } else if (servico.tipo === 'CONDICIONAL') {
                // Se for 'CONDICIONAL', criamos um span com texto azul, negrito e it√°lico.
                tipoSpan = ` <span class="font-bold italic text-blue-600">Condicional</span>`;
            } else if (servico.tipo === 'MELHORIA') {
                // Se for 'MELHORIA', criamos um span com texto amarelo, negrito e it√°lico.
                tipoSpan = ` <span class="font-bold italic text-yellow-600">Melhoria</span>`;
            }

            // 3. Juntamos o texto original com o nosso novo span.
            return `<strong>Frota:</strong> <span class="frota-destaque">${frota}</span> <span class="atividade-info">| ${infoServico}</span>${tipoSpan}`;
            
            // --- FIM DA MODIFICA√á√ÉO ---
        }
        
        // NOVO: Fun√ß√£o auxiliar para validar o tempo de um servi√ßo
        function validarTempoServico(servico) {
            if (!servico.inicio || !servico.fim) return true; // Se um dos campos estiver vazio, √© v√°lido temporariamente.

            try {
                // Junta data e hora para criar objetos Date, garantindo a compara√ß√£o correta.
                const inicioStr = `${servico.data}T${servico.inicio}`;
                const fimStr = `${servico.dataFinal}T${servico.fim}`;
                
                const dataInicio = new Date(inicioStr);
                const dataFim = new Date(fimStr);

                // Retorna falso se a hora final for anterior ou igual √† inicial
                return dataFim.getTime() > dataInicio.getTime();
            } catch (e) {
                console.error("Erro na valida√ß√£o de tempo:", e);
                return true; // Assume v√°lido em caso de erro de parse.
            }
        }


        function formatarDescricao(texto) { if (!texto) return 'Nenhuma descri√ß√£o fornecida.'; return texto.trim().split('\n').map(linha => `- ${linha.trim()}`).join('\n'); }
        function getTipoTexto(tipo) { switch (tipo) { case 'maquina': return 'M√°quina Principal'; case 'implemento': return 'Implemento'; case 'caminhao': return 'Caminh√£o'; default: return 'N/D'; } }
        function getTipoCor(tipo) { switch (tipo) { case 'maquina': return 'text-blue-600'; case 'implemento': return 'text-gray-500'; case 'caminhao': return 'text-green-600'; default: return 'text-gray-400'; } }
        function removerAcentos(texto) {
            if (!texto) return "";
            return texto.normalize("NFD").replace(/[\u0300-\u036f]/g, "");
        }

        // =================================================================================
        // 6. L√ìGICA POR M√ìDULO (SE√á√ÉO)
        // =================================================================================
        // ---------------------------------
        // M√ìDULO: TURNO (TELA INICIAL)
        // ---------------------------------
        function renderizarSecaoTurno(container) { renderizarEquipe(); renderizarFrotasDoTurno(); }
        function adicionarEquipe() { if (!validarCamposTurnoBasicos()) return; const nomeEl = document.getElementById('nomeEquipe'); const matEl = document.getElementById('matriculaEquipe'); if (nomeEl.value.trim() && matEl.value.trim()) { equipe.push({ nome: nomeEl.value.trim(), matricula: matEl.value.trim() }); renderizarEquipe(); salvarTudo(); nomeEl.value = matEl.value = ''; nomeEl.focus(); showToast('Membro adicionado!', 'success'); } else { showToast('Preencha nome e matr√≠cula.', 'error'); } }
        function removerEquipe(index) { equipe.splice(index, 1); renderizarEquipe(); salvarTudo(); showToast('Membro removido.', 'success'); 
   }
        
        
function renderizarEquipe() { 
    const box = document.getElementById('boxEquipe'); 
    if (!box) return; 
    
    if (equipe.length === 0) { 
        box.innerHTML = '<div class="text-center py-8 bg-white border border-gray-100 rounded-xl shadow-sm"><p class="text-sm text-gray-400">Nenhum membro adicionado.</p></div>'; 
        return; 
    } 
    
    box.innerHTML = equipe.map((item, i) => `
        <div class="flex items-center justify-between p-4 mb-4 bg-white rounded-xl shadow-sm border-l-4 border-blue-500 transition-all hover:shadow-md">
            <div class="flex items-center gap-4">
                <div class="w-10 h-10 rounded-full bg-blue-50 text-blue-600 flex items-center justify-center font-bold text-base">
                    ${item.nome.charAt(0)}
                </div>
                <div class="flex flex-col">
                    <span class="text-base font-bold text-gray-800 leading-tight">${item.nome}</span>
                    <span class="text-xs text-gray-500 font-medium mt-0.5">Mat: ${item.matricula}</span>
                </div>
            </div>
            <button onclick="removerEquipe(${i})" class="text-gray-300 hover:text-red-500 p-2 transition-colors bg-gray-50 rounded-full hover:bg-red-50">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                </svg>
            </button>
        </div>
    `).join(''); 
}


        function renderizarFrotasDoTurno() { 
    const div = document.getElementById('listaFrotas'); 
    if (!div) return; 
    
    if (frotasTurno.length === 0) { 
        div.innerHTML = '<div class="text-center py-6 bg-white border border-gray-200 rounded-lg shadow-sm"><p class="text-sm text-gray-400">Nenhuma frota no turno.</p></div>'; 
        return; 
    } 
    
    frotasTurno.sort((a, b) => a.nome.localeCompare(b.nome)); 
    
    div.innerHTML = frotasTurno.map((f, i) => {
        // CORES PADR√ÉO (Seguras para TrebEdit/CDN)
        // Usando classes comuns: blue-500, green-500, gray-400
        let corBorda = 'border-blue-500'; 

        if (f.tipo === 'caminhao') {
            corBorda = 'border-green-500';
        } else if (f.tipo === 'implemento') {
            corBorda = 'border-gray-400';
        }

        return `
        <div class="flex items-center justify-between p-3 mb-2 bg-white rounded-lg shadow-sm border-l-8 ${corBorda}">
            
            <div class="flex flex-col min-w-0 pr-2">
                <span class="text-base font-bold text-gray-800 truncate">
                    ${f.nome}
                </span>
                <span class="text-xs font-bold uppercase tracking-wide w-max px-2 py-0.5 rounded mt-1 text-gray-500 bg-gray-100">
                    ${getTipoTexto(f.tipo)}
                </span>
            </div>

            <div class="flex items-center gap-2 flex-shrink-0">
                <div class="flex items-center bg-gray-50 border border-gray-300 rounded px-2 py-1">
                    <input type="number" step="0.1" value="${f.horas}" 
                        onchange="atualizarHorasFrotaTurno(${i}, this.value)" 
                        class="w-10 bg-transparent text-center text-sm font-bold text-gray-700 outline-none p-0" 
                        placeholder="0">
                    <span class="text-xs text-gray-400 font-bold ml-1">h</span>
                </div>

                <button onclick="removerFrotaDoTurno(${i})" class="text-gray-400 hover:text-red-600 p-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>

        </div>`;
    }).join(''); 
}

        async function removerFrotaDoTurno(index) { const confirmado = await new Promise(resolve => abrirPopupConfirmar('Remover Frota do Turno', 'Tem certeza?', resolve)); if (confirmado) { frotasTurno.splice(index, 1); renderizarFrotasDoTurno(); salvarTudo(); showToast('Frota removida do turno.', 'success'); } }
        function atualizarHorasFrotaTurno(index, novasHoras) { const horas = parseFloat(novasHoras); if (!isNaN(horas) && horas > 0) { frotasTurno[index].horas = horas; salvarTudo(); showToast('Horas da frota atualizadas.', 'success'); } else { showToast('Valor de horas inv√°lido.', 'error'); renderizarFrotasDoTurno(); } }
        
// ============================================================
// GEST√ÉO DE FAZENDAS E FRENTES (Sincronizado)
// ============================================================

let listaFazendas = [];
let listaFrentes = [];

// 1. Inicia a escuta do Firebase (Chamar no main)
function iniciarSincronizacaoAuxiliares() {
    // Sincronizar FAZENDAS
    firestore.collection('lista_fazendas').orderBy('nome').onSnapshot(snapshot => {
        const tx = db.transaction(STORE_FAZENDAS, 'readwrite');
        const store = tx.objectStore(STORE_FAZENDAS);
        
        snapshot.docChanges().forEach(change => {
            const item = { ...change.doc.data(), docId: change.doc.id };
            if (change.type === 'added' || change.type === 'modified') store.put(item);
            if (change.type === 'removed') store.delete(item.docId);
        });

        tx.oncomplete = () => carregarFazendasDoCache();
    });

    // Sincronizar FRENTES
    firestore.collection('lista_frentes').orderBy('nome').onSnapshot(snapshot => {
        const tx = db.transaction(STORE_FRENTES, 'readwrite');
        const store = tx.objectStore(STORE_FRENTES);
        
        snapshot.docChanges().forEach(change => {
            const item = { ...change.doc.data(), docId: change.doc.id };
            if (change.type === 'added' || change.type === 'modified') store.put(item);
            if (change.type === 'removed') store.delete(item.docId);
        });

        tx.oncomplete = () => carregarFrentesDoCache();
    });
}

// 2. Carrega do IndexedDB para a Tela
async function carregarFazendasDoCache() {
    try {
        listaFazendas = await dbExec(STORE_FAZENDAS, 'readonly', s => s.getAll());
        atualizarSelectGenerico('fazenda', listaFazendas);
    } catch(e) { console.error(e); }
}

async function carregarFrentesDoCache() {
    try {
        listaFrentes = await dbExec(STORE_FRENTES, 'readonly', s => s.getAll());
        atualizarSelectGenerico('frente', listaFrentes);
    } catch(e) { console.error(e); }
}

// Fun√ß√£o auxiliar para preencher os selects
function atualizarSelectGenerico(elementId, dados) {
    const select = document.getElementById(elementId);
    if (!select) return;

    // Tenta preservar o valor que j√° estava selecionado ou salvo
    const valorAtual = select.value || select.getAttribute('data-temp-value');

    select.innerHTML = '<option value="">Selecione...</option>';
    
    // Ordena√ß√£o alfab√©tica
    dados.sort((a, b) => a.nome.localeCompare(b.nome));

    dados.forEach(item => {
        const option = document.createElement('option');
        option.value = item.nome;
        option.textContent = item.nome;
        option.dataset.docId = item.docId; // ID do Firebase para exclus√£o
        select.appendChild(option);
    });

    // Restaura a sele√ß√£o
    if (valorAtual) {
        select.value = valorAtual;
        // Se o valor salvo n√£o existe na lista (foi apagado por outro usu√°rio), cria visualmente
        if (!select.value) {
            const opt = document.createElement('option');
            opt.value = valorAtual;
            opt.text = valorAtual + " (Arquivado)";
            opt.selected = true;
            select.appendChild(opt);
        }
    }
}

// 3. Fun√ß√µes de CRUD (Adicionar / Remover)

function adicionarNovaFazenda(callbackSucesso = null) {
    abrirPopupInput('Nova Fazenda', 'Nome:', 'Ex: FAZENDA SANTA MARIA', '', async (nome) => {
        if (!nome) return;
        const nomeUpper = nome.trim().toUpperCase();
        
        // 1. Verifica√ß√£o inicial (antes de ir pro servidor)
        if (listaFazendas.some(f => f.nome === nomeUpper)) {
            showToast("Esta fazenda j√° existe.", "error");
            return;
        }

        try {
            // 2. Salva na Nuvem
            const docRef = await firestore.collection('lista_fazendas').add({ nome: nomeUpper });
            
            // 3. CORRE√á√ÉO AQUI: Verifica se o Sync autom√°tico j√° n√£o adicionou o item
            // enquanto esper√°vamos o 'await' do Firestore.
            const jaExisteNaMemoria = listaFazendas.some(f => f.nome === nomeUpper);
            
            if (!jaExisteNaMemoria) {
                listaFazendas.push({ nome: nomeUpper, docId: docRef.id });
                listaFazendas.sort((a, b) => a.nome.localeCompare(b.nome));
            }
            
            showToast("Fazenda adicionada!", "success");
            
            // Atualiza select da tela principal se existir
            const elMain = document.getElementById('fazenda');
            if(elMain) {
                atualizarSelectGenerico('fazenda', listaFazendas);
                elMain.value = nomeUpper;
            }

            // Retorno para o fluxo do Popup de Contexto
            if (callbackSucesso) {
                callbackSucesso(nomeUpper);
            } else {
                salvarDadosParciaisTurno();
            }

        } catch (e) { showToast("Erro ao salvar: " + e.message, "error"); }
    });
}

function adicionarNovaFrente(callbackSucesso = null) {
    abrirPopupInput('Nova Frente', 'Nome:', 'Ex: M√ìDULO 1', '', async (nome) => {
        if (!nome) return;
        const nomeUpper = nome.trim().toUpperCase();
        
        if (listaFrentes.some(f => f.nome === nomeUpper)) {
            showToast("Esta frente j√° existe.", "error");
            return;
        }

        try {
            const docRef = await firestore.collection('lista_frentes').add({ nome: nomeUpper });
            
            // 3. CORRE√á√ÉO AQUI TAMB√âM: Trava de duplicidade p√≥s-save
            const jaExisteNaMemoria = listaFrentes.some(f => f.nome === nomeUpper);

            if (!jaExisteNaMemoria) {
                listaFrentes.push({ nome: nomeUpper, docId: docRef.id });
                listaFrentes.sort((a, b) => a.nome.localeCompare(b.nome));
            }
            
            showToast("Frente adicionada!", "success");
            
            const elMain = document.getElementById('frente');
            if(elMain) {
                atualizarSelectGenerico('frente', listaFrentes);
                elMain.value = nomeUpper;
            }

            if (callbackSucesso) {
                callbackSucesso(nomeUpper);
            } else {
                salvarDadosParciaisTurno();
            }

        } catch (e) { showToast("Erro ao salvar.", "error"); }
    });
}

function removerFazendaSelecionada() {
    const select = document.getElementById('fazenda');
    const nome = select.value;
    const option = select.options[select.selectedIndex];
    const docId = option.dataset.docId;

    if (!nome || !docId) {
        showToast("Selecione uma fazenda da lista para remover.", "error");
        return;
    }

    abrirPopupConfirmar("Apagar Fazenda", `Deseja remover <b>${nome}</b>? <br>Isso afetar√° todos os usu√°rios.`, async (ok) => {
        if (ok) {
            try {
                await firestore.collection('lista_fazendas').doc(docId).delete();
                showToast("Fazenda removida.", "success");
                select.value = "";
                salvarDadosParciaisTurno();
            } catch (e) { showToast("Erro ao remover.", "error"); }
        }
    });
}

function adicionarNovaFrente() {
    abrirPopupInput('Nova Frente', 'Nome:', 'Ex: M√ìDULO 1', '', async (nome) => {
        if (!nome) return;
        const nomeUpper = nome.trim().toUpperCase();
        
        if (listaFrentes.some(f => f.nome === nomeUpper)) {
            showToast("Esta frente j√° existe.", "error");
            return;
        }

        try {
            await firestore.collection('lista_frentes').add({ nome: nomeUpper });
            showToast("Frente adicionada!", "success");
            setTimeout(() => {
                const el = document.getElementById('frente');
                el.value = nomeUpper;
                salvarDadosParciaisTurno();
            }, 500);
        } catch (e) { showToast("Erro ao salvar.", "error"); }
    });
}

function removerFrenteSelecionada() {
    const select = document.getElementById('frente');
    const nome = select.value;
    const option = select.options[select.selectedIndex];
    const docId = option.dataset.docId;

    if (!nome || !docId) {
        showToast("Selecione uma frente da lista para remover.", "error");
        return;
    }

    abrirPopupConfirmar("Apagar Frente", `Deseja remover <b>${nome}</b>?`, async (ok) => {
        if (ok) {
            try {
                await firestore.collection('lista_frentes').doc(docId).delete();
                showToast("Frente removida.", "success");
                select.value = "";
                salvarDadosParciaisTurno();
            } catch (e) { showToast("Erro ao remover.", "error"); }
        }
    });
}

// ============================================================
// GEST√ÉO DE EQUIPE (FIREBASE + LOCAL)
// ============================================================

let listaEquipeCache = [];

// 1. SINCRONIZA√á√ÉO (Firebase -> App)
// Chamar no main()
function iniciarSincronizacaoEquipe() {
    firestore.collection('lista_equipe').orderBy('nome').onSnapshot(snapshot => {
        const tx = db.transaction(STORE_EQUIPE, 'readwrite');
        const store = tx.objectStore(STORE_EQUIPE);
        
        listaEquipeCache = []; // Limpa RAM

        snapshot.docChanges().forEach(change => {
            const item = { ...change.doc.data(), docId: change.doc.id };
            if (change.type === 'added' || change.type === 'modified') store.put(item);
            if (change.type === 'removed') store.delete(item.docId);
        });

        // Atualiza cache em mem√≥ria
        tx.oncomplete = async () => {
            listaEquipeCache = await dbExec(STORE_EQUIPE, 'readonly', s => s.getAll());
            // Atualiza tamb√©m o select do apontamento se estiver aberto
            renderizarSecaoApontamento(); 
        };
    });
}

function abrirPopupSelecaoEquipe() {
    listaEquipeCache.sort((a, b) => a.nome.localeCompare(b.nome));

    const listaHTML = listaEquipeCache.map(colab => {
        const jaNoTurno = equipe.some(e => e.matricula === colab.matricula);
        const checked = jaNoTurno ? 'checked' : '';
        const style = jaNoTurno ? 'bg-blue-50 border-blue-200' : 'bg-white border-gray-200';
        
        return `
        <div class="flex items-center justify-between p-3 mb-2 border rounded-md ${style} hover:bg-gray-50 transition-colors">
            <label class="flex items-center flex-grow cursor-pointer gap-3">
                <input type="checkbox" class="w-6 h-6 text-blue-600 rounded focus:ring-blue-500 checkbox-equipe" 
                    value="${colab.matricula}" data-nome="${colab.nome}" ${checked}>
                <div class="flex flex-col">
                    <span class="font-bold text-gray-800 text-sm">${colab.nome}</span>
                    <span class="text-xs text-gray-500">Mat: ${colab.matricula}</span>
                </div>
            </label>
            <button onclick="removerColaboradorDoBanco('${colab.docId}', '${colab.nome}')" class="text-gray-300 hover:text-red-500 p-2 text-lg" title="Apagar do Banco">üóëÔ∏è</button>
        </div>`;
    }).join('');

    // --- CONTE√öDO CORRIGIDO COM ALTURA FIXA ---
    const conteudo = `
        <div class="space-y-3 mb-4">
            <button onclick="abrirPopupNovoColaborador()" class="w-full bg-green-600 hover:bg-green-700 text-white py-3 rounded-md font-bold text-sm shadow-sm flex items-center justify-center gap-2">
                <span>+</span> Novo Colaborador
            </button>
            <input type="text" id="filtroEquipe" oninput="filtrarListaEquipe()" placeholder="üîé Buscar nome..." class="w-full p-2 border rounded text-sm bg-gray-50">
        </div>

        <div id="listaCheckboxesEquipe" class="max-h-80 overflow-y-auto border border-gray-200 rounded p-2 space-y-1">
            ${listaHTML || '<p class="text-center text-gray-500 text-sm py-4">Nenhum colaborador cadastrado.</p>'}
        </div>
    `;

    abrirPopup('Gerir Equipe do Turno', conteudo, [
        { texto: 'Cancelar', classe: 'bg-gray-300 text-gray-800 hover:bg-gray-400 py-3 rounded-lg font-bold', acao: fecharPopup },
        { texto: 'Confirmar Sele√ß√£o', classe: 'bg-blue-600 text-white hover:bg-blue-700 py-3 rounded-lg font-bold shadow-lg', acao: confirmarSelecaoEquipe }
    ]);
}


// Filtro r√°pido no popup
function filtrarListaEquipe() {
    const termo = removerAcentos(document.getElementById('filtroEquipe').value.toLowerCase());
    const container = document.getElementById('listaCheckboxesEquipe');
    const items = container.querySelectorAll('div'); // Pega as divs das linhas

    items.forEach(div => {
        const nome = removerAcentos(div.querySelector('span.font-bold').innerText.toLowerCase());
        const mat = div.querySelector('span.text-xs').innerText.toLowerCase();
        
        if (nome.includes(termo) || mat.includes(termo)) {
            div.style.display = 'flex';
        } else {
            div.style.display = 'none';
        }
    });
}


// ============================================================
// CORRE√á√ÉO: MODAL DE NOVO COLABORADOR (COM Z-INDEX ALTO)
// ============================================================

// Fun√ß√£o auxiliar para fechar este modal e RESTAURAR o anterior
function fecharModalNovoColaborador(modalId) {
    const modal = document.getElementById(modalId);
    if (modal) modal.remove();
    
    // 3. REABRE O POPUP E A SOMBRA ANTERIORES
    document.getElementById('popupGenerico').style.display = 'block';
    document.getElementById('overlayGenerico').style.display = 'block';
}

function abrirPopupNovoColaborador() {
    // 1. ESCONDE O POPUP ANTERIOR COMPLETO (Conte√∫do + Sombra)
    document.getElementById('popupGenerico').style.display = 'none';
    document.getElementById('overlayGenerico').style.display = 'none'; // CRUCIAL para evitar conflitos de Z-Index/sombra

    const htmlForm = `
        <div class="space-y-4">
            <div>
                <label class="block text-sm font-bold text-gray-700 mb-1">Nome Completo *</label>
                <input type="text" id="newColabNome" 
                    class="w-full p-3 border border-gray-300 rounded-lg bg-gray-50 focus:ring-2 focus:ring-blue-500 focus:bg-white outline-none uppercase font-semibold text-gray-800 transition-colors" 
                    placeholder="DIGITE O NOME">
            </div>
            <div>
                <label class="block text-sm font-bold text-gray-700 mb-1">Matr√≠cula *</label>
                <input type="text" id="newColabMat" 
                    class="w-full p-3 border border-gray-300 rounded-lg bg-gray-50 focus:ring-2 focus:ring-blue-500 focus:bg-white outline-none font-semibold text-gray-800 transition-colors" 
                    placeholder="00000">
            </div>
        </div>
    `;

    const modalId = 'modal-novo-colab';
    
    // 2. CRIA O NOVO MODAL COM Z-INDEX MUITO ALTO (FOR√áADO)
    const modalHTML = `
    <div id="${modalId}" style="z-index: 99999;" class="fixed inset-0 bg-black bg-opacity-60 backdrop-blur-sm flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl p-5 w-full max-w-sm border border-gray-100 transform transition-all scale-100 relative">
            
            <div class="flex justify-between items-center mb-5 border-b pb-3">
                <h3 class="text-lg font-bold text-blue-800 flex items-center gap-2">
                    <span>üë§</span> Novo Colaborador
                </h3>
                <button onclick="fecharModalNovoColaborador('${modalId}')" class="text-gray-400 hover:text-red-500 text-3xl leading-none">&times;</button>
            </div>

            ${htmlForm}

            <div class="flex justify-end gap-3 mt-6">
                <button onclick="fecharModalNovoColaborador('${modalId}')" 
                    class="px-4 py-2.5 bg-gray-100 text-gray-700 rounded-lg font-bold hover:bg-gray-200 transition-colors border border-gray-300">
                    Voltar
                </button>
                <button onclick="salvarNovoColaborador()" 
                    class="px-4 py-2.5 bg-green-600 text-white rounded-lg font-bold hover:bg-green-700 shadow-md transition-transform active:scale-95 flex items-center gap-2">
                    <span>üíæ</span> Salvar
                </button>
            </div>
        </div>
    </div>`;
    
    document.body.insertAdjacentHTML('beforeend', modalHTML);
    
    setTimeout(() => document.getElementById('newColabNome').focus(), 100);
}


async function salvarNovoColaborador() {
    const nome = document.getElementById('newColabNome').value.trim().toUpperCase();
    const matricula = document.getElementById('newColabMat').value.trim();

    // 1. Valida√ß√£o
    if (!nome || !matricula) {
        showToast("Preencha nome e matr√≠cula.", "error");
        return;
    }

    // 2. Trava de Duplicidade
    const jaExiste = listaEquipeCache.some(colab => colab.matricula === matricula);
    if (jaExiste) {
        const dono = listaEquipeCache.find(c => c.matricula === matricula).nome;
        showToast(`Erro: Matr√≠cula j√° usada por ${dono}.`, "error");
        document.getElementById('newColabMat').focus();
        return;
    }

    // 3. Salvar e Atualizar
    try {
        // Adiciona ao banco
        await firestore.collection('lista_equipe').add({ nome, matricula });
        
        // Remove o modal de cadastro da tela
        const modal = document.getElementById('modal-novo-colab');
        if (modal) modal.remove();
        
        showToast("Colaborador cadastrado!", "success");
        
        // --- A CORRE√á√ÉO EST√Å AQUI ---
        // Em vez de apenas mostrar o popup antigo (que estaria desatualizado),
        // chamamos a fun√ß√£o principal novamente para gerar o HTML novo com o membro novo.
        setTimeout(() => {
            // Garante que o overlay de fundo esteja vis√≠vel
            document.getElementById('overlayGenerico').style.display = 'block';
            // Reconstr√≥i a lista
            abrirPopupSelecaoEquipe(); 
        }, 200); // Pequeno delay para garantir que o dado local foi atualizado

    } catch (e) {
        showToast("Erro ao salvar: " + e.message, "error");
    }
}

function removerColaboradorDoBanco(docId, nome) {
    if(confirm(`Tem certeza que deseja apagar ${nome} do BANCO DE DADOS? Isso sumir√° para todos.`)) {
        firestore.collection('lista_equipe').doc(docId).delete();
        // Atualiza a lista visualmente
        setTimeout(abrirPopupSelecaoEquipe, 500);
    }
}

// 4. CONFIRMAR SELE√á√ÉO (ATUALIZA O TURNO)
function confirmarSelecaoEquipe() {
    const checkboxes = document.querySelectorAll('.checkbox-equipe:checked');
    
    // Limpa a equipe atual e reconstr√≥i baseada na sele√ß√£o
    equipe = [];
    
    checkboxes.forEach(cb => {
        equipe.push({
            nome: cb.getAttribute('data-nome'),
            matricula: cb.value
        });
    });

    renderizarEquipe(); // Atualiza a tela principal
    salvarTudo(); // Salva no turno
    fecharPopup();
    showToast("Equipe do turno atualizada!", "success");
}


        // ---------------------------------
        // M√ìDULO: CAT√ÅLOGO DE FROTAS (ONLINE)
        // ---------------------------------
        function renderizarSecaoFrotas(container) { 
    container.innerHTML = `
    <div class="bg-white p-5 rounded-xl border border-gray-200 shadow-sm">
        <div class="flex items-center gap-3 pb-4 border-b border-gray-100 mb-4">
            <div class="w-10 h-10 rounded-full bg-yellow-50 text-yellow-600 flex items-center justify-center shadow-sm">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path d="M9 17a2 2 0 11-4 0 2 2 0 014 0zM19 17a2 2 0 11-4 0 2 2 0 014 0z" />
                    <path stroke-linecap="round" stroke-linejoin="round" d="M13 16V6a1 1 0 00-1-1H4a1 1 0 00-1 1v10a1 1 0 001 1h1m8-1a1 1 0 01-1 1H9m4-1V8a1 1 0 011-1h2.586a1 1 0 01.707.293l3.414 3.414a1 1 0 01.293.707V16a1 1 0 01-1 1h-1m-6-1a1 1 0 001 1h1M5 17a2 2 0 104 0m-4 0a2 2 0 114 0m6 0a2 2 0 104 0m-4 0a2 2 0 114 0" />
                </svg>
            </div>
            <h2 class="text-lg font-bold text-gray-800">Cat√°logo de Frotas</h2>
        </div>

        <div class="relative">
            <input type="text" id="buscaFrota" oninput="renderizarCatalogoFrotas()" 
                placeholder="Buscar por c√≥digo..." 
                class="w-full pl-10 p-3 border border-gray-300 rounded-lg mb-4 focus:ring-2 focus:ring-yellow-500 outline-none bg-gray-50 text-sm">
            <div class="absolute left-3 top-3.5 text-gray-400">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg>
            </div>
        </div>
            
        <div id="listaCatalogoFrotas" class="space-y-2 max-h-[60vh] overflow-y-auto custom-scrollbar"></div>
    </div>`; 
    renderizarCatalogoFrotas(); 
}

        // MODIFICADO: Aplica 'removerAcentos' na busca
        function renderizarCatalogoFrotas() {
            const listaDiv = document.getElementById('listaCatalogoFrotas');
            if (!listaDiv) return;

            // MODIFICADO: Aplica removerAcentos na busca
            const termoBusca = removerAcentos(document.getElementById('buscaFrota').value.toLowerCase());

            const frotasFiltradas = catalogoFrotas.filter(f => removerAcentos(f.nome.toLowerCase()).includes(termoBusca)); 
            
            if (frotasFiltradas.length === 0) { listaDiv.innerHTML = `<p class="text-center text-gray-500 py-4">Nenhuma frota encontrada no cat√°logo.</p>`; return; } frotasFiltradas.sort((a, b) => a.nome.localeCompare(b.nome)); listaDiv.innerHTML = frotasFiltradas.map(f => `<div class="border rounded-lg p-3 flex justify-between items-center"><div><p class="font-bold text-gray-800">${f.nome}</p><p class="text-sm font-semibold ${getTipoCor(f.tipo)}">${getTipoTexto(f.tipo)}</p></div><button onclick="removerFrotaCatalogo('${f.docId}')" class="p-2 text-red-600 hover:bg-red-100 rounded-full" title="Excluir do Cat√°logo">üóëÔ∏è</button></div>`).join('');
        }
        function abrirPopupTipoFrota(contexto = 'catalogo') {
            const conteudo = `<p class="mb-4">Selecione o tipo de frota para adicionar:</p>
        <div class="grid grid-cols-1 gap-3">
            <button onclick="abrirPopupAdicionarFrotaCatalogo('maquina', '${contexto}')" class="w-full text-left p-3 bg-blue-100 hover:bg-blue-200 rounded-md"><strong>M√°quina Principal</strong><p class="text-xs">Ex: Tratores...</p></button>
            <button onclick="abrirPopupAdicionarFrotaCatalogo('implemento', '${contexto}')" class="w-full text-left p-3 bg-gray-100 hover:bg-gray-200 rounded-md"><strong>Implemento</strong><p class="text-xs">Ex: Subsoladores...</p></button>
            <button onclick="abrirPopupAdicionarFrotaCatalogo('caminhao', '${contexto}')" class="w-full text-left p-3 bg-green-100 hover:bg-green-200 rounded-md"><strong>Caminh√£o</strong><p class="text-xs">Ex: Caminh√µes de apoio...</p></button>
        </div>`;
            abrirPopup('Adicionar Nova Frota', `<div>${conteudo}</div>`);
        }
        function abrirPopupAdicionarFrotaCatalogo(tipo, contexto = 'catalogo') {
            fecharPopup();
            abrirPopupInput(
                `Adicionar ${getTipoTexto(tipo)}`,
                'Digite o c√≥digo da frota:',
                'Ex: JD6115J',
                '',
                (nome) => {
                    if (nome) {
                        // Se o contexto for 'servico', chama a nova fun√ß√£o de cadastro r√°pido.
                        // Caso contr√°rio, usa a fun√ß√£o antiga que apenas salva no cat√°logo.
                        if (contexto === 'servico') {
                            salvarEAdicionarFrotaAoTurno(nome.trim().toUpperCase(), tipo);
                        } else {
                            salvarFrotaCatalogo(nome.trim().toUpperCase(), tipo);
                        }
                    }
                }
            );
        }
        async function salvarFrotaCatalogo(nome, tipo) { if (!nome) { showToast('O c√≥digo da frota n√£o pode ser vazio.', 'error'); return; } if (catalogoFrotas.some(f => f.nome === nome)) { showToast('Esta frota j√° existe no cat√°logo.', 'error'); return; } const novaFrota = { nome, tipo }; try { await firestore.collection('catalogoFrotas').add(novaFrota); showToast('Frota adicionada ao cat√°logo!', 'success'); } catch (error) { showToast('Erro ao salvar a frota.', 'error'); } }
        async function removerFrotaCatalogo(docId) { const confirmado = await new Promise(resolve => abrirPopupConfirmar('Excluir do Cat√°logo', `Deseja remover esta frota permanentemente do cat√°logo?`, resolve)); if (confirmado) { try { await firestore.collection('catalogoFrotas').doc(docId).delete(); showToast('Frota removida do cat√°logo.', 'success'); } catch (error) { showToast('Erro ao remover a frota.', 'error'); } } }
        // MODIFICADO: Adiciona campo de busca e renderiza o cat√°logo ordenado
// MODIFICADO: Inclui bot√£o "Cancelar" expl√≠cito na lista de bot√µes
function abrirPopupSelecaoFrota() {
sincronizarCatalogoFrotas(); 
    if (catalogoFrotas.length === 0) { 
        showToast("Carregando cat√°logo de frotas... Aguarde um momento.", 'info', 4000); 
        return; 
    } 
    
    // Filtra as frotas que J√Å est√£o no turno
    const frotasDisponiveis = catalogoFrotas.filter(cf => !frotasTurno.some(ft => ft.nome === cf.nome)); 
    
    if (frotasDisponiveis.length === 0) { 
        showToast("Todas as frotas do cat√°logo j√° est√£o no turno.", 'info'); 
        return; 
    } 
    
    // Adiciona campo de busca e cont√™iner para a lista
    let conteudo = `<input type="text" id="filtroSelecaoFrota" 
                        class="w-full p-2 border border-gray-300 rounded-md mb-3" 
                        placeholder="üîé Digite para buscar frota..." 
                        oninput="renderizarListaFrotasDisponiveis()">
                    <div id="listaFrotasDisponiveis" class="max-h-64 overflow-y-auto space-y-2"></div>`; 
    
    // NOVO: Define a lista de bot√µes no rodap√©
    const botoes = [
        { 
            texto: 'Cancelar', 
            classe: 'bg-gray-300 text-gray-800 hover:bg-gray-400', 
            acao: fecharPopup // A√ß√£o: apenas fechar o pop-up
        },
        { 
            texto: 'Adicionar Selecionadas', 
            classe: 'bg-blue-600 text-white hover:bg-blue-700', 
            acao: () => adicionarFrotasSelecionadasAoTurno() 
        }
    ]; 
    
    abrirPopup('Selecionar Frotas', `<div id="popup-content-wrapper">${conteudo}</div>`, botoes); 
    
    // Chama a renderiza√ß√£o inicial ap√≥s o pop-up abrir
    renderizarListaFrotasDisponiveis(frotasDisponiveis);
}

// NOVO: Fun√ß√£o para filtrar e renderizar as op√ß√µes de frota no pop-up de sele√ß√£o
function renderizarListaFrotasDisponiveis(frotasIniciais = null) {
    const listaDiv = document.getElementById('listaFrotasDisponiveis');
    if (!listaDiv) return;

    // 1. Obt√©m as frotas a serem processadas (ou as frotas dispon√≠veis se for a 1¬™ chamada)
    const frotasDisponiveis = frotasIniciais || catalogoFrotas.filter(cf => !frotasTurno.some(ft => ft.nome === cf.nome));

    // 2. Aplica o filtro de busca
    const termoBusca = document.getElementById('filtroSelecaoFrota')?.value;
    const frotasFiltradas = frotasDisponiveis.filter(f => {
        if (!termoBusca) return true;
        // Usa removerAcentos para uma busca mais flex√≠vel
        const termoNormalizado = removerAcentos(termoBusca).toLowerCase();
        const nomeNormalizado = removerAcentos(f.nome).toLowerCase();
        return nomeNormalizado.includes(termoNormalizado);
    });

    // 3. Aplica a ordena√ß√£o crescente (alfab√©tica/numeral)
    frotasFiltradas.sort((a, b) => a.nome.localeCompare(b.nome));

    if (frotasFiltradas.length === 0) {
        listaDiv.innerHTML = `<p class="text-center text-gray-500 py-4">Nenhuma frota encontrada com o filtro atual.</p>`;
        return;
    }
    
    // 4. Gera o HTML
    let listaHTML = frotasFiltradas.map(f => `
        <label class="flex items-center p-2 border rounded-md hover:bg-gray-100">
            <input type="checkbox" name="frota-selecao" value="${f.nome}" 
                   data-tipo="${f.tipo}" 
                   class="h-5 w-5 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
            <span class="ml-3 font-semibold">${f.nome}</span>
            <span class="ml-auto text-xs font-semibold ${getTipoCor(f.tipo)}">${getTipoTexto(f.tipo)}</span>
        </label>
    `).join('');
    
    listaDiv.innerHTML = listaHTML;
}
        // MODIFICADO: L√™ o tipo de frota do atributo do checkbox
// CORRIGIDO: Simplifica a l√≥gica de busca do tipo de frota e garante que s√≥ adicione frotas existentes no cat√°logo.
function adicionarFrotasSelecionadasAoTurno() { 
    const checkboxes = document.querySelectorAll('input[name="frota-selecao"]:checked'); 
    if (checkboxes.length === 0) { 
        showToast('Nenhuma frota selecionada.', 'info'); 
        return; 
    } 
    
    checkboxes.forEach(cb => { 
        const frotaDoCatalogo = catalogoFrotas.find(f => f.nome === cb.value);

        // Apenas adiciona se o item existir no cat√°logo global de frotas.
        if (frotaDoCatalogo) { 
            frotasTurno.push({ 
                nome: frotaDoCatalogo.nome, 
                tipo: frotaDoCatalogo.tipo, // Usa o tipo garantido do objeto do cat√°logo
                horas: 7.2 
            }); 
        } 
    }); 
    
    renderizarFrotasDoTurno(); 
    salvarTudo(); 
    showToast(`${checkboxes.length} frota(s) adicionada(s) ao turno.`, 'success'); 
}

        // ADICIONE ESTA NOVA FUN√á√ÉO
        /**
         * Inicia o fluxo de cadastro r√°pido a partir do FAB de servi√ßos.
         * Apenas chama o popup de sele√ß√£o de tipo, passando um contexto diferente.
         */
        function iniciarCadastroRapidoFrota() {
            abrirPopupTipoFrota('servico');
        }

        // ADICIONE ESTA NOVA FUN√á√ÉO
        /**
         * Fun√ß√£o central para o cadastro r√°pido:
         * 1. Verifica se a frota j√° existe no cat√°logo.
         * 2. Se n√£o, salva no Firebase.
         * 3. Adiciona a frota (nova ou existente) ao turno atual.
         * 4. Atualiza a interface.
         */
        async function salvarEAdicionarFrotaAoTurno(nome, tipo) {
            // 1. Verifica se a frota j√° existe no cat√°logo online
            if (catalogoFrotas.some(f => f.nome === nome)) {
                // Se j√° existe, apenas a adiciona ao turno atual
                if (!frotasTurno.some(ft => ft.nome === nome)) {
                    frotasTurno.push({ nome, tipo, horas: 7.2 });
                    salvarTudo(true);
                    showToast(`Frota ${nome} adicionada ao turno!`, 'success');
                    // Se a tela de servi√ßos estiver aberta, atualiza as listas de frotas nos cart√µes
                    if (document.getElementById('servicosLista')) {
                        renderizarServicos();
                    }
                } else {
                    showToast(`Frota ${nome} j√° est√° no turno atual.`, 'info');
                }
                return; // Termina a execu√ß√£o aqui
            }

            // 2. Se a frota √© nova, salva primeiro no cat√°logo do Firebase
            const novaFrota = { nome, tipo };
            try {
                await firestore.collection('catalogoFrotas').add(novaFrota);
                // A sincroniza√ß√£o autom√°tica do Firebase ir√° adicionar ao `catalogoFrotas` local.

                // 3. Em seguida, adiciona ao turno atual
                if (!frotasTurno.some(ft => ft.nome === nome)) {
                    frotasTurno.push({ nome, tipo, horas: 8.0 });
                    salvarTudo(true);
                    showToast(`Frota ${nome} cadastrada e adicionada ao turno!`, 'success');
                    if (document.getElementById('servicosLista')) {
                        renderizarServicos();
                    }
                }
            } catch (error) {
                showToast('Erro ao salvar a nova frota.', 'error');
                console.error("Erro ao salvar frota r√°pida:", error);
            }
        }

        // ---------------------------------
        // M√ìDULO: SERVI√áOS
        // ---------------------------------
        function renderizarSecaoServicos(container) { container.innerHTML = `<div class="bg-white p-4 rounded-lg shadow mb-4"><h4 class="text-lg font-semibold text-blue-700 mb-3 border-b pb-2">Filtrar Servi√ßos</h4><div class="grid grid-cols-1 md:grid-cols-2 gap-4"><input type="text" id="filtroServicoFrota" class="w-full p-2 border border-gray-300 rounded-md" placeholder="Filtrar por Frota..." oninput="renderizarServicos()"><input type="text" id="filtroServicoDescricao" class="w-full p-2 border border-gray-300 rounded-md" placeholder="Filtrar por Descri√ß√£o..." oninput="renderizarServicos()"></div></div><div id="servicosLista" class="space-y-4"></div>`; renderizarServicos(); }
        function renderizarServicos() { const lista = document.getElementById("servicosLista"); if (!lista) return; const filtroFrota = document.getElementById('filtroServicoFrota')?.value.toLowerCase() || ""; const filtroDescricao = document.getElementById('filtroServicoDescricao')?.value.toLowerCase() || ""; const servicosFiltrados = servicos.filter(s => (!filtroFrota || s.frota.toLowerCase().includes(filtroFrota)) && (!filtroDescricao || s.descricao.toLowerCase().includes(filtroDescricao))); servicosFiltrados.sort((a, b) => (a.data + a.inicio).localeCompare(b.data + b.inicio)); lista.innerHTML = ''; if (servicosFiltrados.length === 0) { lista.innerHTML = `<p class='text-center text-gray-500 p-4'>Nenhum servi√ßo encontrado.</p>`; } else { servicosFiltrados.forEach(s => { const template = document.getElementById('servico-template').content.cloneNode(true); const article = template.querySelector('article'); article.id = `servico_${s.id}`; lista.appendChild(article); preencherDetalhesServico(s); }); } }
        
        function preencherDetalhesServico(s) {
    const article = document.getElementById(`servico_${s.id}`);
    if (!article) return;
    
    // --- MUDAN√áA AQUI: border-l-
    article.className = "bg-white rounded-xl shadow-sm mb-4 border-t border-r border-b border-gray-200 transition-all hover:shadow-md border-l-4";
    
    const cabecalho = article.querySelector('.servico-cabecalho');
    const osNaoGerada = !s.texto;
    
    cabecalho.classList.remove('bg-gray-50', 'bg-yellow-50', 'bg-green-50');
    
    if (s.foiCompartilhado) {
        article.classList.add('border-green-500');
        cabecalho.classList.add('bg-green-50');
    } else if (osNaoGerada) {
        // Lembre-se: Usamos yellow-400 para o visual laranja/√¢mbar
        article.classList.add('border-yellow-400');
        cabecalho.classList.add('bg-yellow-50');
    } else {
        article.classList.add('border-blue-500');
        cabecalho.classList.add('bg-gray-50');
    }
    
    // ... (O resto da fun√ß√£o continua IGUAL, n√£o precisa alterar nada abaixo) ...
    
    // Para facilitar, vou manter apenas o in√≠cio atualizado acima.
    // Voc√™ pode copiar o resto da fun√ß√£o do seu c√≥digo anterior ou,
    // se preferir, posso colar a fun√ß√£o inteira novamente.
    
    // --- C√ìDIGO ABAIXO MANTIDO (C√≥pia da vers√£o anterior) ---
    const cabecalhoInfo = article.querySelector('.servico-cabecalho-info');
    const toggler = article.querySelector('.servico-cabecalho-toggler');
    const detalhes = article.querySelector('.servico-detalhes');
    const cabecalhoHTML = gerarTextoCabecalhoServico(s);
    
    if (cabecalhoInfo.innerHTML !== cabecalhoHTML) { cabecalhoInfo.innerHTML = cabecalhoHTML; }
    
    toggler.innerHTML = s.isExpanded ? '&#9650;' : '&#9660;';
    article.querySelector('.servico-cabecalho').onclick = () => toggleDetalhesServico(s.id);
    detalhes.style.display = s.isExpanded ? 'block' : 'none';
    
    if (!s.isExpanded) return;
    
    let listaPecasHTML = '';
    if (s.pecasUtilizadas && s.pecasUtilizadas.length > 0) {
        listaPecasHTML = s.pecasUtilizadas.map((p, i) => `
            <div class="flex justify-between items-center p-2 bg-gray-50 rounded-lg text-sm border border-gray-200 mb-1">
                <span class="truncate flex-1">
                    <strong class="text-blue-700">${p.quantidade || '1'}x</strong> ${p.descricao}
                    <span class="text-xs text-gray-500 ml-1 block sm:inline">SAP: ${p.codigoSap || 'N/D'}</span>
                </span>
                <button onclick="removerPecaUtilizada(${s.id}, ${i})" class="text-red-400 hover:text-red-600 p-1 ml-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                </button>
            </div>
        `).join('');
    } else {
        listaPecasHTML = '<p class="text-xs text-gray-400 italic p-2 text-center border border-dashed border-gray-200 rounded-lg">Nenhuma pe√ßa adicionada.</p>';
    }
    
    const subsistemasAtuais = subsistemas[s.sistema] || [];
    const frotaOptions = '<option value="">Selecione</option>' + frotasTurno.map(f => `<option value="${f.nome}" ${s.frota === f.nome ? 'selected' : ''}>${f.nome}</option>`).join('');
    const atividadeOptions = '<option value="">Selecione</option>' + atividades.map(a => `<option value="${a}" ${s.atividade === a ? 'selected' : ''}>${a}</option>`).join('');
    const sistemaOptions = '<option value="">Selecione</option>' + Object.entries(sistemas).map(([g, lst]) => `<optgroup label="${g}">${lst.map(sys => `<option value="${sys.cod}" ${s.sistema === sys.cod ? 'selected' : ''}>${sys.cod} - ${sys.nome}</option>`).join('')}</optgroup>`).join('');
    const subsistemaOptions = '<option value="">Selecione</option>' + subsistemasAtuais.map(sub => `<option value="${sub}" ${s.subsistema === sub ? 'selected' : ''}>${sub}</option>`).join('');
    
    const inputClass = "mt-1 w-full p-2.5 bg-white border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 outline-none transition-shadow";
    const labelClass = "block text-[10px] font-bold text-gray-500 uppercase mb-1";
    
    detalhes.innerHTML = `
    <div class="space-y-5">
        <div class="bg-gray-50 p-3 rounded-lg border border-gray-200">
            <h5 class="text-sm font-bold text-gray-700 border-b border-gray-200 pb-2 mb-3 flex items-center gap-2">
                <span>üìå</span> Identifica√ß√£o
            </h5>
            <div class="grid grid-cols-2 gap-3">
                <div class="col-span-1"><label class="${labelClass}">Frota*</label><select data-id="${s.id}" data-field="frota" class="${inputClass}">${frotaOptions}</select></div>
                <div class="col-span-1"><label class="${labelClass}">Atividade*</label><select data-id="${s.id}" data-field="atividade" class="${inputClass}">${atividadeOptions}</select></div>
                <div class="col-span-1"><label class="${labelClass}">Sistema*</label><select data-id="${s.id}" data-field="sistema" class="${inputClass}">${sistemaOptions}</select></div>
                <div class="col-span-1"><label class="${labelClass}">Subsistema*</label><select data-id="${s.id}" data-field="subsistema" class="${inputClass}">${subsistemaOptions}</select></div>
            </div>
        </div>
        <div><h5 class="text-sm font-bold text-gray-700 border-b border-gray-200 pb-2 mb-3 flex items-center gap-2"><span>‚öôÔ∏è</span> Pe√ßas Utilizadas</h5><div id="lista-pecas-servico-${s.id}" class="space-y-2 mb-3">${listaPecasHTML}</div><button onclick="abrirPopupSelecaoPecas(${s.id})" class="w-full py-2.5 px-4 rounded-lg font-bold bg-indigo-50 text-indigo-700 border border-indigo-100 hover:bg-indigo-100 text-xs flex items-center justify-center gap-2 transition-colors"><span>+</span> Adicionar Pe√ßa do Cat√°logo</button></div>
        <div class="bg-gray-50 p-3 rounded-lg border border-gray-200"><h5 class="text-sm font-bold text-gray-700 border-b border-gray-200 pb-2 mb-3 flex items-center gap-2"><span>‚è±Ô∏è</span> Opera√ß√£o</h5><div class="grid grid-cols-2 gap-3"><div><label class="${labelClass}">M√°quina parada?*</label><select data-id="${s.id}" data-field="parada" class="${inputClass}"><option value="sim" ${s.parada === "sim" ? 'selected' : ''}>Sim</option><option value="n√£o" ${s.parada === "n√£o" ? 'selected' : ''}>N√£o</option></select></div><div><label class="${labelClass}">Falha operacional?*</label><select data-id="${s.id}" data-field="falha" class="${inputClass}"><option value="n√£o" ${s.falha === "n√£o" ? 'selected' : ''}>N√£o</option><option value="sim" ${s.falha === "sim" ? 'selected' : ''}>Sim</option></select></div><div class="col-span-2"><label class="${labelClass}">Tipo de manuten√ß√£o*</label><select data-id="${s.id}" data-field="tipo" class="${inputClass}"><option value="CORRETIVA" ${s.tipo === "CORRETIVA" ? 'selected' : ''}>Corretiva</option><option value="CONDICIONAL" ${s.tipo === "CONDICIONAL" ? 'selected' : ''}>Condicional</option><option value="MELHORIA" ${s.tipo === "MELHORIA" ? 'selected' : ''}>Melhoria</option></select></div><div><label class="${labelClass}">In√≠cio (Data)</label><input type="date" data-id="${s.id}" id="data-${s.id}" data-field="data" value="${s.data}" class="${inputClass}"></div><div><label class="${labelClass}">In√≠cio (Hora)</label><input type="time" data-id="${s.id}" id="inicio-${s.id}" data-field="inicio" value="${s.inicio}" class="${inputClass}"></div><div><label class="${labelClass}">Fim (Data)</label><input type="date" data-id="${s.id}" id="dataFinal-${s.id}" data-field="dataFinal" value="${s.dataFinal}" class="${inputClass}"></div><div><label class="${labelClass}">Fim (Hora)</label><input type="time" data-id="${s.id}" id="fim-${s.id}" data-field="fim" value="${s.fim}" class="${inputClass}"></div></div></div>
        <div><h5 class="text-sm font-bold text-gray-700 border-b border-gray-200 pb-2 mb-2">Descri√ß√£o Detalhada*</h5><textarea data-id="${s.id}" data-field="descricao" class="w-full p-3 border border-gray-300 rounded-lg h-28 text-sm focus:ring-2 focus:ring-blue-500 outline-none" placeholder="Descreva o problema e a solu√ß√£o...">${s.descricao}</textarea></div>
        <div><div class="flex flex-col space-y-2"><button onclick="processarOS(${s.id})" class="w-full py-3 px-4 rounded-xl font-bold text-white shadow-md transition-transform active:scale-95 ${osNaoGerada ? 'bg-blue-600 hover:bg-blue-700' : 'bg-indigo-600 hover:bg-indigo-700'}">${osNaoGerada ? "‚ú® Gerar O.S." : "üîÑ Regerar O.S."}</button>${osNaoGerada ? `<button onclick="removerServico(${s.id})" class="w-full py-3 px-4 rounded-xl font-bold bg-red-50 text-red-600 border border-red-100 hover:bg-red-100 transition-colors">Excluir Rascunho</button>` : ''}</div><div id="preview_container_${s.id}" class="${osNaoGerada ? 'hidden' : ''} mt-4 border-t border-dashed border-gray-300 pt-4"><div class="p-3 bg-gray-50 border border-gray-200 rounded-lg whitespace-pre-line text-sm text-gray-800 font-mono shadow-inner mb-3">${interpretarMarkdown(s.texto || "")}</div><div class="grid grid-cols-2 sm:grid-cols-4 gap-2"><button onclick="copiarTexto(${s.id}, this)" class="py-2 px-2 rounded-lg font-bold bg-white border border-gray-300 text-gray-700 hover:bg-gray-50 text-xs shadow-sm">Copiar</button><button onclick="compartilharWhatsApp(${s.id})" class="py-2 px-2 rounded-lg font-bold bg-green-500 text-white hover:bg-green-600 text-xs shadow-sm">WhatsApp</button><button onclick="adicionarServicoDepois(${s.id})" class="py-2 px-2 rounded-lg font-bold bg-blue-500 text-white hover:bg-blue-600 text-xs shadow-sm">Duplicar</button><button onclick="removerServico(${s.id})" class="py-2 px-2 rounded-lg font-bold bg-red-50 text-red-600 border border-red-200 hover:bg-red-100 text-xs shadow-sm">Excluir</button></div></div></div>
    </div>`;
    
    const inputFim = detalhes.querySelector(`#fim-${s.id}`);
    const inputDataFinal = detalhes.querySelector(`#dataFinal-${s.id}`);
    const servicoValidado = servicos.find(item => item.id === s.id);
    if (inputFim && inputDataFinal) {
        if (!validarTempoServico(servicoValidado)) {
            inputFim.classList.add('campo-invalido');
            inputDataFinal.classList.add('campo-invalido');
        } else {
            inputFim.classList.remove('campo-invalido');
            inputDataFinal.classList.remove('campo-invalido');
        }
    }
    detalhes.querySelectorAll('input, select, textarea').forEach(el => { el.addEventListener('change', handleServicoInputChange);
        el.addEventListener('input', handleServicoInputChange); });
}
        
        // MODIFICADO: Lida com a entrada de dados do servi√ßo E aplica valida√ß√£o de tempo
        function handleServicoInputChange(event) { 
            const el = event.target; 
            const id = parseInt(el.dataset.id); 
            const field = el.dataset.field; 
            const servico = servicos.find(s => s.id === id); 
            if (!servico) return; 
            
            servico[field] = el.value; 
            el.classList.remove('campo-invalido'); 
            
            if (field === 'sistema') { 
                servico.subsistema = ""; 
                renderizarServicos(); 
            } 
            
            // NOVO BLOCO: Valida√ß√£o Imediata do Tempo
            if (['data', 'inicio', 'dataFinal', 'fim'].includes(field)) {
                const isValid = validarTempoServico(servico);
                const inputFim = document.getElementById(`fim-${servico.id}`);
                const inputDataFinal = document.getElementById(`dataFinal-${servico.id}`);
                
                if (inputFim && inputDataFinal) {
                    if (!isValid) {
                        inputFim.classList.add('campo-invalido');
                        inputDataFinal.classList.add('campo-invalido');
                    } else {
                        inputFim.classList.remove('campo-invalido');
                        inputDataFinal.classList.remove('campo-invalido');
                    }
                }
            }
            
            const camposQueAtualizamCabecalho = ['frota', 'atividade', 'sistema', 'subsistema', 'inicio', 'fim']; 
            if (camposQueAtualizamCabecalho.includes(field)) { 
                const cabecalhoInfo = document.querySelector(`#servico_${id} .servico-cabecalho-info`); 
                if (cabecalhoInfo) { 
                    cabecalhoInfo.innerHTML = gerarTextoCabecalhoServico(servico); 
                } 
            } 
            
            salvarTudo(); 
        }
        function adicionarServico(dadosPreenchidos = null) { 
            if (!validarCamposTurnoBasicos()) return; 
            const id = Date.now(); 
            const novoServico = dadosPreenchidos || { 
                id, 
                frota: "", 
                atividade: "", 
                sistema: "", 
                subsistema: "", 
                descricao: "", 
                tipo: "CORRETIVA", 
                parada: "sim", 
                falha: "n√£o", 
                data: document.getElementById('dataTurno')?.value || dataHojeInputLocal(), 
                inicio: "", 
                dataFinal: document.getElementById('dataTurno')?.value || dataHojeInputLocal(), 
                fim: "", 
                texto: "", 
                oportunidade: "", 
                isExpanded: true, 
                foiCompartilhado: false,
                pecasUtilizadas: [] // NOVO: Inicializa o array de pe√ßas
            }; 
            servicos.push(novoServico); 
            renderizarServicos(); 
            salvarTudo(); 
            showToast("Novo servi√ßo adicionado.", 'success'); 
            setTimeout(() => document.getElementById(`servico_${id}`)?.scrollIntoView({ behavior: 'smooth', block: 'center' }), 100); 
        }
        async function removerServico(id) { const confirmado = await new Promise(resolve => abrirPopupConfirmar('Excluir Servi√ßo', 'Tem certeza?', resolve)); if (confirmado) { const index = servicos.findIndex(s => s.id === id); if (index > -1) { servicos.splice(index, 1); renderizarServicos(); salvarTudo(); showToast("Servi√ßo removido.", 'success'); } } }
        function toggleDetalhesServico(id) { const servico = servicos.find(s => s.id === id); if (!servico) return; servico.isExpanded = !servico.isExpanded; const article = document.getElementById(`servico_${id}`); if (!article) return; const detalhes = article.querySelector('.servico-detalhes'); const toggler = article.querySelector('.servico-cabecalho-toggler'); detalhes.style.display = servico.isExpanded ? 'block' : 'none'; toggler.innerHTML = servico.isExpanded ? '&#9650;' : '&#9660;'; if (servico.isExpanded) preencherDetalhesServico(servico); }
                async function processarOS(id) { 
            const servico = servicos.find(s => s.id === id); 
            if (!servico) return; 
            
            const camposObrigatorios = ['frota', 'atividade', 'sistema', 'subsistema', 'descricao', 'data', 'inicio', 'dataFinal', 'fim']; 
            let camposInvalidos = []; 
            const article = document.getElementById(`servico_${servico.id}`); 
            
            // Valida√ß√£o de campos vazios
            camposObrigatorios.forEach(field => { 
                const el = article.querySelector(`[data-field="${field}"]`); 
                if (!servico[field] || servico[field].trim() === "") { 
                    camposInvalidos.push(field); 
                    if (el) el.classList.add('campo-invalido'); 
                } else { 
                    if (el) el.classList.remove('campo-invalido'); 
                } 
            }); 
            
            if (camposInvalidos.length > 0) { 
                showToast('Preencha todos os campos obrigat√≥rios.', 'error'); 
                return; 
            } 
            
            // Valida√ß√£o de tempo (in√≠cio vs. fim)
            if (!validarTempoServico(servico)) {
                showToast('A data/hora final n√£o pode ser anterior √† inicial.', 'error');
                // Garante que o destaque de erro seja aplicado
                article.querySelector('[data-field="dataFinal"]').classList.add('campo-invalido');
                article.querySelector('[data-field="fim"]').classList.add('campo-invalido');
                return;
            }
            
            const gerarTextoFinal = () => { 
                const frente = document.getElementById("frente").value.trim() || "N√ÉO INFORMADA"; 
                const equipeTexto = equipe.length > 0 ? equipe.map(item => `${item.nome} - ${item.matricula}`).join('\n') : "Equipe n√£o informada."; 
                const dataFormatada = formatarDataParaExibicao(servico.data); 
                const dataFinalFormatada = formatarDataParaExibicao(servico.dataFinal); 

                // MODIFICADO: Gera√ß√£o da se√ß√£o de Pe√ßas
                let secaoPecas = '';
                if (servico.pecasUtilizadas && servico.pecasUtilizadas.length > 0) {
                    const pecasTexto = servico.pecasUtilizadas.map(p => {
                        const sap = p.codigoSap ? `SAP.[${p.codigoSap}]` : '';
                        const pn = p.partNumber ? `PartNumber [${p.partNumber}]` : '';
                        return `- qtd: *(${p.quantidade})* - ${p.descricao} - ${sap} - ${pn}`;
                    }).join('\n');
                    
                    // A se√ß√£o S√ì √â ADICIONADA SE HOUVER PE√áAS
                    secaoPecas = `\n\n‚öôÔ∏è *Pe√ßas:*\n\n${pecasTexto}`;
                }
                
                const txt = `*SOLICITA√á√ÉO DE O.S*\n\n*M√°quina est√° parada por manuten√ß√£o:*\n(${servico.parada === "sim" ? "‚ùå" : " "}) sim *(${servico.parada === "n√£o" ? "‚ùå" : " "}) n√£o*\n*se SIM abre ORDEM*\n*se N√ÉO abre Pr√©-Ordem*\n\n‚Ä¢Frota afetada: ${servico.frota}\n‚Ä¢Local/frente: ${frente}\n\n‚Ä¢Tipo de manuten√ß√£o:\n(${servico.tipo === "CORRETIVA" ? "‚ùå" : " "}) CORRETIVA ORDEM DE MANUTEN√á√ÉO\n(${servico.tipo === "CONDICIONAL" ? "‚ùå" : " "}) CONDICIONAL PR√â-ORDEM\n(${servico.tipo === "MELHORIA" ? "‚ùå" : " "}) MELHORIA PR√â-ORDEM\n\n‚Ä¢Descri√ß√£o servi√ßo\n${servico.descricao}\n(${servico.atividade.split(" - ")[0]} - ${servico.sistema} - ${(servico.subsistema || "").split(" - ")[0]})\n${servico.oportunidade ? `Oportunidade: ${servico.oportunidade}\n\n` : '\n'}‚Ä¢Foi falha operacional?\n(${servico.falha === "sim" ? "‚ùå" : " "}) Sim\n(${servico.falha === "n√£o" ? "‚ùå" : " "}) N√£o\n\nData inicial: ${dataFormatada}\nHora inicial: ${servico.inicio}\nData final: ${dataFinalFormatada}\nHora fim: ${servico.fim}\n\nSolicitante:\n${equipeTexto}${secaoPecas}`; 
                
                servico.texto = txt; 
                servico.isExpanded = true; 
                salvarOSnoHistorico(servico.id); 
                salvarTudo(true); 
                renderizarServicos(); 
                showToast("O.S. gerada/atualizada!", 'success'); 
                setTimeout(() => document.getElementById(`servico_${servico.id}`)?.scrollIntoView({ behavior: 'smooth', block: 'center' }), 100); 
            }; 
            if (servico.tipo === "CONDICIONAL" || servico.tipo === "MELHORIA") { abrirPopupInput('Informar Oportunidade', 'Para manuten√ß√£o Condicional/Melhoria, informe a oportunidade:', 'Ex: Refei√ß√£o, DDS...', servico.oportunidade || '', (oportunidade) => { if (oportunidade !== null) { servico.oportunidade = oportunidade; gerarTextoFinal(); } }); } else { servico.oportunidade = ""; gerarTextoFinal(); } 
        }

        async function copiarTexto(id, button) { const servico = servicos.find(s => s.id === id); if (!servico || !servico.texto) { showToast("Gere a O.S. primeiro.", 'error'); return; } try { await navigator.clipboard.writeText(servico.texto); showToast("Texto da O.S. copiado!", 'success'); button.innerText = 'Copiado!'; setTimeout(() => { minimizarServico(id); button.innerText = 'Copiar'; }, 1000); } catch (err) { showToast("Falha ao copiar texto.", 'error'); } }
        function compartilharWhatsApp(id) { const servico = servicos.find(s => s.id === id); if (!servico || !servico.texto) { showToast("Gere a O.S. primeiro.", 'error'); return; } servico.foiCompartilhado = true; salvarTudo(true); preencherDetalhesServico(servico); window.open(`https://wa.me/?text=${encodeURIComponent(servico.texto)}`, "_blank"); minimizarServico(id); }
        function adicionarServicoDepois(idReferencia) { const refServico = servicos.find(s => s.id === idReferencia); if (!refServico) return; minimizarServico(idReferencia); const novoServico = { id: Date.now(), frota: refServico.frota, atividade: "", sistema: refServico.sistema, subsistema: "", descricao: "", tipo: "CORRETIVA", parada: "sim", falha: "n√£o", data: refServico.dataFinal, dataFinal: refServico.dataFinal, inicio: refServico.fim, fim: "", texto: "", oportunidade: "", isExpanded: true, foiCompartilhado: false, pecasUtilizadas: [] }; const index = servicos.findIndex(s => s.id === idReferencia); servicos.splice(index + 1, 0, novoServico); renderizarServicos(); salvarTudo(); showToast("Novo servi√ßo adicionado abaixo.", 'success'); setTimeout(() => document.getElementById(`servico_${novoServico.id}`)?.scrollIntoView({ behavior: 'smooth', block: 'center' }), 100); }
        
        // ---------------------------------
        // NOVAS FUN√á√ïES: GEST√ÉO DE PE√áAS NO SERVI√áO
        // ---------------------------------
        
    function abrirPopupSelecaoPecas(servicoId) {
    // 1. Inicia o download (se ainda n√£o foi feito)
    sincronizarCatalogoPecas();

    // 2. Se a lista ainda estiver vazia, provavelmente est√° baixando
    if (catalogoLocal.length === 0) {
        showToast("Carregando cat√°logo... Aguarde alguns segundos e tente novamente.", 'info', 4000);
        return;
    }
    
    // Filtro inicial e renderiza√ß√£o do cat√°logo dentro do popup
    const itensFiltrados = catalogoLocal.sort((a, b) => (a.descricao || '').localeCompare(b.descricao || ''));
    
    let conteudo = `<input type="text" id="popupBuscaPeca" oninput="renderizarPecasParaServico(${servicoId})" placeholder="üîé Buscar pe√ßa por SAP/Descri√ß√£o..." class="w-full p-2 border border-gray-300 rounded-lg mb-3">
    <div id="listaPecasPopup" class="max-h-64 overflow-y-auto space-y-2">`;
    
    conteudo += renderizarPecasParaServicoHTML(itensFiltrados, servicoId);
    conteudo += `</div>`;

    abrirPopup('Selecionar Pe√ßa', `<div id="popup-content-wrapper">${conteudo}</div>`, [
        { texto: 'Fechar', classe: 'bg-gray-300 text-gray-800 hover:bg-gray-400', acao: fecharPopup }
    ]);
}

        function renderizarPecasParaServico(servicoId) {
            const listaDiv = document.getElementById('listaPecasPopup');
            if (!listaDiv) return;

            const termoBusca = removerAcentos(document.getElementById('popupBuscaPeca').value.toLowerCase());

            const itensFiltrados = catalogoLocal.filter(item => {
                const codigoSap = removerAcentos(String(item.codigoSap || '').toLowerCase());
                const partNumber = removerAcentos(String(item.partNumber || '').toLowerCase());
                const descricaoNormalizada = removerAcentos(String(item.descricao || '').toLowerCase());

                return (codigoSap.includes(termoBusca) || partNumber.includes(termoBusca) || descricaoNormalizada.includes(termoBusca));
            });

            listaDiv.innerHTML = renderizarPecasParaServicoHTML(itensFiltrados, servicoId);
        }

        function renderizarPecasParaServicoHTML(itens, servicoId) {
            if (itens.length === 0) {
                return `<p class="text-center text-gray-500 py-4">Nenhum item encontrado.</p>`;
            }

            return itens.map(item => `
                <div class="border rounded-lg p-3 flex justify-between items-center transition-all duration-200 hover:bg-blue-50">
                    <div class="flex-1 min-w-0">
                        <p class="font-bold text-gray-800 truncate">${item.descricao}</p>
                        <p class="text-xs text-gray-600">SAP: ${item.codigoSap || 'N/D'} | PN: ${item.partNumber || 'N/D'}</p>
                    </div>
                    <button onclick="selecionarPecaParaServico(${servicoId}, '${item.docId}')" class="py-1 px-3 rounded bg-indigo-600 text-white hover:bg-indigo-700 text-sm font-semibold ml-2">
                        Adicionar
                    </button>
                </div>
            `).join('');
        }

        function selecionarPecaParaServico(servicoId, docId) {
            const peca = catalogoLocal.find(p => p.docId === docId);
            if (!peca) return;

            abrirPopupInput(
                `Qtd. para: ${peca.descricao.substring(0, 30)}...`,
                'Digite a quantidade utilizada (apenas n√∫meros):',
                'Ex: 1, 5.5',
                '1',
                (quantidade) => {
                    if (quantidade && !isNaN(parseFloat(quantidade)) && parseFloat(quantidade) > 0) {
                        adicionarPecaUtilizada(servicoId, peca, parseFloat(quantidade));
                    } else {
                        showToast("Quantidade inv√°lida.", "error");
                    }
                },
                'number'
            );
        }

        function adicionarPecaUtilizada(servicoId, peca, quantidade) {
            const servico = servicos.find(s => s.id === servicoId);
            if (!servico) return;

            servico.pecasUtilizadas.push({
                ...peca, // Inclui docId, codigoSap, partNumber, descricao
                quantidade: quantidade
            });

            fecharPopup();
            salvarTudo();
            preencherDetalhesServico(servico); // Renderiza a lista de pe√ßas no cart√£o
            showToast(`Pe√ßa adicionada: ${quantidade}x ${peca.descricao}`, 'success');
        }

        function removerPecaUtilizada(servicoId, pecaIndex) {
            const servico = servicos.find(s => s.id === servicoId);
            if (!servico) return;

            servico.pecasUtilizadas.splice(pecaIndex, 1);

            salvarTudo();
            preencherDetalhesServico(servico); // Renderiza a lista de pe√ßas no cart√£o
            showToast(`Pe√ßa removida.`, 'success');
        }
// =================================================================================
// M√ìDULO: APONTAMENTO (NOVA L√ìGICA DE EDI√á√ÉO)
// =================================================================================

let linhasApontamento = []; // Armazena as linhas que ser√£o impressas
// Vari√°vel para controlar a reordena√ß√£o
let indiceOrigemTroca = null; 


// Configura√ß√£o das coordenadas (Mantida, ajuste fino se necess√°rio)
const COORD_FORM = {
    imagemBase: 'fundo_apontamento.jpg',
    cabecalho: {
        oficinaInterna: { x: 323, y: 230 }, // Checkbox Interna
        oficinaExterna: { x: 1420, y: 230 }, // Checkbox Externa
        colaborador: { x: 280, y: 400 },
        id: { x: 280, y: 440}, // Ajustado X para ID n√£o sobrepor nome longo
        setor: { x: 900, y: 410 },
        dataDia: { x: 1720, y: 400 },
        dataMes: { x: 1780, y: 400},
        dataAno: { x: 1850, y: 400}
    },
    grid: {
        inicioY: 630, 
        alturaLinha: 90, 
        colunas: {
            os: 210,
            frota: 425,
            operacao: 620,
            atividade: 990,
            sistema: 1370,
            subsistema: 1570,
            inicio: 1748,
            fim: 1888,
            local: 2250
        }
    }
};
// Inicializa a tela de apontamento
function renderizarSecaoApontamento() {
    const sel = document.getElementById('apontamentoColaborador');
    const dataTurno = document.getElementById('dataTurno');
    const dataApont = document.getElementById('apontamentoData');

    if (sel) {
        sel.innerHTML = equipe.length 
            ? equipe.map(e => `<option value="${e.nome} - ${e.matricula}">${e.nome} - ${e.matricula}</option>`).join('') 
            : '<option>Sem equipe definida</option>';
    }
    
    // 1. SINCRONIZA√á√ÉO DE DATAS: O apontamento usa a data do turno principal
    if (dataTurno && dataApont) {
        dataApont.value = dataTurno.value;
    }

    // 2. Inicializar Linhas (DDS Padr√£o)
    if (linhasApontamento.length === 0) {
        linhasApontamento.push({
            id: Date.now(),
            tipo: 'manual',
            atividade: 'H02 - DDS',
            inicio: '07:00',
            fim: '07:20',
            os: '', frota: '', sistema: '', subsistema: ''
        });
    }
    
    // 3. Renderizar
    renderizarListaLinhas();
    iniciarMonitoramentoFormulario();
}

function renderizarListaLinhas() {
    const container = document.getElementById('listaLinhasApontamento');
    if (!container) return;
    
    container.innerHTML = '';

    if (linhasApontamento.length === 0) {
        container.innerHTML = `
            <div class="text-center p-6 bg-gray-50 border-2 border-dashed border-gray-200 rounded-xl">
                <p class="text-sm text-gray-500 font-medium">Nenhuma atividade registrada.</p>
                <p class="text-xs text-gray-400 mt-1">Toque nos bot√µes acima para come√ßar.</p>
            </div>`;
        return;
    }

    linhasApontamento.forEach((linha, index) => {
        const isServico = linha.tipo === 'servico';
        const isSelecionado = (indiceOrigemTroca === index);
        
        // Cores
        let borderClass = isServico ? 'border-l-[5px] border-blue-600' : 'border-l-[5px] border-yellow-400';
        let bgClass = 'bg-white';
        
        if (isSelecionado) {
            borderClass = 'border-l-[5px] border-yellow-400 ring-2 ring-yellow-200';
            bgClass = 'bg-yellow-50';
        }

        // Bot√µes de A√ß√£o (Fixo √† direita)
        const acoesHtml = `
            <div class="flex items-center gap-0.5 ml-1 pl-1 border-l border-gray-200 shrink-0">
                <button onclick="trocarOrdem(${index})" class="p-1 text-gray-400 hover:text-blue-600 rounded hover:bg-gray-100 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4" /></svg>
                </button>
                <button onclick="removerLinhaApontamento(${index})" class="p-1 text-gray-400 hover:text-red-600 rounded hover:bg-red-50 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                </button>
            </div>
        `;

        // Input de Hora (Estilo unificado)
        const inputTimeClass = "block w-[50px] h-8 text-xs font-bold text-center bg-gray-50 border border-gray-300 rounded-lg focus:ring-1 focus:ring-blue-500 outline-none p-0";

        let html = '';

        if (isServico) {
            // === CARD SERVI√áO ===
            // Formata√ß√£o P### ‚Ä¢ # ‚Ä¢ #.#
            const infoTecnica = `${linha.atividade.split(' - ')[0]} ‚Ä¢ ${linha.sistema} ‚Ä¢ ${(linha.subsistema||'?').split(' - ')[0]}`;
            
            html = `
            <div class="${bgClass} rounded-xl shadow-sm mb-3 border-l-[6px] ${borderClass} border-t border-r border-b border-gray-200 overflow-hidden">
                <div class="p-2 flex flex-col gap-2">
                    
                    <div class="flex justify-between items-center">
                        <div class="flex items-center gap-2 overflow-hidden">
                            <span class="flex-shrink-0 w-6 h-6 flex items-center justify-center bg-gray-100 text-gray-500 text-xs font-bold rounded-full border border-gray-200">${index + 1}</span>
                            <div class="min-w-0">
                                <span class="block font-black text-sm text-gray-800 leading-none truncate">${linha.frota || 'N/A'}</span>
                                <span class="block text-[9px] text-gray-400 font-mono mt-0.5 truncate">${infoTecnica}</span>
                            </div>
                        </div>
                        ${acoesHtml}
                    </div>

                    <div class="flex items-center justify-between bg-gray-50 p-1.5 rounded border border-gray-100">
                        <div class="flex items-center gap-1 px-2 py-0.5 bg-white rounded border border-gray-200 shadow-sm">
                            <span class="text-[9px] font-bold text-gray-400 uppercase">OS</span>
                            <span class="text-sm font-bold text-blue-700">${linha.os || '---'}</span>
                        </div>
                        
                        <div class="flex items-center gap-1">
                            <input type="time" value="${linha.inicio}" onchange="atualizarLinha(${index}, 'inicio', this.value)" class="${inputTimeClass}">
                            <span class="text-gray-300 text-[10px]">‚ûú</span>
                            <input type="time" value="${linha.fim}" onchange="atualizarLinha(${index}, 'fim', this.value)" class="${inputTimeClass}">
                        </div>
                    </div>
                </div>
            </div>`;

        } else {
            // === CARD MANUAL (CORRIGIDO) ===
            const opsH = atividades.filter(a => a.startsWith('H')).map(a => 
                `<option value="${a}" ${linha.atividade===a?'selected':''}>${a}</option>`
            ).join('');
            
            html = `
            <div class="bg-white rounded-xl shadow-sm mb-3 border-l-[6px] ${borderClass} border-t border-r border-b border-gray-200 overflow-hidden">
                <div class="p-2 flex items-center gap-2">
                    
                    <span class="flex-shrink-0 w-6 h-6 flex items-center justify-center bg-gray-100 text-gray-500 text-xs font-bold rounded-full border border-gray-200">${index + 1}</span>

                    <div class="flex-grow min-w-0 relative">
                        <select onchange="atualizarLinha(${index}, 'atividade', this.value)" 
                            class="w-full h-9 pl-2 pr-6 text-xs font-bold text-gray-700 bg-yellow-50 border border-yellow-200 rounded-lg focus:ring-1 focus:ring-yellow-400 outline-none appearance-none truncate">
                            ${opsH}
                        </select>
                        <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-yellow-400">
                            <svg class="fill-current h-3 w-3" viewBox="0 0 20 20"><path d="M9.293 12.95l.707.707L15.657 8l-1.414-1.414L10 10.828 5.757 6.586 4.343 8z"/></svg>
                        </div>
                    </div>

                    <div class="flex items-center gap-1 shrink-0">
                        <input type="time" value="${linha.inicio}" onchange="atualizarLinha(${index}, 'inicio', this.value)" class="${inputTimeClass}">
                        <input type="time" value="${linha.fim}" onchange="atualizarLinha(${index}, 'fim', this.value)" class="${inputTimeClass}">
                        ${acoesHtml}
                    </div>
                </div>
            </div>`;
        }
        
        container.innerHTML += html;
    });
}


// ============================================================
// M√ìDULO: ADICIONAR PREVENTIVA (NOVO)
// ============================================================

function abrirPopupAddPreventiva() {
    // 1. Prepara as op√ß√µes de Frota
    let opcoesFrota = '<option value="">Selecione a Frota...</option>';
    if (frotasTurno.length > 0) {
        opcoesFrota += frotasTurno.map(f => `<option value="${f.nome}">${f.nome}</option>`).join('');
    }

    // 2. Prepara as op√ß√µes de Sistema
    let opcoesSistemas = '<option value="">Selecione o Sistema...</option>';
    for (const [grupo, lista] of Object.entries(sistemas)) {
        opcoesSistemas += `<optgroup label="${grupo}">`;
        lista.forEach(sys => {
            opcoesSistemas += `<option value="${sys.cod}">${sys.cod} - ${sys.nome}</option>`;
        });
        opcoesSistemas += `</optgroup>`;
    }

    // 3. Prepara as op√ß√µes de Atividade (Apenas Produtivas 'P')
    let opcoesAtividade = '<option value="">Selecione a Atividade...</option>';
    atividades.forEach(a => {
        if (a.startsWith('P')) { // Mostra apenas c√≥digos 'P'
            opcoesAtividade += `<option value="${a}">${a}</option>`;
        }
    });

    // 4. HTML do Formul√°rio com tamanhos e espa√ßamentos melhorados (text-sm)
    const conteudo = `
        <div class="space-y-4 text-sm text-left">
            
            <div class="grid grid-cols-2 gap-3">
                <div>
                    <label class="block text-xs font-bold text-gray-600 mb-1">N¬∫ da O.S. *</label>
                    <input type="number" id="prevOS" 
                        class="w-full p-3 border border-gray-300 rounded-lg text-sm font-bold text-purple-700 bg-purple-50 focus:ring-2 focus:ring-purple-500 outline-none" 
                        placeholder="Ex: 102030">
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-600 mb-1">Frota *</label>
                    <select id="prevFrota" 
                        class="w-full p-3 border border-gray-300 rounded-lg text-sm bg-white focus:ring-2 focus:ring-blue-500 outline-none">
                        ${opcoesFrota}
                    </select>
                </div>
            </div>

            <div>
                <label class="block text-xs font-bold text-gray-600 mb-1">Atividade Realizada *</label>
                <select id="prevAtividade" 
                    class="w-full p-3 border border-gray-300 rounded-lg text-sm font-semibold text-gray-700 focus:ring-2 focus:ring-blue-500 outline-none">
                    ${opcoesAtividade}
                </select>
            </div>

            <div class="grid grid-cols-2 gap-3">
                <div>
                    <label class="block text-xs font-bold text-gray-600 mb-1">Sistema *</label>
                    <select id="prevSistema" onchange="atualizarSubsistemaPreventiva()" 
                        class="w-full p-3 border border-gray-300 rounded-lg text-sm bg-white focus:ring-2 focus:ring-blue-500 outline-none">
                        ${opcoesSistemas}
                    </select>
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-600 mb-1">Subsistema *</label>
                    <select id="prevSubsistema" 
                        class="w-full p-3 border border-gray-300 rounded-lg text-sm bg-gray-50 focus:ring-2 focus:ring-blue-500 outline-none" disabled>
                        <option value="">Selecione Sistema 1¬∫</option>
                    </select>
                </div>
            </div>

            <div class="grid grid-cols-2 gap-3 bg-purple-50 p-3 rounded-lg border border-purple-200 mt-3">
                <div>
                    <label class="block text-xs font-bold text-purple-800 mb-1">In√≠cio *</label>
                    <input type="time" id="prevInicio" 
                        class="w-full p-2 bg-white border border-purple-300 rounded-lg text-sm text-center font-bold focus:ring-2 focus:ring-purple-500 outline-none">
                </div>
                <div>
                    <label class="block text-xs font-bold text-purple-800 mb-1">Fim *</label>
                    <input type="time" id="prevFim" 
                        class="w-full p-2 bg-white border border-purple-300 rounded-lg text-sm text-center font-bold focus:ring-2 focus:ring-purple-500 outline-none">
                </div>
            </div>

        </div>
    `;

    abrirPopup('üìã Adicionar Preventiva', conteudo, [
        { texto: 'Cancelar', classe: 'bg-gray-200 text-gray-700 py-3 rounded-lg font-bold', acao: fecharPopup },
        { texto: 'Salvar', classe: 'bg-purple-600 text-white py-3 rounded-lg font-bold hover:bg-purple-700 shadow-lg transition-transform active:scale-95', acao: salvarPreventiva }
    ]);
    
    // Adiciona o foco no primeiro campo
    setTimeout(() => document.getElementById('prevOS').focus(), 50);
}

//fun√ß√£o auxiliar para compartilhar no whatsapp.
function compartilharHistorico(uniqueId) {
    // Busca no cache local (DOM hidden textarea)
    const textarea = document.getElementById(`texto_os_hist_${uniqueId}`);
    if (textarea && textarea.value) {
        const texto = textarea.value;
        window.open(`https://wa.me/?text=${encodeURIComponent(texto)}`, "_blank");
    } else {
        showToast("Texto n√£o encontrado para compartilhar.", "error");
    }
}

// Fun√ß√£o auxiliar para carregar subsistemas dinamicamente no popup
function atualizarSubsistemaPreventiva() {
    const codSistema = document.getElementById('prevSistema').value;
    const selectSub = document.getElementById('prevSubsistema');
    
    selectSub.innerHTML = '<option value="">Selecione...</option>';
    selectSub.disabled = true;
    selectSub.classList.add('bg-gray-50');

    if (codSistema && subsistemas[codSistema]) {
        subsistemas[codSistema].forEach(sub => {
            const option = document.createElement('option');
            option.value = sub;
            option.textContent = sub;
            selectSub.appendChild(option);
        });
        selectSub.disabled = false;
        selectSub.classList.remove('bg-gray-50');
        selectSub.classList.add('bg-white');
    }
}

function salvarPreventiva() {
    const os = document.getElementById('prevOS').value.trim();
    const frota = document.getElementById('prevFrota').value;
    const atividade = document.getElementById('prevAtividade').value;
    const sistema = document.getElementById('prevSistema').value;
    const subsistema = document.getElementById('prevSubsistema').value;
    const inicio = document.getElementById('prevInicio').value;
    const fim = document.getElementById('prevFim').value;

    let valido = true;

    // Valida√ß√£o Visual
    const campos = ['prevOS', 'prevFrota', 'prevAtividade', 'prevSistema', 'prevSubsistema', 'prevInicio', 'prevFim'];
    campos.forEach(id => {
        const el = document.getElementById(id);
        if (!el.value) {
            el.classList.add('campo-invalido', 'ring-2', 'ring-red-500');
            valido = false;
        } else {
            el.classList.remove('campo-invalido', 'ring-2', 'ring-red-500');
        }
    });

    if (valido && inicio >= fim) {
        showToast("Hora final deve ser maior que a inicial.", "error");
        document.getElementById('prevFim').classList.add('campo-invalido');
        return false; // üõë ERRO: Retorna false para manter popup aberto
    }

    if (!valido) {
        showToast("Preencha os campos obrigat√≥rios.", "error");
        return false; // üõë ERRO
    }

    // Sucesso
    linhasApontamento.push({
        id: Date.now(),
        tipo: 'servico',
        atividade, inicio, fim, frota, os, sistema, subsistema
    });

    renderizarListaLinhas();
    rolarParaUltimoItemApontamento();
    marcarComoDesatualizado();
    salvarTudo();
    showToast("Adicionado com sucesso!", "success");

    return true; // ‚úÖ SUCESSO: Permite fechar o popup
}





// Atualiza dados da mem√≥ria quando o usu√°rio edita os inputs
function atualizarLinha(index, campo, valor) {
    linhasApontamento[index][campo] = valor;
    marcarComoDesatualizado(); 
    salvarTudo();
}

function adicionarLinhaManual() {
    // Pega o hor√°rio final da √∫ltima linha para sugerir como in√≠cio desta
    const ultima = linhasApontamento[linhasApontamento.length - 1];
    const inicioSugerido = ultima ? ultima.fim : '07:00';

    linhasApontamento.push({
        id: Date.now(),
        tipo: 'manual',
        atividade: 'H03 - Refei√ß√£o', // Padr√£o, usu√°rio muda
        inicio: inicioSugerido,
        fim: '',
        os: '', frota: '', sistema: '', subsistema: ''
    });
    renderizarListaLinhas();
    // ADICIONE ESTA LINHA:
    rolarParaUltimoItemApontamento(); 
    marcarComoDesatualizado(); 
    salvarTudo();
}

function removerLinhaApontamento(index) {
    linhasApontamento.splice(index, 1);
    renderizarListaLinhas();
    marcarComoDesatualizado(); 
    salvarTudo();
}

// Popup para escolher qual servi√ßo importar
// ============================================================
// IMPORTA√á√ÉO DE SERVI√áOS (FILTRADA POR DATA SELECIONADA)
// ============================================================

async function abrirPopupImportarServico() {
    const inputData = document.getElementById('apontamentoData');
    const dataAlvo = inputData ? inputData.value : dataHojeInputLocal();

    // 1. Filtros R√≠gidos da UI
    const frenteInput = document.getElementById('frente');
    const turnoInput = document.getElementById('turnoLetra');
    const frenteAtual = frenteInput ? frenteInput.value.trim() : "";
    const turnoAtual = turnoInput ? turnoInput.value : "";

    if (!dataAlvo || !frenteAtual || !turnoAtual) {
        showToast("Selecione a Data, Frente e Turno para importar servi√ßos.", "error");
        return;
    }

    showToast(`Buscando servi√ßos de ${frenteAtual} [${turnoAtual}]...`, "info", 1000);

    let listaCombinada = [];

    try {
        // A. Busca no Hist√≥rico (IndexedDB)
        const historico = await dbExec(STORE_HISTORICO, 'readonly', store => store.getAll());

        // Filtro R√≠gido: S√≥ traz o que √© da mesma Frente/Turno/Data
        const doHistorico = historico.filter(h => 
            h.dataOS === dataAlvo &&
            (h.frente || "").trim() === frenteAtual &&
            (h.turno || "") === turnoAtual
        );

        // B. Busca na Mem√≥ria (Rascunhos)
        const idsNoHistorico = new Set(doHistorico.map(h => String(h.id)));
        const daMemoria = servicos.filter(s => 
            s.data === dataAlvo && 
            !idsNoHistorico.has(String(s.id)) &&
            (s.frente || "").trim() === frenteAtual && 
            (s.turno || "") === turnoAtual
        );

        listaCombinada = [...doHistorico, ...daMemoria];

    } catch (e) {
        console.error(e);
        showToast("Erro ao ler banco de dados.", "error");
        return;
    }

    if (listaCombinada.length === 0) {
        const dataExibicao = formatarDataParaExibicao(dataAlvo);
        showToast(`Nenhum servi√ßo encontrado para ${frenteAtual} em ${dataExibicao}.`, "info", 4000);
        return;
    }

    listaCombinada.sort((a, b) => a.inicio.localeCompare(b.inicio));

    // --- GERA√á√ÉO DO HTML (Visual Moderno) ---
    const listaHtml = listaCombinada.map(s => {
        const temOS = s.osNumero && String(s.osNumero).trim() !== "";
        const numeroOS = temOS ? s.osNumero : "PENDENTE";
        const jaImportado = linhasApontamento.some(linha => String(linha.idOriginal) === String(s.id));

        const codAtiv = s.atividade ? s.atividade.split(' - ')[0] : '???';
        const sist = s.sistema || '?';
        const sub = s.subsistema ? s.subsistema.split(' - ')[0] : '?'; 
        const infoTecnica = `${codAtiv} ‚Ä¢ ${sist} ‚Ä¢ ${sub}`;
        
        const action = temOS 
            ? `tentarImportarServico('${s.id}', '${s.frota}', '${s.atividade}', '${s.sistema}', '${s.subsistema}', '${s.inicio}', '${s.fim}', '${numeroOS}')` 
            : `explicarFaltaOS()`;
        
        // Estilos Din√¢micos
        let cardStyle = "bg-white border-l-[5px] border-green-500 hover:bg-green-50";
        let badgeOS = "bg-green-100 text-green-800 border-green-200";
        let iconStatus = `<span class="text-green-600 text-xl font-bold">üì•</span>`; // √çcone de Download

        if (!temOS) {
            cardStyle = "bg-white border-l-[5px] border-yellow-400 hover:bg-yellow-50";
            badgeOS = "bg-yellow-100 text-yellow-800 border-yellow-200";
            iconStatus = `<span class="text-yellow-500 text-xl">‚ö†Ô∏è</span>`; // Alerta
        } 
        
        if (jaImportado) {
            cardStyle = "bg-blue-50 border-l-[5px] border-blue-300 opacity-70"; 
            badgeOS = "bg-blue-100 text-blue-800 border-blue-200";
            iconStatus = `<span class="text-blue-600 text-xs font-bold uppercase tracking-wide border border-blue-200 px-2 py-1 rounded bg-white">Importado</span>`;
        }

        return `
        <div onclick="${!jaImportado ? action : ''}" 
             class="group relative rounded-lg shadow-sm mb-3 p-3 flex items-center justify-between transition-all cursor-pointer active:scale-[0.98] border border-gray-100 ${cardStyle}">
            
            <div class="flex-1 min-w-0 pr-3">
                <div class="flex items-center justify-between mb-1.5">
                    <span class="font-black text-gray-800 text-sm uppercase tracking-wide">
                        ${s.frota || 'N/D'}
                    </span>
                    <span class="text-[10px] font-bold px-2 py-0.5 rounded border ${badgeOS}">
                        OS: ${numeroOS}
                    </span>
                </div>

                <div class="text-xs font-bold text-gray-600 font-mono mb-1">
                   ${infoTecnica}
                </div>
                
                <div class="flex items-center gap-1">
                    <span class="text-[10px] font-bold text-gray-400 uppercase">Hor√°rio:</span>
                    <span class="text-[11px] font-bold text-gray-700 bg-gray-100 px-1.5 rounded border border-gray-200">
                        ${s.inicio} - ${s.fim}
                    </span>
                </div>
            </div>

            <div class="flex-shrink-0 pl-2 border-l border-gray-200/50 h-full flex items-center justify-center">
                ${iconStatus}
            </div>
        </div>`;
    }).join('');

    const conteudoFinal = `
        <div class="bg-gray-50 -m-5 p-4 h-full flex flex-col">
            <div class="flex justify-between items-center mb-4 px-1 border-b pb-3 border-gray-200">
                <div class="flex flex-col">
                    <span class="text-[10px] text-gray-400 font-bold uppercase tracking-wider">Data Selecionada</span>
                    <span class="text-sm font-black text-gray-800">${formatarDataParaExibicao(dataAlvo)}</span>
                </div>
                <span class="text-xs bg-white border border-gray-200 text-gray-600 px-3 py-1 rounded-full font-bold shadow-sm">
                    ${listaCombinada.length} itens
                </span>
            </div>
            
            <div class="overflow-y-auto pr-1 custom-scrollbar space-y-1" style="max-height: 55vh;">
                ${listaHtml}
            </div>
        </div>
    `;

    // Bot√£o de fechar grande e f√°cil de clicar
    abrirPopup('üì• Importar Servi√ßo', conteudoFinal, [{ texto: 'Cancelar', classe: 'w-full bg-gray-200 text-gray-700 py-3 font-bold rounded-lg', acao: fecharPopup }]);
}



// Fun√ß√£o auxiliar para evitar erro no HTML
function atualizarPreviewSeNecessario() {
    // Se j√° houver linhas desenhadas, avisa que a data mudou
    if (linhasApontamento.length > 1) { // >1 porque o DDS padr√£o sempre existe
        showToast("Aten√ß√£o: A data do formul√°rio mudou. Verifique se as linhas de tempo conferem.", "info", 4000);
    }
}

// --- FUN√á√ÉO NECESS√ÅRIA PARA IMPORTAR DO HIST√ìRICO ---
function importarServicoFinalizado(originalId, frota, atividade, sistema, subsistema, inicio, fim, os) {
    // Adiciona o item na timeline diretamente, pois j√° foi validado
    linhasApontamento.push({
        id: Date.now(),
        idOriginal: originalId, // Mant√©m o v√≠nculo
        tipo: 'servico',
        atividade: atividade, 
        inicio: inicio,
        fim: fim,
        frota: frota,
        os: os, // J√° vem com o n√∫mero da O.S.
        sistema: sistema,
        subsistema: subsistema
    });

    renderizarListaLinhas();
    fecharPopup();
    showToast(`Servi√ßo ${os} importado!`, "success");
    rolarParaUltimoItemApontamento();
    marcarComoDesatualizado();
    salvarTudo();
}

//explica o.s pendente 
function explicarFaltaOS() {
    // Fecha o popup de sele√ß√£o atual para abrir o de alerta
    fecharPopup();

    setTimeout(() => {
        const conteudo = `
            <div class="text-center p-2">
                <div class="bg-yellow-100 text-yellow-600 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4 text-3xl">
                    ‚ö†Ô∏è
                </div>
                <h3 class="text-lg font-bold text-gray-800 mb-2">Falta o N√∫mero da O.S.</h3>
                <p class="text-sm text-gray-600 mb-4">
                    Para garantir a qualidade do apontamento, voc√™ precisa primeiro 
                    <strong>finalizar a O.S.</strong> no hist√≥rico.
                </p>
                <div class="bg-gray-100 p-3 rounded text-left text-xs text-gray-700 mb-4">
                    <strong>Passo a passo:</strong><br>
                    1. V√° na aba <b>Hist√≥rico</b>.<br>
                    2. Encontre este servi√ßo.<br>
                    3. Digite o n√∫mero e clique em <b>Finalizar</b>.
                </div>
            </div>
        `;

        const botoes = [
            { 
                texto: 'Ir para o Hist√≥rico Agora', 
                classe: 'bg-blue-600 text-white hover:bg-blue-700 w-full mb-2 shadow-lg', 
                acao: irParaAbaHistorico // Chama a navega√ß√£o
            },
            { 
                texto: 'Voltar', 
                classe: 'bg-gray-200 text-gray-700 hover:bg-gray-300 w-full', 
                acao: abrirPopupImportarServico // Reabre a lista
            }
        ];

        abrirPopup('Aten√ß√£o Necess√°ria', conteudo, botoes);
    }, 200); // Pequeno delay para transi√ß√£o suave
}

//direcionar ao hist√≥rico 
function irParaAbaHistorico() {
    fecharPopup();
    // Usa a sua fun√ß√£o 'abrir' existente para trocar a tela
    abrir('historico');
    showToast("Localize o servi√ßo e finalize a O.S.", "info", 4000);
}


// importar servi√ßo 
async function importarServico(servicoId) {
    const s = servicos.find(x => x.id === servicoId);
    
    if (s) {
        let numeroOS = "";

        try {
            const historico = await dbExec(STORE_HISTORICO, 'readonly', store => store.getAll());
            
            // --- CORRE√á√ÉO DE TIPO DE DADO AQUI ---
            const itemHist = historico.find(h => h.id == s.id); // <- Usando ==
            
            if (!itemHist || !itemHist.osNumero || itemHist.osNumero.trim() === "") {
                showToast("Erro: Finalize a O.S. no Hist√≥rico antes de importar!", "error");
                fecharPopup(); 
                return; 
            }

            numeroOS = itemHist.osNumero;

        } catch (e) {
            console.error("Erro ao buscar O.S.", e);
            showToast("Erro ao validar O.S.", "error");
            return;
        }

        // Se passou, adiciona:
        linhasApontamento.push({
            id: Date.now(),
            idOriginal: s.id,
            tipo: 'servico',
            atividade: s.atividade, 
            inicio: s.inicio,
            fim: s.fim,
            frota: s.frota,
            os: numeroOS,
            sistema: s.sistema,
            subsistema: s.subsistema
        });

        renderizarListaLinhas();
        fecharPopup();
        
        const msg = numeroOS ? `Servi√ßo importado (OS: ${numeroOS})` : "Servi√ßo importado (Sem OS)";
        showToast(msg, "success");
        
        rolarParaUltimoItemApontamento(); 
    }
}


// Fun√ß√£o auxiliar para rolar at√© o novo item
function rolarParaUltimoItemApontamento() {
    // Pequeno delay para garantir que o HTML foi desenhado
    setTimeout(() => {
        const container = document.getElementById('listaLinhasApontamento');
        if (container && container.lastElementChild) {
            container.lastElementChild.scrollIntoView({ 
                behavior: 'smooth', 
                block: 'center' 
            });
            
            // Opcional: Um flash visual para destacar
            container.lastElementChild.classList.add('ring-2', 'ring-blue-400', 'ring-offset-2');
            setTimeout(() => {
                container.lastElementChild.classList.remove('ring-2', 'ring-blue-400', 'ring-offset-2');
            }, 1000);
        }
    }, 150);
}

// --- NOVA FUN√á√ÉO: VERIFICA DUPLICIDADE ANTES DE IMPORTAR ---
function tentarImportarServico(id, frota, atividade, sistema, subsistema, inicio, fim, os) {
    // Verifica se este ID Original j√° existe nas linhas do apontamento atual
    const jaImportado = linhasApontamento.some(linha => String(linha.idOriginal) === String(id));

    if (jaImportado) {
        // Se j√° existe, abre o popup de confirma√ß√£o
        abrirPopupConfirmar(
            '‚ö†Ô∏è Servi√ßo Duplicado', 
            'Este servi√ßo <strong>j√° foi importado</strong> para o apontamento.<br>Deseja import√°-lo novamente (duplicar)?', 
            (confirmado) => {
                if (confirmado) {
                    // Se o usu√°rio confirmar, importa mesmo assim
                    importarServicoFinalizado(id, frota, atividade, sistema, subsistema, inicio, fim, os);
                }
            }
        );
    } else {
        // Se n√£o existe, importa direto
        importarServicoFinalizado(id, frota, atividade, sistema, subsistema, inicio, fim, os);
    }
}

function trocarOrdem(index) {
    // 1. Se ningu√©m estiver selecionado, seleciona o atual
    if (indiceOrigemTroca === null) {
        indiceOrigemTroca = index;
        renderizarListaLinhas(); // Re-renderiza para mostrar o destaque visual
        showToast("Selecione outro card para trocar de posi√ß√£o.", "info");
        return;
    }

    // 2. Se clicou no mesmo item, cancela a sele√ß√£o
    if (indiceOrigemTroca === index) {
        indiceOrigemTroca = null;
        renderizarListaLinhas();
        return;
    }

    // 3. Se clicou em outro item, realiza a troca (Swap)
    const itemOrigem = linhasApontamento[indiceOrigemTroca];
    
    // Remove o item da posi√ß√£o antiga
    linhasApontamento.splice(indiceOrigemTroca, 1);
    
    // Insere na nova posi√ß√£o
    // (Precisamos ajustar o √≠ndice se o movimento for de baixo para cima)
    linhasApontamento.splice(index, 0, itemOrigem);

    // Reseta e atualiza
    indiceOrigemTroca = null;
    renderizarListaLinhas();
    showToast("Ordem atualizada!", "success");
    marcarComoDesatualizado();
    salvarTudo();
}


// =================================================================================
// GERA√á√ÉO DA IMAGEM (CANVAS)
// =================================================================================
async function gerarPreviewApontamento() {
    const canvas = document.getElementById('canvasApontamento');
    if (!canvas) return;
    const ctx = canvas.getContext('2d');
    
    const elAjuste = document.getElementById('ajusteYGlobal');
    const ajusteY = elAjuste ? parseFloat(elAjuste.value) || 0 : 0;

    const img = new Image();
    img.src = COORD_FORM.imagemBase;

    try {
        await new Promise((resolve, reject) => { img.onload = resolve; img.onerror = reject; });
    } catch (e) { 
        showToast("ERRO: Imagem 'fundo_apontamento.jpg' n√£o encontrada!", "error"); 
        return; 
    }

    canvas.width = img.width;
    canvas.height = img.height;
    ctx.drawImage(img, 0, 0);

    ctx.font = "28px Arial"; 
    ctx.fillStyle = "#000000"; 
    ctx.textBaseline = "middle";

    // --- CABE√áALHO ---
    const tipoOficina = document.getElementById('apontamentoTipoOficina')?.value || 'externa';
    const dadosColab = document.getElementById('apontamentoColaborador')?.value || ' - ';
    const [nome, matricula] = dadosColab.split(' - ');
    const setor = document.getElementById('apontamentoSetor')?.value || '';
    const dataRaw = document.getElementById('apontamentoData')?.value || '';

    if (tipoOficina === 'externa') {
        ctx.fillText("X", COORD_FORM.cabecalho.oficinaExterna.x, COORD_FORM.cabecalho.oficinaExterna.y);
    } else {
        ctx.fillText("X", COORD_FORM.cabecalho.oficinaInterna.x, COORD_FORM.cabecalho.oficinaInterna.y);
    }

    ctx.fillText(nome.toUpperCase(), COORD_FORM.cabecalho.colaborador.x, COORD_FORM.cabecalho.colaborador.y);
    ctx.fillText(matricula, COORD_FORM.cabecalho.id.x, COORD_FORM.cabecalho.id.y);
    ctx.fillText(setor.toUpperCase(), COORD_FORM.cabecalho.setor.x, COORD_FORM.cabecalho.setor.y);

    if (dataRaw) {
        const [ano, mes, dia] = dataRaw.split('-');
        ctx.fillText(dia, COORD_FORM.cabecalho.dataDia.x, COORD_FORM.cabecalho.dataDia.y);
        ctx.fillText(mes, COORD_FORM.cabecalho.dataMes.x, COORD_FORM.cabecalho.dataMes.y);
        ctx.fillText(ano.slice(-2), COORD_FORM.cabecalho.dataAno.x, COORD_FORM.cabecalho.dataAno.y);
    }

    // --- LINHAS ---
    linhasApontamento.forEach((linha, i) => {
        if (i > 19) return; 

        const y = COORD_FORM.grid.inicioY + (i * COORD_FORM.grid.alturaLinha) + ajusteY;
        const x = COORD_FORM.grid.colunas;

        const numOS = linha.os || '';
        const frota = linha.frota || '';
        
        // Pega apenas o c√≥digo (Ex: "P030")
        const codAtiv = linha.atividade ? linha.atividade.split(' - ')[0] : ''; 
        
        const sist = linha.sistema || '';
        const sub = linha.subsistema ? linha.subsistema.split(' - ')[0] : '';

        // --- DESENHO DAS COLUNAS ---
        
        // 1. O.S.
        ctx.fillText(numOS, x.os, y); 

        // 2. Frota
        ctx.fillText(frota, x.frota, y);

        // 3. N¬∫ Opera√ß√£o (Vazio)
        // ctx.fillText(codAtiv, x.operacao, y); 
        
        // 4. Atividade (C√≥digo Curto)
        ctx.fillText(codAtiv, x.atividade, y);

        // 5. Sistema e Subsistema
        ctx.fillText(sist, x.sistema, y);
        ctx.fillText(sub, x.subsistema, y);

        // 6. Hor√°rios
        ctx.fillText(linha.inicio, x.inicio, y);
        ctx.fillText(linha.fim, x.fim, y);
        
        // 7. Localiza√ß√£o (Vazio)
        // ctx.fillText(localPadrao, x.local, y);
    });

    showToast("Preview gerado com sucesso!", "success");
    marcarComoAtualizado(); // O bot√£o volta a ficar azul
}

function baixarApontamento(tipo) {
    // 1. TRAVA DE SEGURAN√áA
    if (previewEstaDesatualizado) {
        showToast("‚ö†Ô∏è Dados alterados! Clique em 'ATUALIZAR!' antes de baixar.", "error", 4000);
        return;
    }

    const canvas = document.getElementById('canvasApontamento');
    if (!canvas || canvas.width < 100) { 
        showToast("Gere o preview primeiro!", "error"); return; 
    }

    // 2. L√ìGICA SIMPLIFICADA
    const inputData = document.getElementById('apontamentoData');
    const selectColab = document.getElementById('apontamentoColaborador');
    
    const dataFormatada = inputData.value ? inputData.value.split('-').reverse().join('-') : 'SemData';
    
    let nomeColab = "Geral";
    if (selectColab && selectColab.value) {
        nomeColab = selectColab.value.split('-')[0].trim();
    }

    const nomeArquivo = `Apontamento_${nomeColab}_${dataFormatada}`;

    if (tipo === 'jpg') {
        const link = document.createElement('a');
        link.download = `${nomeArquivo}.jpg`;
        link.href = canvas.toDataURL('image/jpeg', 0.9); 
        link.click();
    }
}


async function baixarOuCompartilharPDF() {
    // 1. A TRAVA DE SEGURAN√áA (MANTIDA)
    if (previewEstaDesatualizado) {
        showToast("‚ö†Ô∏è Dados alterados! Clique em 'ATUALIZAR!' para regenerar a imagem.", "error", 4000);
        document.getElementById('btnGerarPreview')?.scrollIntoView({ behavior: 'smooth', block: 'center' });
        return;
    }

    const canvas = document.getElementById('canvasApontamento');
    if (!canvas || canvas.width < 100) { 
        showToast("Gere o preview primeiro!", "error"); return; 
    }

    // 2. L√ìGICA SIMPLIFICADA (L√™ direto dos Inputs)
    const inputData = document.getElementById('apontamentoData');
    const selectColab = document.getElementById('apontamentoColaborador');
    
    // Formata a data (YYYY-MM-DD -> DD-MM-YYYY)
    const dataFormatada = inputData.value ? inputData.value.split('-').reverse().join('-') : 'SemData';
    
    // Pega o nome limpo
    let nomeColab = "Geral";
    if (selectColab && selectColab.value) {
        nomeColab = selectColab.value.split('-')[0].trim();
    }

    const nomeArquivo = `Apontamento_${nomeColab}_${dataFormatada}.pdf`;
    // ---------------------------------------------------------

    showToast("Gerando PDF...", "info");

    try {
        if (!window.jspdf) throw new Error("Biblioteca PDF ausente");
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF('p', 'mm', 'a4');
        const pdfWidth = doc.internal.pageSize.getWidth();
        const pdfHeight = doc.internal.pageSize.getHeight();
        const imgData = canvas.toDataURL('image/jpeg', 0.9);
        const ratio = canvas.height / canvas.width;
        const finalHeight = pdfWidth * ratio;

        if (finalHeight <= pdfHeight) {
            doc.addImage(imgData, 'JPEG', 0, 0, pdfWidth, finalHeight);
        } else {
            const finalWidth = pdfHeight / ratio;
            const xOffset = (pdfWidth - finalWidth) / 2;
            doc.addImage(imgData, 'JPEG', xOffset, 0, finalWidth, pdfHeight);
        }

        if (navigator.share && navigator.canShare) {
            const pdfBlob = doc.output('blob');
            const file = new File([pdfBlob], nomeArquivo, { type: "application/pdf" });
            
            if (navigator.canShare({ files: [file] })) {
                await navigator.share({
                    files: [file],
                    title: 'Apontamento',
                    text: `Segue apontamento de ${nomeColab} do dia ${dataFormatada}`
                });
                showToast("Compartilhado!", "success");
                return; 
            }
        }

        doc.save(nomeArquivo);
        showToast("PDF Baixado!", "success");

    } catch (error) {
        console.error(error);
        if (error.name !== 'AbortError') showToast("Erro ao processar PDF", "error");
    }
}


// Vari√°vel global para controlar se a imagem est√° velha
let previewEstaDesatualizado = true; 

// Fun√ß√£o que avisa visualmente que precisa atualizar
function marcarComoDesatualizado() {
    previewEstaDesatualizado = true;
    
    const btn = document.getElementById('btnGerarPreview');
    if (btn) {
        btn.classList.remove('bg-indigo-600', 'hover:bg-indigo-700');
        btn.classList.add('bg-yellow-600', 'hover:bg-yellow-700', 'animate-pulse'); // Laranja e pulsando
        btn.innerHTML = `
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mb-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
            </svg>
            <span class="text-[10px] font-bold uppercase leading-tight">Atualizar!</span>
        `;
    }
}

// Fun√ß√£o para resetar o bot√£o ao estado normal (Azul)
function marcarComoAtualizado() {
    previewEstaDesatualizado = false;
    
    const btn = document.getElementById('btnGerarPreview');
    if (btn) {
        btn.classList.remove('bg-yellow-600', 'hover:bg-yellow-700', 'animate-pulse');
        btn.classList.add('bg-indigo-600', 'hover:bg-indigo-700');
        btn.innerHTML = `
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mb-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                <path stroke-linecap="round" stroke-linejoin="round" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
            </svg>
            <span class="text-[10px] font-bold uppercase leading-tight">Atualizar</span>
        `;
    }
}

// Inicia os ouvintes nos campos do formul√°rio
function iniciarMonitoramentoFormulario() {
    const ids = ['apontamentoTipoOficina', 'apontamentoColaborador', 'apontamentoSetor', 'apontamentoData'];
    ids.forEach(id => {
        const el = document.getElementById(id);
        if (el) {
            el.addEventListener('change', marcarComoDesatualizado);
            el.addEventListener('input', marcarComoDesatualizado);
        }
    });
}

        // ---------------------------------
        // M√ìDULO: HIST√ìRICO
        // ---------------------------------
    async function renderizarSecaoHistorico(container) {
    container.innerHTML = `
    <div class="bg-white p-5 rounded-xl border border-gray-200 shadow-sm mb-4 space-y-4">
        <div class="flex justify-between items-center border-b border-gray-100 pb-4">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-full bg-blue-50 text-blue-600 flex items-center justify-center shadow-sm">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4" />
                    </svg>
                </div>
                <h3 class="text-lg font-bold text-gray-800">Hist√≥rico de O.S.</h3>
            </div>
            
            <button onclick="mostrarHistorico()" class="text-gray-500 bg-gray-50 hover:bg-gray-100 border border-gray-200 p-2 rounded-lg transition-colors shadow-sm" title="Atualizar Lista">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                </svg>
            </button>
        </div>
        
        <div class="flex gap-2">
             <button onclick="abrirPopupApagarPorData()" class="w-full py-3 rounded-lg font-bold bg-red-50 text-red-600 border border-red-100 hover:bg-red-100 text-xs flex items-center justify-center gap-2 transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                </svg>
                <span>Apagar Registros (Nuvem)</span>
            </button>
        </div>
    </div>
    <div id="historico_lista" class="space-y-4"></div>`;
    
    await mostrarHistorico();
}



        
        async function salvarOSnoHistorico(serviceId) {
            const servico = servicos.find(s => s.id === serviceId);
            if (!servico || !servico.texto) return;

            // Garante campos de filtro para indexa√ß√£o correta
            const frenteInput = document.getElementById("frente");
            const turnoInput = document.getElementById("turnoLetra");
            
            // Se a frente n√£o estiver carregada, tenta pegar do servi√ßo ou define padr√£o
            const frenteValor = frenteInput && frenteInput.value ? frenteInput.value.trim() : "FRENTE INDEFINIDA";
            const turnoValor = turnoInput && turnoInput.value ? turnoInput.value : "A";

            try {
                // Tenta buscar item existente para manter status/osNumero
                let dadosAntigos = {};
                try {
                    const itemExistente = await dbExec(STORE_HISTORICO, 'readonly', s => s.get(servico.id));
                    if (itemExistente) dadosAntigos = itemExistente;
                } catch (e) { /* Novo registro */ }

                const itemHistorico = {
                    uniqueId: servico.id, // ID Num√©rico como chave prim√°ria
                    id: servico.id,
                    
                    // Filtros Cruciais
                    frente: frenteValor,
                    turno: turnoValor,

                    // Dados do Servi√ßo
                    frota: servico.frota,
                    tipo: servico.tipo,
                    texto: servico.texto,
                    descricao: servico.descricao || "",
                    atividade: servico.atividade,
                    sistema: servico.sistema,
                    subsistema: servico.subsistema || "",
                    inicio: servico.inicio,
                    fim: servico.fim,
                    dataOS: servico.data,
                    
                    // Metadados
                    dataKey: formatarDataParaExibicao(servico.data).replace(/\//g, '-'),
                    status: dadosAntigos.status || "pendente",
                    osNumero: dadosAntigos.osNumero || "",
                    datahoraRegistro: dadosAntigos.datahoraRegistro || new Date().toLocaleString('pt-BR'),
                    atualizadoEm: new Date().toISOString()
                };

                // 1. Salva LOCALMENTE (Prioridade M√°xima)
                await dbExec(STORE_HISTORICO, 'readwrite', s => s.put(itemHistorico));
                console.log(`‚úÖ O.S. ${servico.id} salva no hist√≥rico local.`);

                // 2. Tenta enviar para a NUVEM (Background)
                firestore.collection('historico_os').doc(String(servico.id)).set(itemHistorico, { merge: true })
                    .catch(err => console.warn("‚ö†Ô∏è Sem rede. Salvo apenas localmente.", err));

                // 3. Se a tela de hist√≥rico estiver aberta, for√ßa atualiza√ß√£o visual
                if (document.getElementById('historico') && !document.getElementById('historico').classList.contains('hidden')) {
                    mostrarHistorico();
                }

            } catch (err) {
                console.error("Erro cr√≠tico ao salvar hist√≥rico:", err);
                showToast("Erro ao salvar O.S. no hist√≥rico.", "error");
            }
        }

// Fun√ß√µes auxiliares para preservar o estado do Popup
function chamarAddFazendaContexto() {
    // 1. Salva o estado atual do popup
    const tempFrente = document.getElementById('popupQuickFrente').value;
    const tempTurno = document.getElementById('popupQuickTurno').value;
    
    // 2. Chama a fun√ß√£o de adicionar passando o callback de retorno
    adicionarNovaFazenda((novaFazenda) => {
        // 3. Reabre o popup restaurando tudo e selecionando a nova fazenda
        verificarContextoHistorico(novaFazenda, tempFrente, tempTurno);
    });
}

function chamarAddFrenteContexto() {
    const tempFazenda = document.getElementById('popupQuickFazenda').value;
    const tempTurno = document.getElementById('popupQuickTurno').value;
    
    adicionarNovaFrente((novaFrente) => {
        verificarContextoHistorico(tempFazenda, novaFrente, tempTurno);
    });
}


async function verificarContextoHistorico(preSelectFazenda = null, preSelectFrente = null, preSelectTurno = null) {
    const fazendaEl = document.getElementById('fazenda');
    const frenteEl = document.getElementById('frente');
    const turnoEl = document.getElementById('turnoLetra');
    
    // Prioridade: 1. Valor passado (retorno do add) -> 2. Valor do input principal -> 3. Vazio
    const fazenda = preSelectFazenda !== null ? preSelectFazenda : (fazendaEl ? fazendaEl.value.trim() : '');
    const frente = preSelectFrente !== null ? preSelectFrente : (frenteEl ? frenteEl.value.trim() : '');
    const turno = preSelectTurno !== null ? preSelectTurno : (turnoEl ? turnoEl.value : '');

    // Se j√° tem tudo (e n√£o estamos no meio de um fluxo de edi√ß√£o for√ßada), libera
    // A verifica√ß√£o 'preSelectFazenda === null' garante que se a fun√ß√£o foi chamada pelo callback (com valor), o popup ABRA mesmo se j√° tiver dados, para confirmar.
    if (preSelectFazenda === null && fazenda && frente && turno) return true;

    // Garantia de Dados (Offline First)
    if (listaFazendas.length === 0 || listaFrentes.length === 0) {
        try {
            const [fazendasDB, frentesDB] = await Promise.all([
                dbExec(STORE_FAZENDAS, 'readonly', s => s.getAll()),
                dbExec(STORE_FRENTES, 'readonly', s => s.getAll())
            ]);
            listaFazendas = fazendasDB || [];
            listaFrentes = frentesDB || [];
            // Ordena√ß√£o
            listaFazendas.sort((a, b) => a.nome.localeCompare(b.nome));
            listaFrentes.sort((a, b) => a.nome.localeCompare(b.nome));
        } catch (e) { console.warn(e); }
    }

    // --- GERA√á√ÉO DAS LISTAS ---
    let htmlOptionsFazenda = '<option value="">Selecione...</option>';
    listaFazendas.forEach(f => {
        htmlOptionsFazenda += `<option value="${f.nome}" ${f.nome === fazenda ? 'selected' : ''}>${f.nome}</option>`;
    });

    let htmlOptionsFrente = '<option value="">Selecione...</option>';
    listaFrentes.forEach(f => {
        htmlOptionsFrente += `<option value="${f.nome}" ${f.nome === frente ? 'selected' : ''}>${f.nome}</option>`;
    });

    // --- CONTE√öDO DO POPUP ---
    const conteudo = `
        <div class="text-center space-y-4">
            <div class="bg-blue-50 p-3 rounded-full w-14 h-14 flex items-center justify-center mx-auto mb-2">
                <span class="text-2xl">üìç</span>
            </div>
            <p class="text-sm text-gray-600 px-2">
                Confirme sua localiza√ß√£o para carregar os dados.
            </p>
            
            <div class="text-left space-y-3 bg-gray-50 p-4 rounded-xl border border-gray-200">
                
                <div>
                    <label class="block text-[10px] font-bold text-gray-500 uppercase mb-1">Fazenda</label>
                    <div class="flex gap-2">
                        <select id="popupQuickFazenda" class="w-full p-2 border border-gray-300 rounded-lg font-bold text-gray-700 text-sm focus:ring-2 focus:ring-blue-500 outline-none bg-white">
                            ${htmlOptionsFazenda}
                        </select>
                        <button onclick="chamarAddFazendaContexto()" class="bg-green-100 text-green-700 hover:bg-green-200 p-2 rounded-lg border border-green-200 transition-colors shrink-0" title="Nova Fazenda">
                            <span class="font-bold text-lg leading-none">+</span>
                        </button>
                    </div>
                </div>

                <div>
                    <label class="block text-[10px] font-bold text-gray-500 uppercase mb-1">Frente de Trabalho</label>
                    <div class="flex gap-2">
                        <select id="popupQuickFrente" class="w-full p-2 border border-gray-300 rounded-lg font-bold text-gray-700 text-sm focus:ring-2 focus:ring-blue-500 outline-none bg-white">
                            ${htmlOptionsFrente}
                        </select>
                        <button onclick="chamarAddFrenteContexto()" class="bg-green-100 text-green-700 hover:bg-green-200 p-2 rounded-lg border border-green-200 transition-colors shrink-0" title="Nova Frente">
                            <span class="font-bold text-lg leading-none">+</span>
                        </button>
                    </div>
                </div>

                <div>
                    <label class="block text-[10px] font-bold text-gray-500 uppercase mb-1">Turno</label>
                    <select id="popupQuickTurno" class="w-full p-2 border border-gray-300 rounded-lg font-bold text-gray-700 text-sm focus:ring-2 focus:ring-blue-500 outline-none bg-white">
                        <option value="">Selecione...</option>
                        <option value="A" ${turno === 'A' ? 'selected' : ''}>TURNO A</option>
                        <option value="B" ${turno === 'B' ? 'selected' : ''}>TURNO B</option>
                        <option value="C" ${turno === 'C' ? 'selected' : ''}>TURNO C</option>
                    </select>
                </div>

            </div>
        </div>
    `;

    abrirPopup('Configura√ß√£o Inicial', conteudo, [
        { 
            texto: 'Salvar e Acessar', 
            classe: 'bg-blue-600 text-white w-full py-3 rounded-lg shadow-md hover:bg-blue-700 font-bold', 
            acao: () => {
                const faz = document.getElementById('popupQuickFazenda').value;
                const fre = document.getElementById('popupQuickFrente').value;
                const tur = document.getElementById('popupQuickTurno').value;

                if (!faz || !fre || !tur) {
                    showToast("Preencha todos os campos!", "error");
                    return false; // Mant√©m aberto
                }

                if(fazendaEl) fazendaEl.value = faz;
                if(frenteEl) frenteEl.value = fre;
                if(turnoEl) turnoEl.value = tur;

                salvarDadosParciaisTurno();
                iniciarSincronizacaoHistorico();
                
                setTimeout(() => mostrarHistorico(), 50);
                
                return true; 
            }
        }
    ]);

    return false; 
}



async function mostrarHistorico() {
        // --- MUDAN√áA AQUI: Adicionado 'await' ---
    // Agora esperamos a fun√ß√£o verificar se tem dados e carregar as listas se precisar
    if (!(await verificarContextoHistorico())) return; 
    // ----------------------------------------


    const div = document.getElementById("historico_lista");
    if (!div) return;

    div.innerHTML = '<div class="flex justify-center p-8"><div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div></div>';

    try {
        const todosItens = await dbExec(STORE_HISTORICO, 'readonly', s => s.getAll());

        // 1. Filtros (Contexto Atual)
        const frenteInput = document.getElementById('frente');
        const turnoInput = document.getElementById('turnoLetra');
        
        const frenteSelecionada = frenteInput ? frenteInput.value.trim() : "";
        const turnoSelecionado = turnoInput ? turnoInput.value : "";
        
        // 2. Filtragem R√çGIDA
        const itensFiltrados = todosItens.filter(item => {
            const itemFrente = item.frente ? item.frente.trim() : "";
            const itemTurno = item.turno || "";
            return itemFrente === frenteSelecionada && itemTurno === turnoSelecionado;
        });

        if (itensFiltrados.length === 0) {
            div.innerHTML = `
                <div class="text-center p-8 bg-gray-50 rounded-lg border-2 border-dashed border-gray-200">
                    <p class="text-gray-400 font-bold">Nenhum registro encontrado.</p>
                </div>`;
            return;
        }

        // 3. Agrupamento
        const agrupado = itensFiltrados.reduce((acc, item) => {
            const dataKey = item.dataOS || "Sem Data";
            if (!acc[dataKey]) acc[dataKey] = [];
            acc[dataKey].push(item);
            return acc;
        }, {});

        const datasOrdenadas = Object.keys(agrupado).sort((a, b) => b.localeCompare(a));

        // 4. Renderiza√ß√£o (SEU DESIGN)
        div.innerHTML = datasOrdenadas.map(dataKey => {
            const itensDoDia = agrupado[dataKey].sort((a, b) => (b.inicio || "").localeCompare(a.inicio || ""));
            
            return `
            <div class="bg-white rounded-lg shadow-sm mb-5 overflow-hidden border border-gray-200">
                <div class="bg-blue-50 p-3 border-b border-blue-100 flex justify-between items-center cursor-pointer select-none" 
                     onclick="toggleHistoricoDia('${dataKey}')">
                    <h3 class="text-sm font-bold text-blue-800 flex items-center gap-2">
                        üìÖ ${formatarDataParaExibicao(dataKey)}
                        <span class="bg-white text-blue-800 text-[10px] font-extrabold px-2 py-0.5 rounded-full shadow-sm border border-blue-100">${itensDoDia.length}</span>
                    </h3>
                    <span id="toggler-dia-${dataKey}" class="text-blue-400 font-bold text-lg transition-transform">&#9660;</span>
                </div>
                
                <div id="historico-dia-${dataKey}" class="p-2 bg-gray-50 space-y-3">
                    ${itensDoDia.map(s => {
                        const isFinalizada = s.status === 'finalizada';
                        const bordaLateral = isFinalizada ? 'border-green-500' : 'border-yellow-500';
                        // Usa uniqueId se existir (novo padr√£o), sen√£o usa id (legado)
                        const safeId = s.uniqueId || s.id;

                        const infoTecnica = [
                            (s.atividade || "N/A").split(' - ')[0],
                            s.sistema || "?",
                            (s.subsistema || "?").split(' - ')[0]
                        ].join(' <span class="text-gray-300 font-light mx-1">|</span> ');

                        return `
                        <div class="bg-white rounded-lg shadow-sm border border-gray-200 border-l-[6px] ${bordaLateral} p-3 relative">
                            
                            <div class="flex justify-between items-start mb-2">
                                <div>
                                    <span class="text-lg font-black text-blue-700 tracking-tight block leading-none">
                                        ${safeText(s.frota)}
                                    </span>
                                    <div class="text-[11px] font-bold text-gray-500 mt-1 uppercase tracking-wide">
                                        ${infoTecnica}
                                    </div>
                                </div>
                                <div class="text-right">
                                    <span class="text-[10px] font-bold text-gray-500 bg-gray-100 px-2 py-1 rounded border border-gray-200">
                                        üïë ${safeText(s.inicio)} - ${safeText(s.fim)}
                                    </span>
                                </div>
                            </div>

                            <div class="mb-3">
                                <p class="text-xs text-gray-600 italic bg-gray-50 p-2 rounded border border-gray-100 line-clamp-3">
                                    "${safeText(s.descricao)}"
                                </p>
                            </div>

                            <div class="flex items-center justify-between pt-2 border-t border-gray-100 gap-2">
                                <div class="flex items-center gap-2 flex-grow">
                                    <span class="text-[10px] font-bold text-gray-500 uppercase">N¬∫ O.S:</span>
                                    <div class="relative flex items-center">
                                        <input type="number" 
                                            id="os_input_${safeId}" 
                                            class="w-24 p-1.5 pl-2 text-sm font-bold text-gray-800 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 outline-none transition-all disabled:bg-gray-50 disabled:text-gray-500" 
                                            placeholder="PENDENTE" 
                                            value="${safeText(s.osNumero || "")}" 
                                            oninput="validarOSInput(${safeId})" 
                                            ${isFinalizada ? "disabled" : ""}>
                                        
                                        ${!isFinalizada 
                                            ? `<button id="btnFinalizarOS_${safeId}" onclick="finalizarOS(${safeId})" class="ml-1 bg-blue-600 hover:bg-blue-700 text-white px-3 py-1.5 rounded text-xs font-bold shadow-sm disabled:opacity-50 disabled:cursor-not-allowed transition-colors" disabled>OK</button>` 
                                            : `` 
                                        }
                                    </div>
                                    ${isFinalizada ? `<span class="text-[10px] font-bold text-green-600 border border-green-200 bg-green-50 px-2 py-1 rounded flex items-center gap-1">‚úî OK</span>` : ''}
                                </div>

                                <button onclick="toggleBotoesHistorico(${safeId})" class="flex items-center gap-1 bg-gray-100 hover:bg-gray-200 text-gray-700 border border-gray-300 px-3 py-1.5 rounded text-xs font-bold transition-all active:scale-95">
                                    <span>‚öôÔ∏è A√ß√µes</span>
                                </button>
                            </div>

                            <div id="botoes-historico-${safeId}" class="hidden mt-3 pt-3 border-t border-dashed border-gray-300 grid grid-cols-3 gap-2 animate-fade-in">
                                <button onclick="copiarHistorico(${safeId})" class="flex flex-col items-center justify-center p-2 bg-gray-50 hover:bg-white border border-gray-200 rounded text-gray-600 hover:text-blue-600 transition-colors">
                                    <span class="text-lg mb-1">üìã</span>
                                    <span class="text-[9px] font-bold uppercase">Copiar</span>
                                </button>
                                <button onclick="compartilharHistorico(${safeId})" class="flex flex-col items-center justify-center p-2 bg-green-50 hover:bg-white border border-green-200 rounded text-green-700 hover:text-green-800 transition-colors">
                                    <span class="text-lg mb-1">üì±</span>
                                    <span class="text-[9px] font-bold uppercase">Enviar Wtzp</span>
                                </button>
                                <button onclick="excluirHistoricoItem(${safeId})" class="flex flex-col items-center justify-center p-2 bg-red-50 hover:bg-white border border-red-200 rounded text-red-700 hover:text-red-800 transition-colors">
                                    <span class="text-lg mb-1">üóëÔ∏è</span>
                                    <span class="text-[9px] font-bold uppercase">Excluir</span>
                                </button>
                                ${isFinalizada ? `
                                <button onclick="habilitarEdicaoOS(${safeId}, this)" class="col-span-3 mt-1 flex items-center justify-center gap-2 p-2 bg-yellow-50 border border-yellow-200 rounded text-yellow-700 font-bold text-xs hover:bg-yellow-100">
                                    ‚úèÔ∏è Editar N√∫mero da O.S.
                                </button>` : ''}
                            </div>
                            
                            <textarea id="texto_os_hist_${safeId}" class="hidden">${safeText(s.texto)}</textarea>
                        </div>
                        `;
                    }).join('')}
                </div>
            </div>`;
        }).join('');

    } catch (e) {
        console.error(e);
        div.innerHTML = `<p class="text-red-500 text-center p-4 border border-red-200 bg-red-50 rounded-lg">Erro ao ler dados: ${e.message}</p>`;
    }
}

// ============================================================
// L√ìGICA DE LIMPEZA DE HIST√ìRICO (M√äS/DIA)
// ============================================================

async function abrirPopupApagarPorData() {
    const btn = event?.currentTarget;
    const originalText = btn ? btn.innerHTML : "";
    if (btn) {
        btn.innerHTML = "‚è≥ Carregando...";
        btn.disabled = true;
    }

    try {
        const todosItens = await dbExec(STORE_HISTORICO, 'readonly', s => s.getAll());
        const frenteInput = document.getElementById('frente');
        const turnoInput = document.getElementById('turnoLetra');
        const frenteAtual = frenteInput ? frenteInput.value.trim().toUpperCase() : "";
        const turnoAtual = turnoInput ? turnoInput.value.replace("TURNO ", "").trim() : "";

        if (!frenteAtual || !turnoAtual) {
            showToast("Selecione Frente e Turno na tela principal.", "error");
            if(btn) { btn.innerHTML = originalText; btn.disabled = false; }
            return;
        }

        const itensDaEquipe = todosItens.filter(i => {
            const iFrente = (i.frente || "").trim().toUpperCase();
            const iTurno = (i.turno || "").replace("TURNO ", "").trim();
            return iFrente === frenteAtual && iTurno === turnoAtual;
        });

        if (itensDaEquipe.length === 0) {
            alert(`N√£o encontrei registros para:\nFrente: ${frenteAtual}\nTurno: ${turnoAtual}`);
            if(btn) { btn.innerHTML = originalText; btn.disabled = false; }
            return;
        }

        const diasUnicos = [...new Set(itensDaEquipe.map(i => i.dataOS))].sort().reverse();
        const mesesUnicos = [...new Set(diasUnicos.map(d => d.substring(0, 7)))].sort().reverse();

        let listaHTML = `<div class="space-y-3 max-h-[60vh] overflow-y-auto custom-scrollbar pr-1">`;

        // 1. BLOCO DE MESES
        if (mesesUnicos.length > 0) {
            listaHTML += `<div class="text-[10px] font-bold text-gray-400 uppercase tracking-wider mb-1 mt-2 px-1">Apagar M√™s Inteiro</div>`;
            
            mesesUnicos.forEach(mes => {
                const [ano, mesNum] = mes.split('-');
                const qtd = itensDaEquipe.filter(i => i.dataOS.startsWith(mes)).length;
                
                // --- MUDAN√áA AQUI: border-2 para border-4 ---
                listaHTML += `
                <label class="relative block cursor-pointer group">
                    <input type="radio" name="dataExclusao" value="${mes}" class="peer sr-only">
                    <div class="p-3 bg-white border-2 peer-checked:border-4 border-gray-200 rounded-xl transition-all duration-100
                                peer-checked:border-red-500 peer-checked:bg-red-50
                                hover:border-red-200 hover:bg-gray-50 flex justify-between items-center">
                        <div>
                            <span class="block font-bold text-gray-700 peer-checked:text-red-700">M√äS: ${mesNum}/${ano}</span>
                            <span class="text-xs text-gray-500 peer-checked:text-red-500 font-medium">${qtd} registros</span>
                        </div>
                        <div class="w-6 h-6 rounded-full border-2 peer-checked:border-4 border-gray-300 bg-white peer-checked:border-red-500 peer-checked:bg-red-500 flex items-center justify-center transition-all">
                            <div class="w-2 h-2 bg-white rounded-full opacity-0 peer-checked:opacity-100 transition-opacity"></div>
                        </div>
                    </div>
                </label>`;
            });
        }

        // 2. BLOCO DE DIAS
        listaHTML += `<div class="text-[10px] font-bold text-gray-400 uppercase tracking-wider mb-1 mt-4 px-1">Apagar Dia Espec√≠fico</div>`;
        
        diasUnicos.forEach(dia => {
            const qtd = itensDaEquipe.filter(i => i.dataOS === dia).length;
            
            // --- MUDAN√áA AQUI: border-2 para border-4 ---
            listaHTML += `
            <label class="relative block cursor-pointer group">
                <input type="radio" name="dataExclusao" value="${dia}" class="peer sr-only">
                <div class="p-3 bg-white border-2 peer-checked:border-4 border-gray-200 rounded-xl transition-all duration-100
                            peer-checked:border-red-500 peer-checked:bg-red-50
                            hover:border-red-200 hover:bg-gray-50 flex justify-between items-center">
                    <div class="flex items-center gap-3">
                        <div class="bg-gray-100 text-gray-600 font-bold p-2 rounded-lg text-xs peer-checked:bg-red-200 peer-checked:text-red-800">
                            ${dia.split('-').reverse().slice(0, 2).join('/')}
                        </div>
                        <span class="text-sm font-bold text-gray-600 peer-checked:text-red-700">${qtd} itens</span>
                    </div>
                    <div class="w-5 h-5 rounded-full border-2 peer-checked:border-4 border-gray-300 bg-white peer-checked:border-red-500 peer-checked:bg-red-500 flex items-center justify-center transition-all">
                         <div class="w-1.5 h-1.5 bg-white rounded-full opacity-0 peer-checked:opacity-100 transition-opacity"></div>
                    </div>
                </div>
            </label>`;
        });

        listaHTML += `</div>`; 

        if(btn) { btn.innerHTML = originalText; btn.disabled = false; }

        // Abre o popup
        abrirPopupConfirmar('üóëÔ∏è Central de Limpeza', 
            `<div class="text-left mb-2"><p class="text-sm text-gray-600 mb-3">Selecione o per√≠odo que deseja limpar da <b>${frenteAtual}</b>.</p>${listaHTML}</div>`, 
            async (confirmado) => {
                if (confirmado) {
                    const selecionado = document.querySelector('input[name="dataExclusao"]:checked');
                    
                    if (!selecionado) {
                        showToast("Selecione uma op√ß√£o para apagar.", "error");
                        return false; 
                    }

                    const valorSelecionado = selecionado.value;
                    const isMes = valorSelecionado.length === 7;
                    const label = isMes ? `o M√äS ${valorSelecionado}` : `o dia ${formatarDataParaExibicao(valorSelecionado)}`;
                    const codigo = Math.floor(1000 + Math.random() * 9000);

                    setTimeout(() => {
                        abrirPopupInput(
                            'Confirmar Exclus√£o',
                            `Para apagar <b>${label}</b>, digite <span class="text-red-600 font-black text-lg">${codigo}</span>:`,
                            'C√≥digo...', '',
                            (digitado) => {
                                if (String(digitado) === String(codigo)) {
                                    executarExclusaoEmMassa(valorSelecionado, frenteAtual, turnoAtual);
                                } else if (digitado !== null) {
                                    showToast("C√≥digo incorreto.", "error");
                                }
                            }, 'number'
                        );
                        setTimeout(() => document.getElementById('popup-input-field')?.focus(), 100);
                    }, 200);
                }
            }, "Continuar"
        );

    } catch (e) {
        console.error(e);
        showToast("Erro ao listar.", "error");
        if(btn) { btn.innerHTML = originalText; btn.disabled = false; }
    }
}


async function executarExclusaoEmMassa(criterioData, frente, turno) {
    fecharPopup();
    const modoMes = criterioData.length === 7;
    setTimeout(() => abrirPopupLoading(modoMes ? "Apagando M√™s..." : "Apagando Dia..."), 100);

    try {
        const todos = await dbExec(STORE_HISTORICO, 'readonly', s => s.getAll());
        const itensParaApagar = todos.filter(i => {
            const iFrente = (i.frente || "").trim().toUpperCase();
            const iTurno = (i.turno || "").replace("TURNO ", "").trim();
            const bateuEquipe = (iFrente === frente && iTurno === turno);
            if (!bateuEquipe) return false;
            return modoMes ? i.dataOS && i.dataOS.startsWith(criterioData) : i.dataOS === criterioData;
        });

        if (itensParaApagar.length === 0) {
            setTimeout(() => { fecharPopup(); showToast("Nenhum item encontrado.", "info"); }, 500);
            return;
        }

        const tx = db.transaction(STORE_HISTORICO, 'readwrite');
        const store = tx.objectStore(STORE_HISTORICO);
        itensParaApagar.forEach(item => store.delete(item.uniqueId || item.id));

        tx.oncomplete = async () => {
            const batch = firestore.batch();
            itensParaApagar.forEach(item => {
                const ref = firestore.collection('historico_os').doc(String(item.uniqueId || item.id));
                batch.delete(ref);
            });
            batch.commit().catch(console.warn);

            setTimeout(async () => {
                fecharPopup();
                showToast(`Sucesso! ${itensParaApagar.length} apagados.`, 'success');
                await mostrarHistorico();
            }, 800);
        };
    } catch (e) {
        fecharPopup();
        console.error(e);
        showToast("Erro: " + e.message, "error");
    }
}

// ============================================================
// A√á√ïES DO HIST√ìRICO (SINGLETONS)
// ============================================================

async function finalizarOS(id) {
    const input = document.getElementById(`os_input_${id}`);
    const osNumero = input ? input.value.trim() : "";
    if (!osNumero) { showToast('Digite o n√∫mero da O.S.', 'error'); if(input) input.focus(); return; }

    const btn = document.getElementById(`btnFinalizarOS_${id}`);
    if(btn) { btn.innerText = "‚è≥"; btn.disabled = true; }

    try {
        const idNumerico = parseInt(id);
        const item = await dbExec(STORE_HISTORICO, 'readonly', s => s.get(idNumerico));
        if (item) {
            item.status = 'finalizada';
            item.osNumero = osNumero;
            item.atualizadoEm = new Date().toISOString();
            await dbExec(STORE_HISTORICO, 'readwrite', s => s.put(item));
        }
        showToast('O.S. Finalizada!', 'success');
        await mostrarHistorico();
        firestore.collection('historico_os').doc(String(id)).update({ status: 'finalizada', osNumero }).catch(console.warn);
    } catch (e) {
        console.error(e);
        showToast("Erro ao salvar.", "error");
        if(btn) { btn.innerText = "OK"; btn.disabled = false; }
    }
}

function habilitarEdicaoOS(id, btn) {
    const input = document.getElementById(`os_input_${id}`);
    if (!input) return;
    input.disabled = false;
    input.focus();
    input.classList.add('bg-yellow-50', 'border-yellow-400');
    btn.innerText = 'Salvar';
    btn.onclick = () => confirmarEdicaoOS(id, btn);
}

async function confirmarEdicaoOS(id, btn) {
    const input = document.getElementById(`os_input_${id}`);
    const numero = input ? input.value.trim() : "";
    if (!numero) { showToast("N¬∫ O.S n√£o pode ser vazio.", "error"); input.focus(); return; }
    
    const textoOriginal = btn.innerText;
    btn.disabled = true; btn.innerText = "...";

    try {
        const idNumerico = parseInt(id);
        const item = await dbExec(STORE_HISTORICO, 'readonly', s => s.get(idNumerico));
        if (!item) throw new Error("Item n√£o encontrado.");
        item.osNumero = numero;
        item.atualizadoEm = new Date().toISOString();
        await dbExec(STORE_HISTORICO, 'readwrite', s => s.put(item));
        showToast("N¬∫ O.S atualizado!", 'success');
        await mostrarHistorico();
        firestore.collection('historico_os').doc(String(id)).update({ osNumero: numero, atualizadoEm: item.atualizadoEm }).catch(console.warn);
    } catch (error) {
        showToast("Erro: " + error.message, 'error');
        btn.disabled = false; btn.innerText = textoOriginal;
    }
}

async function excluirHistoricoItem(id) {
    try {
        const idNumerico = parseInt(id);
        const item = await dbExec(STORE_HISTORICO, 'readonly', s => s.get(idNumerico));
        if (!item) { showToast('Item n√£o encontrado.', 'error'); return; }

        const elFrente = document.getElementById('frente');
        const elTurno = document.getElementById('turnoLetra');
        const mf = elFrente ? elFrente.value.trim() : "";
        const mt = elTurno ? elTurno.value : "";

        if ((item.frente||"").trim() !== mf || (item.turno||"") !== mt) {
            abrirPopup("Permiss√£o Negada", `<p class="text-sm">Este item pertence a <b>${item.frente}</b>. Mude seus filtros para gerenciar.</p>`);
            return;
        }

        abrirPopupConfirmar('Excluir Registro', 'Tem certeza? N√£o pode ser desfeito.', async (ok) => {
            if(ok) {
                await dbExec(STORE_HISTORICO, 'readwrite', s => s.delete(idNumerico));
                await mostrarHistorico();
                showToast('Item exclu√≠do.', 'success');
                firestore.collection('historico_os').doc(String(id)).delete().catch(console.warn);
            }
        });
    } catch (e) { console.error(e); }
}

function validarOSInput(id) {
    const input = document.getElementById(`os_input_${id}`);
    const btn = document.getElementById(`btnFinalizarOS_${id}`);
    if (input && btn) {
        btn.disabled = !input.value.trim();
        btn.style.opacity = btn.disabled ? '0.5' : '1';
    }
}

function toggleHistoricoDia(dataKey) {
    const lista = document.getElementById(`historico-dia-${dataKey}`);
    const icon = document.getElementById(`toggler-dia-${dataKey}`);
    if (lista && icon) {
        const hidden = lista.style.display === 'none';
        lista.style.display = hidden ? 'block' : 'none';
        icon.innerHTML = hidden ? '&#9650;' : '&#9660;';
    }
}

function toggleBotoesHistorico(id) {
    const box = document.getElementById(`botoes-historico-${id}`);
    if (box) {
        const hidden = box.classList.contains('hidden');
        hidden ? box.classList.remove('hidden') : box.classList.add('hidden');
        if(hidden) box.style.display = 'grid'; else box.style.display = 'none';
    }
}

// ============================================================
// SINCRONIZA√á√ÉO E MIGRA√á√ÉO (SINGLETONS)
// ============================================================

let unsubscribeHistorico = null;

function iniciarSincronizacaoHistorico() {
    const frente = document.getElementById('frente').value;
    const turno = document.getElementById('turnoLetra').value;
    if (!frente || !turno) return;

    if (unsubscribeHistorico) { unsubscribeHistorico(); unsubscribeHistorico = null; }

    const dataLimite = new Date();
    dataLimite.setDate(dataLimite.getDate() - 90);
    const dataString = dataLimite.toISOString().split('T')[0];

    unsubscribeHistorico = firestore.collection('historico_os')
        .where('frente', '==', frente)
        .where('turno', '==', turno)
        .where('dataOS', '>=', dataString)
        .onSnapshot({ includeMetadataChanges: true }, async (snapshot) => {
            if (snapshot.empty) return;
            const tx = db.transaction(STORE_HISTORICO, 'readwrite');
            const store = tx.objectStore(STORE_HISTORICO);
            let changed = false;

            snapshot.docChanges().forEach(change => {
                const d = change.doc.data();
                d.uniqueId = parseInt(change.doc.id);
                if (change.type === 'added' || change.type === 'modified') { store.put(d); changed = true; }
                if (change.type === 'removed') { store.delete(d.uniqueId); changed = true; }
            });

            tx.oncomplete = () => {
                if (changed && !document.getElementById('historico').classList.contains('hidden')) mostrarHistorico();
            };
        }, console.warn);
}

async function migrarDadosLocaisParaNuvem() {
    await new Promise(r => setTimeout(r, 1500));
    const f = document.getElementById('frente')?.value.trim();
    const t = document.getElementById('turnoLetra')?.value;
    if (!f || !t) return;

    try {
        const todos = await dbExec(STORE_HISTORICO, 'readonly', s => s.getAll());
        const legados = todos.filter(i => !i.frente || !i.turno);
        if (legados.length === 0) return;

        const tx = db.transaction(STORE_HISTORICO, 'readwrite');
        const store = tx.objectStore(STORE_HISTORICO);
        const batch = firestore.batch();

        legados.forEach(i => {
            i.frente = f; i.turno = t; i.migradoEm = new Date().toISOString();
            store.put(i);
            batch.set(firestore.collection('historico_os').doc(String(i.uniqueId || i.id)), i, { merge: true });
        });

        tx.oncomplete = () => {
            if(document.getElementById('historico_lista')) mostrarHistorico();
            batch.commit().catch(console.warn);
            showToast(`Migrados ${legados.length} itens antigos.`, "info");
        };
    } catch(e) { console.error("Erro migra√ß√£o:", e); }
}

// ============================================================
// OUTROS M√ìDULOS (MANTIDOS)
// ============================================================
// (Cole aqui o restante das fun√ß√µes: renderizarEstatisticas, Relatorio, Config, etc)


        async function renderizarSecaoEstatisticas(container) { const maquinasPrincipais = frotasTurno.filter(f => f.tipo === 'maquina'); const totalHorasParadas = calcularHorasParadasCorretivasTotais(); const dmTurnoAtual = calcularDMGeral(maquinasPrincipais, totalHorasParadas); const osHistorico = await dbExec(STORE_HISTORICO, 'readonly', s => s.getAll()); const osPorDia = {}; osHistorico.forEach(item => { const dataKey = item.dataOS.split('-').reverse().join('/'); osPorDia[dataKey] = (osPorDia[dataKey] || 0) + 1; }); const labels = Object.keys(osPorDia).sort((a, b) => new Date(a.split('/').reverse().join('-')) - new Date(b.split('/').reverse().join('-'))).slice(-15); const data = labels.map(label => osPorDia[label]); container.innerHTML = `<div class="bg-white p-4 rounded-lg shadow space-y-6"><h2 class="text-2xl font-semibold text-blue-700 border-b pb-3 mb-6 text-center">Estat√≠sticas do Turno</h2><div class="p-4 border border-gray-200 rounded-lg text-center"><h4 class="text-lg font-semibold text-blue-700 mb-2">DM do Turno Atual</h4><p class="text-4xl font-bold text-green-600">${dmTurnoAtual}%</p><p class="text-sm text-gray-500 mt-1">Base: ${maquinasPrincipais.length} m√°quinas. Considera paradas corretivas de todas as frotas.</p></div><div class="p-4 border border-gray-200 rounded-lg"><h4 class="text-lg font-semibold text-blue-700 mb-3 text-center">O.S. Registradas (√öltimos 15 dias)</h4><canvas id="graficoHistoricoOS"></canvas></div></div>`; const ctx = document.getElementById('graficoHistoricoOS'); if (graficoOS) graficoOS.destroy(); if (ctx) { graficoOS = new Chart(ctx, { type: 'bar', data: { labels, datasets: [{ label: 'N¬∫ de O.S.', data, backgroundColor: 'rgba(37, 99, 235, 0.6)', borderColor: 'rgba(37, 99, 235, 1)', borderWidth: 1 }] }, options: { scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } } } }); } }
        async function renderizarSecaoRelatorio(container) { 
    container.innerHTML = `
    <div class="bg-white p-5 rounded-xl border border-gray-200 shadow-sm mb-6">
        
        <div class="flex items-center gap-3 pb-4 border-b border-gray-100 mb-4">
            <div class="w-10 h-10 rounded-full bg-green-50 text-green-600 flex items-center justify-center shadow-sm">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                </svg>
            </div>
            <h2 class="text-lg font-bold text-gray-800">Relat√≥rio Final</h2>
        </div>

        <div id="aviso_relatorio_desatualizado" class="hidden p-3 mb-4 text-sm text-yellow-800 bg-yellow-50 border border-yellow-200 rounded-lg flex items-center gap-2" role="alert">
            <svg class="w-4 h-4 shrink-0" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/></svg>
            <span class="font-medium">Aten√ß√£o:</span> Dados alterados. Gere o relat√≥rio novamente.
        </div>

        <div class="p-4 bg-gray-50 border border-gray-200 rounded-lg mb-4">
            <h4 class="text-xs font-bold text-gray-400 uppercase mb-2 tracking-wider">Visualiza√ß√£o</h4>
            <div id="relatorio_formatado" class="text-sm text-gray-700 whitespace-pre-line font-mono bg-white p-3 border rounded shadow-sm min-h-[150px]"></div>
            <textarea id="relatorio_bruto" class="hidden mt-1 w-full p-2 border rounded-md font-mono h-64 text-sm"></textarea>
            <input type="hidden" id="relatorio_snapshot">
        </div>

        <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
            <button onclick="gerarRelatorioFinal()" class="py-3 px-4 rounded-lg font-bold bg-blue-600 text-white hover:bg-blue-700 shadow-md transition-transform active:scale-95 flex items-center justify-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" /></svg>
                Gerar Relat√≥rio
            </button>
            <button onclick="compartilharRelatorio()" class="py-3 px-4 rounded-lg font-bold bg-green-600 text-white hover:bg-green-700 shadow-md transition-transform active:scale-95 flex items-center justify-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z" /></svg>
                Enviar WhatsApp
            </button>
            <button onclick="toggleEdicaoRelatorio(this)" class="py-3 px-4 rounded-lg font-bold bg-yellow-500 hover:bg-yellow-600 text-white shadow-sm transition-colors flex items-center justify-center gap-2">
                ‚úèÔ∏è Editar
            </button>
            <button onclick="limparRelatorio()" class="py-3 px-4 rounded-lg font-bold bg-white border border-red-200 text-red-600 hover:bg-red-50 shadow-sm transition-colors flex items-center justify-center gap-2">
                üóëÔ∏è Limpar
            </button>
        </div>
    </div>`; 
    
    // L√≥gica de recupera√ß√£o de dados (Mantida)
    try { 
        const dados = await dbExec(STORE_TURNO, 'readonly', s => s.get(TURNO_ATUAL_ID)); 
        const relatorioSalvo = dados?.relatorio || ''; 
        const snapshotSalvo = dados?.relatorioGeradoComServicos || '[]'; 
        if (relatorioSalvo) { 
            document.getElementById('relatorio_bruto').value = relatorioSalvo; 
            document.getElementById('relatorio_formatado').innerHTML = interpretarMarkdown(relatorioSalvo); 
            document.getElementById('relatorio_snapshot').value = snapshotSalvo; 
            if (snapshotSalvo !== JSON.stringify(servicos)) { 
                document.getElementById('aviso_relatorio_desatualizado').classList.remove('hidden'); 
            } 
        } 
    } catch (e) { console.error("Erro ao carregar relat√≥rio salvo:", e); } 
}


        async function gerarRelatorioFinal() { 
    // 1. Valida√ß√£o B√°sica (Campos Vazios do Turno)
    if (!validarCamposTurnoBasicos()) return; 

    // 2. NOVA VALIDA√á√ÉO ESTRITA: Verifica se existe ALGUM campo vermelho na tela
    const camposComErro = document.querySelectorAll('.campo-invalido');
    if (camposComErro.length > 0) {
        showToast(`Existem ${camposComErro.length} campos com erro (vermelho). Corrija antes de gerar.`, 'error');
        
        // Tenta focar no primeiro erro encontrado para ajudar o usu√°rio
        camposComErro[0].scrollIntoView({ behavior: 'smooth', block: 'center' });
        camposComErro[0].focus();
        return;
    }

    // --- L√≥gica de Gera√ß√£o (Mantida) ---
    const data = document.getElementById("dataTurno").value; 
    const fazenda = document.getElementById("fazenda").value.trim().toUpperCase(); 
    const frente = document.getElementById("frente").value.trim().toUpperCase(); 
    const turnoLetra = document.getElementById("turnoLetra").value; 
    const equipeTexto = equipe.length > 0 ? equipe.map(item => `${item.nome.toUpperCase()} - ${item.matricula}`).join('\n') : "EQUIPE N√ÉO INFORMADA"; 
    
    const servicosGerados = servicos.filter(s => s.texto && s.texto.trim() !== '');

    const maquinasPrincipais = frotasTurno.filter(f => f.tipo === 'maquina'); 
    const horasPlanejadasTotaisGeral = maquinasPrincipais.reduce((soma, f) => soma + (f.horas || 0), 0);
    const horasParadasTotais = calcularHorasParadasCorretivasTotais(servicosGerados);
    const dmGeral = calcularDMGeral(maquinasPrincipais, horasParadasTotais); 
    const mediaHorasPorMaquina = maquinasPrincipais.length > 0 ? (horasPlanejadasTotaisGeral / maquinasPrincipais.length) : 0; 
    
    let relatorio = `*MANUTEN√á√ÉO ${frente} BRACELL*\n\nüìÖ *DATA:* ${formatarDataParaExibicao(data)}\n*FAZENDA:* ${fazenda}\n*FRENTE:* ${frente}\n*TURNO:* ${turnoLetra}\n*EQUIPE:*\n${equipeTexto}\n\n*QTD DE M√ÅQUINAS PRINCIPAIS:* ${maquinasPrincipais.length}\n*HORAS PLANEJADAS (por m√°quina):* ${mediaHorasPorMaquina.toFixed(2).replace('.', ',')}h\n*HORAS PLANEJADAS TOTAIS (m√°quinas):* ${horasPlanejadasTotaisGeral.toFixed(2).replace('.', ',')}h\n*HORAS TOTAIS PARADAS (corretivas):* ${horasParadasTotais.toFixed(2).replace('.', ',')}h (${calcularDuracaoEmHorasMinutos(horasParadasTotais)})\n\nüü¢ *DM DO TURNO:* ${dmGeral}%\n\n--- DETALHAMENTO POR FROTA ---\n`; 
    
    const frotasComServico = [...new Set(servicosGerados.map(s => s.frota))].sort(); 
    
    frotasComServico.forEach(nomeFrota => { 
        const frota = frotasTurno.find(f => f.nome === nomeFrota); 
        if (!frota) return; 
        
        const horasPlanejadasFrota = frota.horas || 0;
        const servicosDaFrotaGerados = servicosGerados.filter(s => s.frota === nomeFrota);
        const horasParadaDaFrota = servicosDaFrotaGerados.filter(s => s.tipo === "CORRETIVA" && s.parada === "sim").reduce((total, s) => total + calcularDuracaoServico(s).horas, 0);
        
        let dmFrota = "100.00"; 
        if (horasPlanejadasFrota > 0) {
            const horasOperando = Math.max(0, horasPlanejadasFrota - horasParadaDaFrota);
            dmFrota = ((horasOperando / horasPlanejadasFrota) * 100).toFixed(2); 
        } else if (horasParadaDaFrota > 0) {
            dmFrota = "0.00"; 
        } 

        relatorio += `\nüöú *${frota.nome.toUpperCase()}* ${getTipoTexto(frota.tipo)}\nHoras Planejada: ${horasPlanejadasFrota.toFixed(2).replace('.', ',')}h\nHoras Parada (Corretivas): ${horasParadaDaFrota.toFixed(2).replace('.', ',')}h (${calcularDuracaoEmHorasMinutos(horasParadaDaFrota)})\n*DM:* ${dmFrota}%\n*RELAT√ìRIO DE SERVI√áOS:*\n\n`; 
        
        servicosDaFrotaGerados.forEach(s => { 
            const duracao = calcularDuracaoServico(s); 
            const codAtiv = (s.atividade || "N/A").split(" - ")[0]; 
            const codSistema = s.sistema || "N/A"; 
            const codSub = (s.subsistema || "N/A").split(" - ")[0]; 
            const emoji = s.tipo === "CORRETIVA" ? "üîß" : (s.tipo === "CONDICIONAL" ? "‚è≥" : "‚ú®"); 
            
            relatorio += `${s.descricao.trim()}\n  (${codAtiv} - ${codSistema} - ${codSub}) ${emoji} [${s.tipo}]\n  ‚è±Ô∏è Dura√ß√£o: ${duracao.texto} (Decimal: ${duracao.horas.toFixed(2).replace('.', ',')}h)\n`; 
            if (s.oportunidade) { relatorio += `Oportunidade: ${s.oportunidade}\n`; } 
            relatorio += '\n'; 
        }); 
    }); 
    
    // Atualiza a tela
    document.getElementById('relatorio_bruto').value = relatorio; 
    document.getElementById('relatorio_formatado').innerHTML = interpretarMarkdown(relatorio); 
    document.getElementById('relatorio_snapshot').value = JSON.stringify(servicos); 
    
    // Esconde o aviso de desatualizado (pois acabamos de atualizar)
    document.getElementById('aviso_relatorio_desatualizado').classList.add('hidden'); 
    
    salvarTudo(true); 
    showToast('Relat√≥rio gerado e validado!', 'success'); 
}


        function calcularDuracaoEmHorasMinutos(horasDecimais) { if (isNaN(horasDecimais) || horasDecimais <= 0) return "0min"; const h = Math.floor(horasDecimais); const m = Math.round((horasDecimais - h) * 60); let texto = ""; if (h > 0) texto += `${h}h `; if (m > 0) texto += `${m}min`; return texto.trim() || "0min"; }
        function compartilharRelatorio() { 
    // 1. Verifica se est√° desatualizado
    const avisoDesatualizado = document.getElementById('aviso_relatorio_desatualizado');
    if (avisoDesatualizado && !avisoDesatualizado.classList.contains('hidden')) {
        showToast("‚ö†Ô∏è O relat√≥rio est√° desatualizado! Clique em 'Gerar Relat√≥rio' primeiro.", "error");
        // Rola a tela at√© o bot√£o de gerar para indicar a a√ß√£o
        document.querySelector('button[onclick="gerarRelatorioFinal()"]').scrollIntoView({ behavior: 'smooth', block: 'center' });
        return;
    }

    // 2. Verifica se tem texto
    const texto = document.getElementById("relatorio_bruto").value; 
    if (!texto.trim()) { 
        showToast("Gere o relat√≥rio primeiro.", "error"); 
        return; 
    } 
    
    // 3. Compartilha
    window.open(`https://wa.me/?text=${encodeURIComponent(texto)}`, "_blank"); 
}

        function renderizarSecaoConfig(container) { 
    container.innerHTML = `
    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200 max-w-2xl mx-auto space-y-6">
        
        <div class="text-center border-b border-gray-100 pb-4">
            <div class="w-16 h-16 bg-gray-50 rounded-full flex items-center justify-center mx-auto mb-3 border border-gray-100">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                    <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                </svg>
            </div>
            <h2 class="text-xl font-bold text-gray-800">Configura√ß√µes</h2>
        </div>

        <div class="space-y-4">
            <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
                <h3 class="text-sm font-bold text-gray-700 mb-3 flex items-center gap-2">
                    üì¶ Cat√°logo de Pe√ßas
                </h3>
                <div class="grid gap-2">
                    <label class="flex items-center justify-center gap-2 bg-white border border-gray-300 hover:bg-gray-50 text-gray-700 py-2.5 px-4 rounded-lg font-bold text-sm cursor-pointer transition-colors">
                        ‚¨ÜÔ∏è Importar Excel
                        <input type="file" class="hidden" accept=".xlsx, .xls" onchange="importarCatalogoExcel(event)">
                    </label>
                    <button onclick="iniciarLimpezaCatalogo()" class="flex items-center justify-center gap-2 bg-white border border-red-200 text-red-600 hover:bg-red-50 py-2.5 px-4 rounded-lg font-bold text-sm transition-colors">
                        üóëÔ∏è Limpar Cat√°logo
                    </button>
                </div>
            </div>

            <div class="bg-blue-50 p-4 rounded-lg border border-blue-100">
                <h3 class="text-sm font-bold text-blue-800 mb-3 flex items-center gap-2">
                    üíæ Backup e Restauro
                </h3>
                <div class="grid gap-2">
                    <button onclick="gerarBackupCompleto()" class="flex items-center justify-center gap-2 bg-blue-600 hover:bg-blue-700 text-white py-2.5 px-4 rounded-lg font-bold text-sm shadow-sm transition-all active:scale-95">
                        ‚¨áÔ∏è Baixar Backup
                    </button>
                    <label class="flex items-center justify-center gap-2 bg-white text-blue-600 border border-blue-200 hover:bg-blue-50 py-2.5 px-4 rounded-lg font-bold text-sm cursor-pointer transition-colors">
                        ‚¨ÜÔ∏è Restaurar Backup
                        <input type="file" class="hidden" accept=".json" onchange="restaurarBackupCompleto(event)">
                    </label>
                </div>
            </div>
            
            <div class="pt-2 text-center">
                <button onclick="resetarAplicacao()" class="text-xs text-red-400 hover:text-red-600 font-bold underline">
                    Resetar Aplicativo (F√°brica)
                </button>
            </div>
        </div>
    </div>`; 
}

        async function limparServicosTurnoAtual() { const confirmado = await new Promise(resolve => abrirPopupConfirmar('Limpar Servi√ßos', 'Tem a certeza que deseja apagar TODOS os servi√ßos do turno atual?', resolve)); if (confirmado) { servicos = []; salvarTudo(); showToast('Servi√ßos do turno atual limpos.', 'success'); if (document.getElementById('servicosLista')) renderizarServicos(); } }
        async function resetarAplicacao() { const confirmado = await new Promise(resolve => abrirPopupConfirmar('Resetar Aplica√ß√£o', '<strong>Aten√ß√£o!</strong><br>Isto apagar√° TODOS os dados. Fa√ßa um backup antes. Deseja continuar?', resolve)); if (confirmado) { try { if (db) db.close(); const deleteRequest = indexedDB.deleteDatabase(DB_NAME); deleteRequest.onsuccess = () => { showToast("Dados resetados. A aplica√ß√£o ser√° recarregada.", 'success'); setTimeout(() => window.location.reload(), 1500); }; deleteRequest.onerror = () => showToast("Erro ao apagar o banco de dados.", 'error'); deleteRequest.onblocked = () => showToast("A exclus√£o foi bloqueada. Feche outras abas desta aplica√ß√£o.", 'error'); } catch (e) { showToast("Erro ao tentar resetar a aplica√ß√£o.", 'error'); } } }
        async function gerarBackupCompleto() { try { const dadosTurno = await dbExec(STORE_TURNO, 'readonly', s => s.get(TURNO_ATUAL_ID)) || {}; const dadosHistorico = await dbExec(STORE_HISTORICO, 'readonly', s => s.getAll()) || []; if (Object.keys(dadosTurno).length <= 1 && dadosHistorico.length === 0) { showToast("Nenhum dado para fazer backup.", 'info'); return; } const dadosParaBackup = { turno: dadosTurno, historico: dadosHistorico }; const blob = new Blob([JSON.stringify(dadosParaBackup, null, 2)], { type: "application/json" }); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = `backup_meuturno_${new Date().toISOString().slice(0, 10)}.json`; a.click(); URL.revokeObjectURL(url); showToast("Backup gerado com sucesso!", 'success'); } catch (err) { showToast("Erro ao gerar o backup.", 'error'); } }
        async function restaurarBackupCompleto(event) { const file = event.target.files[0]; if (!file) return; const confirmado = await new Promise(resolve => abrirPopupConfirmar('Restaurar Backup', '<strong>Aten√ß√£o!</strong><br>Isto substituir√° TODOS os dados atuais. Deseja continuar?', resolve)); if (!confirmado) { event.target.value = null; return; } const reader = new FileReader(); reader.onload = async (e) => { try { const dados = JSON.parse(e.target.result); if (!dados.turno || !dados.historico) throw new Error("Formato de backup inv√°lido."); await dbExec(STORE_TURNO, 'readwrite', s => s.put(dados.turno)); const tx = db.transaction(STORE_HISTORICO, 'readwrite'); const hStore = tx.objectStore(STORE_HISTORICO); hStore.clear(); for (const item of dados.historico) { if (item.uniqueId) delete item.uniqueId; hStore.add(item); } tx.oncomplete = () => { showToast("Backup restaurado! A aplica√ß√£o ser√° recarregada.", 'success'); setTimeout(() => window.location.reload(), 1500); }; tx.onerror = () => { throw new Error("Falha na transa√ß√£o do hist√≥rico."); }; } catch (err) { showToast(`Erro ao restaurar: ${err.message}`, 'error'); } finally { event.target.value = null; } }; reader.readAsText(file); }
        async function forcarLimpezaCacheEAtualizar() { if (!('serviceWorker' in navigator && 'caches' in window)) { showToast("O seu navegador n√£o suporta as APIs necess√°rias.", "error"); return; } const confirmado = await new Promise(resolve => abrirPopupConfirmar('For√ßar Atualiza√ß√£o?', 'Isto ir√° limpar todos os dados em cache da aplica√ß√£o e recarregar a p√°gina. √â √∫til para garantir que as √∫ltimas altera√ß√µes de c√≥digo sejam aplicadas. Deseja continuar?', resolve, 'Sim, Limpar e Recarregar')); if (confirmado) { try { const registrations = await navigator.serviceWorker.getRegistrations(); for (const registration of registrations) { await registration.unregister(); } const cacheNames = await caches.keys(); const cachesToDelete = cacheNames.filter(name => name.startsWith('meu-turno-app-cache-')); await Promise.all(cachesToDelete.map(name => caches.delete(name))); showToast("Cache limpo! A recarregar a aplica√ß√£o...", "success"); setTimeout(() => { window.location.reload(true); }, 1500); } catch (error) { console.error('Erro ao for√ßar a limpeza de cache:', error); showToast("Ocorreu um erro ao tentar limpar o cache.", "error"); } } }

        async function importarCatalogoCSV(event) {
            const file = event.target.files[0];
            if (!file) return;

            const confirmado = await new Promise(resolve =>
                abrirPopupConfirmar('Importar Cat√°logo', 'Tem a certeza de que deseja importar este ficheiro? Itens com o mesmo C√≥digo SAP ser√£o ignorados.', resolve)
            );
            if (!confirmado) {
                event.target.value = '';
                return;
            }

            const reader = new FileReader();
            reader.onload = async (e) => {
                const text = e.target.result;
                try {
                    const itensDoCSV = parseCSV(text);
                    if (itensDoCSV.length === 0) {
                        showToast("Nenhum item v√°lido encontrado no ficheiro CSV.", "error");
                        return;
                    }
                    const codigosSapExistentes = new Set(catalogoLocal.map(item => item.codigoSap));
                    const itensNovos = itensDoCSV.filter(item => !codigosSapExistentes.has(item.codigoSap));

                    if (itensNovos.length === 0) {
                        showToast("Importa√ß√£o conclu√≠da. Nenhum item novo para adicionar.", "success");
                        return;
                    }

                    await enviarLoteParaFirestore(itensNovos);
                    showToast(`Importa√ß√£o conclu√≠da! ${itensNovos.length} de ${itensDoCSV.length} itens foram adicionados.`, "success");

                } catch (error) {
                    showToast(error.message, "error");
                } finally {
                    event.target.value = '';
                }
            };
            // AQUI EST√Å A CORRE√á√ÉO:
            // Trocamos 'latin1' por 'UTF-8' para ler corretamente os caracteres especiais do portugu√™s.
            reader.readAsText(file, 'UTF-8');
        }
        function parseCSV(text) { const lines = text.trim().split(/\r?\n/); if (lines.length < 2) throw new Error("Ficheiro CSV vazio ou sem dados."); const header = lines[0].split(',').map(h => h.trim()); const requiredHeaders = ['codigoSap', 'partNumber', 'descricao']; if (!requiredHeaders.every(h => header.includes(h))) { throw new Error(`Cabe√ßalho inv√°lido. Deve conter: ${requiredHeaders.join(',')}`); } const itens = []; for (let i = 1; i < lines.length; i++) { const values = lines[i].split(','); if (values.length !== header.length) continue; const item = {}; header.forEach((key, index) => { const value = (values[index] || '').trim().replace(/^"|"$/g, ''); item[key] = value; }); if (item.codigoSap || item.partNumber || item.descricao) { itens.push(item); } } return itens; }
        async function exportarCatalogoCSV() { if (catalogoLocal.length === 0) { showToast("Cat√°logo est√° vazio. Nada para exportar.", "info"); return; } try { let csvContent = "codigoSap,partNumber,descricao\n"; catalogoLocal.forEach(item => { const descricao = `"${(item.descricao || '').replace(/"/g, '""')}"`; csvContent += `${item.codigoSap},${item.partNumber},${descricao}\n`; }); const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' }); const url = URL.createObjectURL(blob); const a = document.createElement("a"); a.href = url; a.download = `catalogo_meuturno_${new Date().toISOString().slice(0, 10)}.csv`; a.click(); URL.revokeObjectURL(url); showToast("Cat√°logo exportado com sucesso!", "success"); } catch (error) { console.error("Erro ao exportar cat√°logo:", error); showToast("Ocorreu um erro ao exportar.", "error"); } }
        function iniciarLimpezaCatalogo() { abrirPopupInput('Confirma√ß√£o de Seguran√ßa', 'Para apagar TODO o cat√°logo, por favor, insira a senha:', '********', '', (senha) => { if (senha === null) return; if (senha === SENHA_LIMPEZA_CATALOGO) { executarLimpezaCatalogo(); } else { showToast("Senha incorreta.", "error"); } }, 'password'); }
        async function executarLimpezaCatalogo() { const confirmado = await new Promise(resolve => abrirPopupConfirmar('√öLTIMO AVISO', 'Tem a certeza absoluta de que deseja apagar TODOS os itens do cat√°logo para TODOS os utilizadores? Esta a√ß√£o √© irrevers√≠vel.', resolve, 'Sim, apagar tudo')); if (!confirmado) return; showToast("A iniciar limpeza do cat√°logo... Isto pode demorar.", "info"); try { const querySnapshot = await firestore.collection('catalogo').get(); if (querySnapshot.empty) { showToast("O cat√°logo j√° est√° vazio.", "info"); return; } const batchSize = 499; for (let i = 0; i < querySnapshot.docs.length; i += batchSize) { const lote = querySnapshot.docs.slice(i, i + batchSize); const batch = firestore.batch(); lote.forEach(doc => { batch.delete(doc.ref); }); await batch.commit(); } showToast("Cat√°logo limpo com sucesso!", "success"); } catch (error) { console.error("Erro ao limpar o cat√°logo:", error); showToast("Ocorreu um erro durante a limpeza.", "error"); } }
        async function importarCatalogoExcel(event) { const file = event.target.files[0]; if (!file) return; const confirmado = await new Promise(resolve => abrirPopupConfirmar('Importar Cat√°logo', 'Tem a certeza de que deseja importar este ficheiro Excel? Itens com o mesmo C√≥digo SAP ser√£o ignorados.', resolve)); if (!confirmado) { event.target.value = ''; return; } abrirPopupLoading("A ler o ficheiro Excel. Por favor, aguarde..."); const reader = new FileReader(); reader.onload = async (e) => { try { await new Promise(resolve => setTimeout(resolve, 50)); const data = new Uint8Array(e.target.result); const workbook = XLSX.read(data, { type: 'array' }); const firstSheetName = workbook.SheetNames[0]; const worksheet = workbook.Sheets[firstSheetName]; const itensDoExcel = XLSX.utils.sheet_to_json(worksheet, { header: ["codigoSap", "partNumber", "descricao"], defval: "" }); if (itensDoExcel.length === 0) { throw new Error("Nenhum item v√°lido encontrado no ficheiro Excel."); } const codigosSapExistentes = new Set(catalogoLocal.map(item => String(item.codigoSap).trim()).filter(sap => sap)); const itensNovos = itensDoExcel.filter(item => { const sap = String(item.codigoSap || '').trim(); return sap && !codigosSapExistentes.has(sap); }); if (itensNovos.length === 0) { showToast("Importa√ß√£o conclu√≠da. Nenhum item novo para adicionar.", "success"); fecharPopup(); return; } document.querySelector('#popupGenerico #popupMensagem').innerHTML = `<p>A enviar ${itensNovos.length} itens novos para a base de dados...</p>`; await enviarLoteParaFirestore(itensNovos); showToast(`Importa√ß√£o conclu√≠da! ${itensNovos.length} itens novos foram adicionados.`, "success"); } catch (error) { showToast(`Erro: ${error.message}`, "error"); } finally { fecharPopup(); event.target.value = ''; } }; reader.readAsArrayBuffer(file); }
        async function enviarLoteParaFirestore(itens) { const batchSize = 499; for (let i = 0; i < itens.length; i += batchSize) { const lote = itens.slice(i, i + batchSize); const batch = firestore.batch(); lote.forEach(item => { const docRef = firestore.collection('catalogo').doc(); const itemData = { codigoSap: item.codigoSap || '', partNumber: item.partNumber || '', descricao: item.descricao || '' }; batch.set(docRef, itemData); }); await batch.commit(); } }
        async function renderizarSecaoCatalogo(container) { 
    try { catalogoLocal = await dbExec('catalogo', 'readonly', s => s.getAll()); } catch (e) { catalogoLocal = []; } 
    
    container.innerHTML = `
    <div class="bg-white p-5 rounded-xl border border-gray-200 shadow-sm">
        <div class="flex items-center gap-3 pb-4 border-b border-gray-100 mb-4">
            <div class="w-10 h-10 rounded-full bg-purple-50 text-purple-600 flex items-center justify-center shadow-sm">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4" />
                </svg>
            </div>
            <h2 class="text-lg font-bold text-gray-800">Cat√°logo de Pe√ßas</h2>
        </div>

        <div class="relative">
            <input type="text" id="buscaCatalogo" oninput="renderizarCatalogo()" 
                placeholder="Buscar SAP, Part Number ou Descri√ß√£o..." 
                class="w-full pl-10 p-3 border border-gray-300 rounded-lg mb-2 focus:ring-2 focus:ring-purple-500 outline-none bg-gray-50 text-sm">
            <div class="absolute left-3 top-3.5 text-gray-400">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg>
            </div>
        </div>
        <div id="listaCatalogo" class="space-y-2 mt-4"></div>
    </div>`; 
    renderizarCatalogo(); 
}


        function renderizarCatalogo() {
            const listaDiv = document.getElementById('listaCatalogo');
            if (!listaDiv) return;

            // 1. Pega o termo de busca, converte para min√∫sculas E remove os acentos.
            const termoBusca = removerAcentos(document.getElementById('buscaCatalogo').value.toLowerCase());

            const itensFiltrados = catalogoLocal.filter(item => {
                // Converte para String para evitar erros caso os dados venham como n√∫meros
                const codigoSap = String(item.codigoSap || '').toLowerCase();
                const partNumber = String(item.partNumber || '').toLowerCase();

                // 2. Converte a descri√ß√£o do item para min√∫sculas E remove os acentos antes de comparar.
                const descricaoNormalizada = removerAcentos(String(item.descricao || '').toLowerCase());

                return (codigoSap.includes(termoBusca) || partNumber.includes(termoBusca) || descricaoNormalizada.includes(termoBusca));
            });

            if (itensFiltrados.length === 0) {
                listaDiv.innerHTML = `<p class="text-center text-gray-500 py-4">Nenhum item encontrado.</p>`;
                return;
            }

            itensFiltrados.sort((a, b) => (a.descricao || '').localeCompare(b.descricao || ''));
            listaDiv.innerHTML = itensFiltrados.map(item => `<div class="border rounded-lg p-3 flex justify-between items-center transition-all duration-200 hover:bg-gray-50"><div class="flex-1 min-w-0"><p class="font-bold text-gray-800 truncate">${item.descricao}</p><p class="text-sm text-gray-600">SAP: <span class="font-semibold text-blue-700">${item.codigoSap}</span></p><p class="text-sm text-gray-600">Part Number: <span class="font-semibold">${item.partNumber}</span></p></div><div class="flex space-x-2 pl-2"><button onclick="editarItemCatalogo('${item.docId}')" class="p-2 text-yellow-600 hover:bg-yellow-100 rounded-full" title="Editar">‚úèÔ∏è</button><button onclick="excluirItemCatalogo('${item.docId}')" class="p-2 text-red-600 hover:bg-red-100 rounded-full" title="Excluir">üóëÔ∏è</button></div></div>`).join('');
        }
        function abrirPopupFormularioItemCatalogo(item = null) { const isEditing = item !== null; const titulo = isEditing ? 'Editar Item do Cat√°logo' : 'Adicionar Novo Item'; const docId = item?.docId || ''; const codigoSap = item?.codigoSap || ''; const partNumber = item?.partNumber || ''; const descricao = item?.descricao || ''; const conteudoPopup = `<input type="hidden" id="popup-docId" value="${docId}"><div class="space-y-3 text-left"><div><label for="popup-sap" class="block text-sm font-medium text-gray-700">C√≥digo SAP</label><input type="text" id="popup-sap" class="mt-1 w-full p-2 border rounded-md" value="${codigoSap}" placeholder="C√≥digo SAP (opcional)"></div><div><label for="popup-partnumber" class="block text-sm font-medium text-gray-700">Part Number</label><input type="text" id="popup-partnumber" class="mt-1 w-full p-2 border rounded-md" value="${partNumber}" placeholder="Part number (opcional)"></div><div><label for="popup-descricao" class="block text-sm font-medium text-gray-700">Descri√ß√£o</label><textarea id="popup-descricao" class="mt-1 w-full p-2 border rounded-md h-24" placeholder="Descri√ß√£o da pe√ßa (opcional)">${descricao}</textarea></div></div>`; const botoes = [{ texto: 'Salvar', classe: 'bg-blue-600 text-white hover:bg-blue-700', acao: () => salvarItemCatalogo() }, { texto: 'Cancelar', classe: 'bg-gray-300 text-gray-800 hover:bg-gray-400', acao: fecharPopup }]; abrirPopup(titulo, `<div>${conteudoPopup}</div>`, botoes); }
        async function salvarItemCatalogo() { const docId = document.getElementById('popup-docId').value; const codigoSap = document.getElementById('popup-sap').value.trim(); const partNumber = document.getElementById('popup-partnumber').value.trim(); const descricao = document.getElementById('popup-descricao').value.trim(); if (!codigoSap && !partNumber && !descricao) { showToast("Preencha pelo menos um campo para salvar o item.", "error"); return; } const itemData = { codigoSap, partNumber, descricao }; try { if (docId) { await firestore.collection('catalogo').doc(docId).update(itemData); showToast("Item atualizado com sucesso!", "success"); } else { await firestore.collection('catalogo').add(itemData); showToast("Item adicionado com sucesso!", "success"); } fecharPopup(); } catch (error) { console.error("Erro ao salvar item no Firebase:", error); showToast("Erro ao salvar o item.", "error"); } }
        function editarItemCatalogo(docId) { const item = catalogoLocal.find(i => i.docId === docId); if (item) { abrirPopupFormularioItemCatalogo(item); } else { showToast("Item n√£o encontrado para edi√ß√£o.", "error"); } }
        async function excluirItemCatalogo(docId) { const item = catalogoLocal.find(i => i.docId === docId); const itemIdentifier = item?.descricao || item?.codigoSap || item?.partNumber || docId; const confirmado = await new Promise(resolve => abrirPopupConfirmar('Excluir Item', `Tem a certeza que deseja excluir o item <strong>${itemIdentifier}</strong>?`, resolve)); if (confirmado) { try { await firestore.collection('catalogo').doc(docId).delete(); showToast("Item exclu√≠do com sucesso!", "success"); } catch (error) { console.error("Erro ao excluir item no Firebase:", error); showToast("Erro ao excluir o item.", "error"); } } }
        function calcularDuracaoServico(servico) { if (!servico.inicio || !servico.fim || !servico.data || !servico.dataFinal) return { horas: 0, texto: "0min" }; const inicio = new Date(`${servico.data}T${servico.inicio}`); const fim = new Date(`${servico.dataFinal}T${servico.fim}`); if (isNaN(inicio.getTime()) || isNaN(fim.getTime()) || fim < inicio) return { horas: 0, texto: "Inv√°lido" }; const diffMin = (fim - inicio) / 60000; const h = Math.floor(diffMin / 60); const m = Math.round(diffMin % 60); let texto = ""; if (h > 0) texto += `${h}h `; if (m > 0) texto += `${m}min`; return { horas: diffMin / 60, texto: texto.trim() || "0min" }; }
        // MODIFICADO: Agora aceita uma lista de servi√ßos como argumento (padr√£o para todos)
function calcularHorasParadasCorretivasTotais(listaServicos = servicos) { 
    return listaServicos.filter(s => s.tipo === "CORRETIVA" && s.parada === "sim").reduce((total, s) => total + calcularDuracaoServico(s).horas, 0); 
}
        // MODIFICADO: Chamada para usar a nova vers√£o de calcularHorasParadasCorretivasTotais
function calcularDMGeral(maquinas, horasParadasTotais) { 
    const horasPlanejadasTotais = maquinas.reduce((soma, f) => soma + f.horas, 0); 
    if (horasPlanejadasTotais === 0) return maquinas.length > 0 ? "0.00" : "100.00"; 
    const horasOperandoTotais = Math.max(0, horasPlanejadasTotais - horasParadasTotais); 
    return ((horasOperandoTotais / horasPlanejadasTotais) * 100).toFixed(2); 
}

        // =================================================================================
        // 8. SINCRONIZA√á√ÉO COM FIREBASE
        // =================================================================================
        let monitoramentoCatalogoIniciado = false; // Vari√°vel de controle global

function sincronizarCatalogoPecas() {
    // SE j√° estiver monitorando, N√ÉO faz nada (Economiza leituras!)
    if (monitoramentoCatalogoIniciado) return;

    console.log("Iniciando download do cat√°logo de pe√ßas...");
    monitoramentoCatalogoIniciado = true; // Marca como iniciado

    firestore.collection('catalogo').onSnapshot(async (snapshot) => {
        // ... (seu c√≥digo existente de salvar no IndexedDB) ...
        const tx = db.transaction('catalogo', 'readwrite');
        const store = tx.objectStore('catalogo');
        let houveMudanca = false;
        
        // Dica de economia: Se for apenas metadados (fromCache), n√£o conta leitura
        if (snapshot.metadata.fromCache) console.log("Lendo do cache local");

        for (const change of snapshot.docChanges()) {
            houveMudanca = true;
            const item = { ...change.doc.data(), docId: change.doc.id };
            if (change.type === 'added' || change.type === 'modified') { store.put(item); }
            if (change.type === 'removed') { store.delete(item.docId); }
        }
        tx.oncomplete = async () => {
            if (houveMudanca) {
                catalogoLocal = await dbExec('catalogo', 'readonly', s => s.getAll());
                // S√≥ renderiza se a tela de cat√°logo estiver vis√≠vel
                if (document.getElementById('catalogo')?.classList.contains('hidden') === false) {
                    renderizarCatalogo();
                }
            }
        };
    }, (error) => { 
        console.error("Erro catalogo:", error); 
        monitoramentoCatalogoIniciado = false; // Reseta em caso de erro para tentar de novo
    });
}


        let monitoramentoFrotasIniciado = false; // Nova vari√°vel de controle

function sincronizarCatalogoFrotas() {
    // Se j√° iniciou, para aqui (Economia!)
    if (monitoramentoFrotasIniciado) return;

    console.log("Iniciando download do cat√°logo de frotas...");
    monitoramentoFrotasIniciado = true;

    firestore.collection('catalogoFrotas').onSnapshot(async (snapshot) => {
        const tx = db.transaction(STORE_FROTAS, 'readwrite');
        const store = tx.objectStore(STORE_FROTAS);
        let houveMudanca = false;
        
        if (snapshot.metadata.fromCache) console.log("Frotas: Lendo do cache local");

        for (const change of snapshot.docChanges()) {
            houveMudanca = true;
            const item = { ...change.doc.data(), docId: change.doc.id };
            if (change.type === 'added' || change.type === 'modified') { store.put(item); }
            if (change.type === 'removed') { store.delete(item.docId); }
        }
        tx.oncomplete = async () => {
            if (houveMudanca) {
                catalogoFrotas = await dbExec(STORE_FROTAS, 'readonly', s => s.getAll());
                // Atualiza a lista visual se a tela de frotas estiver aberta
                if (document.getElementById('frotas')?.classList.contains('hidden') === false) {
                    renderizarCatalogoFrotas();
                }
            }
        };
    }, (error) => { 
        console.error("Erro Frotas:", error); 
        monitoramentoFrotasIniciado = false; // Reseta em caso de erro
    });
}


    </script>
  <div id="modalOnboarding" class="fixed inset-0 bg-black bg-opacity-90 z-[10002] hidden flex items-center justify-center p-4 backdrop-blur-sm">
    <div class="bg-white rounded-2xl shadow-2xl max-w-sm w-full overflow-hidden relative">
        
        <div id="slide1" class="p-6 text-center space-y-4">
            <div class="w-20 h-20 bg-blue-100 rounded-full flex items-center justify-center mx-auto text-4xl shadow-sm">‚òÅÔ∏è</div>
            <h2 class="text-xl font-bold text-gray-800">Seus dados na Nuvem!</h2>
            <p class="text-sm text-gray-600 leading-relaxed">
                N√£o se preocupe em perder o celular. Todas as suas O.S. e apontamentos agora s√£o salvos automaticamente no servidor seguro.
            </p>
            <button onclick="proximoSlide(2)" class="w-full py-3 bg-blue-600 text-white rounded-xl font-bold mt-4 shadow-lg hover:bg-blue-700 transition-transform active:scale-95">
                Pr√≥ximo
            </button>
        </div>

        <div id="slide2" class="p-6 text-center space-y-4 hidden">
            <div class="w-20 h-20 bg-indigo-100 rounded-full flex items-center justify-center mx-auto text-4xl shadow-sm">üîç</div>
            <h2 class="text-xl font-bold text-gray-800">Hist√≥rico Inteligente</h2>
            <p class="text-sm text-gray-600 leading-relaxed">
                A aba <strong>Hist√≥rico</strong> s√≥ mostra as O.S. da <strong>FRENTE</strong> e <strong>TURNO</strong> que voc√™ selecionou no topo da tela.
            </p>
            <div class="bg-indigo-50 p-3 rounded-lg border border-indigo-100 text-xs text-indigo-800 font-medium">
                üí° Dica: Se o hist√≥rico parecer vazio, verifique se a Frente selecionada √© a correta!
            </div>
            
            <div class="grid grid-cols-3 gap-3 mt-4">
                <button onclick="proximoSlide(1)" class="col-span-1 py-3 bg-gray-100 text-gray-600 rounded-xl font-bold hover:bg-gray-200 transition-colors">
                    Voltar
                </button>
                <button onclick="proximoSlide(3)" class="col-span-2 py-3 bg-blue-600 text-white rounded-xl font-bold shadow-lg hover:bg-blue-700 transition-transform active:scale-95">
                    Entendi
                </button>
            </div>
        </div>

        <div id="slide3" class="p-6 text-center space-y-4 hidden">
            <div class="w-20 h-20 bg-red-100 rounded-full flex items-center justify-center mx-auto text-4xl shadow-sm">üõ°Ô∏è</div>
            <h2 class="text-xl font-bold text-gray-800">Seguran√ßa Total</h2>
            <p class="text-sm text-gray-600 leading-relaxed">
                O sistema √© colaborativo, mas protegido. Voc√™ n√£o poder√° apagar ou editar O.S. criadas por outras Frentes ou Turnos.
            </p>
            
            <div class="grid grid-cols-3 gap-3 mt-4">
                <button onclick="proximoSlide(2)" class="col-span-1 py-3 bg-gray-100 text-gray-600 rounded-xl font-bold hover:bg-gray-200 transition-colors">
                    Voltar
                </button>
                <button onclick="proximoSlide(4)" class="col-span-2 py-3 bg-blue-600 text-white rounded-xl font-bold shadow-lg hover:bg-blue-700 transition-transform active:scale-95">
                    Ok, Pr√≥ximo
                </button>
            </div>
        </div>

        <div id="slide4" class="p-6 text-center space-y-4 hidden">
            <div class="w-20 h-20 bg-green-100 rounded-full flex items-center justify-center mx-auto text-4xl shadow-sm">üöÄ</div>
            <h2 class="text-xl font-bold text-gray-800">Tudo Pronto!</h2>
            <p class="text-sm text-gray-600">
                Lembre-se de sempre clicar em <strong>"Gerar O.S."</strong> para salvar seu servi√ßo.
            </p>
            
            <div class="bg-gray-50 p-3 rounded-lg border border-gray-200 text-xs text-left mt-2">
                <label class="flex items-start gap-3 cursor-pointer select-none">
                    <input type="checkbox" id="checkTermos" class="mt-0.5 w-5 h-5 text-blue-600 rounded focus:ring-blue-500 border-gray-300">
                    <span class="text-gray-500 font-medium">Declaro que li e entendi como usar o hist√≥rico e os filtros.</span>
                </label>
            </div>

            <div class="grid grid-cols-3 gap-3 mt-4">
                <button onclick="proximoSlide(3)" class="col-span-1 py-3 bg-gray-100 text-gray-600 rounded-xl font-bold hover:bg-gray-200 transition-colors">
                    Voltar
                </button>
                <button id="btnConcluirOnboarding" onclick="concluirOnboarding()" disabled class="col-span-2 py-3 bg-gray-300 text-gray-500 rounded-xl font-bold cursor-not-allowed transition-all shadow-none">
                    Come√ßar
                </button>
            </div>
        </div>

    </div>
</div>



</body>

</html>
