<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="manifest" href="./manifest.json">
    <meta name="theme-color" content="#007acc">
    <title>Meu Turno</title>
    <style>
        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            font-family: sans-serif;
            background: #f3f3f3;
        }

        /* HEADER */
        header {
            background: #007acc;
            color: white;
            padding: 15px;
            text-align: center;
            font-size: 22px;
            font-weight: bold;
            letter-spacing: 1px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            border-bottom: 3px solid #005f99;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        header img {
            height: 35px;
        }

        /* NAVBAR AJUSTADO */
        nav {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            /* 5 bot√µes de tamanhos iguais */
            background: #f4f4f4;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            border-bottom: 1px solid #ccc;
        }

        nav button {
            background: transparent;
            color: #333;
            border: none;
            padding: 10px 0;
            /* Menor espa√ßo interno para caber tudo */
            cursor: pointer;
            font-weight: 600;
            font-size: 13px;
            /* Levemente menor */
            transition: background 0.3s, color 0.3s;
            border-right: 1px solid #ddd;
        }

        nav button:last-child {
            border-right: none;
        }

        nav button:hover {
            background: #eaeaea;
        }

        nav button.active {
            background: #007acc;
            color: white;
        }

        /* SECTIONS */
        section {
            display: none;
            padding: 15px;
        }

        section.active {
            display: block;
        }

        /* GRUPOS */
        .grupo {
            background: white;
            padding: 15px;
            border-radius: 10px;
            margin-top: 10px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        /* CAMPOS */
        input,
        select,
        textarea,
        button {
            width: 100%;
            margin: 6px 0;
            padding: 10px;
            border-radius: 6px;
            border: 1px solid #ccc;
        }

        textarea.editavel {
            font-family: monospace;
            height: 200px;
        }

        /* LINHAS FLEX */
        .linha {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
        }

        .linha label {
            font-weight: bold;
        }

        /* PREVIEW */
        .preview {
            background: #fafafa;
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
            border: 1px solid #ccc;
        }

        /* BOT√ïES CENTRALIZADOS */
        .botoes {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 10px;
        }

        button {
            padding: 10px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            transition: background 0.3s;
        }

        button:hover {
            opacity: 0.9;
        }

        button.confirmar {
            background-color: #007acc;
            color: white;
        }

        button.cancelar {
            background-color: #ccc;
            color: black;
        }

        button.perigo {
            background-color: #d9534f;
            color: white;
        }

        /* TOAST */
        #toast {
            visibility: hidden;
            min-width: 250px;
            background: #333;
            color: #fff;
            text-align: center;
            border-radius: 5px;
            padding: 16px;
            position: fixed;
            z-index: 9999;
            left: 50%;
            bottom: 30px;
            transform: translateX(-50%);
        }

        #toast.show {
            visibility: visible;
            animation: fadein 0.5s, fadeout 0.5s 2.5s;
        }

        @keyframes fadein {
            from {
                bottom: 0;
                opacity: 0;
            }

            to {
                bottom: 30px;
                opacity: 1;
            }
        }

        @keyframes fadeout {
            from {
                bottom: 30px;
                opacity: 1;
            }

            to {
                bottom: 0;
                opacity: 0;
            }
        }
     /* POPUP GEN√âRICO */
.popup-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    z-index: 9998;
    display: none;
}

.popup {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: white;
    padding: 20px;
    border-radius: 15px;
    box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
    z-index: 9999;
    width: 90%;
    max-width: 400px;
    display: none;
    animation: fadeIn 0.3s ease;
}

.popup h3 {
    margin-top: 0;
    text-align: center;
}

.popup p {
    margin: 10px 0;
    text-align: center;
}

.popup .botoes {
    justify-content: center;
    display: flex;
    gap: 10px;
}

        

        .btn-adicionar {
            background-color: #28a745;
            color: white;
            padding: 10px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            font-size: 14px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.15);
            transition: background 0.3s;
        }

        .btn-adicionar:hover {
            background-color: #218838;
        }

        .linha input[type="date"] {
            min-width: 130px;
        }

        .linha input[type="time"] {
            min-width: 100px;
        }
        .bloco {
  margin-bottom: 16px;
  padding: 12px;
  border: 1px solid #ccc;
  border-radius: 10px;
  background: #fff;
}
.bloco h4 {
  margin: 0 0 8px;
  color: #007acc;
  font-size: 16px;
  border-bottom: 1px solid #ccc;
  padding-bottom: 4px;
}
    .input-padrao {
  width: 100%;
  padding: 10px;
  font-size: 16px;
  margin-bottom: 10px;
  border-radius: 6px;
  border: 1px solid #ccc;
  background: white;
}

.grupo {
  padding: 15px;
  background: #fff;
  margin: 10px 15px 0 15px;
  border-radius: 10px;
  box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}

.bloco {
  margin-bottom: 25px;
}

.bloco h4 {
  margin-bottom: 15px;
  font-size: 18px;
  color: #007acc;
  border-left: 4px solid #007acc;
  padding-left: 10px;
}

.linha {
  display: flex;
  gap: 10px;
  flex-wrap: wrap;
}

.btn-adicionar {
  background: #007acc;
  color: white;
  padding: 8px 12px;
  border: none;
  border-radius: 6px;
  margin-top: 8px;
  cursor: pointer;
  font-weight: bold;
  transition: background 0.3s;
}

.btn-adicionar:hover {
  background: #005f99;
}

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translate(-50%, -50%) scale(0.9);
            }

            to {
                opacity: 1;
                transform: translate(-50%, -50%) scale(1);
            }
        }
    
    </style>
</head>

<body>
    <header>
        <div style="display: flex; align-items: center; gap: 5px; justify-content: center;">
            <img src="logo.png" alt="Logo" style="height: 100px;">
        </div>
        <div class=linha>
            <h1>MeuTurno</h1>
        </div>
    </header>
    <nav>
        <button onclick="abrir('turno')" class="active">Turno</button>
        <button onclick="abrir('servicos')">Servi√ßos</button>
        <button onclick="abrir('relatorio')">Relat√≥rio</button>
        <button onclick="abrir('historico')">Hist√≥rico</button>
        <button onclick="abrir('config')">Configurar</button>
    </nav>
    
    <section id="turno" class="active">
  <div class="grupo">

    <div class="bloco">
      <h4>Dados do Turno</h4>

      <label><strong>Data</strong></label>
      <input id="dataTurno" type="date" class="input-padrao">

      <label><strong>Fazenda</strong></label>
      <input id="fazenda" type="text" class="input-padrao" placeholder="Digite o nome da fazenda">

      <label><strong>Frente / Local</strong></label>
      <input id="frente" type="text" class="input-padrao" placeholder="Digite a frente de trabalho">

      <label><strong>Turno</strong></label>
      <select id="turnoLetra" class="input-padrao">
        <option value="A">A</option>
        <option value="B">B</option>
        <option value="C">C</option>
      </select>
    </div>

    <div class="bloco">
      <h4>Equipe</h4>

      <div class="linha">
        <input id="nomeEquipe" type="text" class="input-padrao" placeholder="Nome" style="flex:1;">
        <input id="matriculaEquipe" type="text" class="input-padrao" placeholder="Matr√≠cula" style="flex:1;">
      </div>

      <button onclick="adicionarEquipe()" class="btn-adicionar">Adicionar</button>
      <div id="boxEquipe"></div>
    </div>

    <div class="bloco">
      <h4>Frotas</h4>

      <div class="linha">
        <input id="novaFrota" type="text" class="input-padrao" placeholder="C√≥digo da frota" style="flex:1;">
        <input id="novaHoraFrota" type="number" step="0.1" class="input-padrao" placeholder="Ex: 7.20" style="flex:1;">
      </div>

      <button onclick="adicionarFrota()" class="btn-adicionar">Adicionar Frota</button>
      <div id="listaFrotas" style="margin-top:10px;"></div>
    </div>

  </div>
</section>
    
    <section id="servicos">
        <div id="servicosLista">
        </div>
        <button id="btnAddServico" onclick="adicionarServico()"
            style="background-color: #28a745; color: white; padding: 10px 20px; border-radius: 8px; border: none; cursor: pointer;">
            Adicionar Servi√ßo
        </button>
    <button id="fabAddFrota" onclick="abrirPopupFrota()"
    style="
      position: fixed;
      bottom: 100px;
      right: 20px;
      background: #007acc;
      color: white;
      border: none;
      border-radius: 50%;
      width: 60px;
      height: 60px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.3);
      font-size: 30px;
      cursor: pointer;
      z-index: 9999;
      display: flex;
      align-items: center;
      justify-content: center;
    ">
    üöú
</button>
       <button id="fabAddServicos" onclick="verificarServicosPendentes()"
    style="
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: #28a745;
      color: white;
      border: none;
      border-radius: 50%;
      width: 60px;
      height: 60px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.3);
      font-size: 32px;
      cursor: pointer;
      z-index: 9999;
      display: flex;
      align-items: center;
      justify-content: center;
    ">
    +
</button>
    </section>
 <section id="relatorio">
  <div class="grupo">

    <div class="bloco">
      <h4 style="text-align: center;">Visualiza√ß√£o</h4>
      <div id="relatorio_formatado" style="white-space: pre-line;"></div>
      <textarea id="relatorio_bruto" class="editavel" style="display:none;"></textarea>
    </div>

    <div class="bloco">
      <h4 style="text-align: center;">A√ß√µes</h4>
      <div class="botoes" style="text-align:center;">
        <button onclick="gerarRelatorioFinal()">Gerar Relat√≥rio Final</button>
        <button onclick="compartilharRelatorio()">Compartilhar</button>
        <button onclick="toggleEdicaoRelatorio()">Editar Relat√≥rio</button>
        <button onclick="limparRelatorio()" style="background:#d9534f; color:white;">Limpar Relat√≥rio</button>
      </div>
    </div>

  </div>
</section>
    <section id="historico">
        <div class="grupo">
            <button onclick="abrirPopupApagarPorData()" style="background:#d9534f; color:white;">
                üóëÔ∏è Apagar Hist√≥rico por Data
            </button>
        </div>
        <div id="historico_lista"></div>
        <div class="grupo">
            <button onclick="baixarBackup()">&#128190; Backup</button>
        </div>
        <div class="grupo">
            <button onclick="document.getElementById('fileBackup').click()">Restaurar Backup</button>
            <input type="file" id="fileBackup" accept=".json" style="display:none;"
                onchange="restaurarBackupHistorico(event)">
        </div>
    </section>
    <section id="config">
        <div class="grupo">
            <h2>Backup e Dados</h2>

            <button onclick="gerarBackupCompleto()">
                üóÑÔ∏è Exportar Dados Completos
            </button>
            <p>Exporta tudo: turno, servi√ßos, frotas, equipe e hist√≥rico.</p>

            <button onclick="document.getElementById('fileBackupCompleto').click()">
                üîÑ Importar Dados Completos
            </button>
            <input type="file" id="fileBackupCompleto" accept=".json" style="display:none;"
                onchange="restaurarBackupCompleto(event)">
            <p>Restaura um arquivo JSON com todos os dados.</p>

            <hr>

            <button onclick="baixarBackup()">
                üóÑÔ∏è Exportar Apenas Hist√≥rico
            </button>
            <p>Exporta apenas o hist√≥rico de O.S.</p>

            <button onclick="document.getElementById('fileBackup').click()">
                üîÑ Importar Apenas Hist√≥rico
            </button>
            <input type="file" id="fileBackup" accept=".json" style="display:none;"
                onchange="restaurarBackupHistorico(event)">
            <p>Restaura apenas o hist√≥rico de O.S.</p>

            <hr>

            <button onclick="limparStorage()" style="background:#d9534f; color:white;">
                üóëÔ∏è Resetar Tudo (Apagar LocalStorage)
            </button>
            <p style="color:#d9534f;">Apaga todos os dados, reset total. (Confirma√ß√£o necess√°ria)</p>
        </div>
    </section>
    <div id="toast"></div>
    <script>
        //limpar LocalStorage
            function limparStorage() {
             abrirPopupConfirmar('Tem certeza que deseja apagar TODOS os dados salvos? Isso n√£o pode ser desfeito.', () => {
              localStorage.clear();
              location.reload();
          });
        }
        // Vers√£o atualizada para suporte a m√≥dulos e evolu√ß√£o cont√≠nua
        // Pr√≥ximos passos: API para exportar e importar JSON, integra√ß√£o com IndexedDB para grande volume de dados
    </script>
    <script>
        function abrir(modulo) {
            document.querySelectorAll('nav button').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('section').forEach(s => s.classList.remove('active'));

            document.getElementById(modulo).classList.add('active');
            document.querySelector(`nav button[onclick="abrir('${modulo}')"]`).classList.add('active');
            if (modulo === 'servicos') {
              if (window._deveRestaurarServicos) {
                restaurarServicosRascunho();
                window._deveRestaurarServicos = false;
              }
            }
        }
    </script>
    <script>
    function toggleEdicaoRelatorio() {
    const textarea = document.getElementById("relatorio_bruto");
    const botao = document.querySelector('button[onclick="toggleEdicaoRelatorio()"]');

    if (textarea.style.display === 'none' || textarea.style.display === '') {
        textarea.style.display = 'block';
        textarea.scrollIntoView({ behavior: 'smooth', block: 'center' });
        botao.innerText = 'Ocultar Edi√ß√£o';
    } else {
        textarea.style.display = 'none';
        botao.innerText = 'Editar Relat√≥rio';
    }
}
        function limparRelatorio() {
            document.getElementById("relatorio_bruto").value = '';
            document.getElementById("relatorio_formatado").innerHTML = '';
            showToast("Relat√≥rio limpo! Clique em gerar para atualizar.");
        }
        function compartilharRelatorio() {
            const texto = document.getElementById("relatorio_bruto").value.trim();

            if (!texto) {
                showToast("O relat√≥rio est√° vazio.");
                return;
            }

            const url = `https://wa.me/?text=${encodeURIComponent(texto)}`;
            window.open(url, "_blank");
        }

        let equipe = JSON.parse(localStorage.getItem('equipe')) || [];

        // Adiciona novo membro na equipe
        function adicionarEquipe() {
            const nome = document.getElementById('nomeEquipe').value.trim();
            const matricula = document.getElementById('matriculaEquipe').value.trim();

            if (nome && matricula) {
                equipe.push({ nome, matricula });
                salvarEquipe();
                renderizarEquipe();
                document.getElementById('nomeEquipe').value = '';
                document.getElementById('matriculaEquipe').value = '';
                showToast('Membro adicionado √† equipe!');
            } else {
                showToast('Preencha nome e matr√≠cula corretamente!');
            }
        }

        // Limpa toda a equipe
        function removerEquipe() {
            equipe = [];
            salvarEquipe();
            renderizarEquipe();
            showToast('Equipe limpa!');
        }

        // Salva edi√ß√µes feitas nos inputs da lista
        function salvarEdicoesEquipe() {
            const inputsNome = document.querySelectorAll('.input-nome');
            const inputsMatricula = document.querySelectorAll('.input-matricula');

            equipe = [];

            for (let i = 0; i < inputsNome.length; i++) {
                const nome = inputsNome[i].value.trim();
                const matricula = inputsMatricula[i].value.trim();

                if (nome && matricula) {
                    equipe.push({ nome, matricula });
                }
            }

            salvarEquipe();
            renderizarEquipe();
            showToast('Altera√ß√µes na equipe salvas!');
        }

        // Renderiza o card da equipe
        function renderizarEquipe() {
            const box = document.getElementById('boxEquipe');

            if (equipe.length === 0) {
                box.innerHTML = '';
                return;
            }

            let html = `
    <div style="
      background: #f5f5f5;
      border: 1px solid #ccc;
      border-radius: 6px;
      padding: 5px 10px;
      margin-top: 10px;
    ">
  `;

            equipe.forEach((item) => {
                html += `
      <div style="display: flex; gap: 5px; margin-bottom: 5px;">
        <input class="input-nome" type="text" value="${item.nome}" style="flex:1;">
        <input class="input-matricula" type="text" value="${item.matricula}" style="flex:1;">
      </div>
    `;
            });

            html += `</div>`;

            html += `
    <div style="margin-top:5px; display:flex; gap:5px;">
      <button onclick="salvarEdicoesEquipe()" style="background:#007bff; color:white;">Salvar Altera√ß√µes</button>
      <button onclick="removerEquipe()" style="background:#d9534f; color:white;">Limpar Equipe</button>
    </div>
  `;

            box.innerHTML = html;
        }

        // Retorna a equipe no formato texto para relat√≥rio e hist√≥rico
        function obterEquipeTexto() {
            return equipe.map(item => `${item.nome} - ${item.matricula}`).join('\n');
        }

        // Salva no LocalStorage
        function salvarEquipe() {
            localStorage.setItem('equipe', JSON.stringify(equipe));
        }

        // Carrega na abertura da p√°gina
        window.onload = () => {
            renderizarEquipe();
        };
    </script>
    <script>
        let frotasTurno = [];

        // Fun√ß√£o para mostrar toast
        function showToast(msg) {
            const toast = document.getElementById("toast");
            if (!toast) return console.log("Toast n√£o encontrado.");
            toast.innerText = msg;
            toast.className = "show";
            setTimeout(() => toast.className = toast.className.replace("show", ""), 3000);
   
        }
    
        // Fun√ß√£o para adicionar uma nova frota
        function adicionarFrota() {
            const nome = document.getElementById('novaFrota').value.trim();
            const horas = parseFloat(document.getElementById('novaHoraFrota').value);

            if (!nome || isNaN(horas) || horas <= 0) {
                showToast("Preencha corretamente a frota e as horas!");
                return;
            }

            frotasTurno.push({ nome, horas });
            renderizarFrotas();
            atualizarSelectsDeFrotas();
            document.getElementById('novaFrota').value = '';
            document.getElementById('novaHoraFrota').value = '';
            showToast("Frota adicionada!");

            salvarTudo(); // <-- Aqui adiciona isso
        }
        function atualizarSelectsDeFrotas() {
            servicos.forEach(s => {
                const select = document.getElementById(`frota_${s.id}`);
                if (select) {
                    const valorSelecionado = s.frota || select.value;
                    select.innerHTML = frotasTurno.map(f =>
                        `<option value="${f.nome}" ${f.nome === valorSelecionado ? 'selected' : ''}>${f.nome}</option>`
                    ).join('');
                }
            });
        }
        // Fun√ß√£o para renderizar as frotas cadastradas
        function renderizarFrotas() {
            const div = document.getElementById('listaFrotas');
            if (frotasTurno.length === 0) {
                div.innerHTML = "<p>Nenhuma frota adicionada.</p>";
                return;
            }
            div.innerHTML = frotasTurno.map((f, i) => `
    <div>
      Frota: <strong>${f.nome}</strong> - ${f.horas}h
      <button onclick="removerFrota(${i})" style="background:#d9534f; color:white;">Remover</button>
    </div>
  `).join('');
        }

        // Fun√ß√£o para remover uma frota
        function removerFrota(index) {
    abrirPopupConfirmar('Deseja realmente remover esta frota?', () => {
        frotasTurno.splice(index, 1);
        renderizarFrotas();
        atualizarSelectsDeFrotas();
        showToast("Frota removida!");
        salvarTudo();
    });
}
        document.addEventListener("DOMContentLoaded", () => {
            document.getElementById("dataTurno").value = dataHojeInput();
        });
    </script>
    <script>
        let callbackOportunidade = null;
        let servicos = [];

        const atividades = [
            "P001 - AFERIDO", "P002 - AJUSTADO", "P003 - ALINHADO", "P004 - APERTADO",
            "P005 - BALANCEADO", "P006 - CALIBRADO", "P007 - COMPLETADO", "P008 - CONSERTADO COMPONENTE",
            "P009 - DESAMASSADO", "P010 - DESOBSTRUIDO", "P011 - EMBUCHADO", "P012 - FIXADO",
            "P013 - FURADO", "P014 - HIGIENIZADO", "P015 - INSPECIONADO", "P016 - INSTALADO",
            "P017 - ISOLADO", "P018 - LIMPO", "P019 - LUBRIFICADO", "P020 - MODIFICADO",
            "P021 - REAPERTADO", "P022 - RECARREGADO", "P023 - RECUPERADO", "P024 - REFORMADO",
            "P025 - REGULADO", "P026 - REMONTADO", "P027 - REPROGRAMADO", "P028 - RETIFICADO",
            "P029 - SOLDADO", "P030 - SUBSTITUIDO - TROCADO", "P031 - USINADO", "P032 - VEDADO",
            "H01 - Atraso de transporte", "H02 - DDS", "H03 - Refei√ß√£o", "H04 - Organiza√ß√£o/Limpeza",
            "H05 - Aguardando pe√ßa", "H06 - Aguardando Ferramenta", "H07 - Aguardando Servi√ßo",
            "H08 - Falta do colaborador", "H09 - Reuni√£o", "H10 - Ambulatorio", "H11 - Treinamento",
            "H12 - Outros", "H13 - Deslocamento a terceiros", "H14 - Carregamento de pneus pra conserto",
            "H15 - Inventario", "H16 - Apoio a Opera√ß√£o"
        ];

        const sistemas = {
            "Tratores": [
                { cod: "1", nome: "Estrutura" }, { cod: "2", nome: "Cabine" }, { cod: "3", nome: "Motor Combustao" },
                { cod: "4", nome: "Eletrico" }, { cod: "5", nome: "Trem de Forca" }, { cod: "6", nome: "Tracao" },
                { cod: "7", nome: "Hidraulico" }, { cod: "8", nome: "Direcao" }, { cod: "9", nome: "Freio" }
            ],
            "Implementos": [
                { cod: "10", nome: "Estrutura" }, { cod: "11", nome: "Tracao" }, { cod: "12", nome: "Adubo" },
                { cod: "13", nome: "Hidraulico" }, { cod: "14", nome: "Eletrico" }, { cod: "15", nome: "V-SHEAR" }
            ]
        };

        const subsistemas = {
            "1": ["1.1 - Chassi", "1.2 - Protecao", "1.3 - Escapamento", "1.4 - Suportes", "1.5 - Escada", "1.6 - Fixacao", "1.7 - Paralama", "1.8 - Tanque", "1.9 - Eixo", "1.10 - Chaparia", "1.11 - Alavanca"],
            "2": ["2.1 - Refrigecao", "2.2 - Banco", "2.3 - Vidros", "2.4 - Painel", "2.5 - Portas", "2.6 - Hodometro", "2.7 - Radio", "2.8 - Tacografo", "2.9 - Cinto de Seguranca", "2.10 - Cabine", "2.11 - Capo", "2.12 - Buzina"],
            "3": ["3.1 - Radiador", "3.2 - Motor", "3.3 - Intercooler", "3.4 - Arla", "3.5 - Filtro", "3.6 - Ignicao"],
            "4": ["4.1 - Iluminacao", "4.2 - Eletrica", "4.3 - Bateria", "4.4 - Chicote", "4.5 - Rastreador", "4.6 - Alternador", "4.7 - Encoder", "4.8 - Camera", "4.9 - Modulo", "4.10 - Comutador", "4.11 - Fluxometro", "4.12 - GPS"],
            "5": ["5.1 - Cubo", "5.2 - Embreagem", "5.3 - Cambio", "5.4 - Diferencial", "5.5 - Transmissao"],
            "6": ["6.1 - Pneu", "6.2 - Roda", "6.3 - Esteira", "6.4 - Roda Motriz", "6.5 - Roda Estrelada"],
            "7": ["7.1 - Mangueiras", "7.2 - Valvulas", "7.3 - Atuador", "7.4 - Bombas", "7.5 - Cilindro", "7.6 - VCR"],
            "8": ["8.1 - Barra de direcao", "8.2 - Coluna Direcao", "8.3 - Volante"],
            "9": ["9.1 - Freio", "9.2 - Acumulador"],
            "10": ["10.1 - Disco de Corte", "10.2 - Cabecalho", "10.3 - Ferramenta Traseira", "10.4 - Limpa Trilho", "10.5 - Quadro", "10.6 - Escarificador", "10.7 - Fixacao", "10.8 - Tanque", "10.9 - Eixo", "10.10 - Braco"],
            "11": ["11.1 - Pneus", "11.2 - Roda", "11.3 - Mancal"],
            "12": ["12.1 - Caixa de Adubo"],
            "13": ["13.1 - Cilindro", "13.2 - Mangueira", "13.3 - Bloco", "13.4 - Valvula"],
            "14": ["14.1 - Sensores", "14.2 - Chicote"],
            "15": ["15.1 - Lamina", "15.2 - Ball"]
        };

        // Fun√ß√£o para adicionar um novo servi√ßo
        function adicionarServico() {
            salvarValoresServicos();
            const id = Date.now();

            const novoServico = {
                id, sistema: "", subsistema: "", frota: "", atividade: "", descricao: "", texto: "",
                tipo: "CORRETIVA", parada: "sim", falha: "n√£o", data: dataHojeInput(), inicio: "", fim: ""
            };

            servicos.push(novoServico);
            renderizarServicos();
            showToast("Servi√ßo adicionado!");

            setTimeout(() => {
                window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
            }, 100);
        }
    
        // Salva o rascunho de servi√ßos tempor√°rios
function salvarServicosRascunho() {
    const servicos = Array.from(document.querySelectorAll('.servico')).map(div => {
        return {
            frota: div.querySelector('.frota').value,
            atividade: div.querySelector('.atividade').value,
            sistema: div.querySelector('.sistema').value,
            subsistema: div.querySelector('.subsistema').value,
            descricao: div.querySelector('.descricao').value,
            parada: div.querySelector('.parada').checked,
            manutencao: div.querySelector('.manutencao').value,
            falha: div.querySelector('.falha').value,
            data: div.querySelector('.data').value,
            inicio: div.querySelector('.inicio').value,
            fim: div.querySelector('.fim').value,
            solicitante: div.querySelector('.solicitante').value
        };
    });
    localStorage.setItem('servicosRascunho', JSON.stringify(servicos));
}
    function restaurarServicosRascunho() {
    const rascunhos = JSON.parse(localStorage.getItem('servicosRascunho')) || [];
    rascunhos.forEach(dados => {
        adicionarServico(dados);
    });
}
        // Renderiza todos os servi√ßos
       function renderizarServicos() {
  const div = document.getElementById("servicosLista");
  div.innerHTML = servicos.map(s => `
  <div class="grupo servico" id="servico_${s.id}" style="margin-bottom: 20px;">

    <div class="bloco">
      <h4> Identifica√ß√£o da O.S</h4>
      <div class="linha">
        <div style="flex:1;">
          <label>Frota</label>
          <select id="frota_${s.id}" class="input-padrao">
            <option value="">Nenhum</option>
            ${frotasTurno.map(f =>
              `<option value="${f.nome}" ${s.frota === f.nome ? 'selected' : ''}>${f.nome}</option>`
            ).join('')}
          </select>
        </div>
        <div style="flex:1;">
          <label>Atividade</label>
          <select id="atividade_${s.id}" class="input-padrao">
            <option value="">Nenhum</option>
            ${atividades.map(a =>
              `<option ${s.atividade === a ? 'selected' : ''}>${a}</option>`
            ).join('')}
          </select>
        </div>
      </div>

      <label>Sistema</label>
      <select id="sistema_${s.id}" class="input-padrao" onchange="carregarSubsistema(${s.id})">
        <option value="">Nenhum</option>
        ${Object.entries(sistemas).map(([g, lst]) => `
          <optgroup label="${g}">
            ${lst.map(sys =>
              `<option value="${sys.cod}" ${s.sistema === sys.cod ? 'selected' : ''}>${sys.cod} - ${sys.nome}</option>`
            ).join('')}
          </optgroup>
        `).join('')}
      </select>

      <label>Subsistema</label>
      <select id="subsistema_${s.id}" class="input-padrao">
        <option value="">Nenhum</option>
        ${(subsistemas[s.sistema] || []).map(sub =>
          `<option ${s.subsistema === sub ? 'selected' : ''}>${sub}</option>`
        ).join('')}
      </select>
    </div>

    <div class="bloco">
      <h4> Opera√ß√£o</h4>
      <div class="linha">
        <div style="flex:1;">
          <label>M√°quina parada?</label>
          <select id="parada_${s.id}" class="input-padrao">
            <option value="sim" ${!s.parada || s.parada === "sim" ? 'selected' : ''}>Sim</option>
            <option value="n√£o" ${s.parada === "n√£o" ? 'selected' : ''}>N√£o</option>
          </select>
        </div>
        <div style="flex:1;">
          <label>Falha operacional?</label>
          <select id="falha_${s.id}" class="input-padrao">
            <option value="n√£o" ${!s.falha || s.falha === "n√£o" ? 'selected' : ''}>N√£o</option>
            <option value="sim" ${s.falha === "sim" ? 'selected' : ''}>Sim</option>
          </select>
        </div>
      </div>

      <label>Tipo de manuten√ß√£o</label>
      <select id="tipo_${s.id}" class="input-padrao">
        <option value="CORRETIVA" ${s.tipo === "CORRETIVA" ? 'selected' : ''}>CORRETIVA</option>
        <option value="CONDICIONAL" ${s.tipo === "CONDICIONAL" ? 'selected' : ''}>CONDICIONAL</option>
        <option value="MELHORIA" ${s.tipo === "MELHORIA" ? 'selected' : ''}>MELHORIA</option>
      </select>

      <div class="linha">
        <div style="flex:1;">
          <label>Data inicial</label>
          <input type="date" id="data_${s.id}" value="${s.data || dataHojeInput()}" class="input-padrao">
        </div>
        <div style="flex:1;">
          <label>Hora inicial</label>
          <input type="time" id="inicio_${s.id}" value="${s.inicio || ''}" class="input-padrao">
        </div>
      </div>

      <div class="linha">
        <div style="flex:1;">
          <label>Data final</label>
          <input type="date" id="dataFinal_${s.id}" value="${s.dataFinal || s.data || dataHojeInput()}" class="input-padrao">
        </div>
        <div style="flex:1;">
          <label>Hora final</label>
          <input type="time" id="fim_${s.id}" value="${s.fim || ''}" class="input-padrao">
        </div>
      </div>
    </div>

    <div class="bloco">
      <h4> Descri√ß√£o</h4>
      <textarea 
  id="descricao_${s.id}" 
  class="input-padrao descricao" 
  placeholder="Descri√ß√£o do servi√ßo"
  style="font-family: 'Segoe UI', Roboto, sans-serif; font-size: 15px; line-height: 1.4;">${s.descricao}</textarea>
    </div>

    <div class="bloco">
      <div class="botoes">
        <button id="botao_${s.id}" onclick="processarOS(${s.id})" style="background:#007acc; color:white;">
          ${s.texto ? "Regerar O.S" : "Gerar O.S"}
        </button>
      </div>

      <div id="preview_${s.id}" style="display: ${s.texto ? 'block' : 'none'};">
        <div id="interpretado_${s.id}" class="preview">${s.texto ? interpretarMarkdown(s.texto) : ''}</div>
        <div class="botoes">
          <button onclick="copiarTexto(${s.id})">Copiar</button>
          <button onclick="compartilharWhatsApp(${s.id})">Compartilhar</button>
          <button onclick="removerServico(${s.id})" style="background:#d9534f; color:white;">‚ùå Excluir</button>
        </div>
      </div>

      <textarea class="editavel input-padrao" id="texto_${s.id}" style="display:none;">${s.texto || ""}</textarea>
    </div>

  </div>
`).join('');

  aplicarEventosRascunho();

  const btnGlobal = document.getElementById("btnAddServico");
  btnGlobal.style.display = servicos.length > 0 ? "none" : "block";

  setTimeout(() => {
    const lista = document.getElementById("servicosLista");
    const ultimo = lista.lastElementChild;
    if (ultimo) {
      ultimo.scrollIntoView({ behavior: 'smooth' });
    }
  }, 100);
}
    function aplicarEventosRascunho() {
    document.querySelectorAll('#servicosLista .servico input, #servicosLista .servico select, #servicosLista .servico textarea').forEach(el => {
        el.addEventListener('input', salvarServicosRascunho);
        el.addEventListener('change', salvarServicosRascunho);
    });
}
    
        function processarOS(id) {
            salvarValoresServicos();

            const servico = servicos.find(s => s.id === id);
            verificarDataCruzaMeiaNoite(servico);
            const botao = document.getElementById(`botao_${id}`);
            
            
            if (botao.innerText === "Gerar O.S") {
                gerarTextoOS(id);
                botao.innerText = "Regerar O.S";
                showToast("O.S gerada!");
            } else {
                abrirPopupConfirmar('Deseja realmente regerar esta O.S?', () => {
    gerarTextoOS(id);
    showToast("O.S atualizada no hist√≥rico!");
});
            }

            document.getElementById(`preview_${id}`).style.display = 'block';
        }

        function toggleTexto(id) {
            const t = document.getElementById(`texto_${id}`);
            t.style.display = t.style.display === 'none' ? 'block' : 'none';
        }

        // Carrega subsistemas baseado no sistema selecionado
       function carregarSubsistema(id) {
    const sistema = document.getElementById(`sistema_${id}`).value;
    const subs = subsistemas[sistema] || [];
    const selectSub = document.getElementById(`subsistema_${id}`);

    selectSub.innerHTML = `<option value="">Nenhum</option>` +
        subs.map(sub => `<option>${sub}</option>`).join('');

    selectSub.value = ""; // <-- ESSA LINHA GARANTE RESET
}

        // Gera o texto da O.S.
        function gerarTextoOS(id) {
    const f = document.getElementById(`frota_${id}`).value || "Nenhum";
    const frente = document.getElementById("frente").value || "Nenhum";
    const atividade = document.getElementById(`atividade_${id}`).value || "Nenhum";
    const sistema = document.getElementById(`sistema_${id}`).value || "Nenhum";
    const subsistema = document.getElementById(`subsistema_${id}`).value || "Nenhum";
    const descricao = document.getElementById(`descricao_${id}`).value || "-";

    const dataRaw = document.getElementById(`data_${id}`).value || dataHojeInput();
    const [ano, mes, dia] = dataRaw.split('-');
    const data = `${dia}/${mes}/${ano}`;

    const inicio = document.getElementById(`inicio_${id}`).value || "--:--";
    const fim = document.getElementById(`fim_${id}`).value || "--:--";

    const parada = document.getElementById(`parada_${id}`).value;
    const tipo = document.getElementById(`tipo_${id}`).value;
    const falha = document.getElementById(`falha_${id}`).value;

    const solicitante = obterEquipeTexto() || "Equipe n√£o informada";

    const servico = servicos.find(s => s.id === id); // <- importante para salvar oportunidade

    const dadosOS = { f, frente, atividade, sistema, subsistema, descricao, data, inicio, fim, parada, tipo, falha, solicitante };

    if (tipo === "CONDICIONAL" || tipo === "MELHORIA") {
        abrirPopupOportunidade(function (oportunidade) {
            servico.oportunidade = oportunidade; // <- SALVANDO AQUI
            gerarTextoOSFinal(oportunidade, dadosOS, id);
        });
    } else {
        servico.oportunidade = ''; // <- LIMPA CASO SEJA CORRETIVA
        gerarTextoOSFinal('', dadosOS, id);
    }
}
        function gerarTextoOSFinal(oportunidade, dados, id) {
            const txt = `*SOLICITA√á√ÉO DE O.S*\n\n` +
                `*M√°quina est√° parada por manuten√ß√£o:* \n` +
                `*( ${dados.parada === "sim" ? "‚ùå" : " "} ) sim* *( ${dados.parada === "n√£o" ? "‚ùå" : " "} ) n√£o*\n` +
                `*se SIM abre ORDEM*\n*se N√ÉO abre Pr√©-Ordem*\n\n` +

                `‚Ä¢Frota afetada: ${dados.f}\n` +
                `‚Ä¢Local/frente: ${dados.frente}\n\n` +

                `‚Ä¢Tipo de manuten√ß√£o:\n` +
                `(${dados.tipo === "CORRETIVA" ? "‚ùå" : " "}) CORRETIVA ORDEM DE MANUTEN√á√ÉO\n` +
                `(${dados.tipo === "CONDICIONAL" ? "‚ùå" : " "}) CONDICIONAL PR√â-ORDEM\n` +
                `(${dados.tipo === "MELHORIA" ? "‚ùå" : " "}) MELHORIA PR√â-ORDEM\n\n` +

                `‚Ä¢Descri√ß√£o servi√ßo\n${dados.descricao}\n(${dados.atividade.split(" - ")[0]} - ${dados.sistema} - ${(dados.subsistema || "").split(" - ")[0]})\n` +
                `${oportunidade ? `Oportunidade: ${oportunidade}\n\n` : '\n'}` +

                `‚Ä¢Foi falha operacional?\n` +
                `(${dados.falha === "sim" ? "‚ùå" : " "}) Sim\n` +
                `(${dados.falha === "n√£o" ? "‚ùå" : " "}) N√£o\n\n` +

                `Data inicial: ${dados.data}\n` +
                `Hora inicial: ${dados.inicio}\n` +
                `Hora fim: ${dados.fim}\n\n` +

                `Solicitante:\n${dados.solicitante}`;

            document.getElementById(`texto_${id}`).value = txt;

            const interpretado = interpretarMarkdown(txt);
            const previewId = `preview_${id}`;
            let preview = document.getElementById(previewId);

            if (!preview) {
                const textarea = document.getElementById(`texto_${id}`);
                preview = document.createElement('div');
                preview.id = previewId;
                preview.className = 'grupo';
                preview.style.marginTop = '10px';
                textarea.parentNode.insertBefore(preview, textarea.nextSibling);
            }

            preview.innerHTML = `
  <div class="preview">${interpretado}</div>
  <div class="botoes">
    <button onclick="copiarTexto(${id})">Copiar</button>
    <button onclick="compartilharWhatsApp(${id})">Compartilhar</button>
    <button onclick="adicionarServicoDepois(${id})" style="background:#28a745; color:white;">Adicionar Servi√ßo</button>
    <button onclick="removerServico(${id})" style="background:#d9534f; color:white;">Excluir</button>
    
  </div>
`;
            localStorage.removeItem('servicosRascunho');
            salvarOSnoHistorico(id);
            showToast("O.S gerada!");

            const botao = document.getElementById(`botao_${id}`);
            if (botao.innerText === "Gerar O.S") {
                botao.innerText = "Regerar O.S";
            }

            setTimeout(() => {
                const servicoElement = document.getElementById(`servico_${id}`);
                if (servicoElement) {
                    servicoElement.scrollIntoView({ behavior: 'smooth', block: 'end' });
                }
            }, 100);
        }
        // Copia o texto
        function copiarTexto(id) {
            const txt = document.getElementById(`texto_${id}`).value;
            navigator.clipboard.writeText(txt);
            showToast("Texto copiado!");
        }

        // Compartilha no WhatsApp
        function compartilharWhatsApp(id) {
            const txt = document.getElementById(`texto_${id}`).value;
            window.open(`https://wa.me/?text=${encodeURIComponent(txt)}`, "_blank");
        }

        // Remove servi√ßo
        function removerServico(id) {
    abrirPopupConfirmar('Deseja realmente remover este servi√ßo?', () => {
        const index = servicos.findIndex(s => s.id === id);

        servicos = servicos.filter(s => s.id !== id);
        renderizarServicos();
        showToast("Servi√ßo removido!");

        setTimeout(() => {
    const cards = document.querySelectorAll('#servicosLista .grupo');
    if (cards.length > 0) {
        const targetIndex = Math.min(index, cards.length - 1);
        requestAnimationFrame(() => {
            cards[targetIndex].scrollIntoView({ behavior: 'smooth', block: 'center' });
        });
    }
}, 400);
    });
}
        function adicionarServicoDepois(idReferencia) {
            salvarValoresServicos(); // Salva o que j√° existe antes

            const index = servicos.findIndex(s => s.id === idReferencia);
            const id = Date.now(); // Novo ID √∫nico para o servi√ßo

            const refServico = servicos[index];

            const novoServico = {
                id,
                sistema: refServico.sistema,      // Copia o sistema
                subsistema: refServico.subsistema, // Copia o subsistema
                frota: refServico.frota,           // Copia a frota
                atividade: "",
                descricao: "",
                texto: "",
                tipo: "CORRETIVA",
                parada: "sim",
                falha: "n√£o",
                data: dataHojeInput(),
                inicio: "",
                fim: ""
            };

            // Insere logo abaixo do servi√ßo referenciado
            servicos.splice(index + 1, 0, novoServico);

            renderizarServicos();
            showToast("Novo servi√ßo adicionado abaixo.");
        }
        function salvarValoresServicos() {
    servicos.forEach(s => {
        s.frota = document.getElementById(`frota_${s.id}`)?.value || "";
        s.atividade = document.getElementById(`atividade_${s.id}`)?.value || "";
        s.sistema = document.getElementById(`sistema_${s.id}`)?.value || "";
        s.subsistema = document.getElementById(`subsistema_${s.id}`)?.value || "";
        s.descricao = document.getElementById(`descricao_${s.id}`)?.value || "";
        s.tipo = document.getElementById(`tipo_${s.id}`)?.value || "CORRETIVA";
        s.parada = document.getElementById(`parada_${s.id}`)?.value || "n√£o";
        s.falha = document.getElementById(`falha_${s.id}`)?.value || "n√£o";
        s.data = document.getElementById(`data_${s.id}`)?.value || dataHojeInput();
        s.dataFinal = document.getElementById(`dataFinal_${s.id}`)?.value || s.data;
        s.inicio = document.getElementById(`inicio_${s.id}`)?.value || "";
        s.fim = document.getElementById(`fim_${s.id}`)?.value || "";
        s.texto = document.getElementById(`texto_${s.id}`)?.value || "";
    });
}
    function verificarDataCruzaMeiaNoite(servico) {
    const dataIni = document.getElementById(`data_${servico.id}`).value;
    const horaIni = document.getElementById(`inicio_${servico.id}`).value;
    const dataFimInput = document.getElementById(`dataFinal_${servico.id}`);
    const horaFim = document.getElementById(`fim_${servico.id}`).value;

    const [hIni, mIni] = horaIni.split(':').map(Number);
    const [hFim, mFim] = horaFim.split(':').map(Number);

    const dataFinal = dataFimInput.value;

    const ini = new Date(`${dataIni}T${horaIni}:00`);
    const fim = new Date(`${dataFinal}T${horaFim}:00`);

    if (dataIni === dataFinal && (hFim < hIni || (hFim === hIni && mFim < mIni))) {
        abrirPopupConfirmar(
  `O hor√°rio final √© menor que o inicial na mesma data. Deseja ajustar a Data Final para o dia seguinte?`,
  () => {
    const novaData = new Date(dataFinal);
    novaData.setDate(novaData.getDate() + 1);
    const novaDataFormatada = novaData.toISOString().split('T')[0];
    dataFimInput.value = novaDataFormatada;
    servico.dataFinal = novaDataFormatada;
    showToast(`Data final ajustada para ${novaDataFormatada}`);
     }
      );
    }
}
    </script>
    <script>
        // Fun√ß√£o para gerar relat√≥rio consolidado
        function gerarRelatorioFinal() {
            salvarValoresServicos();

            const data = document.getElementById("dataTurno").value || dataHojeInput();
            const fazenda = document.getElementById("fazenda").value.trim();
            const frente = document.getElementById("frente").value.trim();
            const turno = document.getElementById("turnoLetra").value;
            const equipeTexto = obterEquipeTexto() || "Nenhuma equipe informada.";

            const qtdMaquinas = frotasTurno.length;
            const horasPorMaquina = frotasTurno.length > 0 ? frotasTurno[0].horas.toFixed(2) : "0";
            const horasTotais = frotasTurno.reduce((soma, f) => soma + f.horas, 0).toFixed(2);

            const horasParadas = calcularHorasParadasTurno();
            const dm = calcularDMGeral();
            const frenteUpper = (frente || "FRENTE").toUpperCase();

            const [ano, mes, dia] = (data || dataHojeInput()).split("-");
            const dataFormatada = `${dia}/${mes}/${ano}`;

            let relatorio = `
*MANUTEN√á√ÉO ${frenteUpper} BRACELL*

üìÖ *DATA:* ${dataFormatada}
*FAZENDA:* ${fazenda}
*FRENTE:* ${frente}
*TURNO:* ${turno}
*EQUIPE:*
${equipeTexto}

*QTD DE M√ÅQUINAS:* ${qtdMaquinas}
*HORAS PLANEJADAS POR M√ÅQUINA:* ${horasPorMaquina}
*HORAS PLANEJADAS TOTAL:* ${horasTotais}
*HORAS TOTAL PARADA:* ${horasParadas} (${formatarHoras(horasParadas)})
üü¢ *DM DO TURNO:* ${dm}%
`;

            frotasTurno.forEach(f => {
               const paradaFrota = calcularHorasParadasPorFrota(f.nome);
               const dmFrota = calcularDMFrota(f.nome);
                relatorio += `
üöú *${f.nome}*  
Horas Planejada: ${f.horas}h  
Horas Parada Total: ${paradaFrota}h (${formatarHoras(paradaFrota)})  
*DM:* ${dmFrota}%
*RELAT√ìRIO:*  
`;

                const servicosDaFrota = servicos.filter(s => s.frota === f.nome);

                if (servicosDaFrota.length === 0) {
                    relatorio += `- Sem servi√ßos registrados\n`;
                } else {
                    servicosDaFrota.forEach(s => {
                        const codAtiv = (s.atividade || "").split(" - ")[0];
                        const codSub = (s.subsistema || "").split(" - ")[0];
                        const duracao = calcularDuracaoServico(s);

                        relatorio += `- ${s.descricao.trim()}\n` +
                            `(${codAtiv} - ${s.sistema} - ${codSub}) ${emojiTipo(s.tipo)} [${s.tipo}]\n` +
                            `‚è±Ô∏è ${duracao.horas}h (${duracao.texto})\n`;

                        if (s.tipo !== "CORRETIVA") {
                            relatorio += `Oportunidade: ${s.oportunidade || "N√£o informada"}\n\n`;
                        } else {
                            relatorio += `\n`;
                        }
                    });
                }
            }); // <-- Aqui fecha corretamente o forEach das frotas.
            document.getElementById("relatorio_bruto").value = relatorio;
            document.getElementById("relatorio_formatado").innerHTML = relatorio
                .replace(/\*(.*?)\*/g, "<strong>$1</strong>")
                .replace(/\n/g, "<br>");

            salvarTudo();
            showToast("Relat√≥rio gerado!");
        }
        function calcularDuracaoServico(servico) {
    const [hIni, mIni] = (servico.inicio || "00:00").split(":").map(Number);
    const [hFim, mFim] = (servico.fim || "00:00").split(":").map(Number);

    const dataInicial = (servico.data || dataHojeInput());
    const dataFinal = (servico.dataFinal || servico.data || dataHojeInput());

    const dataIni = new Date(`${dataInicial}T${servico.inicio || "00:00"}:00`);
    const dataFim = new Date(`${dataFinal}T${servico.fim || "00:00"}:00`);

    if (dataFim < dataIni) {
        // Seguran√ßa extra: se mesmo assim o fim for menor, adiciona 1 dia
        dataFim.setDate(dataFim.getDate() + 1);
    }

    const diffMs = dataFim - dataIni;
    const diffMin = Math.max(Math.floor(diffMs / 60000), 0);

    const horasDecimais = (diffMin / 60).toFixed(2);
    const h = Math.floor(diffMin / 60);
    const m = diffMin % 60;

    const texto = h > 0 ? `${h}h` : "";
    const textoMin = m > 0 ? `${m}min` : "";
    const sep = (texto && textoMin) ? " " : "";
    const textoCompleto = (texto || textoMin) ? `${texto}${sep}${textoMin}` : "0min";

    return { horas: horasDecimais, texto: textoCompleto };
}

        function formatarHoras(horasDecimais) {
            const horas = Math.floor(horasDecimais);
            const minutos = Math.round((horasDecimais - horas) * 60);
            if (horas > 0 && minutos > 0) {
                return `${horas}h ${minutos}min`;
            } else if (horas > 0) {
                return `${horas}h`;
            } else {
                return `${minutos}min`;
            }
        }
        // Fun√ß√£o de emoji por tipo
        function emojiTipo(tipo) {
            switch (tipo) {
                case "CORRETIVA": return "üîß";
                case "CONDICIONAL": return "‚è≥";
                case "MELHORIA": return "‚ú®";
                default: return "";
            }
        }
    
    // C√°lculo correto das horas paradas por frota (considera sobreposi√ß√£o)
function calcularHorasParadasPorFrota(nomeFrota) {
    const intervalos = servicos
        .filter(s => s.frota === nomeFrota && s.tipo === "CORRETIVA")
        .map(s => {
            const [hIni, mIni] = (s.inicio || "00:00").split(":").map(Number);
            const [hFim, mFim] = (s.fim || "00:00").split(":").map(Number);
            return [hIni * 60 + mIni, hFim * 60 + mFim];
        })
        .filter(([ini, fim]) => fim > ini);

    if (intervalos.length === 0) return 0;

    intervalos.sort((a, b) => a[0] - b[0]);

    const juntado = [intervalos[0]];

    for (let i = 1; i < intervalos.length; i++) {
        const ultimo = juntado[juntado.length - 1];
        const atual = intervalos[i];

        if (atual[0] <= ultimo[1]) {
            ultimo[1] = Math.max(ultimo[1], atual[1]);
        } else {
            juntado.push(atual);
        }
    }

    const totalMinutos = juntado.reduce((soma, [ini, fim]) => soma + (fim - ini), 0);
    return (totalMinutos / 60).toFixed(2);
}

// DM por frota
function calcularDMFrota(nomeFrota) {
    const frotaInfo = frotasTurno.find(f => f.nome === nomeFrota);
    if (!frotaInfo) return 100.00;

    const horasPlanejada = parseFloat(frotaInfo.horas) || 0;
    if (horasPlanejada === 0) return 100.00;

    const horasParada = parseFloat(calcularHorasParadasPorFrota(nomeFrota));
    const dm = ((horasPlanejada - horasParada) / horasPlanejada) * 100;
    return dm < 0 ? 0 : dm.toFixed(2);
}

// Total turno
function calcularHorasParadasTurno() {
    return frotasTurno.reduce((total, f) => {
        return total + Number(calcularHorasParadasPorFrota(f.nome));
    }, 0).toFixed(2);
}

// DM geral turno
function calcularDMGeral() {
    const horasPlanejadas = frotasTurno.reduce((soma, f) => soma + (parseFloat(f.horas) || 0), 0);
    if (horasPlanejadas === 0) return 100.00;

    const horasParadas = parseFloat(calcularHorasParadasTurno());
    const dm = ((horasPlanejadas - horasParadas) / horasPlanejadas) * 100;
    return dm < 0 ? 0 : dm.toFixed(2);
}
     
    </script>
    <script>
        // Salva O.S no hist√≥rico automaticamente
        function salvarOSnoHistorico(id) {
            const historico = JSON.parse(localStorage.getItem("historicoOS")) || {};
            const hoje = new Date();
            const dataKey = dataHojeBR(); // dd/mm/yyyy
            if (!historico[dataKey]) historico[dataKey] = [];

            const texto = document.getElementById(`texto_${id}`).value;
            const frota = document.getElementById(`frota_${id}`).value || "Nenhum";
            const tipo = document.getElementById(`tipo_${id}`).value || "CORRETIVA";
            const datahora = hoje.toLocaleString();

            // Verifica se j√° existe este ID no hist√≥rico
            const index = historico[dataKey].findIndex(s => s.id === id);

            if (index >= 0) {
                // Se j√° existe, atualiza o item
                historico[dataKey][index] = {
                    ...historico[dataKey][index],
                    frota,
                    tipo,
                    texto,
                    datahora,
                };
            } else {
                // Se n√£o existe, cria novo
                historico[dataKey].push({
                    id, frota, tipo, texto, status: "pendente", datahora, osNumero: ""
                });
            }

            localStorage.setItem("historicoOS", JSON.stringify(historico));
            showToast("O.S salva no hist√≥rico!");
            mostrarHistorico();
        }
        // Mostrar hist√≥rico

        function mostrarHistorico() {
            const historico = JSON.parse(localStorage.getItem("historicoOS")) || {};
            const div = document.getElementById("historico_lista");
            const datas = Object.keys(historico);

            if (datas.length === 0) {
                div.innerHTML = "<p>Nenhuma O.S registrada ainda.</p>";
                return;
            }

            let html = "";

            datas.sort().reverse().forEach(data => {
                html += `<div class="grupo">
      <h3 style="margin:5px 0;">Data: ${data}</h3>`;

                historico[data].forEach(s => {
                    html += `
        <div class="grupo" style="background:#f9f9f9;">
          <div style="display:flex; justify-content:space-between; align-items:center;">
            <div style="font-weight: bold; font-size: 15px;">
  ${s.datahora.split(', ')[1] || s.datahora}
</div>
            <button onclick="toggleCorpo(${s.id})" style="background:none; border:none; width:10%;font-size:20px; cursor:pointer;">üëÅÔ∏è</button>
          </div>
          <div class="linha" style="flex-wrap: wrap; align-items: center; gap: 10px;">
  <label style="font-weight: bold;">OS:</label>
  <input 
    id="os_input_${s.id}" 
    style="min-width: 80px; max-width: 90px;" 
    value="${s.osNumero || ""}" 
    oninput="validarOS(${s.id})"
    ${s.status === "pendente" ? "" : "disabled"}>

  <span><strong>Frota:</strong> ${s.frota}</span>
  <span><strong>Status:</strong> ${s.status === "pendente" ? "‚ùå Pendente" : "‚úÖ Finalizada"}</span>
</div>
          <div id="corpo_${s.id}" style="display:none; margin-top:10px;">
            <textarea class="editavel" id="htexto_${s.id}">${s.texto}</textarea>
            <div class="botoes">
              ${s.status === "pendente"
                            ? `<button onclick="finalizarOS(${s.id})">Marcar como Finalizada</button>`
                            : `<button id="editar_${s.id}" onclick="editarOS(${s.id})">Editar O.S</button>`
                        }
              <button onclick="copiarHistorico(${s.id})">Copiar</button>
              <button onclick="compartilharHistorico(${s.id})">Compartilhar</button>
              <button onclick="excluirHistorico(${s.id}, '${data}')" style="background:#d9534f; color:white;">Excluir</button>
            </div>
          </div>
        </div>`;
                });

                html += `</div>`;
            });

            div.innerHTML = html;
        }
    function validarOS(id) {
    const input = document.getElementById(`os_input_${id}`);
    const btnFinalizar = document.querySelector(`#corpo_${id} button`);

    if (input && btnFinalizar) {
        btnFinalizar.disabled = input.value.trim() === "";
    }
}
        function toggleMarkdown(id) {
            const interpretado = document.getElementById(`interpretado_${id}`);
            const texto = document.getElementById(`texto_${id}`);

            if (interpretado.style.display === 'none') {
                interpretado.style.display = 'block';
                texto.style.display = 'none';
            } else {
                interpretado.style.display = 'none';
                texto.style.display = 'block';
            }
        }
        //funcao do olho
        function toggleCorpo(id) {
            const corpo = document.getElementById(`corpo_${id}`);
            corpo.style.display = corpo.style.display === 'none' ? 'block' : 'none';
        }
        // Finaliza O.S.
        function finalizarOS(id) {
    const historico = JSON.parse(localStorage.getItem("historicoOS")) || {};
    const input = document.getElementById(`os_input_${id}`);
    const numero = input.value.trim();

    if (!numero) {
        showToast("Preencha o n√∫mero da O.S antes de finalizar.");
        input.focus();
        return;
    }

    for (const data in historico) {
        const item = historico[data].find(s => s.id === id);
        if (item) {
            item.status = "finalizada";
            item.osNumero = numero;
            break;
        }
    }

    localStorage.setItem("historicoOS", JSON.stringify(historico));
    mostrarHistorico();
    showToast("O.S finalizada!");
}

        // Edita n√∫mero da O.S.
        function editarOS(id) {
            const input = document.getElementById(`os_input_${id}`);
            const btn = document.getElementById(`editar_${id}`);

            if (btn.innerText === "Editar O.S") {
                input.disabled = false;
                btn.innerText = "Confirmar";
                btn.style.background = "#28a745";
                btn.style.color = "white";
                btn.onclick = () => confirmarEdicaoOS(id);
            }
        }

        function confirmarEdicaoOS(id) {
            const historico = JSON.parse(localStorage.getItem("historicoOS")) || {};
            const input = document.getElementById(`os_input_${id}`);
            const numero = input.value.trim();

            if (!numero) return showToast("O n√∫mero da O.S n√£o pode ficar vazio.");

            for (const data in historico) {
                const item = historico[data].find(s => s.id === id);
                if (item) {
                    item.osNumero = numero;
                    break;
                }
            }

            localStorage.setItem("historicoOS", JSON.stringify(historico));
            mostrarHistorico();
            showToast("O.S atualizada!");
        }

        // Copia
        function copiarHistorico(id) {
            const historico = JSON.parse(localStorage.getItem("historicoOS")) || {};

            for (const data in historico) {
                const item = historico[data].find(s => s.id === id);
                if (item) {
                    navigator.clipboard.writeText(item.texto);
                    showToast("Hist√≥rico copiado!");
                    return;
                }
            }

            showToast("O.S n√£o encontrada.");
        }

        // Compartilha
        function compartilharHistorico(id) {
            const historico = JSON.parse(localStorage.getItem("historicoOS")) || {};

            for (const data in historico) {
                const item = historico[data].find(s => s.id === id);
                if (item) {
                    const url = `https://wa.me/?text=${encodeURIComponent(item.texto)}`;
                    window.open(url, "_blank");
                    showToast("Hist√≥rico enviado!");
                    return;
                }
            }

            showToast("O.S n√£o encontrada.");
        }
        // Exclui
        function excluirHistorico(id, data) {
    abrirPopupConfirmar('Tem certeza que deseja excluir esta O.S?', () => {
        const historico = JSON.parse(localStorage.getItem("historicoOS")) || {};
        historico[data] = historico[data].filter(s => s.id !== id);
        if (historico[data].length === 0) delete historico[data];

        localStorage.setItem("historicoOS", JSON.stringify(historico));
        mostrarHistorico();
        showToast("Hist√≥rico exclu√≠do!");
    });
}

    </script>
    <script>
        function interpretarMarkdown(texto) {
            return texto
                .replace(/\*(.*?)\*/g, '<strong>$1</strong>')  // Negrito
                .replace(/_(.*?)_/g, '<em>$1</em>')            // It√°lico
                .replace(/~(.*?)~/g, '<del>$1</del>')          // Tachado
                .replace(/\n/g, '<br>');                       // Quebra de linha
        }
    </script>
    <script>
        // Fun√ß√£o para gerar backup do hist√≥rico
        function baixarBackup() {
            const historico = JSON.parse(localStorage.getItem("historicoOS")) || {};

            if (Object.keys(historico).length === 0) {
                showToast("Nenhum dado no hist√≥rico para backup.");
                return;
            }

            const blob = new Blob([JSON.stringify(historico, null, 2)], { type: "application/json" });
            const url = URL.createObjectURL(blob);

            const agora = new Date();
            const dataHora = agora.toISOString().slice(0, 19).replace(/[:T]/g, '-');
            const nomeArquivo = `backup_meuturno_${dataHora}.json`;

            const a = document.createElement('a');
            a.href = url;
            a.download = nomeArquivo;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);

            URL.revokeObjectURL(url);
            showToast(`Backup criado: ${nomeArquivo}`);
        }
    </script>
    <script>
        // Fun√ß√£o para restaurar backup do hist√≥rico
        function restaurarBackupHistorico(event) {
            abrirPopupConfirmar('Tem certeza que deseja importar este backup? Isso ir√° substituir os dados atuais.', () => {
    // aqui vai o c√≥digo de leitura do arquivo, que j√° est√° dentro da fun√ß√£o.
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function (e) {
                try {
                    const dados = JSON.parse(e.target.result);
                    if (typeof dados === 'object' && !Array.isArray(dados)) {
                        localStorage.setItem("historicoOS", JSON.stringify(dados));
                        mostrarHistorico();
                        showToast("Backup restaurado com sucesso!");
                    } else {
                        showToast("Arquivo inv√°lido.");
                    }
                } catch (err) {
                    showToast("Erro ao ler o arquivo.");
                }
            };
            reader.readAsText(file);
            });
        }
    </script>
    <script>

        function salvarTudo() {
            localStorage.setItem("turno", JSON.stringify({
                data: document.getElementById("dataTurno").value,
                fazenda: document.getElementById("fazenda").value,
                frente: document.getElementById("frente").value,
                turno: document.getElementById("turnoLetra").value,
                equipe: equipe,
                frotas: frotasTurno,
                servicos: servicos,
                relatorio: document.getElementById("relatorio_bruto").value
            }));
        }
        function carregarTudo() {
            const dados = JSON.parse(localStorage.getItem("turno"));
            if (dados) {
                document.getElementById("dataTurno").value = dados.data || dataAtual();
                document.getElementById("fazenda").value = dados.fazenda || "";
                document.getElementById("frente").value = dados.frente || "";
                document.getElementById("turnoLetra").value = dados.turno || "A";

                equipe = dados.equipe || [];
                renderizarEquipe();

                frotasTurno = dados.frotas || [];
                renderizarFrotas();

                servicos = dados.servicos || [];
                renderizarServicos();

                const r = dados.relatorio || "";
                document.getElementById("relatorio_bruto").value = r;
                document.getElementById("relatorio_formatado").innerHTML = r
                    .replace(/\*(.*?)\*/g, "<strong>$1</strong>")
                    .replace(/\n/g, "<br>");

                // Linha obrigat√≥ria para corrigir os selects:
                atualizarSelectsDeFrotas();

            } else {
                document.getElementById("dataTurno").value = dataHojeInput();
            }
        }
        document.addEventListener("DOMContentLoaded", () => {
            carregarTudo();
            mostrarHistorico();
        });
    </script>

    <script>

        function gerarBackupCompleto() {
            const dados = {
                turno: JSON.parse(localStorage.getItem("turno")) || {},
                historicoOS: JSON.parse(localStorage.getItem("historicoOS")) || {}
            };

            const blob = new Blob([JSON.stringify(dados, null, 2)], { type: "application/json" });
            const url = URL.createObjectURL(blob);
            const agora = new Date();
            const dataHora = agora.toISOString().slice(0, 19).replace(/[:T]/g, '-');
            const nomeArquivo = `backup_meuturno_${dataHora}.json`;

            const a = document.createElement('a');
            a.href = url;
            a.download = nomeArquivo;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);

            URL.revokeObjectURL(url);
            showToast(`Backup criado: ${nomeArquivo}`);
        }
        function restaurarBackupCompleto(event) {
    abrirPopupConfirmar('Tem certeza que deseja importar este backup? Isso ir√° substituir os dados atuais.', () => {
        const file = event.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function (e) {
            try {
                const dados = JSON.parse(e.target.result);
                if (dados.turno) localStorage.setItem("turno", JSON.stringify(dados.turno));
                if (dados.historicoOS) localStorage.setItem("historicoOS", JSON.stringify(dados.historicoOS));
                carregarTudo();
                mostrarHistorico();
                showToast("Backup restaurado com sucesso!");
            } catch (err) {
                showToast("Erro ao ler o arquivo de backup.");
            }
        };
        reader.readAsText(file);
    });
}
    </script>
    <script>
   
        //popup botao apagar historico por data

        function dataHojeBR() {
    return new Date().toLocaleDateString('pt-BR');
}

function dataHojeInput() {
    return new Date().toISOString().split('T')[0];
}
        function fecharPopupApagarPorData() {
    document.getElementById('popupApagarData').style.display = 'none';
    document.getElementById('overlayApagarData').style.display = 'none';
}
        // Popup Oportunidade
        function abrirPopupOportunidade(callback) {
            callbackOportunidade = callback;
            document.getElementById('popupOportunidade').style.display = 'block';
            document.getElementById('overlayOportunidade').style.display = 'block';
            document.getElementById('inputOportunidade').value = '';
            document.getElementById('inputOportunidade').focus();
            fecharTeclado();
        }

        function fecharPopupOportunidade() {
            document.getElementById('popupOportunidade').style.display = 'none';
            document.getElementById('overlayOportunidade').style.display = 'none';
        }

        function confirmarOportunidade() {
            const valor = document.getElementById('inputOportunidade').value.trim();
            if (callbackOportunidade) callbackOportunidade(valor);
            fecharPopupOportunidade();
        }

        function cancelarOportunidade() {
            if (callbackOportunidade) callbackOportunidade('');
            fecharPopupOportunidade();
        }

        // Popup Apagar por Data
        function abrirPopupApagarPorData() {
            const historico = JSON.parse(localStorage.getItem("historicoOS")) || {};
            const datas = Object.keys(historico);

            if (datas.length === 0) {
                showToast("Nenhum hist√≥rico para apagar.");
                return;
                fecharTeclado();
            }

            const select = document.getElementById('selectDatas');
            select.innerHTML = datas.map(d => `<option value="${d}">${d}</option>`).join('');

            document.getElementById('popupApagarData').style.display = 'block';
            document.getElementById('overlayApagarData').style.display = 'block';
        }

        function confirmarApagarPorData() {
            const dataSelecionada = document.getElementById('selectDatas').value;
            if (!dataSelecionada) {
                showToast("Selecione uma data.");
                return;
            }

            const historico = JSON.parse(localStorage.getItem("historicoOS")) || {};

            if (historico[dataSelecionada]) {
                delete historico[dataSelecionada];
                localStorage.setItem("historicoOS", JSON.stringify(historico));
                showToast(`Hist√≥rico da data ${dataSelecionada} apagado!`);
                fecharPopupApagarPorData();
                mostrarHistorico();
            }
        }
    
    function verificarServicosPendentes() {
    salvarValoresServicos();

    const pendentes = servicos.filter(s => !s.texto || s.texto.trim() === "");

    if (pendentes.length > 0) {
        const mensagens = pendentes.map(s => {
            const frota = s.frota || "Sem Frota";
            const atividade = (s.atividade || "").split(" - ")[0];
            const sistema = s.sistema || "-";
            const subsistema = (s.subsistema || "").split(" - ")[0];
            const inicio = s.inicio || "--:--";
            const fim = s.fim || "--:--";

            return `
FROTA: ${frota} (${atividade}-${sistema}-${subsistema})
In√≠cio: ${inicio} - Fim: ${fim}
‚ùå O.S N√ÉO FOI GERADA. FAVOR CONFERIR!
--------------------------
`;
        }).join("\n");

        abrirPopup('Aten√ß√£o!', mensagens, [
    { texto: 'OK', classe: 'confirmar' }
]);

        // Scroll at√© o primeiro pendente
        const primeiro = pendentes[0];
        const elemento = document.getElementById(`servico_${primeiro.id}`);
        if (elemento) {
            elemento.scrollIntoView({ behavior: "smooth", block: "center" });
            showToast("Existem servi√ßos sem O.S gerada!");
        }
    } else {
        adicionarServico();
    }
}
    
    // bot√£o fab frota
    function abrirPopupFrota() {
    document.getElementById('popupFrota').style.display = 'block';
    document.getElementById('overlayFrota').style.display = 'block';
    document.getElementById('inputFrota').value = '';
    document.getElementById('inputHoraFrota').value = '';
        fecharTeclado();
}

function fecharPopupFrota() {
    document.getElementById('popupFrota').style.display = 'none';
    document.getElementById('overlayFrota').style.display = 'none';
}

function confirmarFrota() {
    const nome = document.getElementById('inputFrota').value.trim();
    const horas = parseFloat(document.getElementById('inputHoraFrota').value);

    if (!nome || isNaN(horas) || horas <= 0) {
        showToast("Preencha corretamente a frota e as horas!");
        return;
    }

    frotasTurno.push({ nome, horas });
    renderizarFrotas();
    atualizarSelectsDeFrotas();
    fecharPopupFrota();
    showToast("Frota adicionada!");
    salvarTudo();
}
    const fabServico = document.getElementById('fabAddServicos');
const fabFrota = document.getElementById('fabAddFrota');

window.addEventListener('scroll', () => {
    const rodape = document.querySelector('footer') || document.body;
    const rodapePos = rodape.getBoundingClientRect().bottom;
    const windowHeight = window.innerHeight;
    const abaServicos = document.getElementById('servicos');

    if (!fabServico || !fabFrota) return; // <-- seguran√ßa m√°xima contra erros

    if (abaServicos.classList.contains('active')) {
        if (rodapePos < windowHeight + 100) {
            fabServico.style.display = 'none';
            fabFrota.style.display = 'none';
        } else {
            fabServico.style.display = 'flex';
            fabFrota.style.display = 'flex';
        }
    } else {
        fabServico.style.display = 'none';
        fabFrota.style.display = 'none';
    }
});

    </script>
    <div class="popup-overlay" id="overlayFrota"></div>
<div class="popup" id="popupFrota">
    <h3>Adicionar Frota</h3>
    <label>Frota</label>
    <input type="text" id="inputFrota" placeholder="Ex.: JD6115J">
    <label>Horas Planejadas</label>
    <input type="number" step="0.1" id="inputHoraFrota" placeholder="Ex.: 7.20">
    <div class="botoes">
        <button class="confirmar" onclick="confirmarFrota()">Adicionar</button>
        <button class="cancelar" onclick="fecharPopupFrota()">Cancelar</button>
    </div>
</div>
    <!-- popup oportunidades -->
    <div class="popup-overlay" id="overlayOportunidade"></div>
    <div class="popup" id="popupOportunidade">
        <h3>Informar Oportunidade</h3>
        <input type="text" id="inputOportunidade" placeholder="Ex.: Refei√ß√£o, DDS..." style="width:100%; padding:10px;">
        <div class="botoes">
            <button class="confirmar" onclick="confirmarOportunidade()">Confirmar</button>
            <button class="cancelar" onclick="cancelarOportunidade()">Cancelar</button>
        </div>
    </div>
    <!-- popup apagar por data -->
    <div class="popup-overlay" id="overlayApagarData"></div>
    <div class="popup" id="popupApagarData">
        <h3>Selecione a Data</h3>
        <select id="selectDatas" style="width:100%; padding:10px;"></select>
        <div class="botoes">
            <button class="confirmar" onclick="confirmarApagarPorData()">Apagar</button>
            <button class="cancelar" onclick="fecharPopupApagarPorData()">Cancelar</button>
        </div>
    </div>
        <div class="popup-overlay" id="overlayConfirmar"></div>
<div class="popup" id="popupConfirmar">
    <h3>Confirma√ß√£o</h3>
    <p id="popupConfirmarMensagem">Mensagem aqui...</p>
    <div class="botoes">
        <button class="confirmar" onclick="confirmarPopupAcao()">Confirmar</button>
        <button class="cancelar" onclick="fecharPopupConfirmar()">Cancelar</button>
    </div>
</div>
    <script>
    function abrirPopup(titulo, mensagem, botoes = []) {
    document.getElementById('popupTitulo').innerText = titulo;
    document.getElementById('popupMensagem').innerText = mensagem;

    const divBotoes = document.getElementById('popupBotoes');
    divBotoes.innerHTML = '';

    botoes.forEach(b => {
        const btn = document.createElement('button');
        btn.className = b.classe || 'confirmar';
        btn.innerText = b.texto;
        btn.onclick = () => {
            fecharPopup();
            if (b.acao) b.acao();
        };
        divBotoes.appendChild(btn);
    });

    document.getElementById('popupGenerico').style.display = 'block';
    document.getElementById('overlayPopup').style.display = 'block';
}

function fecharPopup() {
    document.getElementById('popupGenerico').style.display = 'none';
    document.getElementById('overlayPopup').style.display = 'none';
}
    let callbackConfirmar = null;

function abrirPopupConfirmar(mensagem, acao) {
    document.getElementById('popupConfirmarMensagem').innerText = mensagem;
    document.getElementById('overlayConfirmar').style.display = 'block';
    document.getElementById('popupConfirmar').style.display = 'block';
    callbackConfirmar = acao;
    fecharTeclado();
}

function confirmarPopupAcao() {
    if (callbackConfirmar) callbackConfirmar();
    fecharPopupConfirmar();
}

function fecharPopupConfirmar() {
    document.getElementById('overlayConfirmar').style.display = 'none';
    document.getElementById('popupConfirmar').style.display = 'none';
}
    function fecharTeclado() {
    document.activeElement.blur();
}
    window.addEventListener('DOMContentLoaded', () => {
    window._deveRestaurarServicos = true;
});
    </script>
    <script>
// Registro do Service Worker com detec√ß√£o de nova vers√£o
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('./service-worker.js').then(reg => {
    reg.onupdatefound = () => {
      const newWorker = reg.installing;
      newWorker.onstatechange = () => {
        if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
          // Mostra o popup de nova vers√£o
          document.getElementById('update-popup').style.display = 'block';
        }
      };
    };
  }).catch(err => {
    console.log('Erro ao registrar o Service Worker:', err);
  });

  // Auto-reload quando a nova vers√£o assumir o controle
  navigator.serviceWorker.addEventListener('controllerchange', () => {
    console.log('Nova vers√£o ativada. Recarregando automaticamente...');
    window.location.reload();
  });
}
</script>
    <div class="popup-overlay" id="overlayPopup"></div>
<div class="popup" id="popupGenerico">
    <h3 id="popupTitulo"></h3>
    <p id="popupMensagem"></p>
    <div class="botoes" id="popupBotoes"></div>
</div>
    <!--popup serviceworker-->
    <div id="update-popup" style="display:none;position:fixed;bottom:20px;left:50%;transform:translateX(-50%);background:#007acc;color:white;padding:15px 25px;border-radius:10px;box-shadow:0 4px 10px rgba(0,0,0,0.3);z-index:1000;font-weight:bold;">
  Nova vers√£o dispon√≠vel. <button onclick="location.reload()" style="background:white;color:#007acc;border:none;font-weight:bold;padding:5px 10px;border-radius:5px;cursor:pointer;">Atualizar</button>
</div>
    
</body>
</html>
