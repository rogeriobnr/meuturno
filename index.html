<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="manifest" href="./manifest.json">
    <meta name="theme-color" content="#007acc">
    <title>Meu Turno</title>
    <style>
        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            font-family: sans-serif;
            background: #f3f3f3;
            font-size: 16px;
        }

        /* HEADER */
        header {
            background: #007acc;
            color: white;
            padding: 15px;
            text-align: center;
            font-size: 22px;
            font-weight: bold;
            letter-spacing: 1px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            border-bottom: 3px solid #005f99;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        header img {
            height: 35px;
        }

        /* NAVBAR AJUSTADO */
        nav {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            background: #f4f4f4;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            border-bottom: 1px solid #ccc;
        }

        nav button {
            background: transparent;
            color: #333;
            border: none;
            padding: 12px 0;
            cursor: pointer;
            font-weight: 600;
            font-size: 13px;
            transition: background 0.3s, color 0.3s;
            border-right: 1px solid #ddd;
        }

        nav button:last-child {
            border-right: none;
        }

        nav button:hover {
            background: #eaeaea;
        }

        nav button.active {
            background: #007acc;
            color: white;
        }

        /* SECTIONS */
        section {
            display: none;
            padding: 15px;
        }

        section.active {
            display: block;
        }

        /* GRUPOS */
        .grupo {
            background: white;
            padding: 15px;
            border-radius: 10px;
            margin-top: 10px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        /* CAMPOS */
        input,
        select,
        textarea,
        button {
            /* Estilo base para bot√µes */
            width: 100%;
            margin: 6px 0;
            padding: 12px;
            border-radius: 6px;
            border: 1px solid #ccc;
        }

        textarea.editavel {
            font-family: monospace;
            height: 200px;
        }

        /* LINHAS FLEX */
        .linha {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
        }

        .linha label {
            font-weight: bold;
        }

        /* PREVIEW */
        .preview {
            background: #fafafa;
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
            border: 1px solid #ccc;
            white-space: pre-wrap;
        }

        /* BOT√ïES CENTRALIZADOS */
        .botoes {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 10px;
        }

        button {
            /* Estilo base para bot√µes j√° tem padding aumentado */
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            transition: background 0.3s;
        }

        button:hover {
            opacity: 0.9;
        }

        button.confirmar {
            background-color: #007acc;
            color: white;
        }

        button.cancelar {
            background-color: #ccc;
            color: black;
        }

        button.perigo {
            background-color: #d9534f;
            color: white;
        }

        /* TOAST */
        #toast {
            visibility: hidden;
            min-width: 250px;
            background: #333;
            color: #fff;
            text-align: center;
            border-radius: 5px;
            padding: 16px;
            position: fixed;
            z-index: 10000;
            left: 50%;
            bottom: 30px;
            transform: translateX(-50%);
        }

        #toast.show {
            visibility: visible;
            animation: fadein 0.5s, fadeout 0.5s 2.5s;
        }

        @keyframes fadein {
            from {
                bottom: 0;
                opacity: 0;
            }

            to {
                bottom: 30px;
                opacity: 1;
            }
        }

        @keyframes fadeout {
            from {
                bottom: 30px;
                opacity: 1;
            }

            to {
                bottom: 0;
                opacity: 0;
            }
        }

        /* POPUP GEN√âRICO */
        .popup-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 9998;
            display: none;
        }

        .popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
            z-index: 9999;
            width: 90%;
            max-width: 400px;
            display: none;
            animation: fadeInPopupAnimation 0.3s ease;
        }

        .popup h3 {
            margin-top: 0;
            text-align: center;
        }

        .popup p {
            margin: 10px 0;
            text-align: center;
        }

        .popup textarea {
            width: 100%;
            min-height: 150px;
            margin-top: 10px;
            margin-bottom: 10px;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 6px;
            font-family: monospace;
            white-space: pre-wrap;
        }


        .popup .botoes {
            justify-content: center;
            display: flex;
            gap: 10px;
        }

        .linha input[type="date"] {
            min-width: 130px;
        }

        .linha input[type="time"] {
            min-width: 100px;
        }

        .bloco {
            margin-bottom: 16px;
            padding: 12px;
            border: 1px solid #ccc;
            border-radius: 10px;
            background: #fff;
        }

        .bloco h4 {
            margin: 0 0 8px;
            color: #007acc;
            font-size: 16px;
            border-bottom: 1px solid #ccc;
            padding-bottom: 4px;
        }

        .input-padrao {
            width: 100%;
            font-size: 16px;
            margin-bottom: 10px;
            border-radius: 6px;
            border: 1px solid #ccc;
            background: white;
        }

        .grupo {
            padding: 15px;
            background: #fff;
            margin: 10px 15px 0 15px;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .btn-adicionar {
            background: #007acc;
            color: white;
            padding: 8px 12px;
            border: none;
            border-radius: 6px;
            margin-top: 8px;
            cursor: pointer;
            font-weight: bold;
            font-size: 14px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.15);
            transition: background 0.3s;
        }

        .btn-adicionar:hover {
            background: #005f99;
        }

        @keyframes fadeInPopupAnimation {
            from {
                opacity: 0;
                transform: translate(-50%, -50%) scale(0.9);
            }

            to {
                opacity: 1;
                transform: translate(-50%, -50%) scale(1);
            }
        }

        .servico-pendente-os {
            border-left: 5px solid orange !important;
        }

        .servico-pendente-os .bloco h4 {
            color: orange !important;
            border-left-color: orange !important;
        }

        .servico-pendente-os .servico-cabecalho {
            background-color: #fff3e0 !important;
        }


        #historico_lista input[disabled=false],
        #historico_lista input:placeholder-shown {
            border: 1px solid orange;
        }

        @media (max-width: 600px) {
            header {
                font-size: 18px;
                flex-direction: column;
            }

            header img {
                height: 30px;
            }

            nav {
                grid-template-columns: repeat(auto-fit, minmax(70px, 1fr));
            }

            nav button {
                font-size: 11px;
                padding: 10px 0;
            }

            .linha {
                flex-direction: column;
                align-items: stretch;
            }

            .linha input,
            .linha select,
            .linha textarea {
                width: 100%;
            }

            .botoes button {
                width: 100%;
                margin-bottom: 8px;
            }

            .botoes button:last-child {
                margin-bottom: 0;
            }

            .popup {
                width: 95%;
            }

            .input-padrao {
                font-size: 15px;
            }
        }

        .servico-cabecalho {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            padding: 12px 15px;
            /* Aumentar um pouco o padding */
            background-color: #e9ecef;
            border-bottom: 1px solid #ced4da;
            /* Cor de borda mais suave */
            border-radius: 8px 8px 0 0;
        }

        .servico-cabecalho-info {
            /* Novo container para o texto */
            flex-grow: 1;
            overflow: hidden;
            /* Para ellipsis funcionar */
            white-space: nowrap;
            text-overflow: ellipsis;
            margin-right: 10px;
            /* Espa√ßo antes do √≠cone */
        }

        .servico-cabecalho-info .frota-destaque {
            font-weight: bold;
            color: #0056b3;
            /* Azul mais escuro */
        }

        .servico-cabecalho-info .atividade-info {
            color: #495057;
            /* Cinza mais escuro */
            font-size: 0.9em;
            margin-left: 5px;
        }

        .servico-cabecalho-toggler {
            /* Span para o √≠cone */
            font-size: 1.1em;
            /* Ajustar tamanho do √≠cone */
            color: #495057;
        }

        .servico-detalhes {
            padding: 15px;
            border: 1px solid #ced4da;
            border-top: none;
            border-radius: 0 0 8px 8px;
        }
    </style>
</head>

<body>
    <header>
        <div style="display: flex; align-items: center; gap: 5px; justify-content: center;">
            <img src="logo.png" alt="Logo MeuTurno" style="height: 40px;" onerror="this.style.display='none'">
        </div>
        <div>
            <h1>MeuTurno</h1>
        </div>
    </header>
    <nav>
        <button onclick="abrir('turno')" class="active">Turno</button>
        <button onclick="abrir('servicos')">Servi√ßos</button>
        <button onclick="abrir('relatorio')">Relat√≥rio</button>
        <button onclick="abrir('historico')">Hist√≥rico</button>
        <button onclick="abrir('config')">Configurar</button>
    </nav>

    <section id="turno" class="active">
        <div class="grupo">

            <div class="bloco">
                <h4>Dados do Turno</h4>

                <label><strong>Data*</strong></label>
                <input id="dataTurno" type="date" class="input-padrao" onchange="salvarDadosParciaisTurno()" required>

                <label><strong>Fazenda*</strong></label>
                <input id="fazenda" type="text" class="input-padrao" placeholder="Digite o nome da fazenda"
                    onblur="salvarDadosParciaisTurno()" required>

                <label><strong>Frente / Local*</strong></label>
                <input id="frente" type="text" class="input-padrao" placeholder="Digite a frente de trabalho"
                    onblur="salvarDadosParciaisTurno()" required>

                <label><strong>Turno</strong></label>
                <select id="turnoLetra" class="input-padrao" onchange="salvarDadosParciaisTurno()">
                    <option value="A">A</option>
                    <option value="B">B</option>
                    <option value="C">C</option>
                </select>
            </div>

            <div class="bloco">
                <h4>Equipe</h4>
                <div class="linha">
                    <input id="nomeEquipe" type="text" class="input-padrao" placeholder="Nome" style="flex:1;">
                    <input id="matriculaEquipe" type="text" class="input-padrao" placeholder="Matr√≠cula"
                        style="flex:1;">
                </div>
                <button onclick="adicionarEquipe()" class="btn-adicionar">Adicionar Membro</button>
                <div id="boxEquipe"></div>
            </div>

            <div class="bloco">
                <h4>Frotas</h4>
                <div class="linha">
                    <input id="novaFrota" type="text" class="input-padrao" placeholder="C√≥digo da frota"
                        style="flex:1;">
                    <input id="novaHoraFrota" type="number" step="0.1" class="input-padrao"
                        placeholder="Ex: 7.5 (7h30min)" style="flex:1;">
                </div>
                <small style="display:block; margin-bottom: 5px;">Use ponto para decimal (ex: 7 horas e 30 minutos =
                    7.5).</small>
                <button onclick="adicionarFrota()" class="btn-adicionar">Adicionar Frota</button>
                <div id="listaFrotas" style="margin-top:10px;"></div>
            </div>

        </div>
    </section>

    <section id="servicos">
        <div class="grupo" style="margin-bottom: 15px;">
            <h4>Filtrar Servi√ßos</h4>
            <div class="linha">
                <input type="text" id="filtroServicoFrota" class="input-padrao" placeholder="Filtrar por Frota..."
                    oninput="aplicarFiltrosServicos()">
                <input type="text" id="filtroServicoDescricao" class="input-padrao"
                    placeholder="Filtrar por Descri√ß√£o..." oninput="aplicarFiltrosServicos()">
            </div>
        </div>

        <div id="servicosLista">
        </div>
        <button id="btnAddServico" onclick="adicionarServico()"
            style="background-color: #28a745; color: white; padding: 10px 20px; border-radius: 8px; border: none; cursor: pointer; display: block; margin: 15px auto;">
            Adicionar Novo Servi√ßo
        </button>
        <button id="fabAddFrota" onclick="abrirPopupFrota()"
            style="position: fixed; bottom: 100px; right: 20px; background: #007acc; color: white; border: none; border-radius: 50%; width: 60px; height: 60px; box-shadow: 0 4px 8px rgba(0,0,0,0.3); font-size: 30px; cursor: pointer; z-index: 9999; display: flex; align-items: center; justify-content: center;">
            üöú
        </button>
        <button id="fabAddServicos" onclick="verificarServicosPendentes()"
            style="position: fixed; bottom: 20px; right: 20px; background: #28a745; color: white; border: none; border-radius: 50%; width: 60px; height: 60px; box-shadow: 0 4px 8px rgba(0,0,0,0.3); font-size: 32px; cursor: pointer; z-index: 9999; display: flex; align-items: center; justify-content: center;">
            +
        </button>
    </section>

    <section id="relatorio">
        <div class="grupo">
            <div class="bloco">
                <h4 style="text-align: center;">Visualiza√ß√£o</h4>
                <div id="relatorio_formatado" class="preview" style="white-space: pre-line; min-height: 100px;"></div>
                <textarea id="relatorio_bruto" class="editavel" style="display:none;"></textarea>
            </div>
            <div class="bloco">
                <h4 style="text-align: center;">A√ß√µes</h4>
                <div class="botoes" style="text-align:center; flex-direction: column; gap: 8px;">
                    <button onclick="gerarRelatorioFinal()" class="confirmar">Gerar Relat√≥rio Final</button>
                    <button onclick="compartilharRelatorio()">Compartilhar</button>
                    <button onclick="toggleEdicaoRelatorio()">Editar Relat√≥rio</button>
                    <button onclick="limparRelatorio()" class="perigo">Limpar Relat√≥rio</button>
                </div>
            </div>
        </div>
    </section>

    <section id="historico">
        <div class="grupo">
            <button onclick="abrirPopupApagarPorData()" class="perigo">
                üóëÔ∏è Apagar Hist√≥rico por Data
            </button>
        </div>
        <div id="historico_lista"></div>
        <div class="grupo">
            <button onclick="baixarBackupHistorico()">&#128190; Backup do Hist√≥rico</button>
        </div>
        <div class="grupo">
            <button onclick="document.getElementById('fileBackupHistoricoInput').click()">Restaurar Backup do
                Hist√≥rico</button>
            <input type="file" id="fileBackupHistoricoInput" accept=".json" style="display:none;"
                onchange="restaurarBackupHistorico(event)">
        </div>
    </section>

    <section id="config">
        <div class="grupo">
            <h2>Backup e Dados</h2>
            <p id="infoUltimoBackup">√öltimo backup: Nunca realizado.</p>
            <hr>
            <button onclick="gerarBackupCompleto()">
                üóÑÔ∏è Exportar Dados Completos (Turno Atual + Hist√≥rico)
            </button>
            <p>Exporta tudo: turno atual, servi√ßos atuais, frotas, equipe e todo o hist√≥rico de O.S.</p>

            <button onclick="document.getElementById('fileBackupCompletoInput').click()">
                üîÑ Importar Dados Completos
            </button>
            <input type="file" id="fileBackupCompletoInput" accept=".json" style="display:none;"
                onchange="restaurarBackupCompleto(event)">
            <p>Restaura um arquivo JSON com todos os dados. <strong>Aten√ß√£o: Isso substituir√° todos os dados
                    atuais.</strong></p>
            <hr>
            <button onclick="limparTodosServicos()" class="perigo">
                üóëÔ∏è Limpar todos os servi√ßos do turno atual</button>
            <p style="color:#d9534f;">Apaga todos os servi√ßos criados no turno atual. (Confirma√ß√£o necess√°ria)</p>
            <hr>
            <button onclick="limparStorage()" class="perigo">
                üóëÔ∏è Resetar Tudo (Apagar TODOS os dados salvos)
            </button>
            <p style="color:#d9534f;">Apaga todos os dados do aplicativo, incluindo hist√≥rico. Reset total. (Confirma√ß√£o
                necess√°ria)</p>
        </div>
    </section>

    <div id="toast"></div>

    <div class="popup-overlay" id="overlayFrota"></div>
    <div class="popup" id="popupFrota">
        <h3>Adicionar Frota</h3>
        <label>Frota</label>
        <input type="text" id="inputFrota" placeholder="Ex.: JD6115J">
        <label>Horas Planejadas</label>
        <input type="number" step="0.1" id="inputHoraFrota" placeholder="Ex.: 7.5 (7h30min)">
        <small style="display:block; margin-bottom: 10px;">Use ponto para decimal.</small>
        <div class="botoes">
            <button class="confirmar" onclick="confirmarFrota()">Adicionar</button>
            <button class="cancelar" onclick="fecharPopupFrota()">Cancelar</button>
        </div>
    </div>

    <div class="popup-overlay" id="overlayOportunidade"></div>
    <div class="popup" id="popupOportunidade">
        <h3>Informar Oportunidade</h3>
        <input type="text" id="inputOportunidade" placeholder="Ex.: Refei√ß√£o, DDS..." style="width:100%; padding:10px;">
        <div class="botoes">
            <button class="confirmar" onclick="confirmarOportunidade()">Confirmar</button>
            <button class="cancelar" onclick="cancelarOportunidade()">Cancelar</button>
        </div>
    </div>

    <div class="popup-overlay" id="overlayApagarData"></div>
    <div class="popup" id="popupApagarData">
        <h3>Selecione a Data do Hist√≥rico para Apagar</h3>
        <select id="selectDatas" style="width:100%; padding:10px; margin-bottom:10px;"></select>
        <div class="botoes">
            <button class="perigo" onclick="confirmarApagarPorData()">Apagar</button>
            <button class="cancelar" onclick="fecharPopupApagarData()">Cancelar</button>
        </div>
    </div>

    <div class="popup-overlay" id="overlayConfirmar"></div>
    <div class="popup" id="popupConfirmar">
        <h3 id="popupConfirmarTitulo">Confirma√ß√£o</h3>
        <p id="popupConfirmarMensagem">Mensagem aqui...</p>
        <div class="botoes">
            <button class="confirmar" id="btnPopupConfirmarAcao" onclick="confirmarPopupAcao()">Confirmar</button>
            <button class="cancelar" onclick="fecharPopupConfirmar()">Cancelar</button>
        </div>
    </div>

    <div class="popup-overlay" id="overlayPopup"></div>
    <div class="popup" id="popupGenerico">
        <h3 id="popupTitulo"></h3>
        <p id="popupMensagem"></p>
        <div class="botoes" id="popupBotoes"></div>
    </div>

    <div id="update-popup"
        style="display:none;position:fixed;bottom:20px;left:50%;transform:translateX(-50%);background:#007acc;color:white;padding:15px 25px;border-radius:10px;box-shadow:0 4px 10px rgba(0,0,0,0.3);z-index:1000;font-weight:bold;">
        Nova vers√£o dispon√≠vel. <button onclick="location.reload()"
            style="background:white;color:#007acc;border:none;font-weight:bold;padding:5px 10px;border-radius:5px;cursor:pointer;">Atualizar</button>
    </div>

    <script>
        // Vari√°veis globais de estado
        let equipe = [];
        let frotasTurno = [];
        let servicos = [];
        let callbackOportunidade = null;
        let callbackConfirmar = null;
        window._deveRestaurarServicos = true;

        const atividades = [
            "P001 - AFERIDO", "P002 - AJUSTADO", "P003 - ALINHADO", "P004 - APERTADO",
            "P005 - BALANCEADO", "P006 - CALIBRADO", "P007 - COMPLETADO", "P008 - CONSERTADO COMPONENTE",
            "P009 - DESAMASSADO", "P010 - DESOBSTRUIDO", "P011 - EMBUCHADO", "P012 - FIXADO",
            "P013 - FURADO", "P014 - HIGIENIZADO", "P015 - INSPECIONADO", "P016 - INSTALADO",
            "P017 - ISOLADO", "P018 - LIMPO", "P019 - LUBRIFICADO", "P020 - MODIFICADO",
            "P021 - REAPERTADO", "P022 - RECARREGADO", "P023 - RECUPERADO", "P024 - REFORMADO",
            "P025 - REGULADO", "P026 - REMONTADO", "P027 - REPROGRAMADO", "P028 - RETIFICADO",
            "P029 - SOLDADO", "P030 - SUBSTITUIDO - TROCADO", "P031 - USINADO", "P032 - VEDADO",
            "H01 - Atraso de transporte", "H02 - DDS", "H03 - Refei√ß√£o", "H04 - Organiza√ß√£o/Limpeza",
            "H05 - Aguardando pe√ßa", "H06 - Aguardando Ferramenta", "H07 - Aguardando Servi√ßo",
            "H08 - Falta do colaborador", "H09 - Reuni√£o", "H10 - Ambulatorio", "H11 - Treinamento",
            "H12 - Outros", "H13 - Deslocamento a terceiros", "H14 - Carregamento de pneus pra conserto",
            "H15 - Inventario", "H16 - Apoio a Opera√ß√£o"
        ];
        const sistemas = {
            "Tratores": [
                { cod: "1", nome: "Estrutura" }, { cod: "2", nome: "Cabine" }, { cod: "3", nome: "Motor Combustao" },
                { cod: "4", nome: "Eletrico" }, { cod: "5", nome: "Trem de Forca" }, { cod: "6", nome: "Tracao" },
                { cod: "7", nome: "Hidraulico" }, { cod: "8", nome: "Direcao" }, { cod: "9", nome: "Freio" }
            ],
            "Implementos": [
                { cod: "10", nome: "Estrutura" }, { cod: "11", nome: "Tracao" }, { cod: "12", nome: "Adubo" },
                { cod: "13", nome: "Hidraulico" }, { cod: "14", nome: "Eletrico" }, { cod: "15", nome: "V-SHEAR" }
            ]
        };
        const subsistemas = {
            "1": ["1.1 - Chassi", "1.2 - Protecao", "1.3 - Escapamento", "1.4 - Suportes", "1.5 - Escada", "1.6 - Fixacao", "1.7 - Paralama", "1.8 - Tanque", "1.9 - Eixo", "1.10 - Chaparia", "1.11 - Alavanca"],
            "2": ["2.1 - Refrigecao", "2.2 - Banco", "2.3 - Vidros", "2.4 - Painel", "2.5 - Portas", "2.6 - Hodometro", "2.7 - Radio", "2.8 - Tacografo", "2.9 - Cinto de Seguranca", "2.10 - Cabine", "2.11 - Capo", "2.12 - Buzina"],
            "3": ["3.1 - Radiador", "3.2 - Motor", "3.3 - Intercooler", "3.4 - Arla", "3.5 - Filtro", "3.6 - Ignicao"],
            "4": ["4.1 - Iluminacao", "4.2 - Eletrica", "4.3 - Bateria", "4.4 - Chicote", "4.5 - Rastreador", "4.6 - Alternador", "4.7 - Encoder", "4.8 - Camera", "4.9 - Modulo", "4.10 - Comutador", "4.11 - Fluxometro", "4.12 - GPS"],
            "5": ["5.1 - Cubo", "5.2 - Embreagem", "5.3 - Cambio", "5.4 - Diferencial", "5.5 - Transmissao"],
            "6": ["6.1 - Pneu", "6.2 - Roda", "6.3 - Esteira", "6.4 - Roda Motriz", "6.5 - Roda Estrelada"],
            "7": ["7.1 - Mangueiras", "7.2 - Valvulas", "7.3 - Atuador", "7.4 - Bombas", "7.5 - Cilindro", "7.6 - VCR"],
            "8": ["8.1 - Barra de direcao", "8.2 - Coluna Direcao", "8.3 - Volante"],
            "9": ["9.1 - Freio", "9.2 - Acumulador"],
            "10": ["10.1 - Disco de Corte", "10.2 - Cabecalho", "10.3 - Ferramenta Traseira", "10.4 - Limpa Trilho", "10.5 - Quadro", "10.6 - Escarificador", "10.7 - Fixacao", "10.8 - Tanque", "10.9 - Eixo", "10.10 - Braco"],
            "11": ["11.1 - Pneus", "11.2 - Roda", "11.3 - Mancal"],
            "12": ["12.1 - Caixa de Adubo"],
            "13": ["13.1 - Cilindro", "13.2 - Mangueira", "13.3 - Bloco", "13.4 - Valvula"],
            "14": ["14.1 - Sensores", "14.2 - Chicote"],
            "15": ["15.1 - Lamina", "15.2 - Ball"]
        };

        // UTILITIES
        function showToast(msg) {
            const toast = document.getElementById("toast");
            if (!toast) return console.error("Elemento toast n√£o encontrado.");
            toast.innerText = msg;
            toast.className = "show";
            setTimeout(() => toast.className = toast.className.replace("show", ""), 3000);
        }

        function dataHojeBR() {
            return new Date().toLocaleDateString('pt-BR');
        }

        function dataHojeInputLocal() {
            const hoje = new Date();
            const ano = hoje.getFullYear();
            const mes = (hoje.getMonth() + 1).toString().padStart(2, '0');
            const dia = hoje.getDate().toString().padStart(2, '0');
            return `${ano}-${mes}-${dia}`;
        }


        function fecharTeclado() {
            if (document.activeElement && typeof document.activeElement.blur === 'function') {
                document.activeElement.blur();
            }
        }

        function interpretarMarkdown(texto) {
            if (!texto) return "";
            return texto
                .replace(/\*(.*?)\*/g, '<strong>$1</strong>')
                .replace(/_(.*?)_/g, '<em>$1</em>')
                .replace(/~(.*?)~/g, '<del>$1</del>')
                .replace(/\n/g, '<br>');
        }

        // NAVEGA√á√ÉO
        function abrir(modulo) {
            document.querySelectorAll('nav button').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('section').forEach(s => s.classList.remove('active'));

            const secaoAtiva = document.getElementById(modulo);
            const botaoAtivo = document.querySelector(`nav button[onclick="abrir('${modulo}')"]`);

            if (secaoAtiva) secaoAtiva.classList.add('active');
            if (botaoAtivo) botaoAtivo.classList.add('active');

            const fabServico = document.getElementById('fabAddServicos');
            const fabFrota = document.getElementById('fabAddFrota');
            const btnAddServicoGlobal = document.getElementById('btnAddServico');


            if (modulo === 'servicos') {
                if (window._deveRestaurarServicos) {
                    restaurarServicosRascunho();
                    window._deveRestaurarServicos = false;
                }
                if (fabServico) fabServico.style.display = 'flex'; // Mostrar por padr√£o
                if (fabFrota) fabFrota.style.display = 'flex';
                if (btnAddServicoGlobal) { // Controlar bot√£o global
                    btnAddServicoGlobal.style.display = servicos.length === 0 ? 'block' : 'none';
                }
                controlarVisibilidadeFABsScroll(); // Aplicar l√≥gica de scroll
            } else {
                if (fabServico) fabServico.style.display = 'none';
                if (fabFrota) fabFrota.style.display = 'none';
                if (btnAddServicoGlobal) btnAddServicoGlobal.style.display = 'none';
            }
        }

        // GERENCIAMENTO DE POPUPS
        function abrirPopup(titulo, mensagem, botoes = []) {
            document.getElementById('popupTitulo').innerText = titulo;
            document.getElementById('popupMensagem').innerText = mensagem;
            const divBotoes = document.getElementById('popupBotoes');
            divBotoes.innerHTML = '';
            botoes.forEach(b => {
                const btn = document.createElement('button');
                btn.className = b.classe || 'confirmar';
                btn.innerText = b.texto;
                btn.onclick = () => {
                    fecharPopup();
                    if (b.acao) b.acao();
                };
                divBotoes.appendChild(btn);
            });
            document.getElementById('popupGenerico').style.display = 'block';
            document.getElementById('overlayPopup').style.display = 'block';
            fecharTeclado();
        }

        function fecharPopup() {
            document.getElementById('popupGenerico').style.display = 'none';
            document.getElementById('overlayPopup').style.display = 'none';
        }

        function abrirPopupConfirmar(mensagem, acao, titulo = "Confirma√ß√£o") {
            document.getElementById('popupConfirmarTitulo').innerText = titulo;
            document.getElementById('popupConfirmarMensagem').innerText = mensagem;
            document.getElementById('overlayConfirmar').style.display = 'block';
            document.getElementById('popupConfirmar').style.display = 'block';
            callbackConfirmar = acao;
            fecharTeclado();
        }

        function confirmarPopupAcao() {
            if (callbackConfirmar) callbackConfirmar();
            fecharPopupConfirmar();
        }

        function fecharPopupConfirmar() {
            document.getElementById('overlayConfirmar').style.display = 'none';
            document.getElementById('popupConfirmar').style.display = 'none';
        }

        function abrirPopupOportunidade(callback) {
            callbackOportunidade = callback;
            document.getElementById('popupOportunidade').style.display = 'block';
            document.getElementById('overlayOportunidade').style.display = 'block';
            const inputOportunidade = document.getElementById('inputOportunidade');
            inputOportunidade.value = '';
            inputOportunidade.focus();
        }

        function fecharPopupOportunidade() {
            document.getElementById('popupOportunidade').style.display = 'none';
            document.getElementById('overlayOportunidade').style.display = 'none';
        }

        function confirmarOportunidade() {
            const valor = document.getElementById('inputOportunidade').value.trim();
            if (callbackOportunidade) callbackOportunidade(valor);
            fecharPopupOportunidade();
        }

        function cancelarOportunidade() {
            if (callbackOportunidade) callbackOportunidade('');
            fecharPopupOportunidade();
        }

        function abrirPopupFrota() {
            document.getElementById('popupFrota').style.display = 'block';
            document.getElementById('overlayFrota').style.display = 'block';
            document.getElementById('inputFrota').value = '';
            document.getElementById('inputHoraFrota').value = '';
            document.getElementById('inputFrota').focus();
        }

        function fecharPopupFrota() {
            document.getElementById('popupFrota').style.display = 'none';
            document.getElementById('overlayFrota').style.display = 'none';
        }

        function confirmarFrota() {
            if (!validarCamposTurnoBasicos()) return;
            const nome = document.getElementById('inputFrota').value.trim();
            const horasInput = document.getElementById('inputHoraFrota').value;

            if (!nome || horasInput === "") {
                showToast("Preencha corretamente a frota e as horas!");
                return;
            }
            const horas = parseFloat(horasInput);
            if (isNaN(horas) || horas <= 0) {
                showToast("As horas da frota devem ser um n√∫mero positivo!");
                return;
            }

            frotasTurno.push({ nome, horas });
            renderizarFrotas();
            atualizarSelectsDeFrotasNosServicos();
            fecharPopupFrota();
            showToast("Frota adicionada!");
            salvarTudo();
        }


        // VALIDA√á√ÉO DE CAMPOS DO TURNO
        function validarCamposTurnoBasicos() {
            const dataTurno = document.getElementById('dataTurno').value;
            const fazenda = document.getElementById('fazenda').value.trim();
            const frente = document.getElementById('frente').value.trim();

            if (!dataTurno || !fazenda || !frente) {
                showToast("Aten√ß√£o: Preencha Data, Fazenda e Frente do turno primeiro!");
                if (!dataTurno) document.getElementById('dataTurno').focus();
                else if (!fazenda) document.getElementById('fazenda').focus();
                else document.getElementById('frente').focus();
                return false;
            }
            return true;
        }


        // EQUIPE
        function adicionarEquipe() {
            if (!validarCamposTurnoBasicos()) return;
            const nome = document.getElementById('nomeEquipe').value.trim();
            const matricula = document.getElementById('matriculaEquipe').value.trim();

            if (nome && matricula) {
                equipe.push({ nome, matricula });
                salvarEquipe();
                renderizarEquipe();
                document.getElementById('nomeEquipe').value = '';
                document.getElementById('matriculaEquipe').value = '';
                showToast('Membro adicionado √† equipe!');
            } else {
                showToast('Preencha nome e matr√≠cula corretamente!');
            }
        }

        function removerEquipe() {
            abrirPopupConfirmar("Tem certeza que deseja limpar toda a equipe?", () => {
                equipe = [];
                salvarEquipe();
                renderizarEquipe();
                showToast('Equipe limpa!');
            });
        }

        function salvarEdicoesEquipe() {
            const inputsNome = document.querySelectorAll('.input-nome-equipe');
            const inputsMatricula = document.querySelectorAll('.input-matricula-equipe');
            const novaEquipe = [];
            for (let i = 0; i < inputsNome.length; i++) {
                const nome = inputsNome[i].value.trim();
                const matricula = inputsMatricula[i].value.trim();
                if (nome && matricula) {
                    novaEquipe.push({ nome, matricula });
                }
            }
            equipe = novaEquipe;
            salvarEquipe();
            renderizarEquipe();
            showToast('Altera√ß√µes na equipe salvas!');
        }

        function renderizarEquipe() {
            const box = document.getElementById('boxEquipe');
            if (!box) return;
            if (equipe.length === 0) {
                box.innerHTML = '<p>Nenhum membro na equipe.</p>';
                return;
            }
            let html = `<div style="background: #f5f5f5; border: 1px solid #ccc; border-radius: 6px; padding: 5px 10px; margin-top: 10px;">`;
            equipe.forEach((item) => {
                html += `
                    <div style="display: flex; gap: 5px; margin-bottom: 5px;">
                        <input class="input-padrao input-nome-equipe" type="text" value="${item.nome}" placeholder="Nome do membro" style="flex:1;">
                        <input class="input-padrao input-matricula-equipe" type="text" value="${item.matricula}" placeholder="Matr√≠cula" style="flex:1;">
                    </div>`;
            });
            html += `</div>
                     <div style="margin-top:5px; display:flex; gap:5px;">
                         <button onclick="salvarEdicoesEquipe()" class="confirmar" style="flex:1;">Salvar Altera√ß√µes na Equipe</button>
                         <button onclick="removerEquipe()" class="perigo" style="flex:1;">Limpar Equipe</button>
                     </div>`;
            box.innerHTML = html;
        }

        function obterEquipeTexto() {
            if (equipe.length === 0) return "Equipe n√£o informada.";
            return equipe.map(item => `${item.nome} - ${item.matricula}`).join('\n');
        }

        function salvarEquipe() {
            salvarTudo();
        }


        // FROTAS
        function adicionarFrota() {
            if (!validarCamposTurnoBasicos()) return;
            const nome = document.getElementById('novaFrota').value.trim();
            const horasInput = document.getElementById('novaHoraFrota').value;

            if (!nome || horasInput === "") {
                showToast("Preencha corretamente a frota e as horas!");
                return;
            }
            const horas = parseFloat(horasInput);
            if (isNaN(horas) || horas <= 0) {
                showToast("As horas da frota devem ser um n√∫mero positivo!");
                return;
            }

            frotasTurno.push({ nome, horas });
            renderizarFrotas();
            atualizarSelectsDeFrotasNosServicos();
            document.getElementById('novaFrota').value = '';
            document.getElementById('novaHoraFrota').value = '';
            showToast("Frota adicionada!");
            salvarTudo();
        }

        function renderizarFrotas() {
            const div = document.getElementById('listaFrotas');
            if (!div) return;
            if (frotasTurno.length === 0) {
                div.innerHTML = "<p>Nenhuma frota adicionada.</p>";
                return;
            }
            div.innerHTML = frotasTurno.map((f, i) => `
                <div style="display:flex; justify-content: space-between; align-items:center; padding: 5px; border-bottom: 1px solid #eee;">
                    <span>Frota: <strong>${f.nome}</strong> - ${f.horas.toFixed(2)}h</span>
                    <button onclick="removerFrota(${i})" class="perigo" style="padding: 5px 10px; width: auto;">Remover</button>
                </div>`).join('');
        }

        function removerFrota(index) {
            abrirPopupConfirmar('Deseja realmente remover esta frota?', () => {
                frotasTurno.splice(index, 1);
                renderizarFrotas();
                atualizarSelectsDeFrotasNosServicos();
                showToast("Frota removida!");
                salvarTudo();
            });
        }

        function atualizarSelectsDeFrotasNosServicos() {
            servicos.forEach(s => {
                const select = document.getElementById(`frota_${s.id}`);
                if (select) {
                    const valorSelecionadoAnteriormente = select.value || s.frota;
                    select.innerHTML = '<option value="">Nenhuma</option>' + frotasTurno.map(f =>
                        `<option value="${f.nome}" ${f.nome === valorSelecionadoAnteriormente ? 'selected' : ''}>${f.nome}</option>`
                    ).join('');
                }
            });
        }

        // SERVI√áOS (O.S)
        function adicionarServico(dadosPreenchidos = null) {
            if (!validarCamposTurnoBasicos()) return;
            salvarValoresServicos();

            const id = Date.now();
            const novoServico = dadosPreenchidos || {
                id, sistema: "", subsistema: "", frota: "", atividade: "", descricao: "", texto: "",
                tipo: "CORRETIVA", parada: "sim", falha: "n√£o", data: dataHojeInputLocal(), dataFinal: dataHojeInputLocal(), inicio: "", fim: "",
                oportunidade: ""
            };
            novoServico.id = id;

            servicos.push(novoServico);
            renderizarServicos(); // Isso tamb√©m vai atualizar a visibilidade do bot√£o global
            showToast("Novo servi√ßo adicionado. Preencha os detalhes.");

            setTimeout(() => {
                const el = document.getElementById(`servico_${id}`);
                if (el) {
                    el.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    const detalhes = document.getElementById(`detalhes_${id}`);
                    const toggler = document.getElementById(`toggler_${id}`);
                    if (detalhes && toggler && detalhes.style.display === 'none') {
                        toggleDetalhesServico(id);
                    }
                }
            }, 100);
        }

        function salvarServicosRascunho() {
            const servicosAtuais = [];
            document.querySelectorAll('#servicosLista .servico').forEach(divServico => {
                const id = parseInt(divServico.id.replace('servico_', ''));
                const servicoExistente = servicos.find(s => s.id === id);
                if (servicoExistente) {
                    servicosAtuais.push({
                        id: id,
                        frota: document.getElementById(`frota_${id}`)?.value || "",
                        atividade: document.getElementById(`atividade_${id}`)?.value || "",
                        sistema: document.getElementById(`sistema_${id}`)?.value || "",
                        subsistema: document.getElementById(`subsistema_${id}`)?.value || "",
                        descricao: document.getElementById(`descricao_${id}`)?.value || "",
                        tipo: document.getElementById(`tipo_${id}`)?.value || "CORRETIVA",
                        parada: document.getElementById(`parada_${id}`)?.value || "sim",
                        falha: document.getElementById(`falha_${id}`)?.value || "n√£o",
                        data: document.getElementById(`data_${id}`)?.value || dataHojeInputLocal(),
                        dataFinal: document.getElementById(`dataFinal_${id}`)?.value || document.getElementById(`data_${id}`)?.value || dataHojeInputLocal(),
                        inicio: document.getElementById(`inicio_${id}`)?.value || "",
                        fim: document.getElementById(`fim_${id}`)?.value || "",
                        texto: document.getElementById(`texto_${id}`)?.value || "",
                        oportunidade: servicoExistente.oportunidade || ""
                    });
                }
            });
            try {
                localStorage.setItem('servicosRascunho', JSON.stringify(servicosAtuais));
            } catch (e) {
                console.error("Erro ao salvar rascunho de servi√ßos no localStorage:", e);
                if (e.name === 'QuotaExceededError') {
                    showToast("Erro: N√£o h√° espa√ßo para salvar o rascunho. Tente limpar dados antigos.");
                } else {
                    showToast("Erro ao salvar rascunho de servi√ßos.");
                }
            }
        }

        function restaurarServicosRascunho() {
            let rascunhos = [];
            let rascunhoString;
            try {
                rascunhoString = localStorage.getItem('servicosRascunho');
                if (rascunhoString) {
                    rascunhos = JSON.parse(rascunhoString);
                }
            } catch (e) {
                console.error("Erro ao carregar rascunho de servi√ßos do localStorage:", e);
                try { localStorage.removeItem('servicosRascunho'); } catch (e2) { console.error("Erro ao remover rascunho corrompido:", e2); }
                showToast("Erro ao carregar rascunho de servi√ßos. Rascunho removido.");
                return;
            }

            if (rascunhos && rascunhos.length > 0) {
                if (servicos.length > 0) {
                    console.warn("Rascunho de servi√ßos encontrado, mas j√° existem servi√ßos carregados. Rascunho n√£o aplicado automaticamente para evitar sobrescrita. Verifique os dados.");
                } else {
                    servicos = rascunhos;
                    renderizarServicos();
                    showToast("Rascunho de servi√ßos restaurado.");
                    try {
                        localStorage.removeItem('servicosRascunho');
                    } catch (e) {
                        console.error("Erro ao remover rascunho de servi√ßos ap√≥s restaura√ß√£o:", e);
                    }
                }
            } else if (rascunhoString) {
                try { localStorage.removeItem('servicosRascunho'); } catch (e) { console.error("Erro ao remover rascunho vazio/inv√°lido:", e); }
            }
        }

        function getCabecalhoServicoTexto(servico) {
            const frota = servico.frota || "N/D";
            let atividadeTexto = "N/D";
            if (servico.atividade) {
                const partesAtividade = servico.atividade.split(" - ");
                atividadeTexto = partesAtividade.length > 1 ? partesAtividade[1] : partesAtividade[0]; // Pega a descri√ß√£o da atividade
                if (atividadeTexto.length > 25) {
                    atividadeTexto = atividadeTexto.substring(0, 25) + "...";
                }
            }
            return `<span class="frota-destaque">Frota: ${frota}</span> <span class="atividade-info">| Atividade: ${atividadeTexto}</span>`;
        }

        function renderizarServicos() {
            const filtroFrota = document.getElementById('filtroServicoFrota')?.value.toLowerCase() || "";
            const filtroDescricao = document.getElementById('filtroServicoDescricao')?.value.toLowerCase() || "";

            const servicosFiltrados = servicos.filter(s => {
                const frotaMatch = !filtroFrota || (s.frota && s.frota.toLowerCase().includes(filtroFrota));
                const descricaoMatch = !filtroDescricao || (s.descricao && s.descricao.toLowerCase().includes(filtroDescricao));
                return frotaMatch && descricaoMatch;
            });

            const divLista = document.getElementById("servicosLista");
            if (!divLista) return;

            divLista.innerHTML = servicosFiltrados.map(s => {
                const classesServico = ['grupo', 'servico'];
                const osNaoGerada = !s.texto || s.texto.trim() === "";
                if (osNaoGerada) {
                    classesServico.push('servico-pendente-os');
                }
                const subsistemasAtuais = subsistemas[s.sistema] || [];
                const textoCabecalho = getCabecalhoServicoTexto(s);


                return `
                <div class="${classesServico.join(' ')}" id="servico_${s.id}" style="margin-bottom: 20px;">
                    <div class="servico-cabecalho" onclick="toggleDetalhesServico(${s.id})">
                        <div class="servico-cabecalho-info">${textoCabecalho}</div>
                        <span id="toggler_${s.id}" class="servico-cabecalho-toggler">‚ñº</span>
                    </div>
                    <div class="servico-detalhes" id="detalhes_${s.id}" style="display:none;">
                        <div class="bloco">
                            <h4>Identifica√ß√£o da O.S</h4>
                            <div class="linha">
                                <div style="flex:1;">
                                    <label>Frota*</label>
                                    <select id="frota_${s.id}" class="input-padrao" onchange="atualizarCabecalhoServico(${s.id})">
                                        <option value="">Nenhuma</option>
                                        ${frotasTurno.map(f => `<option value="${f.nome}" ${s.frota === f.nome ? 'selected' : ''}>${f.nome}</option>`).join('')}
                                    </select>
                                </div>
                                <div style="flex:1;">
                                    <label>Atividade*</label>
                                    <select id="atividade_${s.id}" class="input-padrao" onchange="atualizarCabecalhoServico(${s.id})">
                                        <option value="">Nenhuma</option>
                                        ${atividades.map(a => `<option value="${a}" ${s.atividade === a ? 'selected' : ''}>${a}</option>`).join('')}
                                    </select>
                                </div>
                            </div>
                            <label>Sistema*</label>
                            <select id="sistema_${s.id}" class="input-padrao" onchange="carregarSubsistema(${s.id});">
                                <option value="">Nenhum</option>
                                ${Object.entries(sistemas).map(([g, lst]) => `
                                    <optgroup label="${g}">
                                        ${lst.map(sys => `<option value="${sys.cod}" ${s.sistema === sys.cod ? 'selected' : ''}>${sys.cod} - ${sys.nome}</option>`).join('')}
                                    </optgroup>`).join('')}
                            </select>
                            <label>Subsistema*</label>
                            <select id="subsistema_${s.id}" class="input-padrao">
                                <option value="">Nenhum</option>
                                ${subsistemasAtuais.map(sub => `<option value="${sub}" ${s.subsistema === sub ? 'selected' : ''}>${sub}</option>`).join('')}
                            </select>
                        </div>
                        <div class="bloco">
                            <h4>Opera√ß√£o</h4>
                            <div class="linha">
                                <div style="flex:1;"><label>M√°quina parada?*</label><select id="parada_${s.id}" class="input-padrao"><option value="sim" ${s.parada === "sim" ? 'selected' : ''}>Sim</option><option value="n√£o" ${s.parada === "n√£o" ? 'selected' : ''}>N√£o</option></select></div>
                                <div style="flex:1;"><label>Falha operacional?*</label><select id="falha_${s.id}" class="input-padrao"><option value="n√£o" ${s.falha === "n√£o" ? 'selected' : ''}>N√£o</option><option value="sim" ${s.falha === "sim" ? 'selected' : ''}>Sim</option></select></div>
                            </div>
                            <label>Tipo de manuten√ß√£o*</label><select id="tipo_${s.id}" class="input-padrao"><option value="CORRETIVA" ${s.tipo === "CORRETIVA" ? 'selected' : ''}>CORRETIVA</option><option value="CONDICIONAL" ${s.tipo === "CONDICIONAL" ? 'selected' : ''}>CONDICIONAL</option><option value="MELHORIA" ${s.tipo === "MELHORIA" ? 'selected' : ''}>MELHORIA</option></select>
                            <div class="linha">
                                <div style="flex:1;"><label>Data inicial*</label><input type="date" id="data_${s.id}" value="${s.data || dataHojeInputLocal()}" class="input-padrao"></div>
                                <div style="flex:1;"><label>Hora inicial*</label><input type="time" id="inicio_${s.id}" value="${s.inicio || ''}" class="input-padrao"></div>
                            </div>
                            <div class="linha">
                                <div style="flex:1;"><label>Data final*</label><input type="date" id="dataFinal_${s.id}" value="${s.dataFinal || s.data || dataHojeInputLocal()}" class="input-padrao"></div>
                                <div style="flex:1;"><label>Hora final*</label><input type="time" id="fim_${s.id}" value="${s.fim || ''}" class="input-padrao"></div>
                            </div>
                        </div>
                        <div class="bloco">
                            <h4>Descri√ß√£o*</h4>
                            <textarea id="descricao_${s.id}" class="input-padrao descricao" placeholder="Detalhe o problema encontrado e a solu√ß√£o aplicada. Ex: Vazamento na mangueira X, substitu√≠da por nova. Reaperto do parafuso Y." style="font-family: 'Segoe UI', Roboto, sans-serif; font-size: 16px; line-height: 1.4;">${s.descricao || ""}</textarea>
                        </div>
                        <div class="bloco">
                            <div class="botoes" style="flex-direction: column; gap: 8px;"> 
                                <button id="botao_${s.id}" onclick="processarOS(${s.id})" class="confirmar" style="background:#007acc; color:white;">${osNaoGerada ? "Gerar O.S." : "Regerar O.S."}</button>
                                ${osNaoGerada ? `<button onclick="removerServico(${s.id})" class="perigo">Excluir Este Servi√ßo</button>` : ''}
                            </div>
                            <div id="preview_container_${s.id}" style="display: ${!osNaoGerada ? 'block' : 'none'}; margin-top:10px;">
                                <div id="preview_${s.id}" class="preview">${interpretarMarkdown(s.texto || "")}</div>
                                <div class="botoes" style="margin-top:10px; flex-direction: column; gap: 8px;">
                                    <button onclick="copiarTexto(${s.id})">Copiar Texto</button>
                                    <button onclick="compartilharWhatsApp(${s.id})">Compartilhar</button>
                                    <button onclick="adicionarServicoDepois(${s.id})" style="background:#28a745; color:white;">Adicionar Outro Servi√ßo Nesta Frota</button>
                                    <button onclick="removerServico(${s.id})" class="perigo">Excluir Este Servi√ßo</button> 
                                </div>
                            </div>
                            <textarea class="editavel input-padrao" id="texto_${s.id}" style="display:none;">${s.texto || ""}</textarea>
                        </div>
                    </div>
                </div>`;
            }).join('');

            aplicarEventosRascunho();
            // Atualizar visibilidade do bot√£o global "Adicionar Novo Servi√ßo"
            const btnAddServicoGlobal = document.getElementById('btnAddServico');
            if (btnAddServicoGlobal) {
                btnAddServicoGlobal.style.display = servicos.length === 0 ? 'block' : 'none';
            }
        }

        function atualizarCabecalhoServico(servicoId) {
            const servico = servicos.find(s => s.id === servicoId);
            if (!servico) return;

            // Atualiza os valores do servi√ßo a partir dos inputs antes de gerar o texto do cabe√ßalho
            servico.frota = document.getElementById(`frota_${servicoId}`)?.value || servico.frota;
            servico.atividade = document.getElementById(`atividade_${servicoId}`)?.value || servico.atividade;

            const cabecalhoInfoDiv = document.querySelector(`#servico_${servicoId} .servico-cabecalho-info`);
            if (cabecalhoInfoDiv) {
                cabecalhoInfoDiv.innerHTML = getCabecalhoServicoTexto(servico);
            }
        }


        function toggleDetalhesServico(id) {
            const detalhes = document.getElementById(`detalhes_${id}`);
            const toggler = document.getElementById(`toggler_${id}`);
            if (detalhes && toggler) {
                if (detalhes.style.display === 'none' || detalhes.style.display === '') {
                    detalhes.style.display = 'block';
                    toggler.textContent = '‚ñ≤';
                } else {
                    detalhes.style.display = 'none';
                    toggler.textContent = '‚ñº';
                }
            }
        }

        function aplicarEventosRascunho() {
            document.querySelectorAll('#servicosLista .servico input, #servicosLista .servico select, #servicosLista .servico textarea').forEach(el => {
                el.removeEventListener('input', salvarServicosRascunho);
                el.removeEventListener('change', salvarServicosRascunho);
                el.addEventListener('input', salvarServicosRascunho);
                el.addEventListener('change', salvarServicosRascunho);

                // Adicionar listener para atualizar cabe√ßalho em tempo real para frota e atividade
                if (el.id.startsWith('frota_') || el.id.startsWith('atividade_')) {
                    const servicoId = parseInt(el.id.split('_')[1]);
                    el.removeEventListener('change', () => atualizarCabecalhoServico(servicoId)); // Evitar duplicidade
                    el.addEventListener('change', () => atualizarCabecalhoServico(servicoId));
                }
            });
        }

        function aplicarFiltrosServicos() {
            renderizarServicos();
        }

        function carregarSubsistema(id) {
            const servico = servicos.find(s => s.id === id);
            if (!servico) return;

            const sistemaSelecionado = document.getElementById(`sistema_${id}`).value;
            servico.sistema = sistemaSelecionado; // Atualiza o objeto servi√ßo
            const subsistemasDisponiveis = subsistemas[sistemaSelecionado] || [];
            const selectSub = document.getElementById(`subsistema_${id}`);

            const valorSubsistemaAnterior = servico.subsistema;
            selectSub.innerHTML = `<option value="">Nenhum</option>` +
                subsistemasDisponiveis.map(sub =>
                    `<option value="${sub}" ${sub === valorSubsistemaAnterior ? 'selected' : ''}>${sub}</option>`
                ).join('');

            if (!subsistemasDisponiveis.includes(valorSubsistemaAnterior)) {
                servico.subsistema = "";
                selectSub.value = "";
            } else {
                selectSub.value = valorSubsistemaAnterior;
            }
        }

        function processarOS(id) {
            salvarValoresServicos(); // Garante que os dados dos inputs est√£o no objeto servico
            const servico = servicos.find(s => s.id === id);
            if (!servico) {
                showToast("Erro: Servi√ßo n√£o encontrado.");
                return;
            }

            if (!servico.frota || !servico.atividade || !servico.sistema || !servico.subsistema || !servico.descricao.trim() || !servico.data || !servico.inicio || !servico.dataFinal || !servico.fim) {
                abrirPopup("Campos Obrigat√≥rios", "Por favor, preencha todos os campos marcados com (*) na O.S antes de ger√°-la: Frota, Atividade, Sistema, Subsistema, Descri√ß√£o, Datas e Horas.", [{ texto: 'OK', classe: 'confirmar' }]);
                return;
            }

            const dataInicialObj = new Date(`${servico.data}T${servico.inicio}`);
            const dataFinalObj = new Date(`${servico.dataFinal}T${servico.fim}`);

            if (dataFinalObj < dataInicialObj) {
                abrirPopup("Erro de Data/Hora", "A data/hora final n√£o pode ser anterior √† data/hora inicial do servi√ßo.", [{ texto: 'OK', classe: 'confirmar' }]);
                return;
            }
            verificarDataCruzaMeiaNoite(servico, () => {
                const botao = document.getElementById(`botao_${id}`);
                const osGeradaAnteriormente = servico.texto && servico.texto.trim() !== "";

                const acaoGerar = () => {
                    if (servico.tipo === "CONDICIONAL" || servico.tipo === "MELHORIA") {
                        abrirPopupOportunidade(oportunidade => {
                            servico.oportunidade = oportunidade;
                            gerarTextoOSFinal(servico);
                        });
                    } else {
                        servico.oportunidade = '';
                        gerarTextoOSFinal(servico);
                    }
                };

                if (osGeradaAnteriormente) {
                    abrirPopupConfirmar('Deseja realmente regerar esta O.S.? O texto anterior ser√° substitu√≠do.', () => {
                        acaoGerar();
                        if (botao) botao.innerText = "Regerar O.S.";
                    });
                } else {
                    acaoGerar();
                    if (botao) botao.innerText = "Regerar O.S.";
                }
            });
        }

        function verificarDataCruzaMeiaNoite(servico, callbackContinua) {
            const dataIniStr = servico.data;
            const horaIniStr = servico.inicio;
            const dataFimStr = servico.dataFinal;
            const horaFimStr = servico.fim;

            if (!dataIniStr || !horaIniStr || !dataFimStr || !horaFimStr) {
                if (callbackContinua) callbackContinua();
                return;
            }

            const [hIni, mIni] = horaIniStr.split(':').map(Number);
            const [hFim, mFim] = horaFimStr.split(':').map(Number);

            if (dataIniStr === dataFimStr && (hFim < hIni || (hFim === hIni && mFim < mIni))) {
                abrirPopupConfirmar(
                    `O hor√°rio final (${horaFimStr}) √© menor que o inicial (${horaIniStr}) na mesma data (${dataIniStr}). Deseja ajustar a Data Final para o dia seguinte?`,
                    () => {
                        const novaData = new Date(dataFimStr + "T00:00:00");
                        novaData.setDate(novaData.getDate() + 1);
                        const novaDataFormatada = novaData.toISOString().split('T')[0];

                        servico.dataFinal = novaDataFormatada;
                        const inputDataFinal = document.getElementById(`dataFinal_${servico.id}`);
                        if (inputDataFinal) inputDataFinal.value = novaDataFormatada;

                        showToast(`Data final ajustada para ${novaDataFormatada.split('-').reverse().join('/')}.`);
                        if (callbackContinua) callbackContinua();
                    },
                    "Ajuste de Data"
                );
                const btnCancelar = document.querySelector('#popupConfirmar .cancelar');
                if (btnCancelar) {
                    const novoCancelar = btnCancelar.cloneNode(true);
                    novoCancelar.onclick = () => {
                        fecharPopupConfirmar();
                        showToast("Gera√ß√£o da O.S. cancelada devido √† data/hora inconsistente.");
                    };
                    btnCancelar.parentNode.replaceChild(novoCancelar, btnCancelar);
                }

            } else {
                if (callbackContinua) callbackContinua();
            }
        }

        function gerarTextoOSFinal(servico) {
            const frente = document.getElementById("frente").value.trim() || "N√ÉO INFORMADA";
            const equipeTexto = obterEquipeTexto();

            const [ano, mes, dia] = (servico.data).split('-');
            const dataFormatada = `${dia}/${mes}/${ano}`;

            const [anoF, mesF, diaF] = (servico.dataFinal).split('-');
            const dataFinalFormatada = `${diaF}/${mesF}/${anoF}`;


            const txt = `*SOLICITA√á√ÉO DE O.S*\n\n` +
                `*M√°quina est√° parada por manuten√ß√£o:* \n` +
                `*( ${servico.parada === "sim" ? "‚ùå" : " "} ) sim* *( ${servico.parada === "n√£o" ? "‚ùå" : " "} ) n√£o*\n` +
                `*se SIM abre ORDEM*\n*se N√ÉO abre Pr√©-Ordem*\n\n` +

                `‚Ä¢Frota afetada: ${servico.frota}\n` +
                `‚Ä¢Local/frente: ${frente}\n\n` +

                `‚Ä¢Tipo de manuten√ß√£o:\n` +
                `(${servico.tipo === "CORRETIVA" ? "‚ùå" : " "}) CORRETIVA ORDEM DE MANUTEN√á√ÉO\n` +
                `(${servico.tipo === "CONDICIONAL" ? "‚ùå" : " "}) CONDICIONAL PR√â-ORDEM\n` +
                `(${servico.tipo === "MELHORIA" ? "‚ùå" : " "}) MELHORIA PR√â-ORDEM\n\n` +

                `‚Ä¢Descri√ß√£o servi√ßo\n${servico.descricao}\n(${servico.atividade.split(" - ")[0]} - ${servico.sistema} - ${(servico.subsistema || "").split(" - ")[0]})\n` +
                `${servico.oportunidade ? `Oportunidade: ${servico.oportunidade}\n\n` : '\n'}` +

                `‚Ä¢Foi falha operacional?\n` +
                `(${servico.falha === "sim" ? "‚ùå" : " "}) Sim\n` +
                `(${servico.falha === "n√£o" ? "‚ùå" : " "}) N√£o\n\n` +

                `Data inicial: ${dataFormatada}\n` +
                `Hora inicial: ${servico.inicio}\n` +
                `Data final: ${dataFinalFormatada}\n` +
                `Hora fim: ${servico.fim}\n\n` +

                `Solicitante:\n${equipeTexto}`;

            servico.texto = txt;
            document.getElementById(`texto_${servico.id}`).value = txt;

            const previewContainer = document.getElementById(`preview_container_${servico.id}`);
            const previewDiv = document.getElementById(`preview_${servico.id}`);
            if (previewDiv) previewDiv.innerHTML = interpretarMarkdown(txt);
            if (previewContainer) previewContainer.style.display = 'block';

            const botao = document.getElementById(`botao_${servico.id}`);
            if (botao) botao.innerText = "Regerar O.S.";

            try {
                localStorage.removeItem('servicosRascunho');
            } catch (e) {
                console.error("Erro ao remover rascunho de servi√ßos do localStorage:", e);
            }
            salvarOSnoHistorico(servico.id);
            salvarTudo();
            showToast("O.S gerada/atualizada!");

            const servicoDiv = document.getElementById(`servico_${servico.id}`);
            if (servicoDiv) servicoDiv.classList.remove('servico-pendente-os');

            atualizarCabecalhoServico(servico.id); // Atualiza o cabe√ßalho ap√≥s gerar OS
            renderizarServicos(); // Re-renderiza para atualizar a posi√ß√£o do bot√£o excluir

            setTimeout(() => {
                const el = document.getElementById(`servico_${servico.id}`);
                if (el) el.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }, 100);
        }

        function copiarTexto(id) {
            const txt = document.getElementById(`texto_${id}`).value;
            navigator.clipboard.writeText(txt)
                .then(() => showToast("Texto da O.S. copiado!"))
                .catch(err => {
                    console.error('Erro ao copiar texto: ', err);
                    showToast("Falha ao copiar. Tente manualmente.");
                });
        }

        function compartilharWhatsApp(id) {
            const txt = document.getElementById(`texto_${id}`).value;
            if (!txt) {
                showToast("Gere a O.S. primeiro para compartilhar.");
                return;
            }
            window.open(`https://wa.me/?text=${encodeURIComponent(txt)}`, "_blank");
        }

        function removerServico(id) {
            abrirPopupConfirmar('Deseja realmente remover este servi√ßo?', () => {
                const index = servicos.findIndex(s => s.id === id);
                if (index > -1) {
                    servicos.splice(index, 1);
                    renderizarServicos(); // Isso tamb√©m vai atualizar a visibilidade do bot√£o global
                    showToast("Servi√ßo removido!");
                    salvarTudo();
                } else {
                    showToast("Erro: Servi√ßo n√£o encontrado para remo√ß√£o.");
                }
            });
        }

        function adicionarServicoDepois(idReferencia) {
            salvarValoresServicos();
            const refServico = servicos.find(s => s.id === idReferencia);
            if (!refServico) {
                showToast("Erro: Servi√ßo de refer√™ncia n√£o encontrado.");
                adicionarServico();
                return;
            }

            const novoServico = {
                id: Date.now(),
                sistema: refServico.sistema,
                subsistema: refServico.subsistema,
                frota: refServico.frota,
                atividade: "",
                descricao: "",
                texto: "",
                tipo: "CORRETIVA",
                parada: "sim",
                falha: "n√£o",
                data: refServico.dataFinal || dataHojeInputLocal(),
                dataFinal: refServico.dataFinal || dataHojeInputLocal(),
                inicio: refServico.fim || "",
                fim: "",
                oportunidade: ""
            };

            const indexReferencia = servicos.findIndex(s => s.id === idReferencia);
            servicos.splice(indexReferencia + 1, 0, novoServico);

            renderizarServicos(); // Isso tamb√©m vai atualizar a visibilidade do bot√£o global
            showToast("Novo servi√ßo adicionado abaixo, herdando dados da frota.");

            setTimeout(() => {
                const el = document.getElementById(`servico_${novoServico.id}`);
                if (el) {
                    el.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    const detalhes = document.getElementById(`detalhes_${novoServico.id}`);
                    const toggler = document.getElementById(`toggler_${novoServico.id}`);
                    if (detalhes && toggler && (detalhes.style.display === 'none' || detalhes.style.display === '')) {
                        toggleDetalhesServico(novoServico.id);
                    }
                    const primeiroInput = detalhes ? detalhes.querySelector('select, input, textarea') : null;
                    if (primeiroInput) primeiroInput.focus();
                }
            }, 200);
        }

        function salvarValoresServicos() {
            servicos.forEach(s => {
                s.frota = document.getElementById(`frota_${s.id}`)?.value || s.frota || "";
                s.atividade = document.getElementById(`atividade_${s.id}`)?.value || s.atividade || "";
                s.sistema = document.getElementById(`sistema_${s.id}`)?.value || s.sistema || "";
                s.subsistema = document.getElementById(`subsistema_${s.id}`)?.value || s.subsistema || "";
                s.descricao = document.getElementById(`descricao_${s.id}`)?.value || s.descricao || "";
                s.tipo = document.getElementById(`tipo_${s.id}`)?.value || s.tipo || "CORRETIVA";
                s.parada = document.getElementById(`parada_${s.id}`)?.value || s.parada || "sim";
                s.falha = document.getElementById(`falha_${s.id}`)?.value || s.falha || "n√£o";
                s.data = document.getElementById(`data_${s.id}`)?.value || s.data || dataHojeInputLocal();
                s.dataFinal = document.getElementById(`dataFinal_${s.id}`)?.value || s.dataFinal || s.data || dataHojeInputLocal();
                s.inicio = document.getElementById(`inicio_${s.id}`)?.value || s.inicio || "";
                s.fim = document.getElementById(`fim_${s.id}`)?.value || s.fim || "";
                s.texto = document.getElementById(`texto_${s.id}`)?.value || s.texto || "";
            });
            salvarServicosRascunho();
        }

        function verificarServicosPendentes() {
            salvarValoresServicos();
            const pendentes = servicos.filter(s => !s.texto || s.texto.trim() === "");

            if (pendentes.length > 0) {
                const mensagens = pendentes.map(s => {
                    const frota = s.frota || "Sem Frota";
                    const atividade = (s.atividade || "Sem Atividade").split(" - ")[0];
                    return `Frota: ${frota}, Atividade: ${atividade} - O.S. N√ÉO GERADA.`;
                }).join("\n");

                abrirPopup('Servi√ßos Pendentes',
                    `Existem ${pendentes.length} servi√ßo(s) com O.S. n√£o gerada:\n\n${mensagens}\n\nPor favor, gere as O.S. pendentes.`,
                    [{ texto: 'OK', classe: 'confirmar' }]
                );

                const primeiroPendente = pendentes[0];
                const elemento = document.getElementById(`servico_${primeiroPendente.id}`);
                if (elemento) {
                    elemento.scrollIntoView({ behavior: "smooth", block: "center" });
                    const detalhes = document.getElementById(`detalhes_${primeiroPendente.id}`);
                    if (detalhes && (detalhes.style.display === 'none' || detalhes.style.display === '')) {
                        toggleDetalhesServico(primeiroPendente.id);
                    }
                    showToast("Existem servi√ßos com O.S. n√£o gerada!");
                }
            } else {
                adicionarServico();
            }
        }


        // RELAT√ìRIO
        function toggleEdicaoRelatorio() {
            const textarea = document.getElementById("relatorio_bruto");
            const divFormatado = document.getElementById("relatorio_formatado");
            const botao = document.querySelector('button[onclick="toggleEdicaoRelatorio()"]');

            if (textarea.style.display === 'none' || textarea.style.display === '') {
                textarea.value = divFormatado.innerText;
                textarea.style.display = 'block';
                divFormatado.style.display = 'none';
                textarea.focus();
                botao.innerText = 'Salvar e Ver Formatado';
                botao.style.background = '#28a745';
            } else {
                divFormatado.innerHTML = interpretarMarkdown(textarea.value);
                textarea.style.display = 'none';
                divFormatado.style.display = 'block';
                botao.innerText = 'Editar Relat√≥rio';
                botao.style.background = '';
                salvarTudo();
                showToast("Relat√≥rio atualizado.");
            }
        }

        function limparRelatorio() {
            abrirPopupConfirmar("Tem certeza que deseja limpar o relat√≥rio atual?", () => {
                document.getElementById("relatorio_bruto").value = '';
                document.getElementById("relatorio_formatado").innerHTML = '';
                salvarTudo();
                showToast("Relat√≥rio limpo! Clique em gerar para atualizar.");
            });
        }

        function compartilharRelatorio() {
            const texto = document.getElementById("relatorio_bruto").value.trim() || document.getElementById("relatorio_formatado").innerText.trim();
            if (!texto) {
                showToast("O relat√≥rio est√° vazio. Gere o relat√≥rio primeiro.");
                return;
            }
            const url = `https://wa.me/?text=${encodeURIComponent(texto)}`;
            window.open(url, "_blank");
        }

        function gerarRelatorioFinal() {
            if (!validarCamposTurnoBasicos()) return;
            salvarValoresServicos();

            const osPendentes = servicos.some(s => !s.texto || s.texto.trim() === "");
            if (osPendentes) {
                abrirPopupConfirmar(
                    "Aten√ß√£o: Existem servi√ßos com O.S. n√£o gerada. O relat√≥rio pode ficar incompleto ou com c√°lculos de DM incorretos. Deseja continuar mesmo assim?",
                    () => {
                        procederComGeracaoRelatorio();
                    }
                );
            } else {
                procederComGeracaoRelatorio();
            }
        }

        function procederComGeracaoRelatorio() {
            const dataInput = document.getElementById("dataTurno").value;
            const fazenda = document.getElementById("fazenda").value.trim() || "N√ÉO INFORMADA";
            const frente = document.getElementById("frente").value.trim() || "N√ÉO INFORMADA";
            const turnoLetra = document.getElementById("turnoLetra").value;
            const equipeTextoRel = obterEquipeTexto();

            const qtdMaquinas = frotasTurno.length;
            const horasPorMaquinaRef = frotasTurno.length > 0 ? (frotasTurno[0].horas || 0).toFixed(2) : "0.00";
            const horasTotaisPlanejadas = frotasTurno.reduce((soma, f) => soma + (f.horas || 0), 0).toFixed(2);

            const horasParadasTurno = calcularHorasParadasTurno();
            const dmTurno = calcularDMGeral();
            const frenteUpper = frente.toUpperCase();

            const [ano, mes, dia] = (dataInput || dataHojeInputLocal()).split("-");
            const dataFormatada = `${dia}/${mes}/${ano}`;

            let relatorio = `*MANUTEN√á√ÉO ${frenteUpper} BRACELL*\n\n` +
                `üìÖ *DATA:* ${dataFormatada}\n` +
                `*FAZENDA:* ${fazenda}\n` +
                `*FRENTE:* ${frente}\n` +
                `*TURNO:* ${turnoLetra}\n` +
                `*EQUIPE:*\n${equipeTextoRel}\n\n` +
                `*QTD DE M√ÅQUINAS:* ${qtdMaquinas}\n` +
                `*HORAS PLANEJADAS (Ref. M√°quina):* ${horasPorMaquinaRef}h\n` +
                `*HORAS PLANEJADAS (Total Turno):* ${horasTotaisPlanejadas}h\n` +
                `*HORAS TOTAL PARADA (Corretivas):* ${horasParadasTurno}h (${formatarHorasParaTexto(horasParadasTurno)})\n` +
                `üü¢ *DM DO TURNO:* ${dmTurno}%\n`;

            frotasTurno.forEach(f => {
                const servicosDaFrota = servicos.filter(s => s.frota === f.nome);

                if (servicosDaFrota.length > 0) { // S√≥ adiciona a frota ao relat√≥rio se tiver servi√ßos
                    const paradaFrota = calcularHorasParadasPorFrota(f.nome);
                    const dmFrota = calcularDMFrota(f.nome);
                    relatorio += `\nüöú *${f.nome.toUpperCase()}*\n` +
                        `Horas Planejada: ${(f.horas || 0).toFixed(2)}h\n` +
                        `Horas Parada (Corretivas): ${paradaFrota}h (${formatarHorasParaTexto(paradaFrota)})\n` +
                        `*DM:* ${dmFrota}%\n` +
                        `*RELAT√ìRIO DE SERVI√áOS:*\n`;

                    servicosDaFrota.forEach(s => {
                        const codAtiv = (s.atividade || "N/A").split(" - ")[0];
                        const codSub = (s.subsistema || "N/A").split(" - ")[0];
                        const duracao = calcularDuracaoServico(s);

                        relatorio += `- ${s.descricao.trim() || "Descri√ß√£o n√£o informada"}\n` +
                            `  (${codAtiv} - S:${s.sistema || "N/A"} - Sub:${codSub}) ${emojiTipo(s.tipo)} [${s.tipo.toUpperCase()}]\n` +
                            `  ‚è±Ô∏è Dura√ß√£o: ${duracao.texto} (Decimal: ${duracao.horas}h)\n`;
                        if (s.tipo !== "CORRETIVA" && s.oportunidade) {
                            relatorio += `  Oportunidade: ${s.oportunidade}\n`;
                        }
                        relatorio += `\n`;
                    });
                }
            });
            document.getElementById("relatorio_bruto").value = relatorio;
            document.getElementById("relatorio_formatado").innerHTML = interpretarMarkdown(relatorio);
            salvarTudo();
            showToast("Relat√≥rio gerado!");
        }

        function calcularDuracaoServico(servico) {
            const inicioVal = servico.inicio || "00:00";
            const fimVal = servico.fim || "00:00";

            if (!/^\d{2}:\d{2}$/.test(inicioVal) || !/^\d{2}:\d{2}$/.test(fimVal)) {
                console.warn("Formato de hora inv√°lido para c√°lculo de dura√ß√£o:", servico);
                return { horas: "0.00", texto: "Hora inv√°lida" };
            }

            const dataInicialStr = servico.data || dataHojeInputLocal();
            const dataFinalStr = servico.dataFinal || dataInicialStr;

            const dataIniObj = new Date(`${dataInicialStr}T${inicioVal}:00`);
            const dataFimObj = new Date(`${dataFinalStr}T${fimVal}:00`);

            if (isNaN(dataIniObj.getTime()) || isNaN(dataFimObj.getTime())) {
                console.warn("Data ou hora inv√°lida resultou em data NaN:", servico);
                return { horas: "0.00", texto: "Data/Hora Inv." };
            }

            if (dataFimObj < dataIniObj) {
                console.warn("C√°lculo de dura√ß√£o com data/hora final anterior √† inicial:", servico);
                return { horas: "0.00", texto: "Fim < In√≠cio" };
            }

            const diffMs = dataFimObj - dataIniObj;
            const diffMin = Math.max(Math.floor(diffMs / 60000), 0);

            const horasDecimais = (diffMin / 60).toFixed(2);
            const h = Math.floor(diffMin / 60);
            const m = diffMin % 60;

            let textoCompleto = "";
            if (h > 0) textoCompleto += `${h}h`;
            if (m > 0) textoCompleto += `${h > 0 ? " " : ""}${m}min`;
            if (textoCompleto === "") textoCompleto = "0min";

            return { horas: horasDecimais, texto: textoCompleto };
        }

        function formatarHorasParaTexto(horasDecimaisStr) {
            const horasDecimais = parseFloat(horasDecimaisStr);
            if (isNaN(horasDecimais)) return "N/A";
            const horas = Math.floor(horasDecimais);
            const minutos = Math.round((horasDecimais - horas) * 60);
            if (horas > 0 && minutos > 0) {
                return `${horas}h ${minutos}min`;
            } else if (horas > 0) {
                return `${horas}h`;
            } else if (minutos > 0) {
                return `${minutos}min`;
            } else {
                return `0min`;
            }
        }

        function emojiTipo(tipo) {
            switch (tipo) {
                case "CORRETIVA": return "üîß";
                case "CONDICIONAL": return "‚è≥";
                case "MELHORIA": return "‚ú®";
                default: return "‚ñ™Ô∏è";
            }
        }

        function calcularHorasParadasPorFrota(nomeFrota) {
            let totalHorasParada = 0;
            servicos
                .filter(s => s.frota === nomeFrota && s.tipo === "CORRETIVA" && s.parada === "sim")
                .forEach(s => {
                    totalHorasParada += parseFloat(calcularDuracaoServico(s).horas);
                });
            return totalHorasParada.toFixed(2);
        }

        function calcularDMFrota(nomeFrota) {
            const frotaInfo = frotasTurno.find(f => f.nome === nomeFrota);
            if (!frotaInfo || !frotaInfo.horas || frotaInfo.horas <= 0) return "100.00";

            const horasPlanejada = parseFloat(frotaInfo.horas);
            const horasParada = parseFloat(calcularHorasParadasPorFrota(nomeFrota));
            const horasOperando = Math.max(0, horasPlanejada - horasParada);
            const dm = (horasOperando / horasPlanejada) * 100;
            return dm.toFixed(2);
        }

        function calcularHorasParadasTurno() {
            let totalHorasParadasTurno = 0;
            frotasTurno.forEach(f => {
                totalHorasParadasTurno += parseFloat(calcularHorasParadasPorFrota(f.nome));
            });
            return totalHorasParadasTurno.toFixed(2);
        }

        function calcularDMGeral() {
            const horasTotaisPlanejadas = frotasTurno.reduce((soma, f) => soma + (f.horas || 0), 0);
            if (horasTotaisPlanejadas === 0) return "100.00";

            const horasTotaisParadas = parseFloat(calcularHorasParadasTurno());
            const horasTotaisOperando = Math.max(0, horasTotaisPlanejadas - horasTotaisParadas);
            const dm = (horasTotaisOperando / horasTotaisPlanejadas) * 100;
            return dm.toFixed(2);
        }

        // HIST√ìRICO
        function salvarOSnoHistorico(idServico) {
            const servico = servicos.find(s => s.id === idServico);
            if (!servico || !servico.texto) {
                console.warn("Tentativa de salvar OS no hist√≥rico sem texto ou servi√ßo inv√°lido:", idServico);
                return;
            }
            let historico = {};
            try {
                const historicoString = localStorage.getItem("historicoOS");
                if (historicoString) {
                    historico = JSON.parse(historicoString);
                }
            } catch (e) {
                console.error("Erro ao carregar hist√≥rico do localStorage:", e);
                try { localStorage.removeItem("historicoOS"); } catch (e2) { console.error("Erro ao remover hist√≥rico corrompido:", e2); }
                showToast("Erro ao carregar hist√≥rico. Hist√≥rico resetado.");
            }

            const dataKey = servico.data.split('-').reverse().join('/');
            if (!historico[dataKey]) historico[dataKey] = [];

            const agora = new Date();
            const datahoraRegistro = agora.toLocaleString('pt-BR');

            const indexExistente = historico[dataKey].findIndex(item => item.id === servico.id);
            if (indexExistente >= 0) {
                historico[dataKey][indexExistente].texto = servico.texto;
                historico[dataKey][indexExistente].frota = servico.frota;
                historico[dataKey][indexExistente].tipo = servico.tipo;
                historico[dataKey][indexExistente].datahoraRegistro = datahoraRegistro;
            } else {
                historico[dataKey].push({
                    id: servico.id,
                    frota: servico.frota,
                    tipo: servico.tipo,
                    texto: servico.texto,
                    status: "pendente",
                    datahoraRegistro: datahoraRegistro,
                    osNumero: "",
                    dataOS: servico.data
                });
            }
            try {
                localStorage.setItem("historicoOS", JSON.stringify(historico));
            } catch (e) {
                console.error("Erro ao salvar hist√≥rico no localStorage:", e);
                if (e.name === 'QuotaExceededError') {
                    showToast("Erro: N√£o h√° espa√ßo para salvar o hist√≥rico. Tente limpar dados antigos.");
                } else {
                    showToast("Erro ao salvar hist√≥rico.");
                }
            }
            mostrarHistorico();
        }

        function mostrarHistorico() {
            let historico = {};
            try {
                const historicoString = localStorage.getItem("historicoOS");
                if (historicoString) {
                    historico = JSON.parse(historicoString);
                }
            } catch (e) {
                console.error("Erro ao carregar hist√≥rico do localStorage para exibi√ß√£o:", e);
                try { localStorage.removeItem("historicoOS"); } catch (e2) { console.error("Erro ao remover hist√≥rico corrompido:", e2); }
                historico = {};
                showToast("Erro ao carregar hist√≥rico para exibi√ß√£o. Hist√≥rico pode estar corrompido e foi resetado.");
            }

            const div = document.getElementById("historico_lista");
            if (!div) return;

            const datasOrdenadas = Object.keys(historico).sort((a, b) => {
                const [diaA, mesA, anoA] = a.split('/').map(Number);
                const [diaB, mesB, anoB] = b.split('/').map(Number);
                return new Date(anoB, mesB - 1, diaB) - new Date(anoA, mesA - 1, diaA);
            });

            if (datasOrdenadas.length === 0) {
                div.innerHTML = "<p>Nenhuma O.S registada no hist√≥rico ainda.</p>";
                return;
            }

            let html = "";
            datasOrdenadas.forEach(data => {
                html += `<div class="grupo"><h3 style="margin:5px 0;">Data da O.S.: ${data}</h3>`;
                const osDoDia = historico[data].sort((a, b) => new Date(b.datahoraRegistro.replace(/(\d{2})\/(\d{2})\/(\d{4}), (\d{2}:\d{2}:\d{2})/, '$3-$2-$1T$4')) - new Date(a.datahoraRegistro.replace(/(\d{2})\/(\d{2})\/(\d{4}), (\d{2}:\d{2}:\d{2})/, '$3-$2-$1T$4')));

                osDoDia.forEach(s => {
                    html += `
                        <div class="grupo" style="background:#f9f9f9; margin-top: 10px;">
                            <div style="display:flex; justify-content:space-between; align-items:center;">
                                <div style="font-weight: bold; font-size: 15px;">Registado em: ${s.datahoraRegistro}</div>
                                <button onclick="toggleCorpoHistorico(${s.id})" style="background:none; border:none; width:auto; font-size:20px; cursor:pointer; padding:5px;">üëÅÔ∏è</button>
                            </div>
                            <div class="linha" style="flex-wrap: wrap; align-items: center; gap: 10px; margin-top:5px;">
                                <label style="font-weight: bold;">N¬∫ O.S.:</label>
                                <input id="os_input_${s.id}" class="input-padrao" style="min-width: 80px; max-width: 120px; padding: 5px;" value="${s.osNumero || ""}" oninput="validarOSInput(${s.id})" ${s.status === "pendente" ? "" : "disabled"}>
                                <span><strong>Frota:</strong> ${s.frota}</span>
                                <span style="font-weight:bold; color:${s.status === 'pendente' ? 'orange' : 'green'};">Status: ${s.status === "pendente" ? "‚ùå Pendente" : "‚úÖ Finalizada"}</span>
                            </div>
                            <div id="corpo_hist_${s.id}" style="display:none; margin-top:10px;">
                                <textarea class="editavel input-padrao" id="htexto_${s.id}">${s.texto}</textarea>
                                <div class="botoes" style="margin-top:10px;">
                                    ${s.status === "pendente"
                            ? `<button onclick="finalizarOS(${s.id})" class="confirmar" id="btnFinalizarOS_${s.id}" ${!s.osNumero ? 'disabled' : ''}>Marcar como Finalizada</button>`
                            : `<button id="editarOSBtn_${s.id}" onclick="habilitarEdicaoOS(${s.id})">Editar N¬∫ O.S.</button>`
                        }
                                    <button onclick="copiarHistorico(${s.id})">Copiar Texto</button>
                                    <button onclick="compartilharHistorico(${s.id})">Compartilhar</button>
                                    <button onclick="excluirHistorico(${s.id}, '${data}')" class="perigo">Excluir do Hist√≥rico</button>
                                </div>
                            </div>
                        </div>`;
                });
                html += `</div>`;
            });
            div.innerHTML = html;
        }

        function validarOSInput(id) {
            const input = document.getElementById(`os_input_${id}`);
            const btnFinalizar = document.getElementById(`btnFinalizarOS_${id}`);
            if (input && btnFinalizar) {
                btnFinalizar.disabled = input.value.trim() === "";
            }
        }

        function toggleCorpoHistorico(id) {
            const corpo = document.getElementById(`corpo_hist_${id}`);
            if (corpo) corpo.style.display = corpo.style.display === 'none' ? 'block' : 'none';
        }

        function finalizarOS(id) {
            let historico = {};
            try {
                const historicoString = localStorage.getItem("historicoOS");
                if (historicoString) historico = JSON.parse(historicoString);
            } catch (e) {
                console.error("Erro ao carregar hist√≥rico para finalizar OS:", e);
                showToast("Erro ao acessar dados do hist√≥rico. A√ß√£o cancelada.");
                return;
            }

            const inputOSNumero = document.getElementById(`os_input_${id}`);
            const numeroOS = inputOSNumero.value.trim();

            if (!numeroOS) {
                showToast("Preencha o n√∫mero da O.S. antes de finalizar.");
                inputOSNumero.focus();
                return;
            }
            let osEncontrada = false;
            for (const dataKey in historico) {
                const itemIndex = historico[dataKey].findIndex(s => s.id === id);
                if (itemIndex > -1) {
                    historico[dataKey][itemIndex].status = "finalizada";
                    historico[dataKey][itemIndex].osNumero = numeroOS;
                    osEncontrada = true;
                    break;
                }
            }
            if (osEncontrada) {
                try {
                    localStorage.setItem("historicoOS", JSON.stringify(historico));
                    mostrarHistorico();
                    showToast("O.S finalizada no hist√≥rico!");
                } catch (e) {
                    console.error("Erro ao salvar hist√≥rico ap√≥s finalizar OS:", e);
                    showToast("Erro ao salvar atualiza√ß√£o no hist√≥rico.");
                }
            } else {
                showToast("Erro: O.S n√£o encontrada no hist√≥rico para finalizar.");
            }
        }

        function habilitarEdicaoOS(id) {
            const input = document.getElementById(`os_input_${id}`);
            const btn = document.getElementById(`editarOSBtn_${id}`);
            if (input && btn) {
                input.disabled = false;
                input.focus();
                btn.innerText = "Confirmar Edi√ß√£o";
                btn.style.background = "#28a745";
                btn.onclick = () => confirmarEdicaoOS(id);
            }
        }

        function confirmarEdicaoOS(id) {
            let historico = {};
            try {
                const historicoString = localStorage.getItem("historicoOS");
                if (historicoString) historico = JSON.parse(historicoString);
            } catch (e) {
                console.error("Erro ao carregar hist√≥rico para confirmar edi√ß√£o OS:", e);
                showToast("Erro ao acessar dados do hist√≥rico. A√ß√£o cancelada.");
                return;
            }
            const input = document.getElementById(`os_input_${id}`);
            const numero = input.value.trim();

            if (!numero) {
                showToast("O n√∫mero da O.S n√£o pode ficar vazio.");
                return;
            }
            let osEncontrada = false;
            for (const dataKey in historico) {
                const itemIndex = historico[dataKey].findIndex(s => s.id === id);
                if (itemIndex > -1) {
                    historico[dataKey][itemIndex].osNumero = numero;
                    osEncontrada = true;
                    break;
                }
            }
            if (osEncontrada) {
                try {
                    localStorage.setItem("historicoOS", JSON.stringify(historico));
                    input.disabled = true;
                    const btn = document.getElementById(`editarOSBtn_${id}`);
                    if (btn) {
                        btn.innerText = "Editar N¬∫ O.S.";
                        btn.style.background = "";
                        btn.onclick = () => habilitarEdicaoOS(id);
                    }
                    mostrarHistorico();
                    showToast("N√∫mero da O.S atualizado no hist√≥rico!");
                } catch (e) {
                    console.error("Erro ao salvar hist√≥rico ap√≥s confirmar edi√ß√£o OS:", e);
                    showToast("Erro ao salvar atualiza√ß√£o no hist√≥rico.");
                }
            } else {
                showToast("Erro: O.S n√£o encontrada para editar.");
            }
        }

        function copiarHistorico(id) {
            const texto = document.getElementById(`htexto_${id}`)?.value;
            if (texto) {
                navigator.clipboard.writeText(texto)
                    .then(() => showToast("Texto da O.S. do hist√≥rico copiado!"))
                    .catch(err => showToast("Falha ao copiar."));
            } else {
                showToast("Texto n√£o encontrado para copiar.");
            }
        }

        function compartilharHistorico(id) {
            const texto = document.getElementById(`htexto_${id}`)?.value;
            if (texto) {
                window.open(`https://wa.me/?text=${encodeURIComponent(texto)}`, "_blank");
            } else {
                showToast("Texto n√£o encontrado para compartilhar.");
            }
        }

        function excluirHistorico(id, dataKeyFormatada) {
            abrirPopupConfirmar(`Tem certeza que deseja excluir esta O.S. (ID: ${id}) do hist√≥rico da data ${dataKeyFormatada}? Esta a√ß√£o n√£o pode ser desfeita.`, () => {
                let historico = {};
                try {
                    const historicoString = localStorage.getItem("historicoOS");
                    if (historicoString) historico = JSON.parse(historicoString);
                } catch (e) {
                    console.error("Erro ao carregar hist√≥rico para excluir OS:", e);
                    showToast("Erro ao acessar dados do hist√≥rico. A√ß√£o cancelada.");
                    return;
                }

                if (historico[dataKeyFormatada]) {
                    historico[dataKeyFormatada] = historico[dataKeyFormatada].filter(s => s.id !== id);
                    if (historico[dataKeyFormatada].length === 0) {
                        delete historico[dataKeyFormatada];
                    }
                    try {
                        localStorage.setItem("historicoOS", JSON.stringify(historico));
                        mostrarHistorico();
                        showToast("O.S. exclu√≠da do hist√≥rico!");
                    } catch (e) {
                        console.error("Erro ao salvar hist√≥rico ap√≥s excluir OS:", e);
                        showToast("Erro ao salvar atualiza√ß√£o no hist√≥rico.");
                    }
                } else {
                    showToast("Erro: Data n√£o encontrada no hist√≥rico para exclus√£o.");
                }
            }, "Confirmar Exclus√£o do Hist√≥rico");
        }

        // BACKUP E RESTAURA√á√ÉO
        function baixarBackup(tipo = "historico") {
            let dadosParaBackup;
            let nomeArquivoBase;
            let dadosString;

            if (tipo === "historico") {
                try {
                    dadosString = localStorage.getItem("historicoOS");
                    dadosParaBackup = dadosString ? JSON.parse(dadosString) : {};
                } catch (e) {
                    console.error("Erro ao ler hist√≥rico para backup:", e);
                    showToast("Erro ao ler dados do hist√≥rico para backup. Verifique o console.");
                    return;
                }
                nomeArquivoBase = "backup_meuturno_historico_";
                if (Object.keys(dadosParaBackup).length === 0) {
                    showToast("Nenhum dado no hist√≥rico para backup.");
                    return;
                }
            } else {
                let turnoDados = {}, historicoDados = {};
                try {
                    const turnoString = localStorage.getItem("turno");
                    if (turnoString) turnoDados = JSON.parse(turnoString);
                    const historicoString = localStorage.getItem("historicoOS");
                    if (historicoString) historicoDados = JSON.parse(historicoString);
                } catch (e) {
                    console.error("Erro ao ler dados para backup completo:", e);
                    showToast("Erro ao ler dados para backup completo. Verifique o console.");
                    return;
                }
                dadosParaBackup = {
                    turno: turnoDados,
                    historicoOS: historicoDados
                };
                nomeArquivoBase = "backup_meuturno_completo_";
                if (Object.keys(dadosParaBackup.turno).length === 0 && Object.keys(dadosParaBackup.historicoOS).length === 0) {
                    showToast("Nenhum dado para o backup completo.");
                    return;
                }
            }

            const blob = new Blob([JSON.stringify(dadosParaBackup, null, 2)], { type: "application/json" });
            const url = URL.createObjectURL(blob);
            const agora = new Date();
            const dataHora = agora.toISOString().slice(0, 19).replace(/[:T]/g, '-');
            const nomeArquivo = `${nomeArquivoBase}${dataHora}.json`;

            const a = document.createElement('a');
            a.href = url;
            a.download = nomeArquivo;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            try {
                localStorage.setItem("ultimoBackupTimestamp", new Date().toISOString());
            } catch (e) {
                console.warn("N√£o foi poss√≠vel salvar o timestamp do √∫ltimo backup:", e);
            }
            atualizarInfoUltimoBackup();
            showToast(`Backup (${tipo}) criado: ${nomeArquivo}`);
        }
        function baixarBackupHistorico() {
            baixarBackup("historico");
        }
        function gerarBackupCompleto() {
            baixarBackup("completo");
        }


        function restaurarBackupHistorico(event) {
            const file = event.target.files[0];
            if (!file) return;
            abrirPopupConfirmar(
                'IMPORTANTE: Restaurar este backup substituir√° APENAS o HIST√ìRICO DE O.S. atual. Os dados do turno corrente N√ÉO ser√£o afetados. Esta a√ß√£o N√ÉO PODE SER DESFEITA. Deseja continuar?',
                () => {
                    const reader = new FileReader();
                    reader.onload = function (e) {
                        try {
                            const dados = JSON.parse(e.target.result);
                            if (typeof dados === 'object' && !Array.isArray(dados) && Object.keys(dados).every(key => key.match(/^\d{2}\/\d{2}\/\d{4}$/))) {
                                try {
                                    localStorage.setItem("historicoOS", JSON.stringify(dados));
                                    mostrarHistorico();
                                    showToast("Backup do hist√≥rico restaurado com sucesso!");
                                } catch (storageError) {
                                    console.error("Erro ao salvar backup do hist√≥rico restaurado:", storageError);
                                    showToast("Erro ao salvar o backup do hist√≥rico. Verifique o espa√ßo de armazenamento.");
                                }
                            } else {
                                showToast("Arquivo de backup de hist√≥rico inv√°lido ou mal formatado.");
                            }
                        } catch (err) {
                            console.error("Erro ao ler arquivo de backup de hist√≥rico:", err);
                            showToast("Erro ao ler o arquivo de backup do hist√≥rico.");
                        }
                    };
                    reader.readAsText(file);
                    event.target.value = null;
                }, "Restaurar Backup do Hist√≥rico"
            );
        }

        function restaurarBackupCompleto(event) {
            const file = event.target.files[0];
            if (!file) return;
            abrirPopupConfirmar(
                'MUITO IMPORTANTE: Restaurar este backup substituir√° TODOS os dados atuais do aplicativo (turno atual, servi√ßos, frotas, equipe E TODO o hist√≥rico). Esta a√ß√£o N√ÉO PODE SER DESFEITA. Deseja continuar?',
                () => {
                    const reader = new FileReader();
                    reader.onload = function (e) {
                        try {
                            const dados = JSON.parse(e.target.result);
                            if (dados && typeof dados === 'object') {
                                try {
                                    if (dados.turno) localStorage.setItem("turno", JSON.stringify(dados.turno)); else try { localStorage.removeItem("turno"); } catch (er) { console.warn("Erro ao remover item 'turno'", er) }
                                    if (dados.historicoOS) localStorage.setItem("historicoOS", JSON.stringify(dados.historicoOS)); else try { localStorage.removeItem("historicoOS"); } catch (er) { console.warn("Erro ao remover item 'historicoOS'", er) }

                                    carregarTudo();
                                    mostrarHistorico();
                                    atualizarInfoUltimoBackup();
                                    showToast("Backup completo restaurado com sucesso!");
                                } catch (storageError) {
                                    console.error("Erro ao salvar backup completo restaurado:", storageError);
                                    showToast("Erro ao salvar o backup completo. Verifique o espa√ßo de armazenamento.");
                                }
                            } else {
                                showToast("Arquivo de backup completo inv√°lido.");
                            }
                        } catch (err) {
                            console.error("Erro ao ler arquivo de backup completo:", err);
                            showToast("Erro ao ler o arquivo de backup completo.");
                        }
                    };
                    reader.readAsText(file);
                    event.target.value = null;
                }, "Restaurar Backup Completo"
            );
        }

        function atualizarInfoUltimoBackup() {
            const pInfo = document.getElementById("infoUltimoBackup");
            if (!pInfo) return;
            let timestamp;
            try {
                timestamp = localStorage.getItem("ultimoBackupTimestamp");
            } catch (e) {
                console.warn("Erro ao ler timestamp do √∫ltimo backup:", e);
                pInfo.textContent = "N√£o foi poss√≠vel verificar o √∫ltimo backup.";
                return;
            }


            if (timestamp) {
                const dataBackup = new Date(timestamp);
                pInfo.textContent = `√öltimo backup realizado em: ${dataBackup.toLocaleDateString('pt-BR')} √†s ${dataBackup.toLocaleTimeString('pt-BR')}.`;
                const umaSemanaAtras = new Date();
                umaSemanaAtras.setDate(umaSemanaAtras.getDate() - 7);
                if (dataBackup < umaSemanaAtras) {
                    pInfo.innerHTML += ' <strong style="color:orange;">(Backup antigo! Recomendado fazer novo backup!)</strong>';
                }
            } else {
                pInfo.textContent = "Nenhum backup realizado recentemente. √â altamente recomend√°vel fazer um backup.";
            }
        }


        // LIMPEZA DE DADOS
        function limparTodosServicos() {
            abrirPopupConfirmar(
                "TEM CERTEZA? Esta a√ß√£o apagar√° TODOS os servi√ßos criados no TURNO ATUAL e n√£o poder√° ser desfeita. O hist√≥rico n√£o ser√° afetado. Deseja continuar?",
                () => {
                    servicos = [];
                    try {
                        localStorage.removeItem("servicosRascunho");
                    } catch (e) {
                        console.warn("Erro ao limpar rascunho de servi√ßos:", e);
                    }
                    renderizarServicos();
                    salvarTudo();
                    showToast("Todos os servi√ßos do turno atual foram apagados!");
                }, "Limpar Servi√ßos do Turno"
            );
        }

        function limparStorage() {
            abrirPopupConfirmar(
                'ALERTA M√ÅXIMO! Tem certeza que deseja apagar TODOS OS DADOS SALVOS do aplicativo (turno atual, hist√≥rico, tudo)? Esta a√ß√£o √© IRREVERS√çVEL e todos os seus dados ser√£o perdidos. Para seguran√ßa, fa√ßa um backup completo antes. Deseja prosseguir com a exclus√£o total?',
                () => {
                    try {
                        localStorage.clear();
                        location.reload();
                    } catch (e) {
                        console.error("Erro ao limpar o localStorage:", e);
                        showToast("Erro ao tentar limpar todos os dados. Tente manualmente nas configura√ß√µes do navegador.");
                    }
                }, "Resetar Aplicativo"
            );
        }

        function abrirPopupApagarPorData() {
            let historico = {};
            try {
                const historicoString = localStorage.getItem("historicoOS");
                if (historicoString) historico = JSON.parse(historicoString);
            } catch (e) {
                console.error("Erro ao carregar hist√≥rico para apagar por data:", e);
                showToast("Erro ao acessar dados do hist√≥rico.");
                return;
            }
            const datasDisponiveis = Object.keys(historico).sort((a, b) => {
                const [diaA, mesA, anoA] = a.split('/').map(Number);
                const [diaB, mesB, anoB] = b.split('/').map(Number);
                return new Date(anoB, mesB - 1, diaB) - new Date(anoA, mesA - 1, diaA);
            });

            if (datasDisponiveis.length === 0) {
                showToast("Nenhum hist√≥rico para apagar.");
                return;
            }

            const select = document.getElementById('selectDatas');
            select.innerHTML = '<option value="">Selecione uma data</option>' +
                datasDisponiveis.map(d => `<option value="${d}">${d}</option>`).join('');

            document.getElementById('popupApagarData').style.display = 'block';
            document.getElementById('overlayApagarData').style.display = 'block';
            fecharTeclado();
        }
        function fecharPopupApagarPorData() {
            document.getElementById('popupApagarData').style.display = 'none';
            document.getElementById('overlayApagarData').style.display = 'none';
        }
        function confirmarApagarPorData() {
            const dataSelecionada = document.getElementById('selectDatas').value;
            if (!dataSelecionada) {
                showToast("Selecione uma data para apagar do hist√≥rico.");
                return;
            }
            abrirPopupConfirmar(`Tem certeza que deseja apagar TODO o hist√≥rico da data ${dataSelecionada}? Esta a√ß√£o n√£o pode ser desfeita.`, () => {
                let historico = {};
                try {
                    const historicoString = localStorage.getItem("historicoOS");
                    if (historicoString) historico = JSON.parse(historicoString);
                } catch (e) {
                    console.error("Erro ao carregar hist√≥rico para confirmar apagar por data:", e);
                    showToast("Erro ao acessar dados do hist√≥rico.");
                    return;
                }

                if (historico[dataSelecionada]) {
                    delete historico[dataSelecionada];
                    try {
                        localStorage.setItem("historicoOS", JSON.stringify(historico));
                        showToast(`Hist√≥rico da data ${dataSelecionada} apagado!`);
                        fecharPopupApagarPorData();
                        mostrarHistorico();
                    } catch (storageError) {
                        console.error("Erro ao salvar hist√≥rico ap√≥s apagar por data:", storageError);
                        showToast("Erro ao salvar atualiza√ß√£o no hist√≥rico.");
                    }
                } else {
                    showToast("Data n√£o encontrada no hist√≥rico.");
                }
            }, "Confirmar Exclus√£o de Hist√≥rico por Data");
        }


        // PERSIST√äNCIA GERAL (localStorage)
        function salvarDadosParciaisTurno() {
            let dadosTurnoExistente = {};
            try {
                const turnoString = localStorage.getItem("turno");
                if (turnoString) dadosTurnoExistente = JSON.parse(turnoString);
            } catch (e) {
                console.error("Erro ao carregar dados parciais do turno do localStorage:", e);
                try { localStorage.removeItem("turno"); } catch (e2) { console.error("Erro ao remover turno corrompido:", e2); }
            }

            const dadosTurnoAtualizados = {
                ...dadosTurnoExistente,
                data: document.getElementById("dataTurno").value,
                fazenda: document.getElementById("fazenda").value.trim(),
                frente: document.getElementById("frente").value.trim(),
                turno: document.getElementById("turnoLetra").value,
            };
            try {
                localStorage.setItem("turno", JSON.stringify(dadosTurnoAtualizados));
            } catch (e) {
                console.error("Erro ao salvar dados parciais do turno no localStorage:", e);
                if (e.name === 'QuotaExceededError') {
                    showToast("Erro: N√£o h√° espa√ßo para salvar os dados do turno. Tente limpar dados antigos.");
                } else {
                    showToast("Erro ao salvar dados parciais do turno.");
                }
            }
        }

        function salvarTudo() {
            salvarValoresServicos();
            const dadosTurno = {
                data: document.getElementById("dataTurno").value,
                fazenda: document.getElementById("fazenda").value.trim(),
                frente: document.getElementById("frente").value.trim(),
                turno: document.getElementById("turnoLetra").value,
                equipe: equipe,
                frotas: frotasTurno,
                servicos: servicos,
                relatorio: document.getElementById("relatorio_bruto").value
            };
            try {
                localStorage.setItem("turno", JSON.stringify(dadosTurno));
            } catch (e) {
                console.error("Erro ao salvar tudo no localStorage:", e);
                if (e.name === 'QuotaExceededError') {
                    showToast("Erro cr√≠tico: N√£o h√° espa√ßo para salvar os dados da aplica√ß√£o. Fa√ßa um backup e limpe dados antigos!");
                } else {
                    showToast("Erro cr√≠tico ao salvar os dados da aplica√ß√£o.");
                }
            }
        }

        function carregarTudo() {
            let dados = null;
            try {
                const turnoString = localStorage.getItem("turno");
                if (turnoString) {
                    dados = JSON.parse(turnoString);
                }
            } catch (e) {
                console.error("Erro ao carregar dados do turno do localStorage (carregarTudo):", e);
                try { localStorage.removeItem("turno"); } catch (e2) { console.error("Erro ao remover turno corrompido:", e2); }
                showToast("Erro ao carregar dados do turno. Alguns dados podem ter sido resetados.");
            }

            if (dados) {
                document.getElementById("dataTurno").value = dados.data || dataHojeInputLocal();
                document.getElementById("fazenda").value = dados.fazenda || "";
                document.getElementById("frente").value = dados.frente || "";
                document.getElementById("turnoLetra").value = dados.turno || "A";

                equipe = dados.equipe || [];
                renderizarEquipe();

                frotasTurno = dados.frotas || [];
                renderizarFrotas();

                servicos = dados.servicos || [];

                const relatorioBruto = dados.relatorio || "";
                document.getElementById("relatorio_bruto").value = relatorioBruto;
                document.getElementById("relatorio_formatado").innerHTML = interpretarMarkdown(relatorioBruto);

                atualizarSelectsDeFrotasNosServicos();
            } else {
                document.getElementById("dataTurno").value = dataHojeInputLocal();
            }
        }

        // SERVICE WORKER E PWA
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('./service-worker.js').then(reg => {
                reg.onupdatefound = () => {
                    const newWorker = reg.installing;
                    newWorker.onstatechange = () => {
                        if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                            const updatePopup = document.getElementById('update-popup');
                            if (updatePopup) updatePopup.style.display = 'block';
                        }
                    };
                };
            }).catch(err => {
                console.log('Erro ao registrar o Service Worker:', err);
            });

            navigator.serviceWorker.addEventListener('controllerchange', () => {
                console.log('Nova vers√£o ativada. Recarregando...');
                window.location.reload();
            });
        }

        // Controlar visibilidade dos FABs com base no scroll
        function controlarVisibilidadeFABsScroll() {
            const fabServico = document.getElementById('fabAddServicos');
            const fabFrota = document.getElementById('fabAddFrota'); // Este deve permanecer
            const abaServicosAtiva = document.getElementById('servicos')?.classList.contains('active');

            if (!abaServicosAtiva) {
                if (fabServico) fabServico.style.display = 'none';
                return;
            }

            if (fabServico) {
                if ((window.innerHeight + Math.ceil(window.scrollY)) >= (document.body.offsetHeight - 150)) {
                    fabServico.style.display = 'none';
                } else {
                    fabServico.style.display = 'flex';
                }
            }
        }

        // INICIALIZA√á√ÉO
        document.addEventListener("DOMContentLoaded", () => {
            carregarTudo();
            mostrarHistorico();
            atualizarInfoUltimoBackup();
            abrir('turno');

            if (!document.getElementById("dataTurno").value) {
                document.getElementById("dataTurno").value = dataHojeInputLocal();
            }
            window.addEventListener('scroll', controlarVisibilidadeFABsScroll);
        });

    </script>
</body>

</html>
